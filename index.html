<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARKS GALAXY LIMITED</title>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        
        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDyre2oxURYXHZOLIHUeG2itz56i5ehAYo",
          authDomain: "company-doc-generator.firebaseapp.com",
          projectId: "company-doc-generator",
          storageBucket: "company-doc-generator.firebasestorage.app",
          messagingSenderId: "891677147775",
          appId: "1:891677147775:web:a1ffebf23572f5ca18f54a",
          measurementId: "G-1MMCF9W7HF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = {
            auth, db,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
            collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where
        };
        
        console.log("Firebase initialized successfully");
    </script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Global Styles */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #ff9e00;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ... [Previous CSS remains the same, shortened for brevity] ... */

        /* Document Preview - Ensure it fits PDF */
        .document-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 1px solid #eaeaea;
            position: relative;
            width: 100%;
            max-width: 800px; /* Limit width for better PDF fit */
            margin-left: auto;
            margin-right: auto;
        }

        /* Ensure tables fit within the preview */
        .document-table {
            width: 100%;
            border-collapse: collapse;
            margin: 40px 0;
            table-layout: fixed; /* Ensure table fits */
        }

        .document-table th,
        .document-table td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            word-wrap: break-word; /* Prevent text overflow */
            overflow-wrap: break-word;
        }

        .document-table th:nth-child(1),
        .document-table td:nth-child(1) {
            width: 40%; /* Description column */
        }

        .document-table th:nth-child(2),
        .document-table td:nth-child(2) {
            width: 15%; /* Quantity column */
        }

        .document-table th:nth-child(3),
        .document-table td:nth-child(3) {
            width: 20%; /* Unit Price column */
        }

        .document-table th:nth-child(4),
        .document-table td:nth-child(4) {
            width: 25%; /* Total column */
        }

        /* PDF-specific styles */
        @media print {
            .document-preview {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
            }
            
            .document-table {
                width: 100% !important;
                font-size: 12px !important;
            }
            
            .document-table th,
            .document-table td {
                padding: 8px 10px !important;
            }
            
            .document-title {
                font-size: 24px !important;
                margin: 20px 0 !important;
            }
            
            h2, h3, h4 {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .terms-preview {
                page-break-inside: avoid !important;
            }
        }

        /* ... [Rest of CSS remains the same] ... */
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <!-- ... [Previous HTML remains the same] ... -->

    <script>
        // Global variables
        let currentUser = null;
        let db = null;
        let companies = [];
        let documents = [];
        let clients = [];
        let terms = [];
        let currentCompanyId = null;
        let selectedPaymentMethods = [];
        let paymentAccounts = [];
        let discountAmount = 0;
        let signatureLoaded = false;
        let selectedCurrency = 'USD';
        let currentTermId = null;
        let currentDocumentForPayment = null;
        let selectedTermIds = [];
        let accountCounter = 1;
        
        // Store for monthly sequential numbers
        let monthlySequence = {};

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing...");
            
            // Wait for Firebase to be initialized
            if (!window.firebaseApp) {
                console.error("Firebase not initialized");
                showAuthAlert('loginAlert', 'Firebase initialization failed. Please refresh the page.', 'danger');
                return;
            }

            // Initialize Firebase components
            db = window.firebaseApp.db;
            
            // Set up auth state listener
            window.firebaseApp.onAuthStateChanged(window.firebaseApp.auth, (user) => {
                if (user) {
                    console.log("User signed in:", user.email);
                    currentUser = user;
                    showMainApp();
                    initializeMainApp();
                } else {
                    console.log("No user signed in");
                    showAuthScreen();
                }
            });

            // Set up event listeners for auth screen
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('registerConfirmPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
            
            // Set receipt date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('receiptDate').value = today;
            
            // Initialize payment accounts array
            paymentAccounts = [{
                id: 'paymentAccount1',
                accountType: 'bank',
                accountName: '',
                bankName: '',
                accountNumber: '',
                swiftCode: '',
                mobileNetwork: 'mpesa',
                phoneNumber: '',
                paybillNumber: '',
                cardType: 'visa',
                cardLast4: '',
                processingInstitution: '',
                notes: ''
            }];
        });

        // ... [Previous JavaScript functions remain the same until generatePDF()] ...

        // FIXED PDF Generation Function
        async function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                
                // Create PDF in portrait mode, A4 size
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const element = document.getElementById('documentPreview');
                
                // Set a timeout to ensure all content is rendered
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Calculate optimal scale for A4
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Get the actual dimensions of the element
                const elementWidth = element.offsetWidth;
                const elementHeight = element.scrollHeight;
                
                // Calculate scale to fit width
                const scale = pdfWidth / elementWidth;
                
                // Create canvas with appropriate dimensions
                const canvas = await html2canvas(element, {
                    scale: 2, // Higher scale for better quality
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: elementWidth,
                    height: elementHeight,
                    windowWidth: elementWidth,
                    windowHeight: elementHeight,
                    onclone: function(clonedDoc) {
                        // Ensure all content is visible for capture
                        const previewElement = clonedDoc.getElementById('documentPreview');
                        if (previewElement) {
                            // Remove shadows and borders for cleaner PDF
                            previewElement.style.boxShadow = 'none';
                            previewElement.style.border = '1px solid #ddd';
                            previewElement.style.borderRadius = '0';
                            previewElement.style.padding = '20px';
                            previewElement.style.margin = '0';
                            previewElement.style.width = '100%';
                            previewElement.style.maxWidth = '100%';
                            
                            // Ensure tables fit
                            const tables = previewElement.querySelectorAll('table');
                            tables.forEach(table => {
                                table.style.width = '100%';
                                table.style.tableLayout = 'fixed';
                                table.style.wordWrap = 'break-word';
                            });
                            
                            // Ensure text doesn't overflow
                            const cells = previewElement.querySelectorAll('td, th');
                            cells.forEach(cell => {
                                cell.style.wordWrap = 'break-word';
                                cell.style.overflowWrap = 'break-word';
                                cell.style.maxWidth = '100%';
                            });
                        }
                    }
                });
                
                // Check if canvas is valid
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    throw new Error('Canvas rendering failed');
                }
                
                const imgData = canvas.toDataURL('image/png');
                
                // Verify the image data
                if (!imgData || imgData.length < 100) {
                    throw new Error('Image data is invalid or too small');
                }
                
                // Calculate image dimensions for PDF
                const imgWidth = pdfWidth - 20; // Leave 10mm margins on each side
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Add first page
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                // Add new pages if content is longer than one page
                let heightLeft = imgHeight;
                let position = 0;
                let pageHeight = pdfHeight - 20; // Account for margins
                
                while (heightLeft > pageHeight) {
                    position = heightLeft - pageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 10, 10 - position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const docType = document.getElementById('documentType').value;
                const serialNumber = document.getElementById('serialNumber').value;
                pdf.save(`${serialNumber}-${docType}.pdf`);
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                showAlert('historyAlert', 'Error generating PDF: ' + error.message, 'danger');
                
                // Alternative PDF generation method
                try {
                    await generateTextBasedPDF();
                } catch (fallbackError) {
                    console.error("Fallback PDF generation failed:", fallbackError);
                    alert('PDF generation failed. Please try again or contact support.');
                }
            }
        }

        // Alternative text-based PDF generation
        async function generateTextBasedPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            const docType = document.getElementById('documentType').value;
            const serialNumber = document.getElementById('serialNumber').value;
            const companyName = document.getElementById('previewCompanyName').textContent;
            const customerName = document.getElementById('customerName').value || 'Customer Name';
            
            // Set up PDF styling
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text(companyName, 105, 20, { align: 'center' });
            
            pdf.setFontSize(16);
            pdf.text(docType.toUpperCase(), 105, 30, { align: 'center' });
            
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Serial No: ${serialNumber}`, 20, 45);
            pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, 52);
            
            pdf.text(`Customer: ${customerName}`, 20, 65);
            
            // Add a simple table
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Description', 20, 80);
            pdf.text('Qty', 120, 80);
            pdf.text('Unit Price', 140, 80);
            pdf.text('Total', 170, 80);
            
            pdf.setFont('helvetica', 'normal');
            pdf.line(20, 82, 190, 82);
            
            let yPos = 88;
            
            // Add items
            const rows = document.querySelectorAll('#itemsTableBody tr');
            rows.forEach(row => {
                const desc = row.querySelector('.item-desc').value || '';
                const qty = row.querySelector('.item-qty').value || '0';
                const price = row.querySelector('.item-price').value || '0';
                const total = (parseFloat(qty) * parseFloat(price)).toFixed(2);
                
                if (desc.trim()) {
                    // Handle long descriptions
                    const descLines = pdf.splitTextToSize(desc, 80);
                    pdf.text(descLines, 20, yPos);
                    pdf.text(qty, 120, yPos);
                    pdf.text(selectedCurrency === 'USD' ? '$' : 'KSh' + price, 140, yPos);
                    pdf.text(selectedCurrency === 'USD' ? '$' : 'KSh' + total, 170, yPos);
                    
                    yPos += Math.max(descLines.length * 5, 10);
                    
                    if (yPos > 250) {
                        pdf.addPage();
                        yPos = 20;
                    }
                }
            });
            
            // Add totals
            pdf.setFont('helvetica', 'bold');
            pdf.text('Subtotal:', 140, yPos + 10);
            pdf.text(document.getElementById('subtotal').textContent, 170, yPos + 10);
            
            pdf.text('Discount:', 140, yPos + 17);
            pdf.text(document.getElementById('discountDisplay').textContent, 170, yPos + 17);
            
            pdf.text('Tax:', 140, yPos + 24);
            pdf.text(document.getElementById('taxAmount').textContent, 170, yPos + 24);
            
            pdf.text('Total:', 140, yPos + 31);
            pdf.text(document.getElementById('totalAmount').textContent, 170, yPos + 31);
            
            // Add footer
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'italic');
            pdf.text('Generated by STARKS GALAXY LIMITED Document Generator', 105, 280, { align: 'center' });
            
            pdf.save(`${serialNumber}-${docType}-text.pdf`);
            
            showAlert('historyAlert', 'Generated text-based PDF successfully.', 'success');
        }

        // Helper function to optimize content for PDF
        function optimizeForPDF() {
            const previewElement = document.getElementById('documentPreview');
            if (!previewElement) return;
            
            // Store original styles
            const originalStyles = {
                width: previewElement.style.width,
                maxWidth: previewElement.style.maxWidth,
                padding: previewElement.style.padding,
                margin: previewElement.style.margin,
                boxShadow: previewElement.style.boxShadow,
                border: previewElement.style.border,
                borderRadius: previewElement.style.borderRadius
            };
            
            // Apply PDF-optimized styles
            previewElement.style.width = '800px';
            previewElement.style.maxWidth = '800px';
            previewElement.style.padding = '20px';
            previewElement.style.margin = '0 auto';
            previewElement.style.boxShadow = 'none';
            previewElement.style.border = '1px solid #ddd';
            previewElement.style.borderRadius = '0';
            
            // Optimize tables
            const tables = previewElement.querySelectorAll('table');
            tables.forEach(table => {
                table.style.width = '100%';
                table.style.tableLayout = 'fixed';
                
                // Ensure columns have proper widths
                const headers = table.querySelectorAll('th');
                if (headers.length >= 4) {
                    headers[0].style.width = '40%';
                    headers[1].style.width = '15%';
                    headers[2].style.width = '20%';
                    headers[3].style.width = '25%';
                }
                
                const cells = table.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.wordWrap = 'break-word';
                    cell.style.overflowWrap = 'break-word';
                    cell.style.padding = '8px 10px';
                });
            });
            
            // Optimize text sizes
            previewElement.querySelectorAll('h1, h2, h3, h4').forEach(heading => {
                const originalSize = heading.style.fontSize;
                heading.dataset.originalSize = originalSize;
                
                if (heading.tagName === 'H1') heading.style.fontSize = '24px';
                else if (heading.tagName === 'H2') heading.style.fontSize = '20px';
                else if (heading.tagName === 'H3') heading.style.fontSize = '16px';
                else if (heading.tagName === 'H4') heading.style.fontSize = '14px';
            });
            
            // Return function to restore styles
            return function restoreStyles() {
                previewElement.style.width = originalStyles.width;
                previewElement.style.maxWidth = originalStyles.maxWidth;
                previewElement.style.padding = originalStyles.padding;
                previewElement.style.margin = originalStyles.margin;
                previewElement.style.boxShadow = originalStyles.boxShadow;
                previewElement.style.border = originalStyles.border;
                previewElement.style.borderRadius = originalStyles.borderRadius;
                
                // Restore table styles
                tables.forEach(table => {
                    table.style.width = '';
                    table.style.tableLayout = '';
                });
                
                // Restore text sizes
                previewElement.querySelectorAll('h1, h2, h3, h4').forEach(heading => {
                    if (heading.dataset.originalSize) {
                        heading.style.fontSize = heading.dataset.originalSize;
                        delete heading.dataset.originalSize;
                    } else {
                        heading.style.fontSize = '';
                    }
                });
            };
        }

        // Updated downloadDocumentPDF function with optimization
        async function downloadDocumentPDF(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) {
                // If not in history, load it first
                viewDocument(documentId);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Optimize content for PDF
            const restoreStyles = optimizeForPDF();
            
            try {
                await generatePDF();
            } finally {
                // Always restore styles even if PDF generation fails
                if (restoreStyles) {
                    setTimeout(restoreStyles, 100);
                }
            }
        }

        // ... [Rest of JavaScript functions remain the same] ...
    </script>
</body>
</html>
