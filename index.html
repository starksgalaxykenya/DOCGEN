<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARKS GALAXY LIMITED</title>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        
        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDyre2oxURYXHZOLIHUeG2itz56i5ehAYo",
          authDomain: "company-doc-generator.firebaseapp.com",
          projectId: "company-doc-generator",
          storageBucket: "company-doc-generator.firebasestorage.app",
          messagingSenderId: "891677147775",
          appId: "1:891677147775:web:a1ffebf23572f5ca18f54a",
          measurementId: "G-1MMCF9W7HF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = {
            auth, db,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
            collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where
        };
        
        console.log("Firebase initialized successfully");
    </script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Global Styles */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #ff9e00;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Auth Screen Styles */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }

        .auth-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .auth-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .auth-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .auth-tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .auth-tab:hover {
            color: var(--primary-color);
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .auth-form {
            padding: 40px 30px;
        }

        .auth-form-group {
            margin-bottom: 25px;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .auth-form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .auth-form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }

        .auth-footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9rem;
            color: #666;
        }

        /* Main App Styles - Hidden by default */
        .main-app {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-left h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
            padding: 18px 25px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: var(--secondary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            font-size: 1.8rem;
        }

        h3 {
            color: var(--primary-color);
            margin: 25px 0 15px 0;
            font-size: 1.4rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .required::after {
            content: '*';
            color: var(--danger-color);
        }

        .form-control {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: var(--gray-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px #ddd;
        }

        .items-table th {
            background-color: #f1f5fd;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .items-table td {
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .items-table tfoot td {
            font-weight: 600;
            background-color: #f9fafc;
        }

        .input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-row .form-control {
            flex: 1;
        }

        /* Receipt Specific Styles */
        .receipt-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: #f9fafc;
            border-radius: 8px;
            border-left: 4px solid var(--success-color);
        }

        /* Discount Section */
        .discount-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9fafc;
            border-radius: 8px;
            border-left: 4px solid var(--success-color);
        }

        .discount-section h4 {
            color: var(--success-color);
            margin-bottom: 15px;
        }

        .discount-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        /* Terms and Conditions */
        .terms-section {
            margin: 25px 0;
            padding: 20px;
            background: #fff9e6;
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
        }

        .terms-section h4 {
            color: var(--warning-color);
            margin-bottom: 10px;
        }

        .terms-content {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #666;
        }

        .terms-checkbox-list {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }

        .term-checkbox-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            transition: var(--transition);
        }

        .term-checkbox-item:hover {
            background-color: #f9f9f9;
        }

        .term-checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 3px;
        }

        .term-checkbox-content {
            flex: 1;
        }

        .term-checkbox-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .term-checkbox-text {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
            max-height: 60px;
            overflow-y: auto;
        }

        /* Multiple Payment Accounts */
        .multiple-payment-accounts {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .payment-account-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            margin-bottom: 15px;
        }

        .payment-account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .payment-account-header h5 {
            margin: 0;
            color: var(--primary-color);
        }

        .payment-methods-checkbox-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .payment-method-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }

        .payment-method-checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }

        /* Document Preview */
        .document-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 1px solid #eaeaea;
            position: relative;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .company-details {
            text-align: right;
        }

        .company-tax {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: 5px;
        }

        .parent-company {
            font-size: 0.9rem;
            color: var(--gray-color);
            font-style: italic;
            margin-top: 3px;
        }

        .document-title {
            text-align: center;
            font-size: 2.5rem;
            margin: 40px 0;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .document-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .document-info-column h3 {
            color: var(--secondary-color);
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
            margin: 40px 0;
        }

        .document-table th {
            background-color: #f1f5fd;
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .document-table td {
            padding: 15px;
            border: 1px solid #ddd;
        }

        .document-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .terms-preview {
            margin-top: 30px;
            padding: 20px;
            background: #fff9e6;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #666;
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px #ddd;
        }

        .history-table th {
            background-color: #f1f5fd;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .history-table td {
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background-color: rgba(76, 201, 240, 0.2);
            color: #0a8ea8;
        }

        .status-revoked {
            background-color: rgba(247, 37, 133, 0.2);
            color: #c2185b;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Company Cards */
        .company-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .company-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid #eaeaea;
            transition: var(--transition);
        }

        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .company-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .company-card-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-right: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            padding: 5px;
        }

        /* Color Preview */
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            display: inline-block;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        /* Currency Selection */
        .currency-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .currency-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .currency-btn:hover {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .currency-btn.active {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        /* Terms Management */
        .terms-management {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafc;
            border-radius: 8px;
        }

        .terms-list {
            display: grid;
            gap: 15px;
            margin: 15px 0;
        }

        .term-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eaeaea;
        }

        .term-item h5 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .term-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid transparent;
        }

        .alert-success {
            background-color: rgba(76, 201, 240, 0.1);
            border-left-color: var(--success-color);
            color: #0a8ea8;
        }

        .alert-danger {
            background-color: rgba(247, 37, 133, 0.1);
            border-left-color: var(--danger-color);
            color: #c2185b;
        }

        .alert-info {
            background-color: rgba(67, 97, 238, 0.1);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        /* Signature Image */
        .signature-image {
            max-width: 200px;
            height: auto;
            margin-top: 10px;
        }

        /* Signature Overlay */
        .signature-overlay-container {
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 100px;
        }

        .signature-overlay-text {
            color: var(--gray-color);
            font-size: 0.9rem;
            text-align: center;
        }

        .signature-overlay-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Client List */
        .client-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .client-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #eaeaea;
            cursor: pointer;
            transition: var(--transition);
        }

        .client-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .client-card h4 {
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .client-card p {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 3px;
        }

        /* Receipt Preview Specific */
        .receipt-preview {
            display: grid;
            gap: 20px;
        }

        .receipt-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .receipt-info-box {
            background: #f9fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        /* Payment Tracking Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
        }

        .payment-history-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .payment-history-table th,
        .payment-history-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .payment-history-table th {
            background-color: #f1f5fd;
            font-weight: 600;
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
        }

        @media (max-width: 992px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .document-info {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .company-details {
                text-align: left;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .discount-inputs {
                grid-template-columns: 1fr;
            }
            
            .receipt-info-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                padding: 15px;
                min-width: auto;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .document-preview {
                padding: 15px;
            }
            
            .document-title {
                font-size: 1.8rem;
                margin: 20px 0;
            }
            
            .company-list {
                grid-template-columns: 1fr;
            }
            
            .signature-image {
                max-width: 150px;
            }
            
            .signature-overlay-container {
                width: 150px;
                height: 80px;
            }
            
            .currency-selection {
                flex-direction: column;
            }
            
            .currency-btn {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .auth-header h1 {
                font-size: 2rem;
            }
            
            .header-left h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            h3 {
                font-size: 1.2rem;
            }
            
            .document-title {
                font-size: 1.5rem;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .input-row {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: auto;
            }
        }

        @media (max-width: 480px) {
            .auth-container {
                margin: 10px;
            }
            
            .auth-form {
                padding: 20px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .document-preview {
                padding: 10px;
            }
            
            .document-table th,
            .document-table td {
                padding: 8px;
                font-size: 0.9rem;
            }
            
            .items-table th,
            .items-table td {
                padding: 10px;
                font-size: 0.9rem;
            }
        }

        /* Revoked Stamp */
        .revoked-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px;
            color: var(--danger-color);
            font-weight: bold;
            opacity: 0.3;
            pointer-events: none;
            border: 8px solid var(--danger-color);
            padding: 40px;
            border-radius: 15px;
            text-transform: uppercase;
            letter-spacing: 5px;
            display: none;
        }
        
        /* Print Styles */
@media print {
    .main-app {
        display: block !important;
    }
    
    .auth-screen,
    .nav-tabs,
    .btn,
    .tab-content:not(.active) {
        display: none !important;
    }
    
    .tab-content.active {
        display: block !important;
        box-shadow: none;
        padding: 0;
        margin: 0;
    }
    
    .document-preview {
        box-shadow: none;
        border: none;
        padding: 0;
    }
    
    .no-print {
        display: none !important;
    }
}

/* PDF Generation Fix - Optimized for Single Page */
@media all {
    .document-preview {
        width: 210mm !important; /* Standard A4 width */
        height: auto !/* PDF Generation Fix - Optimized for Single Page */
/* These styles only apply when .pdf-mode class is added */

.document-preview.pdf-mode {
    width: 210mm !important; /* Standard A4 width */
    height: auto !important;
    margin: 0 auto !important;
    box-sizing: border-box !important;
    padding: 15mm !important;
    font-size: 14px !important; /* Base font size */
    line-height: 1.4 !important;
    background: white !important;
}

/* Ensure everything fits within the A4 width */
.document-preview.pdf-mode > * {
    max-width: 100% !important;
    box-sizing: border-box !important;
}

/* Header optimizations */
.document-preview.pdf-mode .document-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    margin-bottom: 15px !important;
    padding-bottom: 10px !important;
    border-bottom: 2px solid #eee !important;
}

.document-preview.pdf-mode .company-details {
    text-align: right !important;
    font-size: 12px !important;
}

/* Document title */
.document-preview.pdf-mode .document-title {
    font-size: 28px !important;
    margin: 25px 0 !important;
    text-align: center !important;
    color: var(--secondary-color) !important;
}

/* Document info section */
.document-preview.pdf-mode .document-info,
.document-preview.pdf-mode .receipt-info-grid {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 20px !important;
    margin-bottom: 25px !important;
    font-size: 13px !important;
}

/* Tables */
.document-preview.pdf-mode .document-table,
.document-preview.pdf-mode #receiptItemsTable,
.document-preview.pdf-mode #standardItemsTable {
    width: 100% !important;
    table-layout: fixed !important;
    font-size: 12px !important;
    margin: 20px 0 !important;
    border-collapse: collapse !important;
}

.document-preview.pdf-mode .document-table th,
.document-preview.pdf-mode .document-table td {
    padding: 10px 8px !important;
    border: 1px solid #ddd !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
}

/* Optimize column widths */
.document-preview.pdf-mode .document-table th:nth-child(1),
.document-preview.pdf-mode .document-table td:nth-child(1) {
    width: 45% !important;
}

.document-preview.pdf-mode .document-table th:nth-child(2),
.document-preview.pdf-mode .document-table td:nth-child(2) {
    width: 15% !important;
    text-align: center !important;
}

.document-preview.pdf-mode .document-table th:nth-child(3),
.document-preview.pdf-mode .document-table td:nth-child(3) {
    width: 20% !important;
    text-align: right !important;
}

.document-preview.pdf-mode .document-table th:nth-child(4),
.document-preview.pdf-mode .document-table td:nth-child(4) {
    width: 20% !important;
    text-align: right !important;
}

/* Payment accounts */
.document-preview.pdf-mode .multiple-payment-accounts {
    margin: 20px 0 !important;
    padding: 15px !important;
    font-size: 12px !important;
}

.document-preview.pdf-mode .receipt-info-box {
    padding: 12px !important;
    font-size: 12px !important;
}

/* Terms section */
.document-preview.pdf-mode .terms-preview {
    margin-top: 20px !important;
    padding: 15px !important;
    font-size: 11px !important;
    line-height: 1.4 !important;
    background: #fff9e6 !important;
    border-radius: 5px !important;
}

/* Footer */
.document-preview.pdf-mode .document-footer {
    margin-top: 25px !important;
    padding-top: 15px !important;
    border-top: 2px solid #eee !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    font-size: 12px !important;
}

.document-preview.pdf-mode .signature-overlay-container {
    width: 120px !important;
    height: 50px !important;
}

/* Headings */
.document-preview.pdf-mode h2,
.document-preview.pdf-mode h3,
.document-preview.pdf-mode h4 {
    margin: 15px 0 10px 0 !important;
}

.document-preview.pdf-mode h2 { 
    font-size: 20px !important;
    color: var(--secondary-color) !important;
}

.document-preview.pdf-mode h3 { 
    font-size: 16px !important;
    color: var(--primary-color) !important;
}

.document-preview.pdf-mode h4 { 
    font-size: 14px !important;
    color: #333 !important;
}

/* Compact spacing */
.document-preview.pdf-mode .mt-20 { margin-top: 10px !important; }
.document-preview.pdf-mode .mt-30 { margin-top: 15px !important; }
.document-preview.pdf-mode .mb-20 { margin-bottom: 10px !important; }

/* Hide UI elements during PDF generation */
.document-preview.pdf-mode .no-print,
.document-preview.pdf-mode .btn,
.document-preview.pdf-mode .action-buttons,
.document-preview.pdf-mode .currency-selection,
.document-preview.pdf-mode .auth-tabs,
.document-preview.pdf-mode .nav-tabs {
    display: none !important;
    }
}
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-header">
                <h1>STARKS GALAXY LIMITED</h1>
                <p>Company Document Generator Engine</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>
            
            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <div class="alert" id="loginAlert"></div>
                <div class="auth-form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="auth-form-control" placeholder="Enter your email">
                </div>
                <div class="auth-form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="auth-form-control" placeholder="Enter your password">
                </div>
                <button class="auth-btn" onclick="login()" id="loginBtn">
                    <span id="loginText">Login</span>
                    <span id="loginSpinner" class="loading hidden"></span>
                </button>
            </div>
            
            <!-- Register Form -->
            <div class="auth-form hidden" id="registerForm">
                <div class="alert" id="registerAlert"></div>
                <div class="auth-form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" class="auth-form-control" placeholder="Enter your email">
                </div>
                <div class="auth-form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="auth-form-control" placeholder="Create a password (min. 6 characters)">
                </div>
                <div class="auth-form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" class="auth-form-control" placeholder="Confirm your password">
                </div>
                <button class="auth-btn" onclick="register()" id="registerBtn">
                    <span id="registerText">Create Account</span>
                    <span id="registerSpinner" class="loading hidden"></span>
                </button>
            </div>
            
            <div class="auth-footer">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>

    <!-- Payment Tracking Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="paymentModalTitle">Record Payment</h3>
                <button class="modal-close" onclick="closePaymentModal()">×</button>
            </div>
            <div class="alert" id="paymentModalAlert"></div>
            
            <div id="paymentFormContainer">
                <!-- Payment form will be loaded here -->
            </div>
            
            <div id="paymentHistoryContainer" class="mt-30">
                <h4>Payment History</h4>
                <div id="paymentHistoryContent">
                    <!-- Payment history will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <header>
                <div class="header-left">
                    <h1>STARKS GALAXY LIMITED</h1>
                    <p>Receipts, Invoices, Quotes, and Proforma Invoices Generator</p>
                </div>
                <div class="user-info">
                    <div class="user-email" id="userEmail"></div>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </header>

            <nav class="nav-tabs" id="navTabs">
                <div class="nav-tab active" data-tab="create">Create Document</div>
                <div class="nav-tab" data-tab="history">Document History</div>
                <div class="nav-tab" data-tab="admin">Admin Dashboard</div>
                <div class="nav-tab" data-tab="preview">Live Preview</div>
                <div class="nav-tab" data-tab="clients">Client Database</div>
                <div class="nav-tab" data-tab="terms">Terms Management</div>
            </nav>

            <!-- Create Document Tab -->
            <div class="tab-content active" id="create">
                <h2>Create New Document</h2>
                <div class="alert" id="createAlert"></div>
                
                <!-- Currency Selection -->
                <div class="currency-selection">
                    <button class="currency-btn active" id="usdCurrency" onclick="selectCurrency('USD')">US Dollars (USD)</button>
                    <button class="currency-btn" id="kshCurrency" onclick="selectCurrency('KSH')">Kenya Shillings (KSH)</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="documentType" class="required">Document Type</label>
                        <select id="documentType" class="form-control" onchange="updateFormLayout()">
                            <option value="invoice">Invoice</option>
                            <option value="quote">Quote</option>
                            <option value="receipt">Receipt</option>
                            <option value="proforma">Proforma Invoice</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="companySelect" class="required">Company</label>
                        <select id="companySelect" class="form-control">
                            <option value="">Select a company</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="serialNumber">Serial Number</label>
                        <input type="text" id="serialNumber" class="form-control" placeholder="Auto-generated" readonly>
                    </div>
                </div>

                <!-- Customer Details -->
                <h3>Customer Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customerName" class="required">Customer Name</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="customerName" class="form-control" placeholder="John Doe" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="showClientList()" style="white-space: nowrap;">Select from Clients</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Customer Email</label>
                        <input type="email" id="customerEmail" class="form-control" placeholder="john@example.com">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Customer Phone</label>
                        <input type="tel" id="customerPhone" class="form-control" placeholder="+1234567890">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Customer Address</label>
                        <textarea id="customerAddress" class="form-control" rows="2" placeholder="123 Main St, City, Country"></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="saveCurrentClient()">Save Client Info</button>
                    <button class="btn btn-secondary" onclick="clearClientForm()">Clear Client Info</button>
                </div>

                <!-- Receipt Specific Fields -->
                <div id="receiptFields" class="hidden">
                    <h3>Receipt Details</h3>
                    <div class="receipt-fields">
                        <div class="form-group">
                            <label for="receiptReason" class="required">Reason for Receipt</label>
                            <input type="text" id="receiptReason" class="form-control" placeholder="Payment for services rendered">
                        </div>
                        <div class="form-group">
                            <label for="receiptDate" class="required">Date of Receipt</label>
                            <input type="date" id="receiptDate" class="form-control" value="">
                        </div>
                    </div>
                </div>

                <!-- Items & Services Section - Now visible for receipts too -->
                <div id="itemsSection">
                    <h3>Items & Services</h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th width="120">Quantity</th>
                                <th width="150">Unit Price (<span id="currencySymbol">$</span>)</th>
                                <th width="150">Total (<span id="currencySymbol2">$</span>)</th>
                                <th width="50">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                                <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                                <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01"></td>
                                <td class="item-total"><span id="currencySymbol3">$</span>0.00</td>
                                <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">✕</button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Subtotal:</strong></td>
                                <td id="subtotal"><span id="currencySymbol4">$</span>0.00</td>
                                <td></td>
                            </tr>
                            <tr id="discountRow">
                                <td colspan="3" style="text-align: right;">
                                    <strong id="discountLabel">Discount (<span id="discountCurrencySymbol">$</span>):</strong>
                                    <input type="number" id="discountAmount" class="form-control" style="width: 120px; display: inline-block; margin-left: 10px;" value="0" min="0" step="0.01">
                                </td>
                                <td id="discountDisplay">-<span id="currencySymbol6">$</span>0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right;">
                                    <strong>Tax Rate (%):</strong>
                                    <input type="number" id="taxRate" class="form-control" style="width: 80px; display: inline-block; margin-left: 10px;" value="10" min="0" max="50">
                                </td>
                                <td id="taxAmount"><span id="currencySymbol7">$</span>0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                                <td id="totalAmount"><span id="currencySymbol8">$</span>0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    <button class="btn btn-secondary mt-20" onclick="addItem()">+ Add Item</button>
                </div>

                <!-- Terms and Conditions Section -->
                <div class="terms-section">
                    <h4>Terms & Conditions</h4>
                    <div class="form-group">
                        <label class="required">Select Terms (Multiple selection allowed)</label>
                        <div class="terms-checkbox-list" id="termsCheckboxList">
                            <!-- Terms checkboxes will be populated here -->
                            <div class="text-center" style="padding: 20px; color: var(--gray-color);">
                                Loading terms...
                            </div>
                        </div>
                    </div>
                    <div class="terms-content" id="termsContent">
                        No terms selected
                    </div>
                </div>

                <!-- Multiple Payment Accounts Section -->
                <div class="multiple-payment-accounts mt-30">
                    <h4>Payment Accounts & Methods</h4>
                    <div class="form-group">
                        <label>Select Payment Methods (Multiple selection allowed)</label>
                        <div class="payment-methods-checkbox-list" id="paymentMethodsCheckboxList">
                            <!-- Payment method checkboxes will be populated here -->
                        </div>
                    </div>
                    
                    <div id="paymentAccountsContainer">
                        <!-- Multiple payment accounts will be added here -->
                        <div class="payment-account-item" id="paymentAccount1">
                            <div class="payment-account-header">
                                <h5>Payment Account #1</h5>
                                <button class="btn btn-danger btn-sm" onclick="removePaymentAccount('paymentAccount1')">Remove</button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Account Type</label>
                                    <select class="form-control account-type" onchange="updateAccountFields(this)">
                                        <option value="bank">Bank Account</option>
                                        <option value="mobile">Mobile Money</option>
                                        <option value="card">Card Payment</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Account Name</label>
                                    <input type="text" class="form-control account-name" placeholder="e.g., Equity Bank USD Account">
                                </div>
                                <div class="form-group bank-fields">
                                    <label>Bank Name</label>
                                    <input type="text" class="form-control bank-name" placeholder="e.g., Equity Bank">
                                </div>
                                <div class="form-group bank-fields">
                                    <label>Account Number</label>
                                    <input type="text" class="form-control account-number" placeholder="Account number">
                                </div>
                                <div class="form-group bank-fields">
                                    <label>Swift/BIC Code</label>
                                    <input type="text" class="form-control swift-code" placeholder="SWIFT/BIC code">
                                </div>
                                <div class="form-group mobile-fields" style="display: none;">
                                    <label>Mobile Network</label>
                                    <select class="form-control mobile-network">
                                        <option value="mpesa">M-Pesa</option>
                                        <option value="airtel">Airtel Money</option>
                                        <option value="tkash">T-Kash</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group mobile-fields" style="display: none;">
                                    <label>Phone Number</label>
                                    <input type="text" class="form-control phone-number" placeholder="Phone number">
                                </div>
                                <div class="form-group mobile-fields" style="display: none;">
                                    <label>Paybill/Till Number</label>
                                    <input type="text" class="form-control paybill-number" placeholder="Paybill/Till number">
                                </div>
                                <div class="form-group card-fields" style="display: none;">
                                    <label>Card Type</label>
                                    <select class="form-control card-type">
                                        <option value="visa">Visa</option>
                                        <option value="mastercard">MasterCard</option>
                                        <option value="amex">American Express</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group card-fields" style="display: none;">
                                    <label>Card Last 4 Digits</label>
                                    <input type="text" class="form-control card-last4" placeholder="Last 4 digits" maxlength="4">
                                </div>
                                <div class="form-group">
                                    <label>Processing Institution</label>
                                    <input type="text" class="form-control processing-institution" placeholder="Institution name">
                                </div>
                                <div class="form-group">
                                    <label>Additional Notes</label>
                                    <textarea class="form-control account-notes" rows="2" placeholder="Additional account information"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-20" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="addPaymentAccount()">+ Add Another Payment Account</button>
                        <button class="btn btn-primary" onclick="updatePaymentAccountsPreview()">Update Payment Preview</button>
                    </div>
                </div>

                <div class="mt-30" style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateDocument()" id="generateBtn">
                        <span id="generateText">Generate Document</span>
                        <span id="generateSpinner" class="loading hidden"></span>
                    </button>
                    <button class="btn btn-success" onclick="previewDocument()">Preview Document</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                </div>
            </div>

            <!-- Document History Tab -->
            <div class="tab-content" id="history">
                <h2>Document History</h2>
                <div class="alert" id="historyAlert"></div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="historyFilter" class="form-control" style="width: auto;">
                        <option value="all">All Documents</option>
                        <option value="invoice">Invoices</option>
                        <option value="quote">Quotes</option>
                        <option value="receipt">Receipts</option>
                        <option value="proforma">Proforma Invoices</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadDocumentHistory()">Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Serial No.</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="7" class="text-center" style="padding: 40px;">
                                    Loading document history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Dashboard Tab -->
            <div class="tab-content" id="admin">
                <h2>Admin Dashboard</h2>
                <div class="alert" id="adminAlert"></div>
                
                <h3>Manage Companies</h3>
                <div class="company-list" id="companyList">
                    <div class="text-center" style="padding: 40px; color: var(--gray-color);">
                        Loading companies...
                    </div>
                </div>
                
                <h3 class="mt-30">Add/Edit Company</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="companyName" class="required">Company Name</label>
                        <input type="text" id="companyName" class="form-control" placeholder="Acme Inc.">
                    </div>
                    <div class="form-group">
                        <label for="parentCompany">Parent Company (Optional)</label>
                        <input type="text" id="parentCompany" class="form-control" placeholder="Parent Company Name">
                    </div>
                    <div class="form-group">
                        <label for="companyEmail" class="required">Company Email</label>
                        <input type="email" id="companyEmail" class="form-control" placeholder="contact@acme.com">
                    </div>
                    <div class="form-group">
                        <label for="companyTaxPin">Company TAX PIN (Optional)</label>
                        <input type="text" id="companyTaxPin" class="form-control" placeholder="Tax Identification Number">
                    </div>
                    <div class="form-group">
                        <label for="companyPhone">Company Phone</label>
                        <input type="tel" id="companyPhone" class="form-control" placeholder="+1234567890">
                    </div>
                    <div class="form-group">
                        <label for="companyWebsite">Company Website</label>
                        <input type="url" id="companyWebsite" class="form-control" placeholder="https://acme.com">
                    </div>
                    <div class="form-group">
                        <label for="companyAddress">Company Address</label>
                        <textarea id="companyAddress" class="form-control" rows="2" placeholder="123 Business Ave, City, Country"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="primaryColor">Primary Color</label>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <div class="color-preview" id="colorPreview" style="background-color: #4361ee;"></div>
                            <input type="color" id="primaryColor" class="form-control" value="#4361ee" style="padding: 0; width: 60px;">
                            <input type="text" id="primaryColorText" class="form-control" value="#4361ee" style="flex: 1;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="secondaryColor">Secondary Color</label>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <div class="color-preview" id="secondaryColorPreview" style="background-color: #3a0ca3;"></div>
                            <input type="color" id="secondaryColor" class="form-control" value="#3a0ca3" style="padding: 0; width: 60px;">
                            <input type="text" id="secondaryColorText" class="form-control" value="#3a0ca3" style="flex: 1;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-20">
                    <label>Payment Methods</label>
                    <div class="payment-methods-checkbox-list" id="paymentMethodsContainer">
                        <!-- Payment methods will be populated here -->
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="newPaymentMethod" class="form-control" placeholder="Add custom payment method" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="addPaymentMethod()">Add</button>
                        <button class="btn btn-success" onclick="savePaymentMethods()">Save Payment Methods</button>
                    </div>
                </div>
                
                <div class="mt-30" style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveCompany()" id="saveCompanyBtn">
                        <span id="saveCompanyText">Save Company</span>
                        <span id="saveCompanySpinner" class="loading hidden"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearCompanyForm()">Clear Form</button>
                    <button class="btn btn-danger" onclick="deleteCompany()" id="deleteCompanyBtn" style="display: none;">Delete Company</button>
                </div>
            </div>

           <!-- Preview Tab -->
<div class="tab-content" id="preview">
    <h2>Document Preview</h2>
    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;" class="no-print">
        <button class="btn btn-primary" onclick="generatePDF()">Download as PDF</button>
        <button class="btn btn-secondary" onclick="refreshPreview()">Refresh Preview</button>
    </div>
                <div class="document-preview" id="documentPreview">
                    <div class="revoked-stamp" id="revokedStamp">REVOKED</div>
                    
                    <div class="document-header">
                        <div>
                            <h2 id="previewCompanyName">Company Name</h2>
                            <div id="previewParentCompany" class="parent-company"></div>
                            <div id="previewCompanyTax" class="company-tax"></div>
                        </div>
                        <div class="company-details">
                            <p id="previewCompanyContact">Contact information</p>
                            <p id="previewCompanyWebsite">Website</p>
                        </div>
                    </div>
                    
                    <div class="document-title" id="previewDocumentTitle">INVOICE</div>
                    
                    <!-- Receipt Preview Layout -->
                    <div id="receiptPreview" class="hidden">
                        <div class="receipt-info-grid">
                            <div class="receipt-info-box">
                                <h4>Customer Details</h4>
                                <p id="previewCustomerDetails">Customer details will appear here</p>
                            </div>
                            <div class="receipt-info-box">
                                <h4>Receipt Details</h4>
                                <p><strong>Serial No:</strong> <span id="previewReceiptSerial">REC-YYYYMM-001</span></p>
                                <p><strong>Date:</strong> <span id="previewReceiptDate">January 1, 2023</span></p>
                                <p><strong>Reason:</strong> <span id="previewReceiptReason">Payment for services</span></p>
                                <p><strong>Currency:</strong> <span id="previewReceiptCurrency">USD</span></p>
                            </div>
                        </div>
                        
                        <!-- Items table for receipts -->
                        <table class="document-table mt-30" id="receiptItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="receiptPreviewItems">
                                <tr>
                                    <td colspan="4" class="text-center">No items added</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Subtotal:</strong></td>
                                    <td id="receiptPreviewSubtotal"><span id="receiptPreviewCurrencySymbol1">$</span>0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Discount:</strong></td>
                                    <td id="receiptPreviewDiscount">-<span id="receiptPreviewCurrencySymbol2">$</span>0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Tax:</strong></td>
                                    <td id="receiptPreviewTax"><span id="receiptPreviewCurrencySymbol3">$</span>0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Total Paid:</strong></td>
                                    <td id="receiptPreviewTotal"><span id="receiptPreviewCurrencySymbol4">$</span>0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="receipt-info-grid mt-20">
                            <div class="receipt-info-box">
                                <h4>Payment Information</h4>
                                <div id="receiptPaymentInfo">
                                    <p>No payment information available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Standard Document Preview Layout -->
                    <div id="standardPreview">
                        <div class="document-info">
                            <div class="document-info-column">
                                <h3>Bill To:</h3>
                                <p id="previewCustomerDetailsStandard">Customer details will appear here</p>
                            </div>
                            <div class="document-info-column" style="text-align: right;">
                                <h3>Document Details:</h3>
                                <p><strong>Serial No:</strong> <span id="previewSerialNumber">INV-2023-001</span></p>
                                <p><strong>Date:</strong> <span id="previewDate">January 1, 2023</span></p>
                                <p><strong>Document Type:</strong> <span id="previewDocType">Invoice</span></p>
                                <p><strong>Currency:</strong> <span id="previewCurrency">USD</span></p>
                            </div>
                        </div>
                        
                        <table class="document-table" id="standardItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="previewItems">
                                <tr>
                                    <td colspan="4" class="text-center">No items added</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Subtotal:</strong></td>
                                    <td id="previewSubtotal"><span id="previewCurrencySymbol1">$</span>0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Discount:</strong></td>
                                    <td id="previewDiscount">-<span id="previewCurrencySymbol2">$</span>0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Tax:</strong></td>
                                    <td id="previewTax"><span id="previewCurrencySymbol3">$</span>0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                                    <td id="previewTotal"><span id="previewCurrencySymbol4">$</span>0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="multiple-payment-accounts">
                        <h4>Payment Accounts & Methods</h4>
                        <div id="previewPaymentMethodsList">
                            <!-- Selected payment methods will appear here -->
                            <p>No payment methods selected</p>
                        </div>
                        <div id="previewPaymentAccounts">
                            <!-- Payment accounts will be populated here -->
                            <p>No payment accounts added</p>
                        </div>
                    </div>
                    
                    <div class="terms-preview" id="previewTerms">
                        <!-- Selected terms will be populated here -->
                        <p>No terms selected</p>
                    </div>
                    
                    <div class="document-footer">
                        <div>
                            <h3>Thank You!</h3>
                            <p>We appreciate your business</p>
                        </div>
                        <div style="text-align: right; position: relative;">
                            <p><strong>Authorized Signature:</strong></p>
                            <div class="signature-overlay-container">
                                <img id="signatureOverlayImage" class="signature-overlay-image" src="https://raw.githubusercontent.com/starksgalaxykenya/DOCGEN/main/signature.png" alt="Signature" onerror="this.style.display='none'; document.getElementById('signatureOverlayText').style.display='block';">
                                <div class="signature-overlay-text" id="signatureOverlayText" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Database Tab -->
            <div class="tab-content" id="clients">
                <h2>Client Database</h2>
                <div class="alert" id="clientsAlert"></div>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="clientSearch" class="form-control" placeholder="Search clients..." style="flex: 1; max-width: 300px;">
                    <button class="btn btn-primary" onclick="loadClients()">Refresh</button>
                    <button class="btn btn-success" onclick="saveCurrentClient()">Save Current Client</button>
                </div>
                
                <div class="client-list" id="clientList">
                    <div class="text-center" style="padding: 40px; color: var(--gray-color);">
                        Loading clients...
                    </div>
                </div>
            </div>

            <!-- Terms Management Tab -->
            <div class="tab-content" id="terms">
                <h2>Terms & Conditions Management</h2>
                <div class="alert" id="termsAlert"></div>
                
                <div class="terms-management">
                    <h3>Manage Document Terms</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="termName" class="required">Term Name</label>
                            <input type="text" id="termName" class="form-control" placeholder="e.g., Standard Invoice Terms">
                        </div>
                        <div class="form-group">
                            <label for="termDocumentType">Document Type</label>
                            <select id="termDocumentType" class="form-control">
                                <option value="all">All Documents</option>
                                <option value="invoice">Invoice</option>
                                <option value="quote">Quote</option>
                                <option value="receipt">Receipt</option>
                                <option value="proforma">Proforma Invoice</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="termContent" class="required">Term Content</label>
                        <textarea id="termContent" class="form-control" rows="6" placeholder="Enter terms and conditions here..."></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveTerm()">Save Term</button>
                        <button class="btn btn-secondary" onclick="clearTermForm()">Clear Form</button>
                        <button class="btn btn-danger" id="deleteTermBtn" style="display: none;" onclick="deleteTerm()">Delete Term</button>
                    </div>
                </div>
                
                <div class="mt-30">
                    <h3>Available Terms</h3>
                    <div class="terms-list" id="termsList">
                        <div class="text-center" style="padding: 40px; color: var(--gray-color);">
                            Loading terms...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let db = null;
        let companies = [];
        let documents = [];
        let clients = [];
        let terms = [];
        let currentCompanyId = null;
        let selectedPaymentMethods = [];
        let paymentAccounts = []; // Array for multiple payment accounts
        let discountAmount = 0;
        let signatureLoaded = false;
        let selectedCurrency = 'USD';
        let currentTermId = null;
        let currentDocumentForPayment = null;
        let selectedTermIds = [];
        let accountCounter = 1;

        // Auth functions
         async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthAlert('loginAlert', 'Please enter both email and password', 'danger');
                return;
            }
            
            const btn = document.getElementById('loginBtn');
            const text = document.getElementById('loginText');
            const spinner = document.getElementById('loginSpinner');
            
            text.textContent = 'Logging in...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                await window.firebaseApp.signInWithEmailAndPassword(window.firebaseApp.auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                let message = 'Login failed. ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        message += 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        message += 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        message += 'Invalid email address.';
                        break;
                    default:
                        message += error.message;
                }
                showAuthAlert('loginAlert', message, 'danger');
                
                text.textContent = 'Login';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }
        
        // Store for monthly sequential numbers
        let monthlySequence = {};

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing...");
            
            // Wait for Firebase to be initialized
            if (!window.firebaseApp) {
                console.error("Firebase not initialized");
                showAuthAlert('loginAlert', 'Firebase initialization failed. Please refresh the page.', 'danger');
                return;
            }

            // Initialize Firebase components
            db = window.firebaseApp.db;
            
            // Set up auth state listener
            window.firebaseApp.onAuthStateChanged(window.firebaseApp.auth, (user) => {
                if (user) {
                    console.log("User signed in:", user.email);
                    currentUser = user;
                    showMainApp();
                    initializeMainApp();
                } else {
                    console.log("No user signed in");
                    showAuthScreen();
                }
            });

            // Set up event listeners for auth screen
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('registerConfirmPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
            
            // Set receipt date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('receiptDate').value = today;
            
            // Initialize payment accounts array
            paymentAccounts = [{
                id: 'paymentAccount1',
                accountType: 'bank',
                accountName: '',
                bankName: '',
                accountNumber: '',
                swiftCode: '',
                mobileNetwork: 'mpesa',
                phoneNumber: '',
                paybillNumber: '',
                cardType: 'visa',
                cardLast4: '',
                processingInstitution: '',
                notes: ''
            }];
        });

        // Auth functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        function showAuthAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

       

        async function register() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showAuthAlert('registerAlert', 'Please fill in all fields', 'danger');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthAlert('registerAlert', 'Passwords do not match', 'danger');
                return;
            }
            
            if (password.length < 6) {
                showAuthAlert('registerAlert', 'Password must be at least 6 characters', 'danger');
                return;
            }
            
            const btn = document.getElementById('registerBtn');
            const text = document.getElementById('registerText');
            const spinner = document.getElementById('registerSpinner');
            
            text.textContent = 'Creating account...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                await window.firebaseApp.createUserWithEmailAndPassword(window.firebaseApp.auth, email, password);
            } catch (error) {
                console.error("Registration error:", error);
                let message = 'Registration failed. ';
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        message += 'Email already in use.';
                        break;
                    case 'auth/invalid-email':
                        message += 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        message += 'Password is too weak.';
                        break;
                    default:
                        message += error.message;
                }
                showAuthAlert('registerAlert', message, 'danger');
                
                text.textContent = 'Create Account';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        async function logout() {
            try {
                await window.firebaseApp.signOut(window.firebaseApp.auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Clear forms
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirmPassword').value = '';
        }

        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        // Main App Functions
        function initializeMainApp() {
            console.log("Initializing main app...");
            
            // Set up color pickers
            document.getElementById('primaryColor')?.addEventListener('input', function() {
                document.getElementById('primaryColorText').value = this.value;
                document.getElementById('colorPreview').style.backgroundColor = this.value;
            });
            
            document.getElementById('primaryColorText')?.addEventListener('input', function() {
                const color = this.value;
                if (isValidColor(color)) {
                    document.getElementById('primaryColor').value = color;
                    document.getElementById('colorPreview').style.backgroundColor = color;
                }
            });
            
            document.getElementById('secondaryColor')?.addEventListener('input', function() {
                document.getElementById('secondaryColorText').value = this.value;
                document.getElementById('secondaryColorPreview').style.backgroundColor = this.value;
            });
            
            document.getElementById('secondaryColorText')?.addEventListener('input', function() {
                const color = this.value;
                if (isValidColor(color)) {
                    document.getElementById('secondaryColor').value = color;
                    document.getElementById('secondaryColorPreview').style.backgroundColor = color;
                }
            });
            
            // Set up tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Set up form event listeners
            document.getElementById('documentType')?.addEventListener('change', function() {
                updateSerialNumber();
                updateFormLayout();
                loadTermsForDocumentType(this.value);
            });
            
            document.getElementById('companySelect')?.addEventListener('change', onCompanySelect);
            
            // Set up item calculations
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-desc') || 
                    e.target.classList.contains('item-qty') || 
                    e.target.classList.contains('item-price') ||
                    e.target.id === 'taxRate' ||
                    e.target.id === 'discountAmount' ||
                    e.target.id === 'amountPaid' ||
                    e.target.id === 'balanceAmount') {
                    updateItemTotals();
                }
                
                // Update payment accounts data
                if (e.target.classList.contains('account-name') || 
                    e.target.classList.contains('bank-name') ||
                    e.target.classList.contains('account-number') ||
                    e.target.classList.contains('swift-code') ||
                    e.target.classList.contains('mobile-network') ||
                    e.target.classList.contains('phone-number') ||
                    e.target.classList.contains('paybill-number') ||
                    e.target.classList.contains('card-type') ||
                    e.target.classList.contains('card-last4') ||
                    e.target.classList.contains('processing-institution') ||
                    e.target.classList.contains('account-notes')) {
                    updatePaymentAccountsData();
                }

                // Client search
                if (e.target.id === 'clientSearch') {
                    filterClients(e.target.value);
                }
                
                // Terms checkbox change
                if (e.target.classList.contains('term-checkbox')) {
                    updateSelectedTerms();
                }
                
                // Payment method checkbox change
                if (e.target.classList.contains('payment-method-checkbox')) {
                    updateSelectedPaymentMethods();
                }
                
                // Account type change
                if (e.target.classList.contains('account-type')) {
                    updateAccountFields(e.target);
                }
            });
            
            // Initialize
            updateFormLayout();
            updateSerialNumber();
            loadDefaultPaymentMethods();
            checkSignatureFile();
            loadCompanies();
            loadDocumentHistory();
            loadClients();
            loadAllTerms();
            
            // Set current date
            const now = new Date();
            document.getElementById('previewDate').textContent = now.toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            
            // Set initial currency
            updateCurrencyDisplay();
            
            console.log("Main app initialized successfully");
        }

        // Check if signature.png exists
        async function checkSignatureFile() {
            const signatureImg = document.getElementById('signatureOverlayImage');
            const signatureText = document.getElementById('signatureOverlayText');
            
            const img = new Image();
            img.onload = function() {
                console.log("Signature file found at GitHub raw URL");
                signatureLoaded = true;
                signatureImg.style.display = 'block';
                signatureText.style.display = 'none';
            };
            img.onerror = function() {
                console.log("Signature file not found at GitHub raw URL");
                signatureLoaded = false;
                signatureImg.style.display = 'none';
                signatureText.style.display = 'block';
                signatureText.textContent = 'Signature not found';
            };
            img.src = 'https://raw.githubusercontent.com/starksgalaxykenya/DOCGEN/main/signature.png';
        }

        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function switchTab(tabId) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
        }

        function isValidColor(color) {
            const s = new Option().style;
            s.color = color;
            return s.color !== '';
        }

        // Update form layout based on document type
        function updateFormLayout() {
            const docType = document.getElementById('documentType').value;
            const receiptFields = document.getElementById('receiptFields');
            const itemsSection = document.getElementById('itemsSection');
            
            if (docType === 'receipt') {
                receiptFields.classList.remove('hidden');
                itemsSection.classList.remove('hidden'); // Show items for receipts
                
                // Set today's date if empty
                const today = new Date().toISOString().split('T')[0];
                if (!document.getElementById('receiptDate').value) {
                    document.getElementById('receiptDate').value = today;
                }
            } else {
                receiptFields.classList.add('hidden');
                itemsSection.classList.remove('hidden');
            }
            
            updateTermsAndConditions();
        }

        // Update terms and conditions based on selected checkboxes
        function updateSelectedTerms() {
            selectedTermIds = [];
            const checkboxes = document.querySelectorAll('.term-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                selectedTermIds.push(checkbox.value);
            });
            
            updateTermsAndConditions();
        }

        // Update terms and conditions display
        function updateTermsAndConditions() {
            const docType = document.getElementById('documentType').value;
            
            // Get selected terms
            let termsText = '';
            
            selectedTermIds.forEach(termId => {
                const term = terms.find(t => t.id === termId);
                if (term && (term.documentType === docType || term.documentType === 'all')) {
                    if (termsText) termsText += '\n\n';
                    termsText += term.content;
                }
            });
            
            if (!termsText) {
                termsText = 'No terms selected';
            }
            
            document.getElementById('termsContent').textContent = termsText;
            
            // Update preview
            const previewTerms = document.getElementById('previewTerms');
            const formattedTerms = termsText.split('\n').map(line => `<p>${line}</p>`).join('');
            previewTerms.innerHTML = formattedTerms;
        }

        // Update selected payment methods
        function updateSelectedPaymentMethods() {
            selectedPaymentMethods = [];
            const checkboxes = document.querySelectorAll('#paymentMethodsCheckboxList .payment-method-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                selectedPaymentMethods.push(checkbox.value);
            });
            
            updatePaymentAccountsPreview();
        }

        // Currency selection function
        function selectCurrency(currency) {
            selectedCurrency = currency;
            
            // Update button styles
            document.getElementById('usdCurrency').classList.remove('active');
            document.getElementById('kshCurrency').classList.remove('active');
            
            if (currency === 'USD') {
                document.getElementById('usdCurrency').classList.add('active');
            } else {
                document.getElementById('kshCurrency').classList.add('active');
            }
            
            // Update currency display
            updateCurrencyDisplay();
            updateItemTotals();
        }

        // Update currency display throughout the app
        function updateCurrencyDisplay() {
            const symbol = selectedCurrency === 'USD' ? '$' : 'KSh';
            
            // Update table headers and symbols
            document.querySelectorAll('#currencySymbol, #currencySymbol2, #currencySymbol3, #currencySymbol4, #currencySymbol5, #currencySymbol6, #currencySymbol7, #currencySymbol8').forEach(el => {
                if (el) el.textContent = symbol;
            });
            
            // Update discount label
            const discountLabel = document.getElementById('discountLabel');
            if (discountLabel) {
                discountLabel.innerHTML = `Discount (${symbol}):`;
            }
            
            const discountCurrencySymbol = document.getElementById('discountCurrencySymbol');
            if (discountCurrencySymbol) {
                discountCurrencySymbol.textContent = symbol;
            }
            
            // Update preview currency symbols
            document.querySelectorAll('#previewCurrencySymbol1, #previewCurrencySymbol2, #previewCurrencySymbol3, #previewCurrencySymbol4, #receiptPreviewCurrencySymbol1, #receiptPreviewCurrencySymbol2, #receiptPreviewCurrencySymbol3, #receiptPreviewCurrencySymbol4').forEach(el => {
                if (el) el.textContent = symbol;
            });
            
            // Update currency in preview
            const previewCurrency = document.getElementById('previewCurrency');
            if (previewCurrency) previewCurrency.textContent = selectedCurrency;
            
            const previewReceiptCurrency = document.getElementById('previewReceiptCurrency');
            if (previewReceiptCurrency) previewReceiptCurrency.textContent = selectedCurrency;
        }

        // Generate monthly sequential serial number
        async function getNextMonthlySequence(docType) {
            const now = new Date();
            const monthKey = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`;
            const sequenceKey = `${docType}_${monthKey}`;
            
            // Initialize if not exists
            if (!monthlySequence[sequenceKey]) {
                monthlySequence[sequenceKey] = 0;
            }
            
            // Load existing documents to find highest sequence
            try {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                const q = window.firebaseApp.query(
                    window.firebaseApp.collection(db, "documents"),
                    window.firebaseApp.where("type", "==", docType),
                    window.firebaseApp.where("createdAt", ">=", window.firebaseApp.Timestamp.fromDate(startOfMonth)),
                    window.firebaseApp.where("createdAt", "<=", window.firebaseApp.Timestamp.fromDate(endOfMonth)),
                    window.firebaseApp.orderBy("createdAt", "desc")
                );
                
                const querySnapshot = await window.firebaseApp.getDocs(q);
                let maxSequence = 0;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const serial = data.serialNumber || '';
                    const match = serial.match(/-(\d+)$/);
                    if (match) {
                        const sequence = parseInt(match[1]);
                        if (sequence > maxSequence) maxSequence = sequence;
                    }
                });
                
                monthlySequence[sequenceKey] = maxSequence;
            } catch (error) {
                console.error("Error loading sequence:", error);
            }
            
            // Increment and return
            monthlySequence[sequenceKey]++;
            return monthlySequence[sequenceKey];
        }

        // Serial Number Generation with monthly reset
        async function updateSerialNumber() {
            const docType = document.getElementById('documentType').value;
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            
            let prefix = 'DOC';
            switch(docType) {
                case 'invoice': prefix = 'INV'; break;
                case 'quote': prefix = 'QUO'; break;
                case 'receipt': prefix = 'REC'; break;
                case 'proforma': prefix = 'PRO'; break;
            }
            
            const sequence = await getNextMonthlySequence(docType);
            const serialNumber = `${prefix}-${year}${month}-${String(sequence).padStart(3, '0')}`;
            
            document.getElementById('serialNumber').value = serialNumber;
            document.getElementById('previewSerialNumber').textContent = serialNumber;
            document.getElementById('previewReceiptSerial').textContent = serialNumber;
        }

        // Item Management with Discount
        function addItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const symbol = selectedCurrency === 'USD' ? '$' : 'KSh';
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01"></td>
                <td class="item-total">${symbol}0.00</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">✕</button></td>
            `;
            tableBody.appendChild(newRow);
            updateItemTotals();
        }

        function removeItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateItemTotals();
        }

        function updateItemTotals() {
            const docType = document.getElementById('documentType').value;
            const symbol = selectedCurrency === 'USD' ? '$' : 'KSh';
            
            // Handle all document types with items table
            let subtotal = 0;
            const rows = document.querySelectorAll('#itemsTableBody tr');
            const previewItems = document.getElementById('previewItems');
            const receiptPreviewItems = document.getElementById('receiptPreviewItems');
            
            previewItems.innerHTML = '';
            if (receiptPreviewItems) receiptPreviewItems.innerHTML = '';
            
            rows.forEach(row => {
                const desc = row.querySelector('.item-desc').value || '';
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = qty * price;
                subtotal += total;
                
                row.querySelector('.item-total').textContent = symbol + total.toFixed(2);
                
                if (desc.trim()) {
                    // For standard preview
                    const previewRow = document.createElement('tr');
                    previewRow.innerHTML = `
                        <td>${desc}</td>
                        <td>${qty}</td>
                        <td>${symbol}${price.toFixed(2)}</td>
                        <td>${symbol}${total.toFixed(2)}</td>
                    `;
                    previewItems.appendChild(previewRow);
                    
                    // For receipt preview
                    if (receiptPreviewItems) {
                        const receiptPreviewRow = document.createElement('tr');
                        receiptPreviewRow.innerHTML = `
                            <td>${desc}</td>
                            <td>${qty}</td>
                            <td>${symbol}${price.toFixed(2)}</td>
                            <td>${symbol}${total.toFixed(2)}</td>
                        `;
                        receiptPreviewItems.appendChild(receiptPreviewRow);
                    }
                }
            });
            
            if (previewItems.children.length === 0) {
                previewItems.innerHTML = '<tr><td colspan="4" class="text-center">No items added</td></tr>';
            }
            if (receiptPreviewItems && receiptPreviewItems.children.length === 0) {
                receiptPreviewItems.innerHTML = '<tr><td colspan="4" class="text-center">No items added</td></tr>';
            }
            
            // Calculate discount
            discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
                document.getElementById('discountAmount').value = discountAmount.toFixed(2);
            }
            
            const discountedSubtotal = subtotal - discountAmount;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = discountedSubtotal * (taxRate / 100);
            const totalAmount = discountedSubtotal + taxAmount;
            
            // Update display
            document.getElementById('subtotal').innerHTML = symbol + subtotal.toFixed(2);
            document.getElementById('discountDisplay').innerHTML = '-' + symbol + discountAmount.toFixed(2);
            document.getElementById('taxAmount').innerHTML = symbol + taxAmount.toFixed(2);
            document.getElementById('totalAmount').innerHTML = symbol + totalAmount.toFixed(2);
            
            // Update standard preview
            document.getElementById('previewSubtotal').innerHTML = symbol + subtotal.toFixed(2);
            document.getElementById('previewDiscount').innerHTML = '-' + symbol + discountAmount.toFixed(2);
            document.getElementById('previewTax').innerHTML = symbol + taxAmount.toFixed(2);
            document.getElementById('previewTotal').innerHTML = symbol + totalAmount.toFixed(2);
            
            // Update receipt preview
            if (document.getElementById('receiptPreviewSubtotal')) {
                document.getElementById('receiptPreviewSubtotal').innerHTML = symbol + subtotal.toFixed(2);
                document.getElementById('receiptPreviewDiscount').innerHTML = '-' + symbol + discountAmount.toFixed(2);
                document.getElementById('receiptPreviewTax').innerHTML = symbol + taxAmount.toFixed(2);
                document.getElementById('receiptPreviewTotal').innerHTML = symbol + totalAmount.toFixed(2);
            }
        }

        // Payment Methods Management
        function loadDefaultPaymentMethods() {
            const defaultMethods = ['Credit Card', 'PayPal', 'Bank Transfer', 'Cash', 'M-Pesa', 'Airtel Money', 'T-Kash', 'Check'];
            const container = document.getElementById('paymentMethodsContainer');
            const checkboxList = document.getElementById('paymentMethodsCheckboxList');
            
            container.innerHTML = '';
            checkboxList.innerHTML = '';
            
            defaultMethods.forEach(method => {
                // For admin panel
                const item = document.createElement('div');
                item.className = 'payment-method-checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" class="payment-method-checkbox" value="${method}" ${method === 'Credit Card' || method === 'PayPal' ? 'checked' : ''}>
                    <span>${method}</span>
                `;
                container.appendChild(item);
                
                // For document creation
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'payment-method-checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" class="payment-method-checkbox" value="${method}">
                    <span>${method}</span>
                `;
                checkboxList.appendChild(checkboxItem);
            });
        }

        function addPaymentMethod() {
            const input = document.getElementById('newPaymentMethod');
            const method = input.value.trim();
            
            if (!method) {
                showAlert('adminAlert', 'Please enter a payment method name', 'danger');
                return;
            }
            
            const container = document.getElementById('paymentMethodsContainer');
            const checkboxList = document.getElementById('paymentMethodsCheckboxList');
            
            // For admin panel
            const item = document.createElement('div');
            item.className = 'payment-method-checkbox-item';
            item.innerHTML = `
                <input type="checkbox" class="payment-method-checkbox" value="${method}" checked>
                <span>${method}</span>
            `;
            container.appendChild(item);
            
            // For document creation
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'payment-method-checkbox-item';
            checkboxItem.innerHTML = `
                <input type="checkbox" class="payment-method-checkbox" value="${method}">
                <span>${method}</span>
            `;
            checkboxList.appendChild(checkboxItem);
            
            input.value = '';
        }

        async function savePaymentMethods() {
            const companyId = document.getElementById('companySelect').value;
            if (!companyId) {
                showAlert('adminAlert', 'Please select a company first', 'danger');
                return;
            }
            
            try {
                // Get payment methods
                const paymentMethods = [];
                document.querySelectorAll('#paymentMethodsContainer .payment-method-checkbox:checked').forEach(cb => {
                    paymentMethods.push(cb.value);
                });
                
                // Update company
                const companyRef = window.firebaseApp.doc(db, "companies", companyId);
                await window.firebaseApp.updateDoc(companyRef, {
                    paymentMethods: paymentMethods,
                    updatedAt: window.firebaseApp.Timestamp.now()
                });
                
                showAlert('adminAlert', 'Payment methods saved successfully!', 'success');
                
                // Reload companies
                await loadCompanies();
                
            } catch (error) {
                console.error("Error saving payment methods:", error);
                showAlert('adminAlert', 'Error saving payment methods: ' + error.message, 'danger');
            }
        }

        function updatePaymentMethodsSelection(company) {
            const checkboxList = document.getElementById('paymentMethodsCheckboxList');
            checkboxList.innerHTML = '';
            
            if (company && company.paymentMethods && Array.isArray(company.paymentMethods)) {
                company.paymentMethods.forEach(method => {
                    const item = document.createElement('div');
                    item.className = 'payment-method-checkbox-item';
                    item.innerHTML = `
                        <input type="checkbox" class="payment-method-checkbox" value="${method}">
                        <span>${method}</span>
                    `;
                    checkboxList.appendChild(item);
                });
            }
        }

        // Multiple Payment Accounts Management
        function updateAccountFields(selectElement) {
            const accountItem = selectElement.closest('.payment-account-item');
            const accountType = selectElement.value;
            
            // Hide all field groups
            accountItem.querySelectorAll('.bank-fields, .mobile-fields, .card-fields').forEach(field => {
                field.style.display = 'none';
            });
            
            // Show relevant fields based on account type
            if (accountType === 'bank') {
                accountItem.querySelectorAll('.bank-fields').forEach(field => {
                    field.style.display = 'block';
                });
            } else if (accountType === 'mobile') {
                accountItem.querySelectorAll('.mobile-fields').forEach(field => {
                    field.style.display = 'block';
                });
            } else if (accountType === 'card') {
                accountItem.querySelectorAll('.card-fields').forEach(field => {
                    field.style.display = 'block';
                });
            }
            
            updatePaymentAccountsData();
        }

        function addPaymentAccount() {
            accountCounter++;
            const newAccountId = `paymentAccount${accountCounter}`;
            const container = document.getElementById('paymentAccountsContainer');
            
            const newAccount = document.createElement('div');
            newAccount.className = 'payment-account-item';
            newAccount.id = newAccountId;
            newAccount.innerHTML = `
                <div class="payment-account-header">
                    <h5>Payment Account #${accountCounter}</h5>
                    <button class="btn btn-danger btn-sm" onclick="removePaymentAccount('${newAccountId}')">Remove</button>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Account Type</label>
                        <select class="form-control account-type" onchange="updateAccountFields(this)">
                            <option value="bank">Bank Account</option>
                            <option value="mobile">Mobile Money</option>
                            <option value="card">Card Payment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account Name</label>
                        <input type="text" class="form-control account-name" placeholder="e.g., Equity Bank USD Account">
                    </div>
                    <div class="form-group bank-fields">
                        <label>Bank Name</label>
                        <input type="text" class="form-control bank-name" placeholder="e.g., Equity Bank">
                    </div>
                    <div class="form-group bank-fields">
                        <label>Account Number</label>
                        <input type="text" class="form-control account-number" placeholder="Account number">
                    </div>
                    <div class="form-group bank-fields">
                        <label>Swift/BIC Code</label>
                        <input type="text" class="form-control swift-code" placeholder="SWIFT/BIC code">
                    </div>
                    <div class="form-group mobile-fields" style="display: none;">
                        <label>Mobile Network</label>
                        <select class="form-control mobile-network">
                            <option value="mpesa">M-Pesa</option>
                            <option value="airtel">Airtel Money</option>
                            <option value="tkash">T-Kash</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group mobile-fields" style="display: none;">
                        <label>Phone Number</label>
                        <input type="text" class="form-control phone-number" placeholder="Phone number">
                    </div>
                    <div class="form-group mobile-fields" style="display: none;">
                        <label>Paybill/Till Number</label>
                        <input type="text" class="form-control paybill-number" placeholder="Paybill/Till number">
                    </div>
                    <div class="form-group card-fields" style="display: none;">
                        <label>Card Type</label>
                        <select class="form-control card-type">
                            <option value="visa">Visa</option>
                            <option value="mastercard">MasterCard</option>
                            <option value="amex">American Express</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group card-fields" style="display: none;">
                        <label>Card Last 4 Digits</label>
                        <input type="text" class="form-control card-last4" placeholder="Last 4 digits" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label>Processing Institution</label>
                        <input type="text" class="form-control processing-institution" placeholder="Institution name">
                    </div>
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea class="form-control account-notes" rows="2" placeholder="Additional account information"></textarea>
                    </div>
                </div>
            `;
            
            container.appendChild(newAccount);
            
            // Add to paymentAccounts array
            paymentAccounts.push({
                id: newAccountId,
                accountType: 'bank',
                accountName: '',
                bankName: '',
                accountNumber: '',
                swiftCode: '',
                mobileNetwork: 'mpesa',
                phoneNumber: '',
                paybillNumber: '',
                cardType: 'visa',
                cardLast4: '',
                processingInstitution: '',
                notes: ''
            });
        }

        function removePaymentAccount(accountId) {
            if (paymentAccounts.length <= 1) {
                showAlert('createAlert', 'You must have at least one payment account', 'danger');
                return;
            }
            
            const accountElement = document.getElementById(accountId);
            if (accountElement) {
                accountElement.remove();
            }
            
            // Remove from paymentAccounts array
            const index = paymentAccounts.findIndex(acc => acc.id === accountId);
            if (index !== -1) {
                paymentAccounts.splice(index, 1);
            }
            
            updatePaymentAccountsPreview();
        }

        function updatePaymentAccountsData() {
            // Clear and rebuild paymentAccounts array
            paymentAccounts = [];
            
            document.querySelectorAll('.payment-account-item').forEach(accountItem => {
                const accountId = accountItem.id;
                const accountType = accountItem.querySelector('.account-type').value;
                
                const accountData = {
                    id: accountId,
                    accountType: accountType,
                    accountName: accountItem.querySelector('.account-name').value || '',
                    bankName: accountItem.querySelector('.bank-name')?.value || '',
                    accountNumber: accountItem.querySelector('.account-number')?.value || '',
                    swiftCode: accountItem.querySelector('.swift-code')?.value || '',
                    mobileNetwork: accountItem.querySelector('.mobile-network')?.value || 'mpesa',
                    phoneNumber: accountItem.querySelector('.phone-number')?.value || '',
                    paybillNumber: accountItem.querySelector('.paybill-number')?.value || '',
                    cardType: accountItem.querySelector('.card-type')?.value || 'visa',
                    cardLast4: accountItem.querySelector('.card-last4')?.value || '',
                    processingInstitution: accountItem.querySelector('.processing-institution').value || '',
                    notes: accountItem.querySelector('.account-notes').value || ''
                };
                
                paymentAccounts.push(accountData);
            });
        }

        function updatePaymentAccountsPreview() {
            updatePaymentAccountsData();
            
            const previewMethods = document.getElementById('previewPaymentMethodsList');
            const previewAccounts = document.getElementById('previewPaymentAccounts');
            
            // Update payment methods preview
            if (selectedPaymentMethods.length > 0) {
                let html = '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">';
                selectedPaymentMethods.forEach(method => {
                    html += `<span class="payment-method-tag active">${method}</span>`;
                });
                html += '</div>';
                previewMethods.innerHTML = html;
            } else {
                previewMethods.innerHTML = '<p>No payment methods selected</p>';
            }
            
            // Update payment accounts preview
            if (paymentAccounts.length > 0) {
                let accountsHtml = '<div class="receipt-info-grid">';
                
                paymentAccounts.forEach((account, index) => {
                    accountsHtml += `
                        <div class="receipt-info-box">
                            <h4>Payment Account #${index + 1}</h4>
                            <p><strong>Account Name:</strong> ${account.accountName || 'Not specified'}</p>
                    `;
                    
                    if (account.accountType === 'bank') {
                        accountsHtml += `
                            <p><strong>Type:</strong> Bank Account</p>
                            <p><strong>Bank:</strong> ${account.bankName || 'Not specified'}</p>
                            <p><strong>Account No:</strong> ${account.accountNumber || 'Not specified'}</p>
                            ${account.swiftCode ? `<p><strong>SWIFT/BIC:</strong> ${account.swiftCode}</p>` : ''}
                        `;
                    } else if (account.accountType === 'mobile') {
                        accountsHtml += `
                            <p><strong>Type:</strong> Mobile Money</p>
                            <p><strong>Network:</strong> ${account.mobileNetwork === 'mpesa' ? 'M-Pesa' : 
                                                            account.mobileNetwork === 'airtel' ? 'Airtel Money' : 
                                                            account.mobileNetwork === 'tkash' ? 'T-Kash' : 'Other'}</p>
                            <p><strong>Phone:</strong> ${account.phoneNumber || 'Not specified'}</p>
                            ${account.paybillNumber ? `<p><strong>Paybill/Till:</strong> ${account.paybillNumber}</p>` : ''}
                        `;
                    } else if (account.accountType === 'card') {
                        accountsHtml += `
                            <p><strong>Type:</strong> Card Payment</p>
                            <p><strong>Card Type:</strong> ${account.cardType === 'visa' ? 'Visa' : 
                                                           account.cardType === 'mastercard' ? 'MasterCard' : 
                                                           account.cardType === 'amex' ? 'American Express' : 'Other'}</p>
                            ${account.cardLast4 ? `<p><strong>Last 4 Digits:</strong> ****${account.cardLast4}</p>` : ''}
                        `;
                    } else {
                        accountsHtml += `<p><strong>Type:</strong> Other</p>`;
                    }
                    
                    accountsHtml += `
                            <p><strong>Institution:</strong> ${account.processingInstitution || 'Not specified'}</p>
                            ${account.notes ? `<p><strong>Notes:</strong> ${account.notes}</p>` : ''}
                        </div>
                    `;
                });
                
                accountsHtml += '</div>';
                previewAccounts.innerHTML = accountsHtml;
            } else {
                previewAccounts.innerHTML = '<p>No payment accounts added</p>';
            }
        }

        // Company Management
        async function loadCompanies() {
            try {
                console.log("Loading companies...");
                const querySnapshot = await window.firebaseApp.getDocs(window.firebaseApp.collection(db, "companies"));
                companies = [];
                const companySelect = document.getElementById('companySelect');
                const companyList = document.getElementById('companyList');
                
                // Clear existing options except the first one
                while (companySelect.options.length > 1) {
                    companySelect.remove(1);
                }
                
                companyList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    companyList.innerHTML = '<div class="text-center" style="padding: 40px; color: var(--gray-color);">No companies found. Add your first company below.</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const company = { id: doc.id, ...doc.data() };
                    companies.push(company);
                    
                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = company.name;
                    companySelect.appendChild(option);
                    
                    // Add to company list
                    const card = document.createElement('div');
                    card.className = 'company-card';
                    card.innerHTML = `
                        <div class="company-card-header">
                            <div>
                                <h4 style="margin-bottom: 5px;">${company.name}</h4>
                                <p style="font-size: 0.9rem; color: var(--gray-color);">${company.email}</p>
                                ${company.parentCompany ? `<p style="font-size: 0.8rem; color: var(--gray-color);">Parent: ${company.parentCompany}</p>` : ''}
                            </div>
                        </div>
                        <p style="margin-bottom: 10px; font-size: 0.9rem;">${company.address || 'No address'}</p>
                        <div style="display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap;">
                            <span class="color-preview" style="background-color: ${company.primaryColor || '#4361ee'}"></span>
                            <span class="color-preview" style="background-color: ${company.secondaryColor || '#3a0ca3'}"></span>
                        </div>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="editCompany('${doc.id}')">Edit</button>
                            <button class="btn btn-success btn-sm" onclick="loadCompanyPaymentMethods('${doc.id}')">Payment Methods</button>
                        </div>
                    `;
                    companyList.appendChild(card);
                });
                
                // Select first company
                if (companies.length > 0) {
                    companySelect.value = companies[0].id;
                    onCompanySelect();
                }
                
                console.log(`Loaded ${companies.length} companies`);
            } catch (error) {
                console.error("Error loading companies:", error);
                showAlert('adminAlert', 'Error loading companies: ' + error.message, 'danger');
            }
        }

        async function loadCompanyPaymentMethods(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            // Populate payment methods
            const checkboxes = document.querySelectorAll('#paymentMethodsContainer .payment-method-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = company.paymentMethods && company.paymentMethods.includes(cb.value);
            });
            
            // Switch to admin tab
            switchTab('admin');
            showAlert('adminAlert', `Loaded payment methods for ${company.name}`, 'success');
        }

        function onCompanySelect() {
            const companyId = document.getElementById('companySelect').value;
            if (!companyId) return;
            
            const company = companies.find(c => c.id === companyId);
            if (company) {
                updatePreviewWithCompany(company);
                updatePaymentMethodsSelection(company);
            }
        }

        function updatePreviewWithCompany(company) {
            document.getElementById('previewCompanyName').textContent = company.name;
            
            let contactInfo = '';
            if (company.email) contactInfo += company.email + '<br>';
            if (company.phone) contactInfo += company.phone + '<br>';
            if (company.address) contactInfo += company.address;
            
            document.getElementById('previewCompanyContact').innerHTML = contactInfo || 'No contact information';
            document.getElementById('previewCompanyWebsite').textContent = company.website || '';
            
            // Update parent company
            const parentCompany = document.getElementById('previewParentCompany');
            if (company.parentCompany) {
                parentCompany.textContent = `A division of ${company.parentCompany}`;
                parentCompany.style.display = 'block';
            } else {
                parentCompany.style.display = 'none';
            }
            
            // Update tax pin
            const companyTax = document.getElementById('previewCompanyTax');
            if (company.taxPin) {
                companyTax.textContent = `TAX PIN: ${company.taxPin}`;
                companyTax.style.display = 'block';
            } else {
                companyTax.style.display = 'none';
            }
            
            // Update colors
            if (company.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', company.primaryColor);
            }
            if (company.secondaryColor) {
                document.documentElement.style.setProperty('--secondary-color', company.secondaryColor);
            }
        }

        async function saveCompany() {
            const name = document.getElementById('companyName').value.trim();
            const email = document.getElementById('companyEmail').value.trim();
            
            if (!name || !email) {
                showAlert('adminAlert', 'Company name and email are required', 'danger');
                return;
            }
            
            const btn = document.getElementById('saveCompanyBtn');
            const text = document.getElementById('saveCompanyText');
            const spinner = document.getElementById('saveCompanySpinner');
            
            text.textContent = 'Saving...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                // Get payment methods
                const paymentMethods = [];
                document.querySelectorAll('#paymentMethodsContainer .payment-method-checkbox:checked').forEach(cb => {
                    paymentMethods.push(cb.value);
                });
                
                // Prepare company data
                const companyData = {
                    name: name,
                    parentCompany: document.getElementById('parentCompany').value.trim(),
                    taxPin: document.getElementById('companyTaxPin').value.trim(),
                    email: email,
                    phone: document.getElementById('companyPhone').value.trim(),
                    website: document.getElementById('companyWebsite').value.trim(),
                    address: document.getElementById('companyAddress').value.trim(),
                    primaryColor: document.getElementById('primaryColor').value,
                    secondaryColor: document.getElementById('secondaryColor').value,
                    paymentMethods: paymentMethods,
                    updatedAt: window.firebaseApp.Timestamp.now()
                };
                
                if (currentCompanyId) {
                    // Update existing company
                    const companyRef = window.firebaseApp.doc(db, "companies", currentCompanyId);
                    await window.firebaseApp.updateDoc(companyRef, companyData);
                    showAlert('adminAlert', 'Company updated successfully!', 'success');
                } else {
                    // Add new company
                    companyData.createdAt = window.firebaseApp.Timestamp.now();
                    const docRef = await window.firebaseApp.addDoc(
                        window.firebaseApp.collection(db, "companies"), 
                        companyData
                    );
                    currentCompanyId = docRef.id;
                    showAlert('adminAlert', 'Company saved successfully!', 'success');
                    document.getElementById('deleteCompanyBtn').style.display = 'inline-block';
                }
                
                // Reload companies
                await loadCompanies();
                
                if (!currentCompanyId) {
                    clearCompanyForm();
                }
                
            } catch (error) {
                console.error("Error saving company:", error);
                showAlert('adminAlert', 'Error saving company: ' + error.message, 'danger');
            } finally {
                text.textContent = 'Save Company';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function editCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            currentCompanyId = companyId;
            
            // Populate form
            document.getElementById('companyName').value = company.name || '';
            document.getElementById('parentCompany').value = company.parentCompany || '';
            document.getElementById('companyTaxPin').value = company.taxPin || '';
            document.getElementById('companyEmail').value = company.email || '';
            document.getElementById('companyPhone').value = company.phone || '';
            document.getElementById('companyWebsite').value = company.website || '';
            document.getElementById('companyAddress').value = company.address || '';
            document.getElementById('primaryColor').value = company.primaryColor || '#4361ee';
            document.getElementById('primaryColorText').value = company.primaryColor || '#4361ee';
            document.getElementById('secondaryColor').value = company.secondaryColor || '#3a0ca3';
            document.getElementById('secondaryColorText').value = company.secondaryColor || '#3a0ca3';
            
            // Update color previews
            document.getElementById('colorPreview').style.backgroundColor = company.primaryColor || '#4361ee';
            document.getElementById('secondaryColorPreview').style.backgroundColor = company.secondaryColor || '#3a0ca3';
            
            // Update payment methods
            document.querySelectorAll('#paymentMethodsContainer .payment-method-checkbox').forEach(cb => {
                cb.checked = company.paymentMethods && company.paymentMethods.includes(cb.value);
            });
            
            document.getElementById('deleteCompanyBtn').style.display = 'inline-block';
            
            // Switch to admin tab
            switchTab('admin');
        }

        function clearCompanyForm() {
            currentCompanyId = null;
            
            document.getElementById('companyName').value = '';
            document.getElementById('parentCompany').value = '';
            document.getElementById('companyTaxPin').value = '';
            document.getElementById('companyEmail').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyWebsite').value = '';
            document.getElementById('companyAddress').value = '';
            document.getElementById('primaryColor').value = '#4361ee';
            document.getElementById('primaryColorText').value = '#4361ee';
            document.getElementById('secondaryColor').value = '#3a0ca3';
            document.getElementById('secondaryColorText').value = '#3a0ca3';
            
            document.getElementById('colorPreview').style.backgroundColor = '#4361ee';
            document.getElementById('secondaryColorPreview').style.backgroundColor = '#3a0ca3';
            
            document.querySelectorAll('#paymentMethodsContainer .payment-method-checkbox').forEach(cb => {
                cb.checked = cb.value === 'Credit Card' || cb.value === 'PayPal';
            });
            
            document.getElementById('deleteCompanyBtn').style.display = 'none';
            document.getElementById('adminAlert').style.display = 'none';
        }

        async function deleteCompany() {
            if (!currentCompanyId || !confirm('Are you sure you want to delete this company? This action cannot be undone.')) {
                return;
            }
            
            try {
                const companyRef = window.firebaseApp.doc(db, "companies", currentCompanyId);
                await window.firebaseApp.deleteDoc(companyRef);
                
                showAlert('adminAlert', 'Company deleted successfully!', 'success');
                clearCompanyForm();
                await loadCompanies();
            } catch (error) {
                console.error("Error deleting company:", error);
                showAlert('adminAlert', 'Error deleting company: ' + error.message, 'danger');
            }
        }

        // Terms Management
        async function loadAllTerms() {
            try {
                const querySnapshot = await window.firebaseApp.getDocs(
                    window.firebaseApp.query(
                        window.firebaseApp.collection(db, "terms"),
                        window.firebaseApp.where("userId", "==", currentUser.uid),
                        window.firebaseApp.orderBy("createdAt", "desc")
                    )
                );
                
                terms = [];
                const termsList = document.getElementById('termsList');
                const termsCheckboxList = document.getElementById('termsCheckboxList');
                
                termsCheckboxList.innerHTML = '';
                termsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    termsCheckboxList.innerHTML = '<div class="text-center" style="padding: 40px; color: var(--gray-color);">No terms found. Add your first term!</div>';
                    termsList.innerHTML = '<div class="text-center" style="padding: 40px; color: var(--gray-color);">No terms found. Add your first term!</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const term = { id: doc.id, ...doc.data() };
                    terms.push(term);
                    
                    // Add to terms checkbox list
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'term-checkbox-item';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" class="term-checkbox" value="${doc.id}">
                        <div class="term-checkbox-content">
                            <div class="term-checkbox-name">${term.name} (${term.documentType === 'all' ? 'All' : term.documentType})</div>
                            <div class="term-checkbox-text">${term.content.length > 100 ? term.content.substring(0, 100) + '...' : term.content}</div>
                        </div>
                    `;
                    termsCheckboxList.appendChild(checkboxItem);
                    
                    // Add to terms list
                    const termItem = document.createElement('div');
                    termItem.className = 'term-item';
                    termItem.innerHTML = `
                        <h5>${term.name}</h5>
                        <p style="font-size: 0.9rem; color: var(--gray-color); margin-bottom: 5px;">
                            Document Type: ${term.documentType === 'all' ? 'All Documents' : term.documentType}
                        </p>
                        <div style="font-size: 0.9rem; color: #666; max-height: 100px; overflow-y: auto;">
                            ${term.content.replace(/\n/g, '<br>')}
                        </div>
                        <div class="term-actions">
                            <button class="btn btn-primary btn-sm" onclick="editTerm('${doc.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTerm('${doc.id}')">Delete</button>
                        </div>
                    `;
                    termsList.appendChild(termItem);
                });
                
                console.log(`Loaded ${terms.length} terms`);
                
            } catch (error) {
                console.error("Error loading terms:", error);
                showAlert('termsAlert', 'Error loading terms: ' + error.message, 'danger');
            }
        }

        async function loadTermsForDocumentType(docType) {
            const termsCheckboxList = document.getElementById('termsCheckboxList');
            termsCheckboxList.innerHTML = '';
            
            if (terms.length === 0) {
                termsCheckboxList.innerHTML = '<div class="text-center" style="padding: 20px; color: var(--gray-color);">No terms found</div>';
                return;
            }
            
            // Add matching terms
            let hasMatchingTerms = false;
            
            terms.forEach(term => {
                if (term.documentType === docType || term.documentType === 'all') {
                    hasMatchingTerms = true;
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'term-checkbox-item';
                    checkboxItem.innerHTML = `
                        <input type="checkbox" class="term-checkbox" value="${term.id}">
                        <div class="term-checkbox-content">
                            <div class="term-checkbox-name">${term.name} (${term.documentType === 'all' ? 'All' : term.documentType})</div>
                            <div class="term-checkbox-text">${term.content.length > 100 ? term.content.substring(0, 100) + '...' : term.content}</div>
                        </div>
                    `;
                    termsCheckboxList.appendChild(checkboxItem);
                }
            });
            
            if (!hasMatchingTerms) {
                termsCheckboxList.innerHTML = '<div class="text-center" style="padding: 20px; color: var(--gray-color);">No terms available for this document type</div>';
            }
        }

        async function saveTerm() {
            const name = document.getElementById('termName').value.trim();
            const content = document.getElementById('termContent').value.trim();
            const documentType = document.getElementById('termDocumentType').value;
            
            if (!name || !content) {
                showAlert('termsAlert', 'Term name and content are required', 'danger');
                return;
            }
            
            try {
                const termData = {
                    name: name,
                    content: content,
                    documentType: documentType,
                    userId: currentUser.uid,
                    updatedAt: window.firebaseApp.Timestamp.now()
                };
                
                if (currentTermId) {
                    // Update existing term
                    const termRef = window.firebaseApp.doc(db, "terms", currentTermId);
                    await window.firebaseApp.updateDoc(termRef, termData);
                    showAlert('termsAlert', 'Term updated successfully!', 'success');
                } else {
                    // Add new term
                    termData.createdAt = window.firebaseApp.Timestamp.now();
                    const docRef = await window.firebaseApp.addDoc(
                        window.firebaseApp.collection(db, "terms"), 
                        termData
                    );
                    currentTermId = docRef.id;
                    showAlert('termsAlert', 'Term saved successfully!', 'success');
                    document.getElementById('deleteTermBtn').style.display = 'inline-block';
                }
                
                // Reload terms
                await loadAllTerms();
                loadTermsForDocumentType(document.getElementById('documentType').value);
                
                if (!currentTermId) {
                    clearTermForm();
                }
                
            } catch (error) {
                console.error("Error saving term:", error);
                showAlert('termsAlert', 'Error saving term: ' + error.message, 'danger');
            }
        }

        function editTerm(termId) {
            const term = terms.find(t => t.id === termId);
            if (!term) return;
            
            currentTermId = termId;
            
            document.getElementById('termName').value = term.name;
            document.getElementById('termContent').value = term.content;
            document.getElementById('termDocumentType').value = term.documentType;
            
            document.getElementById('deleteTermBtn').style.display = 'inline-block';
            
            switchTab('terms');
        }

        function clearTermForm() {
            currentTermId = null;
            
            document.getElementById('termName').value = '';
            document.getElementById('termContent').value = '';
            document.getElementById('termDocumentType').value = 'all';
            
            document.getElementById('deleteTermBtn').style.display = 'none';
            document.getElementById('termsAlert').style.display = 'none';
        }

        async function deleteTerm(termId = null) {
            const idToDelete = termId || currentTermId;
            if (!idToDelete || !confirm('Are you sure you want to delete this term?')) {
                return;
            }
            
            try {
                const termRef = window.firebaseApp.doc(db, "terms", idToDelete);
                await window.firebaseApp.deleteDoc(termRef);
                
                showAlert('termsAlert', 'Term deleted successfully!', 'success');
                clearTermForm();
                await loadAllTerms();
                loadTermsForDocumentType(document.getElementById('documentType').value);
                
            } catch (error) {
                console.error("Error deleting term:", error);
                showAlert('termsAlert', 'Error deleting term: ' + error.message, 'danger');
            }
        }

        // Client Management
        async function loadClients() {
            try {
                const querySnapshot = await window.firebaseApp.getDocs(
                    window.firebaseApp.query(
                        window.firebaseApp.collection(db, "clients"),
                        window.firebaseApp.where("userId", "==", currentUser.uid),
                        window.firebaseApp.orderBy("createdAt", "desc")
                    )
                );
                
                clients = [];
                const clientList = document.getElementById('clientList');
                clientList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    clientList.innerHTML = '<div class="text-center" style="padding: 40px; color: var(--gray-color);">No clients found. Add your first client!</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const client = { id: doc.id, ...doc.data() };
                    clients.push(client);
                    
                    const card = document.createElement('div');
                    card.className = 'client-card';
                    card.onclick = () => selectClient(client);
                    card.innerHTML = `
                        <h4>${client.name}</h4>
                        ${client.email ? `<p>📧 ${client.email}</p>` : ''}
                        ${client.phone ? `<p>📱 ${client.phone}</p>` : ''}
                        ${client.address ? `<p>📍 ${client.address}</p>` : ''}
                        <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); selectClient(${JSON.stringify(client).replace(/"/g, '&quot;')})">Select</button>
                            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteClient('${doc.id}')">Delete</button>
                        </div>
                    `;
                    clientList.appendChild(card);
                });
                
                console.log(`Loaded ${clients.length} clients`);
            } catch (error) {
                console.error("Error loading clients:", error);
                showAlert('clientsAlert', 'Error loading clients: ' + error.message, 'danger');
            }
        }

        function filterClients(searchTerm) {
            const clientList = document.getElementById('clientList');
            const cards = clientList.querySelectorAll('.client-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function showClientList() {
            switchTab('clients');
        }

        function selectClient(client) {
            document.getElementById('customerName').value = client.name || '';
            document.getElementById('customerEmail').value = client.email || '';
            document.getElementById('customerPhone').value = client.phone || '';
            document.getElementById('customerAddress').value = client.address || '';
            
            switchTab('create');
            showAlert('createAlert', `Client "${client.name}" selected`, 'success');
        }

        function clearClientForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
        }

        async function saveCurrentClient() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            
            if (!name) {
                showAlert('createAlert', 'Client name is required', 'danger');
                return;
            }
            
            try {
                const clientData = {
                    name: name,
                    email: email,
                    phone: document.getElementById('customerPhone').value.trim(),
                    address: document.getElementById('customerAddress').value.trim(),
                    userId: currentUser.uid,
                    createdAt: window.firebaseApp.Timestamp.now(),
                    updatedAt: window.firebaseApp.Timestamp.now()
                };
                
                // Check if client already exists
                const existingClient = clients.find(c => 
                    c.email === email && email || 
                    c.name.toLowerCase() === name.toLowerCase()
                );
                
                if (existingClient) {
                    // Update existing client
                    const clientRef = window.firebaseApp.doc(db, "clients", existingClient.id);
                    await window.firebaseApp.updateDoc(clientRef, clientData);
                    showAlert('createAlert', 'Client updated successfully!', 'success');
                } else {
                    // Add new client
                    await window.firebaseApp.addDoc(
                        window.firebaseApp.collection(db, "clients"), 
                        clientData
                    );
                    showAlert('createAlert', 'Client saved successfully!', 'success');
                }
                
                // Reload clients
                await loadClients();
                
            } catch (error) {
                console.error("Error saving client:", error);
                showAlert('createAlert', 'Error saving client: ' + error.message, 'danger');
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client?')) {
                return;
            }
            
            try {
                const clientRef = window.firebaseApp.doc(db, "clients", clientId);
                await window.firebaseApp.deleteDoc(clientRef);
                
                showAlert('clientsAlert', 'Client deleted successfully!', 'success');
                await loadClients();
            } catch (error) {
                console.error("Error deleting client:", error);
                showAlert('clientsAlert', 'Error deleting client: ' + error.message, 'danger');
            }
        }

        // Document Generation - FIXED VERSION
        async function generateDocument() {
            const docType = document.getElementById('documentType').value;
            
            // Check if at least one term is selected (required for all documents)
            if (selectedTermIds.length === 0) {
                showAlert('createAlert', 'Please select at least one term', 'danger');
                return;
            }
            
            // Check if at least one payment method is selected
            if (selectedPaymentMethods.length === 0) {
                showAlert('createAlert', 'Please select at least one payment method', 'danger');
                return;
            }
            
            if (docType === 'receipt') {
                await generateReceipt();
            } else {
                await generateStandardDocument();
            }
        }

        async function generateStandardDocument() {
            const docType = document.getElementById('documentType').value; // FIXED: Added this line
            const companyId = document.getElementById('companySelect').value;
            const customerName = document.getElementById('customerName').value.trim();
            
            if (!companyId) {
                showAlert('createAlert', 'Please select a company', 'danger');
                return;
            }
            
            if (!customerName) {
                showAlert('createAlert', 'Please enter customer name', 'danger');
                return;
            }
            
            // Check items
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let hasItems = false;
            rows.forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                if (desc && desc.trim()) hasItems = true;
            });
            
            if (!hasItems) {
                showAlert('createAlert', 'Please add at least one item', 'danger');
                return;
            }
            
            const btn = document.getElementById('generateBtn');
            const text = document.getElementById('generateText');
            const spinner = document.getElementById('generateSpinner');
            
            text.textContent = 'Generating...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                const company = companies.find(c => c.id === companyId);
                if (!company) throw new Error('Company not found');
                
                // Calculate totals
                let subtotal = 0;
                const items = [];
                
                rows.forEach(row => {
                    const desc = row.querySelector('.item-desc').value;
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    const total = qty * price;
                    
                    if (desc && desc.trim()) {
                        items.push({
                            description: desc,
                            quantity: qty,
                            unitPrice: price,
                            total: total
                        });
                        subtotal += total;
                    }
                });
                
                discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                if (discountAmount > subtotal) discountAmount = subtotal;
                
                const discountedSubtotal = subtotal - discountAmount;
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const taxAmount = discountedSubtotal * (taxRate / 100);
                const totalAmount = discountedSubtotal + taxAmount;
                
                // Get selected terms
                let termsText = '';
                selectedTermIds.forEach(termId => {
                    const term = terms.find(t => t.id === termId);
                    if (term) {
                        if (termsText) termsText += '\n\n';
                        termsText += term.content;
                    }
                });
                
                // Prepare document data
                const documentData = {
                    type: docType,
                    serialNumber: document.getElementById('serialNumber').value,
                    currency: selectedCurrency,
                    companyId: companyId,
                    companyName: company.name,
                    companyEmail: company.email,
                    companyPhone: company.phone,
                    companyAddress: company.address,
                    companyWebsite: company.website,
                    parentCompany: company.parentCompany || '',
                    taxPin: company.taxPin || '',
                    customerName: customerName,
                    customerEmail: document.getElementById('customerEmail').value.trim(),
                    customerPhone: document.getElementById('customerPhone').value.trim(),
                    customerAddress: document.getElementById('customerAddress').value.trim(),
                    items: items,
                    subtotal: subtotal,
                    discount: discountAmount,
                    taxRate: taxRate,
                    taxAmount: taxAmount,
                    total: totalAmount,
                    paymentMethods: company.paymentMethods || [],
                    selectedPaymentMethods: selectedPaymentMethods,
                    paymentAccounts: paymentAccounts, // Store multiple payment accounts
                    hasSignature: signatureLoaded,
                    terms: termsText,
                    selectedTermIds: selectedTermIds,
                    userId: currentUser.uid,
                    createdAt: window.firebaseApp.Timestamp.now(),
                    revoked: false,
                    payments: []
                };
                
                // Save to Firebase
                const docRef = await window.firebaseApp.addDoc(
                    window.firebaseApp.collection(db, "documents"), 
                    documentData
                );
                
                console.log("Document saved with ID:", docRef.id);
                showAlert('createAlert', 'Document generated successfully!', 'success');
                
                clearForm();
                await loadDocumentHistory();
                
            } catch (error) {
                console.error("Error generating document:", error);
                showAlert('createAlert', 'Error generating document: ' + error.message, 'danger');
            } finally {
                text.textContent = 'Generate Document';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        async function generateReceipt() {
            const docType = 'receipt'; // Fixed: Define docType for receipts
            const companyId = document.getElementById('companySelect').value;
            const customerName = document.getElementById('customerName').value.trim();
            const receiptReason = document.getElementById('receiptReason').value.trim();
            
            // Check items for receipts too
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let hasItems = false;
            rows.forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                if (desc && desc.trim()) hasItems = true;
            });
            
            if (!hasItems) {
                showAlert('createAlert', 'Please add at least one item', 'danger');
                return;
            }
            
            if (!companyId) {
                showAlert('createAlert', 'Please select a company', 'danger');
                return;
            }
            
            if (!customerName) {
                showAlert('createAlert', 'Please enter customer name', 'danger');
                return;
            }
            
            if (!receiptReason) {
                showAlert('createAlert', 'Please enter reason for receipt', 'danger');
                return;
            }
            
            const btn = document.getElementById('generateBtn');
            const text = document.getElementById('generateText');
            const spinner = document.getElementById('generateSpinner');
            
            text.textContent = 'Generating...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                const company = companies.find(c => c.id === companyId);
                if (!company) throw new Error('Company not found');
                
                // Calculate totals from items
                let subtotal = 0;
                const items = [];
                
                rows.forEach(row => {
                    const desc = row.querySelector('.item-desc').value;
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    const total = qty * price;
                    
                    if (desc && desc.trim()) {
                        items.push({
                            description: desc,
                            quantity: qty,
                            unitPrice: price,
                            total: total
                        });
                        subtotal += total;
                    }
                });
                
                discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                if (discountAmount > subtotal) discountAmount = subtotal;
                
                const discountedSubtotal = subtotal - discountAmount;
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const taxAmount = discountedSubtotal * (taxRate / 100);
                const totalAmount = discountedSubtotal + taxAmount;
                
                const receiptDate = document.getElementById('receiptDate').value;
                
                // Get selected terms
                let termsText = '';
                selectedTermIds.forEach(termId => {
                    const term = terms.find(t => t.id === termId);
                    if (term) {
                        if (termsText) termsText += '\n\n';
                        termsText += term.content;
                    }
                });
                
                // Prepare receipt data
                const receiptData = {
                    type: 'receipt',
                    serialNumber: document.getElementById('serialNumber').value,
                    currency: selectedCurrency,
                    companyId: companyId,
                    companyName: company.name,
                    companyEmail: company.email,
                    companyPhone: company.phone,
                    companyAddress: company.address,
                    companyWebsite: company.website,
                    parentCompany: company.parentCompany || '',
                    taxPin: company.taxPin || '',
                    customerName: customerName,
                    customerEmail: document.getElementById('customerEmail').value.trim(),
                    customerPhone: document.getElementById('customerPhone').value.trim(),
                    customerAddress: document.getElementById('customerAddress').value.trim(),
                    receiptReason: receiptReason,
                    receiptDate: receiptDate,
                    items: items,
                    subtotal: subtotal,
                    discount: discountAmount,
                    taxRate: taxRate,
                    taxAmount: taxAmount,
                    totalAmount: totalAmount,
                    paymentMethods: company.paymentMethods || [],
                    selectedPaymentMethods: selectedPaymentMethods,
                    paymentAccounts: paymentAccounts, // Store multiple payment accounts
                    hasSignature: signatureLoaded,
                    terms: termsText,
                    selectedTermIds: selectedTermIds,
                    userId: currentUser.uid,
                    createdAt: window.firebaseApp.Timestamp.now(),
                    revoked: false,
                    payments: []
                };
                
                // Save to Firebase
                const docRef = await window.firebaseApp.addDoc(
                    window.firebaseApp.collection(db, "documents"), 
                    receiptData
                );
                
                console.log("Receipt saved with ID:", docRef.id);
                showAlert('createAlert', 'Receipt generated successfully!', 'success');
                
                clearForm();
                await loadDocumentHistory();
                
            } catch (error) {
                console.error("Error generating receipt:", error);
                showAlert('createAlert', 'Error generating receipt: ' + error.message, 'danger');
            } finally {
                text.textContent = 'Generate Document';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function clearForm() {
            const docType = document.getElementById('documentType').value;
            
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            
            // Clear items table
            const tableBody = document.getElementById('itemsTableBody');
            while (tableBody.rows.length > 1) {
                tableBody.deleteRow(1);
            }
            
            // Reset first row
            const firstRow = tableBody.rows[0];
            firstRow.querySelector('.item-desc').value = '';
            firstRow.querySelector('.item-qty').value = '1';
            firstRow.querySelector('.item-price').value = '0';
            
            if (docType === 'receipt') {
                // Clear receipt fields
                document.getElementById('receiptReason').value = '';
                
                // Set date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('receiptDate').value = today;
            }
            
            document.getElementById('discountAmount').value = '0';
            document.getElementById('taxRate').value = '10';
            
            // Clear selected terms
            selectedTermIds = [];
            document.querySelectorAll('.term-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            // Clear selected payment methods
            selectedPaymentMethods = [];
            document.querySelectorAll('#paymentMethodsCheckboxList .payment-method-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            // Clear payment accounts (keep only one)
            const accountsContainer = document.getElementById('paymentAccountsContainer');
            while (accountsContainer.children.length > 1) {
                accountsContainer.removeChild(accountsContainer.lastChild);
            }
            
            // Reset the first account
            const firstAccount = accountsContainer.querySelector('.payment-account-item');
            if (firstAccount) {
                firstAccount.querySelector('.account-type').value = 'bank';
                firstAccount.querySelector('.account-name').value = '';
                firstAccount.querySelector('.bank-name').value = '';
                firstAccount.querySelector('.account-number').value = '';
                firstAccount.querySelector('.swift-code').value = '';
                firstAccount.querySelector('.mobile-network').value = 'mpesa';
                firstAccount.querySelector('.phone-number').value = '';
                firstAccount.querySelector('.paybill-number').value = '';
                firstAccount.querySelector('.card-type').value = 'visa';
                firstAccount.querySelector('.card-last4').value = '';
                firstAccount.querySelector('.processing-institution').value = '';
                firstAccount.querySelector('.account-notes').value = '';
                
                // Update fields display
                updateAccountFields(firstAccount.querySelector('.account-type'));
            }
            
            // Reset payment accounts array
            paymentAccounts = [{
                id: 'paymentAccount1',
                accountType: 'bank',
                accountName: '',
                bankName: '',
                accountNumber: '',
                swiftCode: '',
                mobileNetwork: 'mpesa',
                phoneNumber: '',
                paybillNumber: '',
                cardType: 'visa',
                cardLast4: '',
                processingInstitution: '',
                notes: ''
            }];
            
            accountCounter = 1;
            
            updateItemTotals();
            
            // Reset terms and payment methods display
            updateTermsAndConditions();
            updatePaymentAccountsPreview();
            
            updateSerialNumber();
            document.getElementById('createAlert').style.display = 'none';
        }

        function previewDocument() {
            const docType = document.getElementById('documentType').value;
            
            // Update customer details
            const customerName = document.getElementById('customerName').value || 'John Doe';
            const customerEmail = document.getElementById('customerEmail').value || 'john@example.com';
            const customerPhone = document.getElementById('customerPhone').value || '+1234567890';
            const customerAddress = document.getElementById('customerAddress').value || '123 Main St, City, Country';
            
            const customerDetails = `
                <strong>${customerName}</strong><br>
                ${customerEmail}<br>
                ${customerPhone}<br>
                ${customerAddress}
            `;
            
            document.getElementById('previewCustomerDetails').innerHTML = customerDetails;
            document.getElementById('previewCustomerDetailsStandard').innerHTML = customerDetails;
            
            // Update document type
            let docTitle = 'DOCUMENT';
            switch(docType) {
                case 'invoice': docTitle = 'INVOICE'; break;
                case 'quote': docTitle = 'QUOTE'; break;
                case 'receipt': docTitle = 'RECEIPT'; break;
                case 'proforma': docTitle = 'PROFORMA INVOICE'; break;
            }
            
            document.getElementById('previewDocumentTitle').textContent = docTitle;
            document.getElementById('previewDocType').textContent = docTitle.charAt(0) + docTitle.slice(1).toLowerCase();
            
            // Update serial number and date
            const serialNumber = document.getElementById('serialNumber').value;
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            
            document.getElementById('previewSerialNumber').textContent = serialNumber;
            document.getElementById('previewReceiptSerial').textContent = serialNumber;
            document.getElementById('previewDate').textContent = dateStr;
            document.getElementById('previewReceiptDate').textContent = dateStr;
            
            // Update currency
            document.getElementById('previewCurrency').textContent = selectedCurrency;
            document.getElementById('previewReceiptCurrency').textContent = selectedCurrency;
            
            // Update payment preview
            updatePaymentAccountsPreview();
            
            // Update terms in preview
            updateTermsAndConditions();
            
            // Update item totals
            updateItemTotals();
            
            // Show/hide appropriate preview layout
            if (docType === 'receipt') {
                document.getElementById('receiptPreview').classList.remove('hidden');
                document.getElementById('standardPreview').classList.add('hidden');
                
                // Update receipt-specific preview
                document.getElementById('previewReceiptReason').textContent = document.getElementById('receiptReason').value || 'Payment for services';
                document.getElementById('previewReceiptDate').textContent = document.getElementById('receiptDate').value || dateStr;
            } else {
                document.getElementById('receiptPreview').classList.add('hidden');
                document.getElementById('standardPreview').classList.remove('hidden');
            }
            
            // Switch to preview tab
            switchTab('preview');
        }

        function refreshPreview() {
            previewDocument();
        }

        // Payment Tracking Modal Functions - FIXED VERSION
        function openPaymentModal(documentId) {
            currentDocumentForPayment = documents.find(d => d.id === documentId);
            if (!currentDocumentForPayment) return;
            
            // Set modal title
            document.getElementById('paymentModalTitle').textContent = `Record Payment - ${currentDocumentForPayment.serialNumber}`;
            
            // Load payment form
            loadPaymentForm(currentDocumentForPayment);
            
            // Load payment history
            loadPaymentHistory(currentDocumentForPayment);
            
            // Show modal
            document.getElementById('paymentModal').style.display = 'flex';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentDocumentForPayment = null;
            document.getElementById('paymentModalAlert').style.display = 'none';
        }

        function loadPaymentForm(doc) {
            const container = document.getElementById('paymentFormContainer');
            const symbol = doc.currency === 'KSH' ? 'KSh' : '$';
            const remainingBalance = calculateRemainingBalance(doc);
            
            container.innerHTML = `
                <div class="form-grid">
                    <div class="form-group">
                        <label for="paymentDate" class="required">Payment Date</label>
                        <input type="date" id="paymentDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount" class="required">Payment Amount (${symbol})</label>
                        <input type="number" id="paymentAmount" class="form-control" value="${remainingBalance > 0 ? remainingBalance.toFixed(2) : '0.00'}" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod" class="required">Payment Method</label>
                        <select id="paymentMethod" class="form-control">
                            <option value="">Select payment method</option>
                            ${doc.paymentMethods && Array.isArray(doc.paymentMethods) ? 
                                doc.paymentMethods.map(method => `<option value="${method}">${method}</option>`).join('') : ''}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentCurrency">Currency</label>
                        <select id="paymentCurrency" class="form-control">
                            <option value="${doc.currency || 'USD'}">${doc.currency || 'USD'}</option>
                            <option value="USD">USD</option>
                            <option value="KSH">KSH</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="paymentNotes">Payment Notes</label>
                    <textarea id="paymentNotes" class="form-control" rows="3" placeholder="Optional notes about this payment"></textarea>
                </div>
                <div class="mt-20">
                    <p><strong>Document Total:</strong> ${symbol}${doc.totalAmount?.toFixed(2) || doc.total?.toFixed(2) || '0.00'}</p>
                    <p><strong>Amount Paid:</strong> ${symbol}${calculateTotalPaid(doc).toFixed(2)}</p>
                    <p><strong>Remaining Balance:</strong> ${symbol}${remainingBalance.toFixed(2)}</p>
                </div>
                <div class="mt-20" style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="recordPayment()">Record Payment</button>
                    <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                </div>
            `;
        }

        function calculateTotalPaid(doc) {
            if (!doc.payments || !Array.isArray(doc.payments)) return 0;
            return doc.payments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
        }

        function calculateRemainingBalance(doc) {
            const total = doc.totalAmount || doc.total || 0;
            const paid = calculateTotalPaid(doc);
            return Math.max(0, total - paid);
        }

        function loadPaymentHistory(doc) {
            const container = document.getElementById('paymentHistoryContent');
            
            if (!doc.payments || !Array.isArray(doc.payments) || doc.payments.length === 0) {
                container.innerHTML = '<p>No payments recorded yet.</p>';
                return;
            }
            
            let html = '<table class="payment-history-table">';
            html += '<thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Currency</th><th>Notes</th><th>Actions</th></tr></thead>';
            html += '<tbody>';
            
            doc.payments.forEach((payment, index) => {
                const date = payment.date ? new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                const symbol = payment.currency === 'KSH' ? 'KSh' : '$';
                html += `<tr>
                    <td>${date}</td>
                    <td>${symbol}${payment.amount?.toFixed(2) || '0.00'}</td>
                    <td>${payment.method || 'N/A'}</td>
                    <td>${payment.currency || doc.currency || 'USD'}</td>
                    <td>${payment.notes || ''}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deletePayment(${index})">Delete</button></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function recordPayment() {
            if (!currentDocumentForPayment) return;
            
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentCurrency = document.getElementById('paymentCurrency').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            
            if (!paymentDate) {
                showPaymentAlert('Please select a payment date', 'danger');
                return;
            }
            
            if (!paymentAmount || paymentAmount <= 0) {
                showPaymentAlert('Please enter a valid payment amount', 'danger');
                return;
            }
            
            if (!paymentMethod) {
                showPaymentAlert('Please select a payment method', 'danger');
                return;
            }
            
            const remainingBalance = calculateRemainingBalance(currentDocumentForPayment);
            if (paymentAmount > remainingBalance) {
                showPaymentAlert(`Payment amount cannot exceed remaining balance of ${remainingBalance.toFixed(2)}`, 'danger');
                return;
            }
            
            try {
                // Create payment object
                const payment = {
                    date: window.firebaseApp.Timestamp.fromDate(new Date(paymentDate)),
                    amount: paymentAmount,
                    method: paymentMethod,
                    currency: paymentCurrency,
                    notes: paymentNotes,
                    recordedAt: window.firebaseApp.Timestamp.now(),
                    recordedBy: currentUser.uid
                };
                
                // Get current payments array
                const currentPayments = currentDocumentForPayment.payments || [];
                currentPayments.push(payment);
                
                // Update document in Firebase
                const docRef = window.firebaseApp.doc(db, "documents", currentDocumentForPayment.id);
                await window.firebaseApp.updateDoc(docRef, {
                    payments: currentPayments,
                    updatedAt: window.firebaseApp.Timestamp.now()
                });
                
                // Update local document
                currentDocumentForPayment.payments = currentPayments;
                
                // Update document history
                await loadDocumentHistory();
                
                // Reload payment form and history
                loadPaymentForm(currentDocumentForPayment);
                loadPaymentHistory(currentDocumentForPayment);
                
                showPaymentAlert('Payment recorded successfully!', 'success');
                
                // Check if document is fully paid and update status
                const newRemainingBalance = calculateRemainingBalance(currentDocumentForPayment);
                if (newRemainingBalance === 0) {
                    // Mark as paid
                    await window.firebaseApp.updateDoc(docRef, {
                        paid: true,
                        paidAt: window.firebaseApp.Timestamp.now()
                    });
                    
                    // If it's an invoice, offer to convert to receipt
                    if (currentDocumentForPayment.type === 'invoice') {
                        setTimeout(() => {
                            if (confirm('Invoice is now fully paid. Would you like to convert it to a receipt?')) {
                                convertToReceipt(currentDocumentForPayment.id);
                                closePaymentModal();
                            }
                        }, 1000);
                    }
                }
                
            } catch (error) {
                console.error("Error recording payment:", error);
                showPaymentAlert('Error recording payment: ' + error.message, 'danger');
            }
        }

        async function deletePayment(paymentIndex) {
            if (!currentDocumentForPayment || !confirm('Are you sure you want to delete this payment?')) {
                return;
            }
            
            try {
                // Get current payments array
                const currentPayments = currentDocumentForPayment.payments || [];
                
                // Remove the payment at the specified index
                currentPayments.splice(paymentIndex, 1);
                
                // Update document in Firebase
                const docRef = window.firebaseApp.doc(db, "documents", currentDocumentForPayment.id);
                await window.firebaseApp.updateDoc(docRef, {
                    payments: currentPayments,
                    updatedAt: window.firebaseApp.Timestamp.now()
                });
                
                // Update local document
                currentDocumentForPayment.payments = currentPayments;
                
                // Update document history
                await loadDocumentHistory();
                
                // Reload payment history
                loadPaymentHistory(currentDocumentForPayment);
                loadPaymentForm(currentDocumentForPayment);
                
                showPaymentAlert('Payment deleted successfully!', 'success');
                
            } catch (error) {
                console.error("Error deleting payment:", error);
                showPaymentAlert('Error deleting payment: ' + error.message, 'danger');
            }
        }

        function showPaymentAlert(message, type) {
            const alert = document.getElementById('paymentModalAlert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Document History
        async function loadDocumentHistory() {
            try {
                const filter = document.getElementById('historyFilter').value;
                const q = filter === 'all' 
                    ? window.firebaseApp.query(window.firebaseApp.collection(db, "documents"), window.firebaseApp.orderBy("createdAt", "desc"))
                    : window.firebaseApp.query(window.firebaseApp.collection(db, "documents"), window.firebaseApp.where("type", "==", filter), window.firebaseApp.orderBy("createdAt", "desc"));
                
                const querySnapshot = await window.firebaseApp.getDocs(q);
                documents = [];
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 40px;">No documents found. Create your first document!</td>
                        </tr>
                    `;
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    documents.push(data);
                    
                    const date = data.createdAt?.toDate() || new Date();
                    const dateStr = date.toLocaleDateString('en-US');
                    const currencySymbol = data.currency === 'KSH' ? 'KSh' : '$';
                    const totalPaid = calculateTotalPaid(data);
                    const remainingBalance = calculateRemainingBalance(data);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.serialNumber || 'N/A'}</td>
                        <td><span style="text-transform: capitalize;">${data.type || 'Unknown'}</span></td>
                        <td>${data.customerName || 'Unknown'}</td>
                        <td>${dateStr}</td>
                        <td>${currencySymbol}${data.totalAmount?.toFixed(2) || data.total?.toFixed(2) || '0.00'}</td>
                        <td>
                            <span class="status-badge ${data.revoked ? 'status-revoked' : data.paid ? 'status-active' : 'status-warning'}">
                                ${data.revoked ? 'Revoked' : data.paid ? 'Paid' : 'Pending'}
                            </span>
                            ${!data.paid && data.payments && data.payments.length > 0 ? 
                                `<br><small>Paid: ${currencySymbol}${totalPaid.toFixed(2)}</small>` : ''}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="viewDocument('${doc.id}')">View</button>
                                <button class="btn btn-success btn-sm" onclick="downloadDocumentPDF('${doc.id}')">PDF</button>
                                ${data.type === 'invoice' && !data.revoked ? 
                                    `<button class="btn btn-warning btn-sm" onclick="openPaymentModal('${doc.id}')">Record Payment</button>` : ''}
                                ${data.type === 'invoice' && !data.revoked && !data.paid ? 
                                    `<button class="btn btn-warning btn-sm" onclick="convertToReceipt('${doc.id}')">To Receipt</button>` : ''}
                                ${(data.type === 'proforma' || data.type === 'quote') && !data.revoked ? 
                                    `<button class="btn btn-warning btn-sm" onclick="convertToInvoice('${doc.id}')">To Invoice</button>` : ''}
                                ${data.type === 'quote' && !data.revoked ? 
                                    `<button class="btn btn-warning btn-sm" onclick="convertToProforma('${doc.id}')">To Proforma</button>` : ''}
                                ${!data.revoked ? `<button class="btn btn-danger btn-sm" onclick="revokeDocument('${doc.id}')">Revoke</button>` : ''}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("Error loading history:", error);
                showAlert('historyAlert', 'Error loading document history: ' + error.message, 'danger');
            }
        }

        // Convert document functions
        function convertToReceipt(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) return;
            
            // If invoice has payments, ask if they want to include them
            if (doc.payments && doc.payments.length > 0) {
                if (confirm('This invoice has payment records. Would you like to include them in the receipt?')) {
                    createConvertedDocumentWithPayments(doc, 'receipt');
                } else {
                    createConvertedDocument(doc, 'receipt');
                }
            } else {
                createConvertedDocument(doc, 'receipt');
            }
        }

        function convertToInvoice(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) return;
            createConvertedDocument(doc, 'invoice');
        }

        function convertToProforma(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) return;
            createConvertedDocument(doc, 'proforma');
        }

        async function createConvertedDocument(originalDoc, newType) {
            try {
                // Generate new serial number
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                
                let prefix = 'DOC';
                switch(newType) {
                    case 'invoice': prefix = 'INV'; break;
                    case 'quote': prefix = 'QUO'; break;
                    case 'receipt': prefix = 'REC'; break;
                    case 'proforma': prefix = 'PRO'; break;
                }
                
                const sequence = await getNextMonthlySequence(newType);
                const newSerial = `${prefix}-${year}${month}-${String(sequence).padStart(3, '0')}`;
                
                // Prepare new document data
                const documentData = {
                    type: newType,
                    serialNumber: newSerial,
                    currency: originalDoc.currency || 'USD',
                    companyId: originalDoc.companyId,
                    companyName: originalDoc.companyName,
                    companyEmail: originalDoc.companyEmail,
                    companyPhone: originalDoc.companyPhone,
                    companyAddress: originalDoc.companyAddress,
                    companyWebsite: originalDoc.companyWebsite,
                    parentCompany: originalDoc.parentCompany || '',
                    taxPin: originalDoc.taxPin || '',
                    customerName: originalDoc.customerName,
                    customerEmail: originalDoc.customerEmail || '',
                    customerPhone: originalDoc.customerPhone || '',
                    customerAddress: originalDoc.customerAddress || '',
                    items: originalDoc.items || [],
                    subtotal: originalDoc.subtotal || 0,
                    discount: originalDoc.discount || 0,
                    taxRate: originalDoc.taxRate || 0,
                    taxAmount: originalDoc.taxAmount || 0,
                    total: originalDoc.total || 0,
                    paymentMethods: originalDoc.paymentMethods || [],
                    selectedPaymentMethods: originalDoc.selectedPaymentMethods || [],
                    paymentAccounts: originalDoc.paymentAccounts || [],
                    hasSignature: signatureLoaded,
                    terms: originalDoc.terms || '',
                    selectedTermIds: originalDoc.selectedTermIds || [],
                    userId: currentUser.uid,
                    createdAt: window.firebaseApp.Timestamp.now(),
                    convertedFrom: originalDoc.id,
                    revoked: false,
                    payments: newType === 'receipt' && originalDoc.payments ? originalDoc.payments : []
                };
                
                // For receipts, add receipt-specific data
                if (newType === 'receipt') {
                    documentData.receiptReason = originalDoc.receiptReason || 'Payment conversion from ' + originalDoc.type;
                    documentData.receiptDate = new Date().toISOString().split('T')[0];
                    documentData.totalAmount = originalDoc.total || 0;
                }
                
                // Save to Firebase
                const docRef = await window.firebaseApp.addDoc(
                    window.firebaseApp.collection(db, "documents"), 
                    documentData
                );
                
                console.log(`Document converted to ${newType} with ID:`, docRef.id);
                showAlert('historyAlert', `Document converted to ${newType} successfully!`, 'success');
                
                // Reload history
                await loadDocumentHistory();
                
                // Switch to create tab and populate form
                switchTab('create');
                viewDocument(docRef.id);
                
            } catch (error) {
                console.error("Error converting document:", error);
                showAlert('historyAlert', 'Error converting document: ' + error.message, 'danger');
            }
        }

        async function createConvertedDocumentWithPayments(originalDoc, newType) {
            try {
                // Generate new serial number
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                
                let prefix = 'DOC';
                switch(newType) {
                    case 'invoice': prefix = 'INV'; break;
                    case 'quote': prefix = 'QUO'; break;
                    case 'receipt': prefix = 'REC'; break;
                    case 'proforma': prefix = 'PRO'; break;
                }
                
                const sequence = await getNextMonthlySequence(newType);
                const newSerial = `${prefix}-${year}${month}-${String(sequence).padStart(3, '0')}`;
                
                // Calculate total paid from payments
                const totalPaid = calculateTotalPaid(originalDoc);
                
                // Prepare new document data with payments
                const documentData = {
                    type: newType,
                    serialNumber: newSerial,
                    currency: originalDoc.currency || 'USD',
                    companyId: originalDoc.companyId,
                    companyName: originalDoc.companyName,
                    companyEmail: originalDoc.companyEmail,
                    companyPhone: originalDoc.companyPhone,
                    companyAddress: originalDoc.companyAddress,
                    companyWebsite: originalDoc.companyWebsite,
                    parentCompany: originalDoc.parentCompany || '',
                    taxPin: originalDoc.taxPin || '',
                    customerName: originalDoc.customerName,
                    customerEmail: originalDoc.customerEmail || '',
                    customerPhone: originalDoc.customerPhone || '',
                    customerAddress: originalDoc.customerAddress || '',
                    items: originalDoc.items || [],
                    subtotal: originalDoc.subtotal || 0,
                    discount: originalDoc.discount || 0,
                    taxRate: originalDoc.taxRate || 0,
                    taxAmount: originalDoc.taxAmount || 0,
                    total: originalDoc.total || 0,
                    paymentMethods: originalDoc.paymentMethods || [],
                    selectedPaymentMethods: originalDoc.selectedPaymentMethods || [],
                    paymentAccounts: originalDoc.paymentAccounts || [],
                    hasSignature: signatureLoaded,
                    terms: originalDoc.terms || '',
                    selectedTermIds: originalDoc.selectedTermIds || [],
                    userId: currentUser.uid,
                    createdAt: window.firebaseApp.Timestamp.now(),
                    convertedFrom: originalDoc.id,
                    revoked: false,
                    payments: originalDoc.payments || []
                };
                
                // For receipts, add receipt-specific data
                if (newType === 'receipt') {
                    documentData.receiptReason = originalDoc.receiptReason || 'Payment conversion from ' + originalDoc.type;
                    documentData.receiptDate = new Date().toISOString().split('T')[0];
                    documentData.totalAmount = originalDoc.total || 0;
                    documentData.paid = true;
                    documentData.paidAt = window.firebaseApp.Timestamp.now();
                }
                
                // Save to Firebase
                const docRef = await window.firebaseApp.addDoc(
                    window.firebaseApp.collection(db, "documents"), 
                    documentData
                );
                
                console.log(`Document converted to ${newType} with payments, ID:`, docRef.id);
                showAlert('historyAlert', `Document converted to ${newType} with payment history!`, 'success');
                
                // Reload history
                await loadDocumentHistory();
                
                // Switch to create tab and populate form
                switchTab('create');
                viewDocument(docRef.id);
                
            } catch (error) {
                console.error("Error converting document with payments:", error);
                showAlert('historyAlert', 'Error converting document: ' + error.message, 'danger');
            }
        }

        function viewDocument(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) return;
            
            // Set document type
            document.getElementById('documentType').value = doc.type;
            
            // Set currency if available
            if (doc.currency) {
                selectCurrency(doc.currency);
            }
            
            // Update form layout
            updateFormLayout();
            updateSerialNumber();
            
            if (doc.companyId) {
                document.getElementById('companySelect').value = doc.companyId;
                const company = companies.find(c => c.id === doc.companyId);
                if (company) {
                    updatePreviewWithCompany(company);
                    updatePaymentMethodsSelection(company);
                }
            }
            
            // Populate customer details
            document.getElementById('customerName').value = doc.customerName || '';
            document.getElementById('customerEmail').value = doc.customerEmail || '';
            document.getElementById('customerPhone').value = doc.customerPhone || '';
            document.getElementById('customerAddress').value = doc.customerAddress || '';
            
            if (doc.type === 'receipt') {
                // Populate receipt fields
                document.getElementById('receiptReason').value = doc.receiptReason || '';
                document.getElementById('receiptDate').value = doc.receiptDate || '';
            }
            
            // Populate items for all document types
            const tableBody = document.getElementById('itemsTableBody');
            tableBody.innerHTML = '';
            
            if (doc.items && Array.isArray(doc.items)) {
                doc.items.forEach((item, index) => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="form-control item-desc" value="${item.description || ''}"></td>
                        <td><input type="number" class="form-control item-qty" value="${item.quantity || 1}" min="1"></td>
                        <td><input type="number" class="form-control item-price" value="${item.unitPrice || 0}" min="0" step="0.01"></td>
                        <td class="item-total">${doc.currency === 'KSH' ? 'KSh' : '$'}${(item.total || 0).toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">✕</button></td>
                    `;
                    tableBody.appendChild(newRow);
                });
            }
            
            // Add one empty row if needed
            if (tableBody.rows.length === 0) {
                addItem();
            }
            
            document.getElementById('discountAmount').value = doc.discount || 0;
            document.getElementById('taxRate').value = doc.taxRate || 10;
            
            updateItemTotals();
            
            // Set selected payment methods
            selectedPaymentMethods = doc.selectedPaymentMethods || [];
            document.querySelectorAll('#paymentMethodsCheckboxList .payment-method-checkbox').forEach(cb => {
                cb.checked = selectedPaymentMethods.includes(cb.value);
            });
            
            // Set payment accounts
            if (doc.paymentAccounts && Array.isArray(doc.paymentAccounts) && doc.paymentAccounts.length > 0) {
                // Clear existing accounts
                const accountsContainer = document.getElementById('paymentAccountsContainer');
                accountsContainer.innerHTML = '';
                
                // Add accounts from document
                doc.paymentAccounts.forEach((account, index) => {
                    const accountId = `paymentAccount${index + 1}`;
                    const accountItem = document.createElement('div');
                    accountItem.className = 'payment-account-item';
                    accountItem.id = accountId;
                    accountItem.innerHTML = `
                        <div class="payment-account-header">
                            <h5>Payment Account #${index + 1}</h5>
                            ${index > 0 ? `<button class="btn btn-danger btn-sm" onclick="removePaymentAccount('${accountId}')">Remove</button>` : ''}
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Account Type</label>
                                <select class="form-control account-type" onchange="updateAccountFields(this)">
                                    <option value="bank" ${account.accountType === 'bank' ? 'selected' : ''}>Bank Account</option>
                                    <option value="mobile" ${account.accountType === 'mobile' ? 'selected' : ''}>Mobile Money</option>
                                    <option value="card" ${account.accountType === 'card' ? 'selected' : ''}>Card Payment</option>
                                    <option value="other" ${account.accountType === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Account Name</label>
                                <input type="text" class="form-control account-name" value="${account.accountName || ''}" placeholder="e.g., Equity Bank USD Account">
                            </div>
                            <div class="form-group bank-fields" style="display: ${account.accountType === 'bank' ? 'block' : 'none'}">
                                <label>Bank Name</label>
                                <input type="text" class="form-control bank-name" value="${account.bankName || ''}" placeholder="e.g., Equity Bank">
                            </div>
                            <div class="form-group bank-fields" style="display: ${account.accountType === 'bank' ? 'block' : 'none'}">
                                <label>Account Number</label>
                                <input type="text" class="form-control account-number" value="${account.accountNumber || ''}" placeholder="Account number">
                            </div>
                            <div class="form-group bank-fields" style="display: ${account.accountType === 'bank' ? 'block' : 'none'}">
                                <label>Swift/BIC Code</label>
                                <input type="text" class="form-control swift-code" value="${account.swiftCode || ''}" placeholder="SWIFT/BIC code">
                            </div>
                            <div class="form-group mobile-fields" style="display: ${account.accountType === 'mobile' ? 'block' : 'none'}">
                                <label>Mobile Network</label>
                                <select class="form-control mobile-network">
                                    <option value="mpesa" ${account.mobileNetwork === 'mpesa' ? 'selected' : ''}>M-Pesa</option>
                                    <option value="airtel" ${account.mobileNetwork === 'airtel' ? 'selected' : ''}>Airtel Money</option>
                                    <option value="tkash" ${account.mobileNetwork === 'tkash' ? 'selected' : ''}>T-Kash</option>
                                    <option value="other" ${account.mobileNetwork === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group mobile-fields" style="display: ${account.accountType === 'mobile' ? 'block' : 'none'}">
                                <label>Phone Number</label>
                                <input type="text" class="form-control phone-number" value="${account.phoneNumber || ''}" placeholder="Phone number">
                            </div>
                            <div class="form-group mobile-fields" style="display: ${account.accountType === 'mobile' ? 'block' : 'none'}">
                                <label>Paybill/Till Number</label>
                                <input type="text" class="form-control paybill-number" value="${account.paybillNumber || ''}" placeholder="Paybill/Till number">
                            </div>
                            <div class="form-group card-fields" style="display: ${account.accountType === 'card' ? 'block' : 'none'}">
                                <label>Card Type</label>
                                <select class="form-control card-type">
                                    <option value="visa" ${account.cardType === 'visa' ? 'selected' : ''}>Visa</option>
                                    <option value="mastercard" ${account.cardType === 'mastercard' ? 'selected' : ''}>MasterCard</option>
                                    <option value="amex" ${account.cardType === 'amex' ? 'selected' : ''}>American Express</option>
                                    <option value="other" ${account.cardType === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group card-fields" style="display: ${account.accountType === 'card' ? 'block' : 'none'}">
                                <label>Card Last 4 Digits</label>
                                <input type="text" class="form-control card-last4" value="${account.cardLast4 || ''}" placeholder="Last 4 digits" maxlength="4">
                            </div>
                            <div class="form-group">
                                <label>Processing Institution</label>
                                <input type="text" class="form-control processing-institution" value="${account.processingInstitution || ''}" placeholder="Institution name">
                            </div>
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea class="form-control account-notes" rows="2" placeholder="Additional account information">${account.notes || ''}</textarea>
                            </div>
                        </div>
                    `;
                    accountsContainer.appendChild(accountItem);
                    
                    // Update fields display
                    if (accountItem.querySelector('.account-type')) {
                        updateAccountFields(accountItem.querySelector('.account-type'));
                    }
                });
                
                // Update paymentAccounts array
                paymentAccounts = doc.paymentAccounts;
                accountCounter = doc.paymentAccounts.length;
            }
            
            // Set selected terms
            selectedTermIds = doc.selectedTermIds || [];
            document.querySelectorAll('.term-checkbox').forEach(cb => {
                cb.checked = selectedTermIds.includes(cb.value);
            });
            
            updateTermsAndConditions();
            updatePaymentAccountsPreview();
            
            // Show revoked stamp if needed
            document.getElementById('revokedStamp').style.display = doc.revoked ? 'block' : 'none';
            
            // Switch to create tab and preview
            switchTab('create');
            previewDocument();
        }

        async function revokeDocument(documentId) {
            if (!confirm('Are you sure you want to revoke this document?')) {
                return;
            }
            
            try {
                const docRef = window.firebaseApp.doc(db, "documents", documentId);
                await window.firebaseApp.updateDoc(docRef, { revoked: true });
                
                showAlert('historyAlert', 'Document revoked successfully!', 'success');
                await loadDocumentHistory();
                
                // Update preview if viewing this document
                const doc = documents.find(d => d.id === documentId);
                if (doc && doc.serialNumber === document.getElementById('serialNumber').value) {
                    document.getElementById('revokedStamp').style.display = 'block';
                }
            } catch (error) {
                console.error("Error revoking document:", error);
                showAlert('historyAlert', 'Error revoking document: ' + error.message, 'danger');
            }
        }

        async function downloadDocumentPDF(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) {
                // If not in history, load it first
                viewDocument(documentId);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            generatePDF();
        }

       async function generatePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        const element = document.getElementById('documentPreview');
        
        // Add pdf-mode class to trigger PDF-specific styles
        element.classList.add('pdf-mode');
        
        // Store original styles
        const originalStyles = {
            width: element.style.width,
            margin: element.style.margin,
            padding: element.style.padding,
            fontSize: element.style.fontSize
        };
        
        // Apply A4-optimized styles directly to the element
        element.style.width = '210mm';
        element.style.margin = '0 auto';
        element.style.padding = '15mm';
        element.style.fontSize = '14px';
        element.style.boxSizing = 'border-box';
        element.style.background = 'white';
        
        // Wait for styles to apply
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Optimize tables for better fit
        const tables = element.querySelectorAll('table');
        tables.forEach(table => {
            table.style.width = '100%';
            table.style.tableLayout = 'fixed';
            table.style.fontSize = '12px';
            
            // Set consistent column widths
            const headers = table.querySelectorAll('th');
            const cells = table.querySelectorAll('td');
            
            if (headers.length >= 4) {
                headers[0].style.width = '45%';
                headers[1].style.width = '15%';
                headers[2].style.width = '20%';
                headers[3].style.width = '20%';
            }
            
            if (cells.length >= 4) {
                cells.forEach((cell, index) => {
                    if (index % 4 === 1) { // Quantity column
                        cell.style.textAlign = 'center';
                    } else if (index % 4 === 2 || index % 4 === 3) { // Price and Total columns
                        cell.style.textAlign = 'right';
                    }
                });
            }
        });
        
        // Wait for styles to apply
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Calculate optimal scale for A4
        const a4Width = 210; // mm
        const a4Height = 297; // mm
        const contentWidth = element.offsetWidth;
        const contentHeight = element.scrollHeight;
        
        // Calculate scale to fit A4
        const widthScale = (a4Width - 30) / (contentWidth / 3.78); // Convert pixels to mm (96 DPI)
        const heightScale = (a4Height - 30) / (contentHeight / 3.78);
        const scale = Math.min(widthScale, heightScale, 1); // Don't scale up beyond 100%
        
        const canvas = await html2canvas(element, {
            scale: 3, // High resolution
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            width: element.offsetWidth,
            height: element.scrollHeight,
            windowWidth: element.offsetWidth,
            windowHeight: element.scrollHeight,
                       onclone: function(clonedDoc) {
                const previewElement = clonedDoc.getElementById('documentPreview');
                if (previewElement) {
                    // Add pdf-mode class to clone
                    previewElement.classList.add('pdf-mode');
                    
                    // Ensure A4 dimensions
                    previewElement.style.width = '210mm';
                    previewElement.style.padding = '15mm';
                    previewElement.style.margin = '0';
                    previewElement.style.boxSizing = 'border-box';
                    previewElement.style.background = 'white';
                    previewElement.style.fontSize = '14px';
                    
                    // The CSS will handle hiding UI elements via .pdf-mode class
                    
                    // Optimize all tables in clone
                    const cloneTables = previewElement.querySelectorAll('table');
                    cloneTables.forEach(table => {
                        table.style.width = '100%';
                        table.style.tableLayout = 'fixed';
                        table.style.fontSize = '12px';
                    });
                    
                    // Ensure text is readable
                    const allText = previewElement.querySelectorAll('p, span, div, td, th, h1, h2, h3, h4');
                    allText.forEach(textEl => {
                        const currentSize = parseInt(window.getComputedStyle(textEl).fontSize);
                        if (currentSize < 10) {
                            textEl.style.fontSize = '10px';
                        }
                    });
                }
            }
        });
        
                // Restore original styles and remove pdf-mode class
        element.style.width = originalStyles.width;
        element.style.margin = originalStyles.margin;
        element.style.padding = originalStyles.padding;
        element.style.fontSize = originalStyles.fontSize;
        element.style.background = '';
        element.style.boxSizing = '';
        element.classList.remove('pdf-mode');;
        
        });
        
        // Restore table styles
        tables.forEach(table => {
            table.style.width = '';
            table.style.tableLayout = '';
            table.style.fontSize = '';
        });
        
        if (!canvas || canvas.width === 0 || canvas.height === 0) {
            throw new Error('Canvas rendering failed');
        }
        
        const imgData = canvas.toDataURL('image/png');
        
        if (!imgData || imgData.length < 100) {
            throw new Error('Image data is invalid or too small');
        }
        
        // Calculate dimensions for PDF
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();
        
        // Margins (5mm each side)
        const margin = 5;
        const contentAreaWidth = pdfWidth - (margin * 2);
        const contentAreaHeight = pdfHeight - (margin * 2);
        
        // Calculate image dimensions to fit content area
        const canvasRatio = canvas.width / canvas.height;
        let imgWidth, imgHeight;
        
        if (canvasRatio > (contentAreaWidth / contentAreaHeight)) {
            // Width is the limiting factor
            imgWidth = contentAreaWidth;
            imgHeight = imgWidth / canvasRatio;
        } else {
            // Height is the limiting factor
            imgHeight = contentAreaHeight;
            imgWidth = imgHeight * canvasRatio;
        }
        
        // Center the image
        const xPos = margin + (contentAreaWidth - imgWidth) / 2;
        const yPos = margin + (contentAreaHeight - imgHeight) / 2;
        
        // Add image to PDF
        doc.addImage(imgData, 'PNG', xPos, yPos, imgWidth, imgHeight);
        
        // Add document info in footer
        const docType = document.getElementById('documentType').value;
        const serialNumber = document.getElementById('serialNumber').value;
        const date = new Date().toLocaleDateString();
        
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(
            `Document: ${serialNumber} | Generated: ${date}`,
            pdfWidth / 2,
            pdfHeight - 3,
            { align: 'center' }
        );
        
        const fileName = `${serialNumber}-${docType}.pdf`;
        doc.save(fileName);
        
        showAlert('historyAlert', 'PDF generated successfully!', 'success');
        
    } catch (error) {
        console.error("Error generating PDF:", error);
        
        // Fallback: Create a properly scaled text-based PDF
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Page dimensions
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Margins
            const margin = 15;
            let yPos = margin;
            
            // Get document data
            const docType = document.getElementById('documentType').value;
            const serialNumber = document.getElementById('serialNumber').value;
            const companyName = document.getElementById('previewCompanyName').textContent;
            const customerName = document.getElementById('customerName').value || 'Customer';
            const total = document.getElementById('totalAmount').textContent;
            const date = new Date().toLocaleDateString();
            
            // Company header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(companyName, pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;
            
            // Document title
            doc.setFontSize(16);
            doc.setTextColor(67, 97, 238); // Primary color
            doc.text(`${docType.toUpperCase()}`, pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            // Document info
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Serial No: ${serialNumber}`, pageWidth - margin, yPos, { align: 'right' });
            doc.text(`Date: ${date}`, margin, yPos);
            yPos += 6;
            doc.text(`Currency: ${selectedCurrency}`, pageWidth - margin, yPos, { align: 'right' });
            yPos += 10;
            
            // Customer info
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Bill To:', margin, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 6;
            doc.setFontSize(11);
            doc.text(customerName, margin, yPos);
            yPos += 15;
            
            // Items table header
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Description', margin, yPos);
            doc.text('Qty', pageWidth - 60, yPos, { align: 'right' });
            doc.text('Price', pageWidth - 40, yPos, { align: 'right' });
            doc.text('Total', pageWidth - margin, yPos, { align: 'right' });
            yPos += 6;
            
            // Horizontal line
            doc.setLineWidth(0.5);
            doc.line(margin, yPos - 2, pageWidth - margin, yPos - 2);
            
            // Items
            doc.setFont(undefined, 'normal');
            const items = document.querySelectorAll('#itemsTableBody tr');
            
            items.forEach((row, index) => {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = margin;
                }
                
                const desc = row.querySelector('.item-desc')?.value;
                const qty = row.querySelector('.item-qty')?.value || '1';
                const price = row.querySelector('.item-price')?.value || '0';
                const itemTotal = (parseFloat(qty) * parseFloat(price)).toFixed(2);
                
                if (desc && desc.trim()) {
                    doc.text(desc.substring(0, 50), margin, yPos);
                    doc.text(qty, pageWidth - 60, yPos, { align: 'right' });
                    doc.text(price, pageWidth - 40, yPos, { align: 'right' });
                    doc.text(itemTotal, pageWidth - margin, yPos, { align: 'right' });
                    yPos += 6;
                }
            });
            
            // Totals
            yPos = Math.max(yPos, pageHeight - 40);
            doc.setFont(undefined, 'bold');
            doc.text(`Total: ${total}`, pageWidth - margin, yPos, { align: 'right' });
            
            // Footer
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100);
            doc.text(
                'Generated by STARKS GALAXY LIMITED Document Generator',
                pageWidth / 2,
                pageHeight - 10,
                { align: 'center' }
            );
            
            const fileName = `${serialNumber}-${docType}.pdf`;
            doc.save(fileName);
            
            showAlert('historyAlert', 'Generated optimized PDF as fallback.', 'warning');
            
        } catch (fallbackError) {
            console.error("Fallback PDF generation failed:", fallbackError);
            alert('PDF generation failed. Please try refreshing the page and try again.');
        }
    }
}
    </script>
</body>
</html>
