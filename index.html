<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARKS GALAXY ENTERPRISE - Professional Document Suite</title>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDyre2oxURYXHZOLIHUeG2itz56i5ehAYo",
            authDomain: "company-doc-generator.firebaseapp.com",
            projectId: "company-doc-generator",
            storageBucket: "company-doc-generator.firebasestorage.app",
            messagingSenderId: "891677147775",
            appId: "1:891677147775:web:a1ffebf23572f5ca18f54a",
            measurementId: "G-1MMCF9W7HF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Export all Firebase functions to window
        window.firebase = {
            auth,
            db,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            getDocs,
            updateDoc,
            doc,
            query,
            orderBy,
            Timestamp,
            deleteDoc,
            where,
            getDoc,
            arrayUnion
        };
        
        console.log("Firebase initialized successfully");
    </script>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1e293b;
            --gray: #64748b;
            --light: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body { background: #f1f5f9; color: var(--dark); min-height: 100vh; }

        /* Auth Styles */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .auth-card { background: white; border-radius: 20px; width: 100%; max-width: 450px; box-shadow: var(--shadow-lg); overflow: hidden; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .auth-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 40px 30px; text-align: center; }
        .auth-header h1 { font-size: 2rem; margin-bottom: 10px; }
        .auth-tabs { display: flex; border-bottom: 2px solid var(--border); }
        .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; color: var(--gray); transition: all 0.3s; }
        .auth-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .auth-form { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; transition: all 0.3s; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; }

        /* Main App */
        .main-app { display: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Top Navigation */
        .top-nav { background: white; border-radius: 15px; padding: 15px 25px; margin-bottom: 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .nav-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-link { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--gray); transition: all 0.3s; }
        .nav-link:hover { background: var(--light); color: var(--primary); }
        .nav-link.active { background: var(--primary); color: white; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-email { background: var(--light); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; color: var(--dark); }

        /* Content Area */
        .content-area { background: white; border-radius: 15px; padding: 30px; box-shadow: var(--shadow); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--light); padding: 25px; border-radius: 12px; border-left: 4px solid var(--primary); }
        .stat-card h3 { font-size: 2rem; color: var(--primary); margin-bottom: 5px; }
        .stat-card p { color: var(--gray); font-size: 0.9rem; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .data-table th { background: var(--light); padding: 15px; text-align: left; font-weight: 600; color: var(--dark); }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--border); }
        .data-table tbody tr:hover { background: var(--light); }

        /* Cards Grid */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: var(--primary); }
        .card.company-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px; }

        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }

        /* Items Table */
        .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .items-table th { background: var(--light); padding: 12px; text-align: left; }
        .items-table td { padding: 10px; border-bottom: 1px solid var(--border); }
        .items-table input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }

        /* Utility Classes */
        .hidden { display: none !important; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .flex { display: flex; gap: 10px; flex-wrap: wrap; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid var(--success); }
        .alert-danger { background: #fee2e2; color: #991b1b; border-left: 4px solid var(--danger); }
        .alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid var(--warning); }
        .alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid var(--info); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* Document Preview */
        .document-preview { padding: 40px; background: white; border-radius: 12px; border: 1px solid var(--border); position: relative; }
        .document-preview.pdf-mode { width: 210mm; padding: 15mm; margin: 0 auto; font-size: 12px; }
        .watermark { position: absolute; opacity: 0.1; font-size: 80px; transform: rotate(-45deg); top: 50%; left: 50%; margin-top: -40px; margin-left: -200px; pointer-events: none; color: var(--danger); }
        .contract-clauses { margin: 20px 0; }
        .clause-item { background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--primary); }
        .signature-box { border: 1px solid var(--border); padding: 20px; border-radius: 8px; margin-top: 30px; }

        /* Progress Bar */
        .progress-bar { height: 8px; background: var(--light); border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.3s; }

        /* Color Picker */
        .color-picker { width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--border); cursor: pointer; padding: 0; }

        /* Tabs */
        .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); flex-wrap: wrap; }
        .sub-tab { padding: 10px 20px; cursor: pointer; color: var(--gray); border-bottom: 3px solid transparent; transition: all 0.3s; }
        .sub-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .sub-tab:hover { color: var(--primary); }

        @media (max-width: 768px) {
            .top-nav { flex-direction: column; }
            .nav-links { justify-content: center; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>STARKS GALAXY</h1>
                <p>Enterprise Document Suite</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="ui.switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="ui.switchAuthTab('register')">Register</div>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <div id="loginAlert" class="alert"></div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="auth.login()" style="width: 100%;" id="loginBtn">
                    <span id="loginText">Login</span>
                    <span id="loginSpinner" class="loading hidden"></span>
                </button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <div id="registerAlert" class="alert"></div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Create a password (min. 6 characters)">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="registerConfirm" class="form-control" placeholder="Confirm your password">
                </div>
                <button class="btn btn-primary" onclick="auth.register()" style="width: 100%;" id="registerBtn">
                    <span id="registerText">Create Account</span>
                    <span id="registerSpinner" class="loading hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <!-- Top Navigation -->
            <div class="top-nav">
                <div class="nav-links">
                    <div class="nav-link active" data-section="dashboard">Dashboard</div>
                    <div class="nav-link" data-section="companies">Companies</div>
                    <div class="nav-link" data-section="invoices">Invoices</div>
                    <div class="nav-link" data-section="quotes">Quotes</div>
                    <div class="nav-link" data-section="receipts">Receipts</div>
                    <div class="nav-link" data-section="proforma">Proforma</div>
                    <div class="nav-link" data-section="contracts">Contracts</div>
                    <div class="nav-link" data-section="templates">Templates</div>
                    <div class="nav-link" data-section="clients">Clients</div>
                    <div class="nav-link" data-section="reports">Reports</div>
                    <div class="nav-link" data-section="settings">Settings</div>
                </div>
                <div class="user-menu">
                    <span class="user-email" id="userEmail"></span>
                    <button class="btn btn-sm btn-danger" onclick="auth.logout()">Logout</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="content-section active">
                    <h2>Dashboard</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalRevenue">$0</h3>
                            <p>Total Revenue</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="outstandingInvoices">$0</h3>
                            <p>Outstanding Invoices</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalReceipts">0</h3>
                            <p>Total Receipts</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="activeContracts">0</h3>
                            <p>Active Contracts</p>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="monthlyRevenue">$0</h3>
                            <p>This Month</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="overdueInvoices">0</h3>
                            <p>Overdue Invoices</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="paidInvoices">0</h3>
                            <p>Paid Invoices</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="pendingQuotes">0</h3>
                            <p>Pending Quotes</p>
                        </div>
                    </div>
                    
                    <h3 class="mb-20">Recent Activity</h3>
                    <table class="data-table" id="recentDocumentsTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Serial No</th>
                                <th>Client</th>
                                <th>Company</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentDocumentsBody">
                            <tr><td colspan="8" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Companies Section -->
                <div id="companiesSection" class="content-section">
                    <h2>Company Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showCompanyModal()">Add New Company</button>
                        <button class="btn btn-success" onclick="companies.load()">Refresh</button>
                    </div>
                    
                    <div class="cards-grid" id="companiesGrid"></div>
                </div>

                <!-- Invoices Section -->
                <div id="invoicesSection" class="content-section">
                    <h2>Invoice Management</h2>
                    <div class="sub-tabs">
                        <div class="sub-tab active" onclick="invoices.filter('all', this)">All</div>
                        <div class="sub-tab" onclick="invoices.filter('pending', this)">Pending</div>
                        <div class="sub-tab" onclick="invoices.filter('paid', this)">Paid</div>
                        <div class="sub-tab" onclick="invoices.filter('overdue', this)">Overdue</div>
                        <div class="sub-tab" onclick="invoices.filter('partial', this)">Partial</div>
                    </div>
                    
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('invoice')">Create New Invoice</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('invoice')">Refresh</button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="invoicesTable">
                            <thead>
                                <tr>
                                    <th>Serial No</th>
                                    <th>Client</th>
                                    <th>Company</th>
                                    <th>Date</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Paid</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesBody">
                                <tr><td colspan="10" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quotes Section -->
                <div id="quotesSection" class="content-section">
                    <h2>Quote Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('quote')">Create New Quote</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('quote')">Refresh</button>
                        <button class="btn btn-warning" onclick="quotes.convertToInvoice()">Convert Selected to Invoice</button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="quotesTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllQuotes" onchange="quotes.toggleAll()"></th>
                                    <th>Serial No</th>
                                    <th>Client</th>
                                    <th>Company</th>
                                    <th>Date</th>
                                    <th>Valid Until</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotesBody">
                                <tr><td colspan="9" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Receipts Section -->
                <div id="receiptsSection" class="content-section">
                    <h2>Receipt Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('receipt')">Create New Receipt</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('receipt')">Refresh</button>
                        <button class="btn btn-warning" onclick="receipts.fromInvoice()">Create from Invoice</button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="receiptsTable">
                            <thead>
                                <tr>
                                    <th>Serial No</th>
                                    <th>Client</th>
                                    <th>Company</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Reference Invoice</th>
                                    <th>Payment Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="receiptsBody">
                                <tr><td colspan="8" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Proforma Section -->
                <div id="proformaSection" class="content-section">
                    <h2>Proforma Invoice Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('proforma')">Create New Proforma</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('proforma')">Refresh</button>
                        <button class="btn btn-warning" onclick="proforma.convertSelectedToInvoice()">Convert Selected to Invoice</button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="proformaTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllProforma" onchange="proforma.toggleAll()"></th>
                                    <th>Serial No</th>
                                    <th>Client</th>
                                    <th>Company</th>
                                    <th>Date</th>
                                    <th>Valid Until</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="proformaBody">
                                <tr><td colspan="9" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Contracts Section -->
                <div id="contractsSection" class="content-section">
                    <h2>Contract Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showContractModal()">Create New Contract</button>
                        <button class="btn btn-success" onclick="data.loadContracts()">Refresh</button>
                    </div>
                    
                    <div class="sub-tabs">
                        <div class="sub-tab active" onclick="contracts.filter('all', this)">All</div>
                        <div class="sub-tab" onclick="contracts.filter('draft', this)">Draft</div>
                        <div class="sub-tab" onclick="contracts.filter('active', this)">Active</div>
                        <div class="sub-tab" onclick="contracts.filter('expired', this)">Expired</div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="contractsTable">
                            <thead>
                                <tr>
                                    <th>Contract No</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Party A</th>
                                    <th>Party B</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Value</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contractsBody">
                                <tr><td colspan="10" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Templates Section -->
                <div id="templatesSection" class="content-section">
                    <h2>Template Management</h2>
                    
                    <div class="sub-tabs">
                        <div class="sub-tab active" onclick="templates.showTab('contract', this)">Contract Templates</div>
                        <div class="sub-tab" onclick="templates.showTab('document', this)">Document Templates</div>
                        <div class="sub-tab" onclick="templates.showTab('clause', this)">Standard Clauses</div>
                    </div>
                    
                    <!-- Contract Templates -->
                    <div id="contractTemplatesTab" class="template-tab">
                        <div class="flex mb-20">
                            <button class="btn btn-primary" onclick="templates.showContractTemplateModal()">Create Contract Template</button>
                            <button class="btn btn-success" onclick="templates.loadContractTemplates()">Refresh</button>
                        </div>
                        <div class="cards-grid" id="contractTemplatesGrid"></div>
                    </div>
                    
                    <!-- Document Templates -->
                    <div id="documentTemplatesTab" class="template-tab hidden">
                        <div class="flex mb-20">
                            <button class="btn btn-primary" onclick="templates.showDocumentTemplateModal()">Create Document Template</button>
                            <button class="btn btn-success" onclick="templates.loadDocumentTemplates()">Refresh</button>
                        </div>
                        <div class="cards-grid" id="documentTemplatesGrid"></div>
                    </div>
                    
                    <!-- Standard Clauses -->
                    <div id="standardClausesTab" class="template-tab hidden">
                        <div class="flex mb-20">
                            <button class="btn btn-primary" onclick="templates.showClauseModal()">Add Standard Clause</button>
                            <button class="btn btn-success" onclick="templates.loadStandardClauses()">Refresh</button>
                        </div>
                        <div class="cards-grid" id="standardClausesGrid"></div>
                    </div>
                </div>

                <!-- Clients Section -->
                <div id="clientsSection" class="content-section">
                    <h2>Client Database</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showClientModal()">Add New Client</button>
                        <input type="text" id="clientSearch" class="form-control" placeholder="Search clients..." style="max-width: 300px;">
                    </div>
                    <div class="cards-grid" id="clientsGrid"></div>
                </div>

                <!-- Reports Section -->
                <div id="reportsSection" class="content-section">
                    <h2>Financial Reports</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalRevenueReport">$0</h3>
                            <p>Total Revenue</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="outstandingReport">$0</h3>
                            <p>Outstanding</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="overdueReport">$0</h3>
                            <p>Overdue</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="paidReport">$0</h3>
                            <p>Paid This Month</p>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Report Type</label>
                            <select id="reportType" class="form-control">
                                <option value="revenue">Revenue Report</option>
                                <option value="outstanding">Outstanding Invoices</option>
                                <option value="client">Client Summary</option>
                                <option value="aging">Aging Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Range</label>
                            <select id="dateRange" class="form-control">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="reports.generate()">Generate Report</button>
                    
                    <div id="reportResults" class="mt-20"></div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="content-section">
                    <h2>System Settings</h2>
                    
                    <div class="sub-tabs">
                        <div class="sub-tab active" onclick="settings.showTab('general', this)">General</div>
                        <div class="sub-tab" onclick="settings.showTab('payment', this)">Payment Methods</div>
                        <div class="sub-tab" onclick="settings.showTab('tax', this)">Tax Settings</div>
                    </div>
                    
                    <!-- General Settings -->
                    <div id="generalSettingsTab">
                        <h3>Default Company</h3>
                        <div class="form-group">
                            <label>Select Default Company</label>
                            <select id="defaultCompany" class="form-control">
                                <option value="">Select Company</option>
                            </select>
                        </div>
                        
                        <h3 class="mt-20">Document Numbering</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Invoice Prefix</label>
                                <input type="text" id="invoicePrefix" class="form-control" value="INV">
                            </div>
                            <div class="form-group">
                                <label>Quote Prefix</label>
                                <input type="text" id="quotePrefix" class="form-control" value="QUO">
                            </div>
                            <div class="form-group">
                                <label>Receipt Prefix</label>
                                <input type="text" id="receiptPrefix" class="form-control" value="REC">
                            </div>
                            <div class="form-group">
                                <label>Contract Prefix</label>
                                <input type="text" id="contractPrefix" class="form-control" value="CON">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="settings.saveGeneral()">Save Settings</button>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div id="paymentSettingsTab" class="hidden">
                        <h3>Payment Methods</h3>
                        <div id="paymentMethodsList" class="cards-grid"></div>
                        <button class="btn btn-success mt-20" onclick="settings.addPaymentMethod()">Add Payment Method</button>
                    </div>
                    
                    <!-- Tax Settings -->
                    <div id="taxSettingsTab" class="hidden">
                        <h3>Tax Rates</h3>
                        <div id="taxRatesList" class="cards-grid"></div>
                        <button class="btn btn-success mt-20" onclick="settings.addTaxRate()">Add Tax Rate</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Modal -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <h2 id="companyModalTitle">Add Company</h2>
            <div id="companyAlert" class="alert"></div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="companyName" class="form-control">
                </div>
                <div class="form-group">
                    <label>Registration Number</label>
                    <input type="text" id="companyRegNo" class="form-control">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="companyEmail" class="form-control">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="companyPhone" class="form-control">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Tax ID / VAT Number</label>
                    <input type="text" id="companyTaxId" class="form-control">
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="companyWebsite" class="form-control">
                </div>
            </div>
            
            <div class="form-group">
                <label>Address</label>
                <textarea id="companyAddress" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Logo URL</label>
                    <input type="url" id="companyLogo" class="form-control">
                </div>
                <div class="form-group">
                    <label>Brand Color</label>
                    <input type="color" id="companyColor" class="form-control color-picker" value="#2563eb">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="companyBank" class="form-control">
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="companyAccount" class="form-control">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>SWIFT/BIC</label>
                    <input type="text" id="companySwift" class="form-control">
                </div>
                <div class="form-group">
                    <label>IBAN</label>
                    <input type="text" id="companyIban" class="form-control">
                </div>
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="companies.save()">Save Company</button>
                <button class="btn btn-danger" id="deleteCompanyBtn" style="display:none;" onclick="companies.delete()">Delete</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('companyModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Create Document</h2>
            <div id="documentAlert" class="alert"></div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Company *</label>
                    <select id="docCompany" class="form-control" onchange="documents.updateCompanyColors()">
                        <option value="">Select Company</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Client *</label>
                    <select id="docClient" class="form-control">
                        <option value="">Select Client</option>
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Currency</label>
                    <select id="docCurrency" class="form-control" onchange="items.updateTotals()">
                        <option value="USD">USD ($)</option>
                        <option value="KSH">KSH (KSh)</option>
                        <option value="EUR">EUR (€)</option>
                        <option value="GBP">GBP (£)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="docDueDate" class="form-control">
                </div>
            </div>

            <div id="receiptSpecific" class="hidden">
                <div class="form-group">
                    <label>Receipt Reason</label>
                    <input type="text" id="receiptReason" class="form-control" placeholder="Payment for services">
                </div>
                <div class="form-group">
                    <label>Reference Invoice</label>
                    <select id="receiptInvoice" class="form-control">
                        <option value="">Select Invoice (Optional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="receiptPaymentMethod" class="form-control">
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="M-Pesa">M-Pesa</option>
                        <option value="Cash">Cash</option>
                        <option value="Check">Check</option>
                    </select>
                </div>
            </div>

            <h3>Items</h3>
            <table class="items-table" id="itemsTable">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Discount %</th>
                        <th>Tax %</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <tr>
                        <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                        <td><input type="number" class="form-control item-qty" value="1" min="1" onchange="items.updateTotals()"></td>
                        <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01" onchange="items.updateTotals()"></td>
                        <td><input type="number" class="form-control item-discount" value="0" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                        <td><input type="number" class="form-control item-tax" value="0" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                        <td class="item-total">$0.00</td>
                        <td><button class="btn btn-danger btn-sm" onclick="items.remove(this)">×</button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="text-right"><strong>Subtotal:</strong></td>
                        <td id="subtotal">$0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="text-right"><strong>Total Discount:</strong></td>
                        <td id="totalDiscount">-$0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="text-right"><strong>Total Tax:</strong></td>
                        <td id="totalTax">$0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="text-right"><strong>Grand Total:</strong></td>
                        <td id="grandTotal">$0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <button class="btn btn-success btn-sm" onclick="items.add()">+ Add Item</button>

            <div class="form-group mt-20">
                <label>Notes</label>
                <textarea id="documentNotes" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
            </div>

            <div class="form-group">
                <label>Terms & Conditions</label>
                <textarea id="documentTerms" class="form-control" rows="3" placeholder="Terms and conditions...">Payment is due within 30 days. Please include invoice number with payment.</textarea>
            </div>

            <div class="flex mt-20">
                <button class="btn btn-primary" onclick="documents.save()" id="saveDocBtn">
                    <span>Save Document</span>
                    <span id="docSpinner" class="loading hidden"></span>
                </button>
                <button class="btn btn-secondary" onclick="ui.closeModal('documentModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Contract Modal -->
    <div id="contractModal" class="modal">
        <div class="modal-content">
            <h2>Create Contract</h2>
            <div id="contractAlert" class="alert"></div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Contract Title *</label>
                    <input type="text" id="contractTitle" class="form-control" placeholder="e.g., Service Agreement">
                </div>
                <div class="form-group">
                    <label>Contract Template</label>
                    <select id="contractTemplate" class="form-control" onchange="contracts.loadTemplate()">
                        <option value="">Select Template</option>
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Company (Party A) *</label>
                    <select id="contractCompany" class="form-control">
                        <option value="">Select Company</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Client (Party B) *</label>
                    <select id="contractClient" class="form-control">
                        <option value="">Select Client</option>
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Contract Type</label>
                    <select id="contractType" class="form-control">
                        <option value="nda">NDA</option>
                        <option value="service">Service Agreement</option>
                        <option value="employment">Employment</option>
                        <option value="consultancy">Consultancy</option>
                        <option value="lease">Lease Agreement</option>
                        <option value="partnership">Partnership Agreement</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Contract Value</label>
                    <input type="number" id="contractValue" class="form-control" min="0" step="0.01" value="0">
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="contractStart" class="form-control">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="contractEnd" class="form-control">
                </div>
            </div>

            <h3>Contract Clauses</h3>
            <div id="clausesList" class="contract-clauses"></div>
            <div class="flex mb-20">
                <button class="btn btn-success btn-sm" onclick="contracts.addClause()">+ Add Clause</button>
                <button class="btn btn-info btn-sm" onclick="contracts.showClauseLibrary()">Clause Library</button>
            </div>

            <div class="form-group">
                <label>Special Conditions</label>
                <textarea id="specialConditions" class="form-control" rows="3" placeholder="Additional conditions..."></textarea>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Governing Law</label>
                    <input type="text" id="governingLaw" class="form-control" value="Laws of Kenya">
                </div>
                <div class="form-group">
                    <label>Dispute Resolution</label>
                    <select id="disputeResolution" class="form-control">
                        <option value="court">Court Jurisdiction</option>
                        <option value="arbitration">Arbitration</option>
                        <option value="mediation">Mediation</option>
                    </select>
                </div>
            </div>

            <div class="flex">
                <button class="btn btn-primary" onclick="contracts.save()">Save Contract</button>
                <button class="btn btn-success" onclick="contracts.saveAsTemplate()">Save as Template</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('contractModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Contract Template Modal -->
    <div id="contractTemplateModal" class="modal">
        <div class="modal-content">
            <h2>Save Contract Template</h2>
            <div id="templateAlert" class="alert"></div>
            
            <div class="form-group">
                <label>Template Name *</label>
                <input type="text" id="templateName" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="templateDescription" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>Category</label>
                <select id="templateCategory" class="form-control">
                    <option value="nda">NDA</option>
                    <option value="service">Service</option>
                    <option value="employment">Employment</option>
                    <option value="consultancy">Consultancy</option>
                    <option value="lease">Lease</option>
                    <option value="partnership">Partnership</option>
                </select>
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="templates.saveContractTemplate()">Save Template</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('contractTemplateModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Clause Library Modal -->
    <div id="clauseLibraryModal" class="modal">
        <div class="modal-content">
            <h2>Standard Clauses Library</h2>
            <div id="clauseLibraryList" class="cards-grid"></div>
            <div class="flex mt-20">
                <button class="btn btn-secondary" onclick="ui.closeModal('clauseLibraryModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2>Record Payment</h2>
            <div id="paymentAlert" class="alert"></div>
            
            <div class="form-group">
                <label>Invoice</label>
                <select id="paymentInvoice" class="form-control">
                    <option value="">Select Invoice</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="paymentAmount" class="form-control" min="0.01" step="0.01">
            </div>
            
            <div class="form-group">
                <label>Payment Date</label>
                <input type="date" id="paymentDate" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Payment Method</label>
                <select id="paymentMethod" class="form-control">
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="M-Pesa">M-Pesa</option>
                    <option value="Cash">Cash</option>
                    <option value="Check">Check</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Reference/Transaction ID</label>
                <input type="text" id="paymentReference" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="payments.record()">Record Payment</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('paymentModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2>Add/Edit Client</h2>
            <div id="clientAlert" class="alert"></div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Client Name *</label>
                    <input type="text" id="clientName" class="form-control">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="clientEmail" class="form-control">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="clientPhone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Tax ID/VAT Number</label>
                    <input type="text" id="clientTaxId" class="form-control">
                </div>
            </div>
            
            <div class="form-group">
                <label>Address</label>
                <textarea id="clientAddress" class="form-control" rows="3"></textarea>
            </div>

            <div class="flex">
                <button class="btn btn-primary" onclick="clients.save()">Save Client</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('clientModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <h2>Document Preview</h2>
            <div class="flex mb-20">
                <button class="btn btn-primary" onclick="pdf.generate()">Download PDF</button>
                <button class="btn btn-info" onclick="pdf.print()">Print</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('previewModal')">Close</button>
            </div>
            <div id="previewContent" class="document-preview"></div>
        </div>
    </div>

    <!-- Invoice Selection Modal (for receipts) -->
    <div id="invoiceSelectModal" class="modal">
        <div class="modal-content">
            <h2>Select Invoice for Receipt</h2>
            <div id="invoiceSelectList" class="cards-grid"></div>
            <div class="flex mt-20">
                <button class="btn btn-secondary" onclick="ui.closeModal('invoiceSelectModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Document Template Modal -->
    <div id="documentTemplateModal" class="modal">
        <div class="modal-content">
            <h2>Save Document Template</h2>
            <div id="docTemplateAlert" class="alert"></div>
            
            <div class="form-group">
                <label>Template Name *</label>
                <input type="text" id="docTemplateName" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="docTemplateDescription" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>Document Type</label>
                <select id="docTemplateType" class="form-control">
                    <option value="invoice">Invoice</option>
                    <option value="quote">Quote</option>
                    <option value="receipt">Receipt</option>
                    <option value="proforma">Proforma</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Template Content</label>
                <textarea id="docTemplateContent" class="form-control" rows="5" placeholder="Enter default notes, terms, etc..."></textarea>
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="templates.saveDocumentTemplate()">Save Template</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('documentTemplateModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Clause Modal -->
    <div id="clauseModal" class="modal">
        <div class="modal-content">
            <h2>Add Standard Clause</h2>
            <div id="clauseModalAlert" class="alert"></div>
            
            <div class="form-group">
                <label>Clause Title *</label>
                <input type="text" id="clauseTitle" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Clause Content *</label>
                <textarea id="clauseContent" class="form-control" rows="5" placeholder="Enter clause text..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Category</label>
                <select id="clauseCategory" class="form-control">
                    <option value="general">General</option>
                    <option value="payment">Payment</option>
                    <option value="termination">Termination</option>
                    <option value="confidentiality">Confidentiality</option>
                    <option value="liability">Liability</option>
                </select>
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="templates.saveClause()">Save Clause</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('clauseModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="paymentMethodModal" class="modal">
        <div class="modal-content">
            <h2>Add Payment Method</h2>
            <div id="paymentMethodAlert" class="alert"></div>
            
            <div class="form-group">
                <label>Method Name *</label>
                <input type="text" id="paymentMethodName" class="form-control" placeholder="e.g., Bank Transfer, M-Pesa">
            </div>
            
            <div class="form-group">
                <label>Instructions</label>
                <textarea id="paymentMethodInstructions" class="form-control" rows="3" placeholder="Payment instructions..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Account Details (Optional)</label>
                <input type="text" id="paymentMethodDetails" class="form-control" placeholder="Account number, paybill, etc.">
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="settings.savePaymentMethod()">Save Method</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('paymentMethodModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Tax Rate Modal -->
    <div id="taxRateModal" class="modal">
        <div class="modal-content">
            <h2>Add Tax Rate</h2>
            <div id="taxRateAlert" class="alert"></div>
            
            <div class="form-group">
                <label>Tax Name *</label>
                <input type="text" id="taxName" class="form-control" placeholder="e.g., VAT, Sales Tax">
            </div>
            
            <div class="form-group">
                <label>Rate (%) *</label>
                <input type="number" id="taxRate" class="form-control" min="0" max="100" step="0.1" value="16">
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="taxDescription" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="flex">
                <button class="btn btn-primary" onclick="settings.saveTaxRate()">Save Tax Rate</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('taxRateModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const state = {
            currentUser: null,
            companies: [],
            clients: [],
            documents: [],
            contracts: [],
            templates: { contract: [], document: [], clause: [] },
            settings: {},
            monthlySequence: {},
            currentFilters: { invoice: 'all', contract: 'all' },
            paymentMethods: [],
            taxRates: []
        };

        // ==================== UTILITIES ====================
        const utils = {
            showAlert: (elementId, message, type) => {
                const alert = document.getElementById(elementId);
                if (alert) {
                    alert.textContent = message;
                    alert.className = `alert alert-${type}`;
                    alert.style.display = 'block';
                    setTimeout(() => alert.style.display = 'none', 4000);
                }
            },
            
            formatCurrency: (amount, currency = 'USD') => {
                const num = amount || 0;
                const symbols = { USD: '$', KSH: 'KSh', EUR: '€', GBP: '£' };
                return (symbols[currency] || '$') + num.toFixed(2);
            },
            
            formatDate: (timestamp) => {
                if (!timestamp) return 'N/A';
                if (timestamp.toDate) {
                    return timestamp.toDate().toLocaleDateString();
                }
                if (timestamp instanceof Date) {
                    return timestamp.toLocaleDateString();
                }
                return String(timestamp);
            },
            
            generateSerialNumber: async (type, companyId = null) => {
                const now = new Date();
                const settings = state.settings;
                const prefixes = {
                    invoice: settings?.invoicePrefix || 'INV',
                    quote: settings?.quotePrefix || 'QUO',
                    receipt: settings?.receiptPrefix || 'REC',
                    proforma: 'PRO',
                    contract: settings?.contractPrefix || 'CON'
                };
                
                const prefix = prefixes[type] || 'DOC';
                const monthKey = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`;
                const key = companyId ? `${type}_${companyId}_${monthKey}` : `${type}_${monthKey}`;
                
                if (!state.monthlySequence[key]) {
                    state.monthlySequence[key] = 1;
                } else {
                    state.monthlySequence[key]++;
                }
                
                return `${prefix}-${monthKey}-${String(state.monthlySequence[key]).padStart(3, '0')}`;
            }
        };

        // ==================== AUTHENTICATION ====================
        const auth = {
            init: () => {
                if (!window.firebase) {
                    console.error("Firebase not initialized");
                    return;
                }
                
                window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                    state.currentUser = user;
                    
                    if (user) {
                        document.getElementById('authScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('userEmail').textContent = user.email;
                        data.loadAll();
                    } else {
                        document.getElementById('authScreen').style.display = 'flex';
                        document.getElementById('mainApp').style.display = 'none';
                    }
                });
            },

            login: async () => {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    utils.showAlert('loginAlert', 'Please enter email and password', 'danger');
                    return;
                }

                const btn = document.getElementById('loginBtn');
                btn.disabled = true;
                document.getElementById('loginText').classList.add('hidden');
                document.getElementById('loginSpinner').classList.remove('hidden');

                try {
                    await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                } catch (error) {
                    utils.showAlert('loginAlert', error.message, 'danger');
                    btn.disabled = false;
                    document.getElementById('loginText').classList.remove('hidden');
                    document.getElementById('loginSpinner').classList.add('hidden');
                }
            },

            register: async () => {
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirm = document.getElementById('registerConfirm').value;
                
                if (!email || !password || !confirm) {
                    utils.showAlert('registerAlert', 'Please fill all fields', 'danger');
                    return;
                }
                if (password !== confirm) {
                    utils.showAlert('registerAlert', 'Passwords do not match', 'danger');
                    return;
                }
                if (password.length < 6) {
                    utils.showAlert('registerAlert', 'Password must be at least 6 characters', 'danger');
                    return;
                }

                const btn = document.getElementById('registerBtn');
                btn.disabled = true;
                document.getElementById('registerText').classList.add('hidden');
                document.getElementById('registerSpinner').classList.remove('hidden');

                try {
                    await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                } catch (error) {
                    utils.showAlert('registerAlert', error.message, 'danger');
                    btn.disabled = false;
                    document.getElementById('registerText').classList.remove('hidden');
                    document.getElementById('registerSpinner').classList.add('hidden');
                }
            },

            logout: () => {
                window.firebase.signOut(window.firebase.auth);
            }
        };

        // ==================== COMPANIES ====================
        const companies = {
            currentId: null,
            
            load: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'companies'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    companies.render();
                    companies.updateSelects();
                } catch (error) {
                    console.error('Load companies error:', error);
                }
            },
            
            render: () => {
                const grid = document.getElementById('companiesGrid');
                if (!grid) return;
                
                if (state.companies.length === 0) {
                    grid.innerHTML = '<p class="text-center">No companies yet. Add your first company!</p>';
                    return;
                }
                
                grid.innerHTML = '';
                state.companies.forEach(company => {
                    grid.innerHTML += `
                        <div class="card company-card" style="border-top-color: ${company.color || '#2563eb'};" onclick="companies.edit('${company.id}')">
                            <h4>${company.name || 'Unnamed'}</h4>
                            <p>📧 ${company.email || 'No email'}</p>
                            <p>📱 ${company.phone || 'No phone'}</p>
                            <p>📍 ${company.address || 'No address'}</p>
                            <p>🏦 ${company.bank || 'No bank details'}</p>
                        </div>
                    `;
                });
            },
            
            updateSelects: () => {
                const selects = ['docCompany', 'contractCompany', 'defaultCompany'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">Select Company</option>';
                        state.companies.forEach(company => {
                            select.innerHTML += `<option value="${company.id}">${company.name || 'Unnamed'}</option>`;
                        });
                    }
                });
            },
            
            save: async () => {
                const name = document.getElementById('companyName').value.trim();
                if (!name) {
                    utils.showAlert('companyAlert', 'Company name is required', 'danger');
                    return;
                }
                
                const companyData = {
                    name,
                    regNo: document.getElementById('companyRegNo').value,
                    email: document.getElementById('companyEmail').value,
                    phone: document.getElementById('companyPhone').value,
                    taxId: document.getElementById('companyTaxId').value,
                    website: document.getElementById('companyWebsite').value,
                    address: document.getElementById('companyAddress').value,
                    logo: document.getElementById('companyLogo').value,
                    color: document.getElementById('companyColor').value,
                    bank: document.getElementById('companyBank').value,
                    account: document.getElementById('companyAccount').value,
                    swift: document.getElementById('companySwift').value,
                    iban: document.getElementById('companyIban').value,
                    userId: state.currentUser.uid,
                    updatedAt: window.firebase.Timestamp.now()
                };
                
                try {
                    if (companies.currentId) {
                        await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'companies', companies.currentId), companyData);
                        utils.showAlert('companyAlert', 'Company updated successfully!', 'success');
                    } else {
                        companyData.createdAt = window.firebase.Timestamp.now();
                        await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'companies'), companyData);
                        utils.showAlert('companyAlert', 'Company added successfully!', 'success');
                    }
                    
                    ui.closeModal('companyModal');
                    await companies.load();
                } catch (error) {
                    utils.showAlert('companyAlert', error.message, 'danger');
                }
            },
            
            edit: (id) => {
                const company = state.companies.find(c => c.id === id);
                if (!company) return;
                
                companies.currentId = id;
                document.getElementById('companyModalTitle').textContent = 'Edit Company';
                document.getElementById('companyName').value = company.name || '';
                document.getElementById('companyRegNo').value = company.regNo || '';
                document.getElementById('companyEmail').value = company.email || '';
                document.getElementById('companyPhone').value = company.phone || '';
                document.getElementById('companyTaxId').value = company.taxId || '';
                document.getElementById('companyWebsite').value = company.website || '';
                document.getElementById('companyAddress').value = company.address || '';
                document.getElementById('companyLogo').value = company.logo || '';
                document.getElementById('companyColor').value = company.color || '#2563eb';
                document.getElementById('companyBank').value = company.bank || '';
                document.getElementById('companyAccount').value = company.account || '';
                document.getElementById('companySwift').value = company.swift || '';
                document.getElementById('companyIban').value = company.iban || '';
                
                document.getElementById('deleteCompanyBtn').style.display = 'inline-block';
                ui.openModal('companyModal');
            },
            
            delete: async () => {
                if (!companies.currentId || !confirm('Are you sure you want to delete this company?')) return;
                
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'companies', companies.currentId));
                    utils.showAlert('companyAlert', 'Company deleted successfully!', 'success');
                    ui.closeModal('companyModal');
                    await companies.load();
                } catch (error) {
                    utils.showAlert('companyAlert', error.message, 'danger');
                }
            }
        };

        // ==================== DATA MANAGEMENT ====================
        const data = {
            loadAll: async () => {
                await companies.load();
                await data.loadClients();
                await data.loadDocuments();
                await data.loadContracts();
                await templates.loadAll();
                await settings.load();
            },

            loadClients: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'clients'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Update client selects
                    const selects = ['docClient', 'contractClient'];
                    selects.forEach(id => {
                        const select = document.getElementById(id);
                        if (select) {
                            select.innerHTML = '<option value="">Select Client</option>';
                            state.clients.forEach(client => {
                                select.innerHTML += `<option value="${client.id}">${client.name || 'Unnamed'}</option>`;
                            });
                        }
                    });
                    
                    data.renderClients();
                } catch (error) {
                    console.error('Load clients error:', error);
                }
            },

            loadDocuments: async (type = null) => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    let q;
                    if (type) {
                        q = window.firebase.query(
                            window.firebase.collection(window.firebase.db, 'documents'),
                            window.firebase.where('userId', '==', state.currentUser.uid),
                            window.firebase.where('type', '==', type),
                            window.firebase.orderBy('createdAt', 'desc')
                        );
                    } else {
                        q = window.firebase.query(
                            window.firebase.collection(window.firebase.db, 'documents'),
                            window.firebase.where('userId', '==', state.currentUser.uid),
                            window.firebase.orderBy('createdAt', 'desc')
                        );
                    }
                    
                    const snapshot = await window.firebase.getDocs(q);
                    state.documents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    data.renderDocuments(type);
                    data.updateDashboard();
                } catch (error) {
                    console.error('Load documents error:', error);
                }
            },

            loadContracts: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'contracts'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.contracts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    contracts.render();
                } catch (error) {
                    console.error('Load contracts error:', error);
                }
            },

            renderClients: () => {
                const grid = document.getElementById('clientsGrid');
                if (!grid) return;
                
                if (state.clients.length === 0) {
                    grid.innerHTML = '<p class="text-center">No clients yet. Add your first client!</p>';
                    return;
                }
                
                grid.innerHTML = '';
                state.clients.forEach(client => {
                    grid.innerHTML += `
                        <div class="card" onclick="clients.edit('${client.id}')">
                            <h4>${client.name || 'Unnamed'}</h4>
                            <p>📧 ${client.email || 'No email'}</p>
                            <p>📱 ${client.phone || 'No phone'}</p>
                            <p>📍 ${client.address || 'No address'}</p>
                        </div>
                    `;
                });
            },

            renderDocuments: (type = null) => {
                if (type === 'invoice') {
                    const tbody = document.getElementById('invoicesBody');
                    if (!tbody) return;
                    
                    let filtered = state.documents.filter(d => d.type === 'invoice');
                    
                    // Apply filters
                    if (state.currentFilters.invoice === 'pending') {
                        filtered = filtered.filter(d => {
                            const paid = d.paidAmount || 0;
                            const total = d.total || 0;
                            return paid < total;
                        });
                    } else if (state.currentFilters.invoice === 'paid') {
                        filtered = filtered.filter(d => {
                            const paid = d.paidAmount || 0;
                            const total = d.total || 0;
                            return paid >= total;
                        });
                    } else if (state.currentFilters.invoice === 'overdue') {
                        const now = new Date();
                        filtered = filtered.filter(d => {
                            const paid = d.paidAmount || 0;
                            const total = d.total || 0;
                            const dueDate = d.dueDate?.toDate?.();
                            return paid < total && dueDate && dueDate < now;
                        });
                    } else if (state.currentFilters.invoice === 'partial') {
                        filtered = filtered.filter(d => {
                            const paid = d.paidAmount || 0;
                            const total = d.total || 0;
                            return paid > 0 && paid < total;
                        });
                    }
                    
                    if (filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="text-center">No invoices found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = filtered.map(doc => {
                        const date = utils.formatDate(doc.createdAt);
                        const dueDate = utils.formatDate(doc.dueDate);
                        const company = state.companies.find(c => c.id === doc.companyId);
                        const paid = doc.paidAmount || 0;
                        const total = doc.total || 0;
                        const balance = total - paid;
                        
                        let status = 'Pending';
                        let statusClass = 'warning';
                        if (balance <= 0) {
                            status = 'Paid';
                            statusClass = 'success';
                        } else if (doc.dueDate?.toDate?.() < new Date()) {
                            status = 'Overdue';
                            statusClass = 'danger';
                        } else if (paid > 0 && paid < total) {
                            status = 'Partial';
                            statusClass = 'info';
                        }
                        
                        return `
                            <tr>
                                <td>${doc.serialNumber || 'N/A'}</td>
                                <td>${doc.customerName || 'N/A'}</td>
                                <td>${company?.name || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${dueDate}</td>
                                <td>${utils.formatCurrency(total, doc.currency)}</td>
                                <td>${utils.formatCurrency(paid, doc.currency)}</td>
                                <td>${utils.formatCurrency(balance, doc.currency)}</td>
                                <td><span class="badge badge-${statusClass}">${status}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="documents.view('${doc.id}')">View</button>
                                    ${balance > 0 ? `<button class="btn btn-sm btn-success" onclick="payments.forInvoice('${doc.id}')">Pay</button>` : ''}
                                    <button class="btn btn-sm btn-info" onclick="receipts.fromInvoice('${doc.id}')">Receipt</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else if (type === 'receipt') {
                    const tbody = document.getElementById('receiptsBody');
                    if (!tbody) return;
                    
                    const filtered = state.documents.filter(d => d.type === 'receipt');
                    
                    if (filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No receipts found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = filtered.map(doc => {
                        const date = utils.formatDate(doc.createdAt);
                        const company = state.companies.find(c => c.id === doc.companyId);
                        return `
                            <tr>
                                <td>${doc.serialNumber || 'N/A'}</td>
                                <td>${doc.customerName || 'N/A'}</td>
                                <td>${company?.name || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${utils.formatCurrency(doc.total, doc.currency)}</td>
                                <td>${doc.referenceInvoice || 'N/A'}</td>
                                <td>${doc.paymentMethod || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="documents.view('${doc.id}')">View</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else if (type === 'quote') {
                    const tbody = document.getElementById('quotesBody');
                    if (!tbody) return;
                    
                    const filtered = state.documents.filter(d => d.type === 'quote');
                    
                    if (filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No quotes found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = filtered.map(doc => {
                        const date = utils.formatDate(doc.createdAt);
                        const dueDate = utils.formatDate(doc.dueDate);
                        const company = state.companies.find(c => c.id === doc.companyId);
                        return `
                            <tr>
                                <td><input type="checkbox" class="doc-select quote-select" value="${doc.id}" onchange="quotes.updateSelection()"></td>
                                <td>${doc.serialNumber || 'N/A'}</td>
                                <td>${doc.customerName || 'N/A'}</td>
                                <td>${company?.name || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${dueDate}</td>
                                <td>${utils.formatCurrency(doc.total, doc.currency)}</td>
                                <td><span class="badge badge-info">${doc.status || 'Draft'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="documents.view('${doc.id}')">View</button>
                                    <button class="btn btn-sm btn-success" onclick="quotes.convert('${doc.id}')">Convert</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else if (type === 'proforma') {
                    const tbody = document.getElementById('proformaBody');
                    if (!tbody) return;
                    
                    const filtered = state.documents.filter(d => d.type === 'proforma');
                    
                    if (filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No proforma invoices found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = filtered.map(doc => {
                        const date = utils.formatDate(doc.createdAt);
                        const dueDate = utils.formatDate(doc.dueDate);
                        const company = state.companies.find(c => c.id === doc.companyId);
                        return `
                            <tr>
                                <td><input type="checkbox" class="doc-select proforma-select" value="${doc.id}" onchange="proforma.updateSelection()"></td>
                                <td>${doc.serialNumber || 'N/A'}</td>
                                <td>${doc.customerName || 'N/A'}</td>
                                <td>${company?.name || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${dueDate}</td>
                                <td>${utils.formatCurrency(doc.total, doc.currency)}</td>
                                <td><span class="badge badge-info">${doc.status || 'Draft'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="documents.view('${doc.id}')">View</button>
                                    <button class="btn btn-sm btn-success" onclick="proforma.convert('${doc.id}')">Convert</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                // Update recent documents
                const recentBody = document.getElementById('recentDocumentsBody');
                if (recentBody) {
                    if (state.documents.length === 0) {
                        recentBody.innerHTML = '<tr><td colspan="8" class="text-center">No documents yet</td></tr>';
                        return;
                    }
                    
                    recentBody.innerHTML = state.documents.slice(0, 5).map(doc => {
                        const date = utils.formatDate(doc.createdAt);
                        const company = state.companies.find(c => c.id === doc.companyId);
                        const amount = utils.formatCurrency(doc.total || 0, doc.currency || 'USD');
                        return `
                            <tr>
                                <td><span class="badge badge-info">${doc.type || 'N/A'}</span></td>
                                <td>${doc.serialNumber || 'N/A'}</td>
                                <td>${doc.customerName || 'N/A'}</td>
                                <td>${company?.name || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${amount}</td>
                                <td><span class="badge ${doc.revoked ? 'badge-danger' : 'badge-success'}">${doc.revoked ? 'Revoked' : 'Active'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="documents.view('${doc.id}')">View</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            },

            updateDashboard: () => {
                const totalRevenue = state.documents
                    .filter(d => d.type === 'receipt')
                    .reduce((sum, d) => sum + (d.total || 0), 0);
                    
                const outstanding = state.documents
                    .filter(d => d.type === 'invoice')
                    .reduce((sum, d) => sum + ((d.total || 0) - (d.paidAmount || 0)), 0);
                    
                const now = new Date();
                const thisMonth = state.documents
                    .filter(d => {
                        const date = d.createdAt?.toDate?.();
                        return date && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                    })
                    .reduce((sum, d) => sum + (d.total || 0), 0);
                    
                const overdueInvoices = state.documents
                    .filter(d => d.type === 'invoice' && d.dueDate?.toDate?.() < now && (d.total || 0) > (d.paidAmount || 0)).length;
                    
                const paidInvoices = state.documents
                    .filter(d => d.type === 'invoice' && (d.paidAmount || 0) >= (d.total || 0)).length;
                    
                const pendingQuotes = state.documents
                    .filter(d => d.type === 'quote' && d.status === 'pending').length;
                    
                document.getElementById('totalRevenue').textContent = utils.formatCurrency(totalRevenue);
                document.getElementById('outstandingInvoices').textContent = utils.formatCurrency(outstanding);
                document.getElementById('totalReceipts').textContent = state.documents.filter(d => d.type === 'receipt').length;
                document.getElementById('activeContracts').textContent = state.contracts.filter(c => c.status === 'active').length;
                document.getElementById('monthlyRevenue').textContent = utils.formatCurrency(thisMonth);
                document.getElementById('overdueInvoices').textContent = overdueInvoices;
                document.getElementById('paidInvoices').textContent = paidInvoices;
                document.getElementById('pendingQuotes').textContent = pendingQuotes;
            }
        };

        // ==================== INVOICES ====================
        const invoices = {
            filter: (status, element) => {
                state.currentFilters.invoice = status;
                document.querySelectorAll('#invoicesSection .sub-tab').forEach(t => t.classList.remove('active'));
                element.classList.add('active');
                data.renderDocuments('invoice');
            }
        };

        // ==================== QUOTES ====================
        const quotes = {
            selectedIds: new Set(),
            
            toggleAll: () => {
                const checkboxes = document.querySelectorAll('#quotesBody .quote-select');
                const selectAll = document.getElementById('selectAllQuotes');
                checkboxes.forEach(cb => {
                    cb.checked = selectAll.checked;
                    if (selectAll.checked) {
                        quotes.selectedIds.add(cb.value);
                    } else {
                        quotes.selectedIds.delete(cb.value);
                    }
                });
            },
            
            updateSelection: () => {
                const checkboxes = document.querySelectorAll('#quotesBody .quote-select');
                quotes.selectedIds.clear();
                checkboxes.forEach(cb => {
                    if (cb.checked) quotes.selectedIds.add(cb.value);
                });
            },
            
            convertToInvoice: async () => {
                if (quotes.selectedIds.size === 0) {
                    alert('Please select quotes to convert');
                    return;
                }
                
                for (const id of quotes.selectedIds) {
                    await quotes.convert(id);
                }
                
                quotes.selectedIds.clear();
                await data.loadDocuments('quote');
                await data.loadDocuments('invoice');
            },
            
            convert: async (id) => {
                const quote = state.documents.find(d => d.id === id);
                if (!quote) return;
                
                const invoiceData = {
                    ...quote,
                    id: undefined,
                    type: 'invoice',
                    serialNumber: await utils.generateSerialNumber('invoice', quote.companyId),
                    status: 'pending',
                    paidAmount: 0,
                    payments: []
                };
                
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'documents'), invoiceData);
                    
                    // Mark quote as converted
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'documents', id), {
                        status: 'converted'
                    });
                    
                    utils.showAlert('', 'Quote converted to invoice successfully!', 'success');
                } catch (error) {
                    console.error('Convert error:', error);
                }
            }
        };

        // ==================== RECEIPTS ====================
        const receipts = {
            fromInvoice: (invoiceId = null) => {
                if (invoiceId) {
                    const invoice = state.documents.find(d => d.id === invoiceId);
                    if (invoice) {
                        ui.showDocumentModal('receipt');
                        setTimeout(() => {
                            document.getElementById('receiptInvoice').value = invoice.serialNumber;
                            document.getElementById('receiptReason').value = `Payment for Invoice ${invoice.serialNumber}`;
                            
                            // Copy items
                            const tbody = document.getElementById('itemsBody');
                            tbody.innerHTML = '';
                            invoice.items.forEach(item => {
                                const row = tbody.insertRow();
                                row.innerHTML = `
                                    <td><input type="text" class="form-control item-desc" value="${item.description || ''}"></td>
                                    <td><input type="number" class="form-control item-qty" value="${item.quantity || 1}" min="1" onchange="items.updateTotals()"></td>
                                    <td><input type="number" class="form-control item-price" value="${item.unitPrice || 0}" min="0" step="0.01" onchange="items.updateTotals()"></td>
                                    <td><input type="number" class="form-control item-discount" value="${item.discount || 0}" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                                    <td><input type="number" class="form-control item-tax" value="${item.tax || 0}" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                                    <td class="item-total">$0.00</td>
                                    <td><button class="btn btn-danger btn-sm" onclick="items.remove(this)">×</button></td>
                                `;
                            });
                            
                            items.updateTotals();
                        }, 100);
                        return;
                    }
                }
                
                // Show invoice selection modal
                const modal = document.getElementById('invoiceSelectModal');
                const list = document.getElementById('invoiceSelectList');
                
                const unpaidInvoices = state.documents.filter(d => 
                    d.type === 'invoice' && 
                    (d.total || 0) > (d.paidAmount || 0)
                );
                
                list.innerHTML = unpaidInvoices.map(inv => {
                    const balance = (inv.total || 0) - (inv.paidAmount || 0);
                    return `
                        <div class="card" onclick="receipts.fromInvoice('${inv.id}'); ui.closeModal('invoiceSelectModal')">
                            <h4>${inv.serialNumber}</h4>
                            <p>Client: ${inv.customerName}</p>
                            <p>Total: ${utils.formatCurrency(inv.total, inv.currency)}</p>
                            <p>Balance: ${utils.formatCurrency(balance, inv.currency)}</p>
                            <p>Due: ${utils.formatDate(inv.dueDate)}</p>
                        </div>
                    `;
                }).join('');
                
                if (unpaidInvoices.length === 0) {
                    list.innerHTML = '<p class="text-center">No unpaid invoices found</p>';
                }
                
                ui.openModal('invoiceSelectModal');
            }
        };

        // ==================== PROFORMA ====================
        const proforma = {
            selectedIds: new Set(),
            
            toggleAll: () => {
                const checkboxes = document.querySelectorAll('#proformaBody .proforma-select');
                const selectAll = document.getElementById('selectAllProforma');
                checkboxes.forEach(cb => {
                    cb.checked = selectAll.checked;
                    if (selectAll.checked) {
                        proforma.selectedIds.add(cb.value);
                    } else {
                        proforma.selectedIds.delete(cb.value);
                    }
                });
            },
            
            updateSelection: () => {
                const checkboxes = document.querySelectorAll('#proformaBody .proforma-select');
                proforma.selectedIds.clear();
                checkboxes.forEach(cb => {
                    if (cb.checked) proforma.selectedIds.add(cb.value);
                });
            },
            
            convertSelectedToInvoice: async () => {
                if (proforma.selectedIds.size === 0) {
                    alert('Please select proforma invoices to convert');
                    return;
                }
                
                for (const id of proforma.selectedIds) {
                    await proforma.convert(id);
                }
                
                proforma.selectedIds.clear();
                await data.loadDocuments('proforma');
                await data.loadDocuments('invoice');
            },
            
            convert: async (id) => {
                const proformaDoc = state.documents.find(d => d.id === id);
                if (!proformaDoc) return;
                
                const invoiceData = {
                    ...proformaDoc,
                    id: undefined,
                    type: 'invoice',
                    serialNumber: await utils.generateSerialNumber('invoice', proformaDoc.companyId),
                    status: 'pending',
                    paidAmount: 0,
                    payments: []
                };
                
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'documents'), invoiceData);
                    
                    // Mark proforma as converted
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'documents', id), {
                        status: 'converted'
                    });
                    
                    utils.showAlert('', 'Proforma converted to invoice successfully!', 'success');
                } catch (error) {
                    console.error('Convert error:', error);
                }
            }
        };

        // ==================== CONTRACTS ====================
        const contracts = {
            filter: (status, element) => {
                state.currentFilters.contract = status;
                document.querySelectorAll('#contractsSection .sub-tab').forEach(t => t.classList.remove('active'));
                element.classList.add('active');
                contracts.render();
            },
            
            render: () => {
                const tbody = document.getElementById('contractsBody');
                if (!tbody) return;
                
                let filtered = state.contracts;
                if (state.currentFilters.contract !== 'all') {
                    filtered = filtered.filter(c => c.status === state.currentFilters.contract);
                }
                
                // Check for expired contracts
                const now = new Date();
                filtered.forEach(contract => {
                    if (contract.status === 'active' && contract.endDate?.toDate?.() < now) {
                        contract.status = 'expired';
                    }
                });
                
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center">No contracts found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = filtered.map(contract => {
                    const start = utils.formatDate(contract.startDate);
                    const end = utils.formatDate(contract.endDate);
                    const company = state.companies.find(c => c.id === contract.companyId);
                    const client = state.clients.find(c => c.id === contract.clientId);
                    
                    let statusClass = 'warning';
                    if (contract.status === 'active') statusClass = 'success';
                    if (contract.status === 'expired') statusClass = 'danger';
                    
                    return `
                        <tr>
                            <td>${contract.contractNumber || 'N/A'}</td>
                            <td>${contract.title || 'N/A'}</td>
                            <td>${contract.type || 'N/A'}</td>
                            <td>${company?.name || contract.partyA}</td>
                            <td>${client?.name || contract.partyBName}</td>
                            <td>${start}</td>
                            <td>${end}</td>
                            <td>${utils.formatCurrency(contract.value || 0)}</td>
                            <td><span class="badge badge-${statusClass}">${contract.status || 'Draft'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="contracts.view('${contract.id}')">View</button>
                                <button class="btn btn-sm btn-success" onclick="pdf.fromContract('${contract.id}')">PDF</button>
                                ${contract.status === 'draft' ? `<button class="btn btn-sm btn-danger" onclick="contracts.sign('${contract.id}')">Sign</button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            addClause: (title = '', content = '') => {
                const list = document.getElementById('clausesList');
                
                const div = document.createElement('div');
                div.className = 'clause-item';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Clause Title" value="${title}" style="width: 70%;">
                        <button class="btn btn-danger btn-sm" onclick="this.closest('.clause-item').remove()">Remove</button>
                    </div>
                    <textarea class="form-control" rows="3" placeholder="Clause content...">${content}</textarea>
                `;
                
                list.appendChild(div);
            },
            
            loadTemplate: () => {
                const templateId = document.getElementById('contractTemplate').value;
                const template = state.templates.contract.find(t => t.id === templateId);
                if (!template) return;
                
                document.getElementById('contractTitle').value = template.title || '';
                document.getElementById('contractType').value = template.type || 'service';
                document.getElementById('governingLaw').value = template.governingLaw || 'Laws of Kenya';
                document.getElementById('disputeResolution').value = template.disputeResolution || 'court';
                
                // Load clauses
                const list = document.getElementById('clausesList');
                list.innerHTML = '';
                (template.clauses || []).forEach(clause => {
                    contracts.addClause(clause.title, clause.content);
                });
            },
            
            save: async () => {
                const companyId = document.getElementById('contractCompany').value;
                const clientId = document.getElementById('contractClient').value;
                const title = document.getElementById('contractTitle').value.trim();
                
                if (!companyId || !clientId || !title) {
                    utils.showAlert('contractAlert', 'Please fill all required fields', 'danger');
                    return;
                }
                
                const company = state.companies.find(c => c.id === companyId);
                const client = state.clients.find(c => c.id === clientId);
                
                // Collect clauses
                const clauses = [];
                document.querySelectorAll('#clausesList .clause-item').forEach(item => {
                    const titleInput = item.querySelector('input');
                    const contentInput = item.querySelector('textarea');
                    if (titleInput.value && contentInput.value) {
                        clauses.push({
                            title: titleInput.value,
                            content: contentInput.value
                        });
                    }
                });

                const contractData = {
                    contractNumber: await utils.generateSerialNumber('contract', companyId),
                    title,
                    type: document.getElementById('contractType').value,
                    companyId,
                    partyA: company.name,
                    clientId,
                    partyBName: client.name,
                    partyBEmail: client.email || '',
                    partyBPhone: client.phone || '',
                    partyBAddress: client.address || '',
                    startDate: document.getElementById('contractStart').value ? window.firebase.Timestamp.fromDate(new Date(document.getElementById('contractStart').value)) : null,
                    endDate: document.getElementById('contractEnd').value ? window.firebase.Timestamp.fromDate(new Date(document.getElementById('contractEnd').value)) : null,
                    value: parseFloat(document.getElementById('contractValue').value) || 0,
                    clauses,
                    specialConditions: document.getElementById('specialConditions').value,
                    governingLaw: document.getElementById('governingLaw').value,
                    disputeResolution: document.getElementById('disputeResolution').value,
                    status: 'draft',
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now()
                };

                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'contracts'), contractData);
                    utils.showAlert('contractAlert', 'Contract saved successfully!', 'success');
                    ui.closeModal('contractModal');
                    await data.loadContracts();
                } catch (error) {
                    utils.showAlert('contractAlert', error.message, 'danger');
                }
            },
            
            saveAsTemplate: () => {
                ui.openModal('contractTemplateModal');
            },
            
            view: (id) => {
                const contract = state.contracts.find(c => c.id === id);
                if (!contract) return;
                
                const preview = document.getElementById('previewContent');
                const company = state.companies.find(c => c.id === contract.companyId);
                const client = state.clients.find(c => c.id === contract.clientId);
                
                preview.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px; color: ${company?.color || '#2563eb'};">
                        <h1>${contract.title}</h1>
                        <p>Contract No: ${contract.contractNumber}</p>
                        <p>Date: ${utils.formatDate(contract.createdAt)}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px; padding: 20px; background: var(--light); border-radius: 8px;">
                        <h3 style="color: ${company?.color || '#2563eb'};">THIS AGREEMENT</h3>
                        <p>is made on this day ${utils.formatDate(contract.startDate)}</p>
                        <p><strong>BETWEEN:</strong> ${contract.partyA} (hereinafter "Party A")</p>
                        <p><strong>AND:</strong> ${contract.partyBName} (hereinafter "Party B")</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: ${company?.color || '#2563eb'};">TERM</h3>
                        <p><strong>Start Date:</strong> ${utils.formatDate(contract.startDate)}</p>
                        <p><strong>End Date:</strong> ${utils.formatDate(contract.endDate) || 'Indefinite'}</p>
                        ${contract.value ? `<p><strong>Contract Value:</strong> ${utils.formatCurrency(contract.value)}</p>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: ${company?.color || '#2563eb'};">CLAUSES</h3>
                        ${(contract.clauses || []).map((clause, index) => `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: ${company?.color || '#2563eb'};">${index + 1}. ${clause.title}</h4>
                                <p>${clause.content}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${contract.specialConditions ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: ${company?.color || '#2563eb'};">SPECIAL CONDITIONS</h3>
                            <p>${contract.specialConditions}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: ${company?.color || '#2563eb'};">GOVERNING LAW</h3>
                        <p>This agreement shall be governed by and construed in accordance with the laws of ${contract.governingLaw}.</p>
                        <p>Disputes shall be resolved through ${contract.disputeResolution || 'court jurisdiction'}.</p>
                    </div>
                    
                    <div class="signature-box" style="display: flex; justify-content: space-between; margin-top: 50px;">
                        <div style="text-align: center; width: 45%;">
                            <p><strong>SIGNED for and on behalf of ${contract.partyA}</strong></p>
                            <div style="margin-top: 40px;">
                                <p>_________________________</p>
                                <p>Authorized Signature</p>
                                <p>Date: _______________</p>
                            </div>
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <p><strong>SIGNED for and on behalf of ${contract.partyBName}</strong></p>
                            <div style="margin-top: 40px;">
                                <p>_________________________</p>
                                <p>Authorized Signature</p>
                                <p>Date: _______________</p>
                            </div>
                        </div>
                    </div>
                `;
                
                ui.openModal('previewModal');
            },
            
            sign: async (id) => {
                if (!confirm('Sign this contract? This action cannot be undone.')) return;
                
                try {
                    const contractRef = window.firebase.doc(window.firebase.db, 'contracts', id);
                    await window.firebase.updateDoc(contractRef, {
                        status: 'active',
                        signedAt: window.firebase.Timestamp.now()
                    });
                    await data.loadContracts();
                    alert('Contract signed successfully!');
                } catch (error) {
                    console.error('Sign error:', error);
                    alert('Error signing contract: ' + error.message);
                }
            },
            
            showClauseLibrary: () => {
                const modal = document.getElementById('clauseLibraryModal');
                const list = document.getElementById('clauseLibraryList');
                
                if (state.templates.clause.length === 0) {
                    list.innerHTML = '<p class="text-center">No clauses in library yet</p>';
                } else {
                    list.innerHTML = state.templates.clause.map(clause => `
                        <div class="card" onclick="contracts.addClause('${clause.title.replace(/'/g, "\\'")}', '${clause.content.replace(/'/g, "\\'").replace(/\n/g, '\\n')}'); ui.closeModal('clauseLibraryModal')">
                            <h4>${clause.title}</h4>
                            <p>${clause.content.substring(0, 100)}...</p>
                        </div>
                    `).join('');
                }
                
                ui.openModal('clauseLibraryModal');
            }
        };

        // ==================== TEMPLATES ====================
        const templates = {
            loadAll: async () => {
                await templates.loadContractTemplates();
                await templates.loadDocumentTemplates();
                await templates.loadStandardClauses();
            },
            
            loadContractTemplates: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'contractTemplates'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.templates.contract = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Update contract template select
                    const select = document.getElementById('contractTemplate');
                    if (select) {
                        select.innerHTML = '<option value="">Select Template</option>';
                        state.templates.contract.forEach(template => {
                            select.innerHTML += `<option value="${template.id}">${template.name || 'Unnamed'}</option>`;
                        });
                    }
                    
                    templates.renderContractTemplates();
                } catch (error) {
                    console.error('Load contract templates error:', error);
                }
            },
            
            loadDocumentTemplates: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'documentTemplates'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.templates.document = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    templates.renderDocumentTemplates();
                } catch (error) {
                    console.error('Load document templates error:', error);
                }
            },
            
            loadStandardClauses: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'standardClauses'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.templates.clause = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    templates.renderStandardClauses();
                } catch (error) {
                    console.error('Load standard clauses error:', error);
                }
            },
            
            renderContractTemplates: () => {
                const grid = document.getElementById('contractTemplatesGrid');
                if (!grid) return;
                
                if (state.templates.contract.length === 0) {
                    grid.innerHTML = '<p class="text-center">No contract templates yet</p>';
                    return;
                }
                
                grid.innerHTML = state.templates.contract.map(template => `
                    <div class="card" onclick="templates.useContractTemplate('${template.id}')">
                        <h4>${template.name || 'Unnamed'}</h4>
                        <p>${template.description || ''}</p>
                        <p>Category: ${template.category || 'General'}</p>
                        <p>Clauses: ${template.clauses?.length || 0}</p>
                    </div>
                `).join('');
            },
            
            renderDocumentTemplates: () => {
                const grid = document.getElementById('documentTemplatesGrid');
                if (!grid) return;
                
                if (state.templates.document.length === 0) {
                    grid.innerHTML = '<p class="text-center">No document templates yet</p>';
                    return;
                }
                
                grid.innerHTML = state.templates.document.map(template => `
                    <div class="card" onclick="templates.useDocumentTemplate('${template.id}')">
                        <h4>${template.name || 'Unnamed'}</h4>
                        <p>${template.description || ''}</p>
                        <p>Type: ${template.documentType || 'General'}</p>
                    </div>
                `).join('');
            },
            
            renderStandardClauses: () => {
                const grid = document.getElementById('standardClausesGrid');
                if (!grid) return;
                
                if (state.templates.clause.length === 0) {
                    grid.innerHTML = '<p class="text-center">No standard clauses yet</p>';
                    return;
                }
                
                grid.innerHTML = state.templates.clause.map(clause => `
                    <div class="card">
                        <h4>${clause.title || 'Unnamed'}</h4>
                        <p>${clause.content ? clause.content.substring(0, 100) : ''}...</p>
                    </div>
                `).join('');
            },
            
            showTab: (tab, element) => {
                document.querySelectorAll('#templatesSection .sub-tab').forEach(t => t.classList.remove('active'));
                element.classList.add('active');
                
                document.querySelectorAll('.template-tab').forEach(t => t.classList.add('hidden'));
                document.getElementById(tab + 'TemplatesTab').classList.remove('hidden');
            },
            
            showContractTemplateModal: () => {
                document.getElementById('templateName').value = '';
                document.getElementById('templateDescription').value = '';
                document.getElementById('templateCategory').value = 'service';
                ui.openModal('contractTemplateModal');
            },
            
            showDocumentTemplateModal: () => {
                document.getElementById('docTemplateName').value = '';
                document.getElementById('docTemplateDescription').value = '';
                document.getElementById('docTemplateType').value = 'invoice';
                document.getElementById('docTemplateContent').value = '';
                ui.openModal('documentTemplateModal');
            },
            
            showClauseModal: () => {
                document.getElementById('clauseTitle').value = '';
                document.getElementById('clauseContent').value = '';
                document.getElementById('clauseCategory').value = 'general';
                ui.openModal('clauseModal');
            },
            
            saveContractTemplate: async () => {
                const name = document.getElementById('templateName').value.trim();
                if (!name) {
                    utils.showAlert('templateAlert', 'Template name is required', 'danger');
                    return;
                }
                
                // Collect clauses from current contract form
                const clauses = [];
                document.querySelectorAll('#clausesList .clause-item').forEach(item => {
                    const titleInput = item.querySelector('input');
                    const contentInput = item.querySelector('textarea');
                    if (titleInput.value && contentInput.value) {
                        clauses.push({
                            title: titleInput.value,
                            content: contentInput.value
                        });
                    }
                });
                
                const templateData = {
                    name,
                    description: document.getElementById('templateDescription').value,
                    category: document.getElementById('templateCategory').value,
                    type: document.getElementById('contractType').value,
                    clauses,
                    governingLaw: document.getElementById('governingLaw').value,
                    disputeResolution: document.getElementById('disputeResolution').value,
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now()
                };
                
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'contractTemplates'), templateData);
                    utils.showAlert('templateAlert', 'Template saved successfully!', 'success');
                    ui.closeModal('contractTemplateModal');
                    await templates.loadContractTemplates();
                } catch (error) {
                    utils.showAlert('templateAlert', error.message, 'danger');
                }
            },
            
            saveDocumentTemplate: async () => {
                const name = document.getElementById('docTemplateName').value.trim();
                if (!name) {
                    utils.showAlert('docTemplateAlert', 'Template name is required', 'danger');
                    return;
                }
                
                const templateData = {
                    name,
                    description: document.getElementById('docTemplateDescription').value,
                    documentType: document.getElementById('docTemplateType').value,
                    content: document.getElementById('docTemplateContent').value,
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now()
                };
                
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'documentTemplates'), templateData);
                    utils.showAlert('docTemplateAlert', 'Template saved successfully!', 'success');
                    ui.closeModal('documentTemplateModal');
                    await templates.loadDocumentTemplates();
                } catch (error) {
                    utils.showAlert('docTemplateAlert', error.message, 'danger');
                }
            },
            
            saveClause: async () => {
                const title = document.getElementById('clauseTitle').value.trim();
                const content = document.getElementById('clauseContent').value.trim();
                
                if (!title || !content) {
                    utils.showAlert('clauseModalAlert', 'Title and content are required', 'danger');
                    return;
                }
                
                const clauseData = {
                    title,
                    content,
                    category: document.getElementById('clauseCategory').value,
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now()
                };
                
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'standardClauses'), clauseData);
                    utils.showAlert('clauseModalAlert', 'Clause saved successfully!', 'success');
                    ui.closeModal('clauseModal');
                    await templates.loadStandardClauses();
                } catch (error) {
                    utils.showAlert('clauseModalAlert', error.message, 'danger');
                }
            },
            
            useContractTemplate: (id) => {
                const template = state.templates.contract.find(t => t.id === id);
                if (template) {
                    ui.showContractModal();
                    setTimeout(() => {
                        document.getElementById('contractTemplate').value = id;
                        contracts.loadTemplate();
                    }, 100);
                }
            },
            
            useDocumentTemplate: (id) => {
                const template = state.templates.document.find(t => t.id === id);
                if (template && template.documentType) {
                    ui.showDocumentModal(template.documentType);
                    setTimeout(() => {
                        if (template.content) {
                            document.getElementById('documentNotes').value = template.content;
                        }
                    }, 100);
                }
            }
        };

        // ==================== PAYMENTS ====================
        const payments = {
            forInvoice: (invoiceId) => {
                const invoice = state.documents.find(d => d.id === invoiceId);
                if (!invoice) return;
                
                // Populate invoice select
                const select = document.getElementById('paymentInvoice');
                select.innerHTML = '<option value="">Select Invoice</option>';
                state.documents
                    .filter(d => d.type === 'invoice' && (d.total || 0) > (d.paidAmount || 0))
                    .forEach(inv => {
                        select.innerHTML += `<option value="${inv.id}" ${inv.id === invoiceId ? 'selected' : ''}>${inv.serialNumber} - ${inv.customerName}</option>`;
                    });
                
                document.getElementById('paymentAmount').value = ((invoice.total || 0) - (invoice.paidAmount || 0)).toFixed(2);
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                
                ui.openModal('paymentModal');
            },
            
            record: async () => {
                const invoiceId = document.getElementById('paymentInvoice').value;
                const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
                const date = document.getElementById('paymentDate').value;
                const method = document.getElementById('paymentMethod').value;
                const reference = document.getElementById('paymentReference').value;
                const notes = document.getElementById('paymentNotes').value;
                
                if (!invoiceId || amount <= 0) {
                    utils.showAlert('paymentAlert', 'Please select an invoice and enter a valid amount', 'danger');
                    return;
                }
                
                const invoice = state.documents.find(d => d.id === invoiceId);
                const newPaidAmount = (invoice.paidAmount || 0) + amount;
                
                const payment = {
                    amount,
                    date,
                    method,
                    reference,
                    notes,
                    recordedAt: window.firebase.Timestamp.now()
                };
                
                try {
                    // Update invoice
                    const invoiceRef = window.firebase.doc(window.firebase.db, 'documents', invoiceId);
                    await window.firebase.updateDoc(invoiceRef, {
                        paidAmount: newPaidAmount,
                        payments: window.firebase.arrayUnion(payment)
                    });
                    
                    // Create receipt
                    const receiptData = {
                        type: 'receipt',
                        serialNumber: await utils.generateSerialNumber('receipt', invoice.companyId),
                        currency: invoice.currency,
                        companyId: invoice.companyId,
                        customerId: invoice.customerId,
                        customerName: invoice.customerName,
                        customerEmail: invoice.customerEmail,
                        items: [{
                            description: `Payment for Invoice ${invoice.serialNumber}`,
                            quantity: 1,
                            unitPrice: amount,
                            total: amount
                        }],
                        subtotal: amount,
                        total: amount,
                        receiptReason: `Payment for Invoice ${invoice.serialNumber}`,
                        referenceInvoice: invoice.serialNumber,
                        paymentMethod: method,
                        userId: state.currentUser.uid,
                        createdAt: window.firebase.Timestamp.now()
                    };
                    
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'documents'), receiptData);
                    
                    utils.showAlert('paymentAlert', 'Payment recorded successfully!', 'success');
                    ui.closeModal('paymentModal');
                    await data.loadDocuments('invoice');
                    await data.loadDocuments('receipt');
                } catch (error) {
                    utils.showAlert('paymentAlert', error.message, 'danger');
                }
            }
        };

        // ==================== DOCUMENTS ====================
        const documents = {
            currentType: null,
            
            updateCompanyColors: () => {
                const companyId = document.getElementById('docCompany').value;
                const company = state.companies.find(c => c.id === companyId);
                if (company?.color) {
                    document.documentElement.style.setProperty('--primary', company.color);
                }
            },
            
            save: async () => {
                const companyId = document.getElementById('docCompany').value;
                const clientId = document.getElementById('docClient').value;
                
                if (!companyId || !clientId) {
                    utils.showAlert('documentAlert', 'Please select company and client', 'danger');
                    return;
                }
                
                const company = state.companies.find(c => c.id === companyId);
                const client = state.clients.find(c => c.id === clientId);

                const items = [];
                let subtotal = 0;
                let totalDiscount = 0;
                let totalTax = 0;
                
                document.querySelectorAll('#itemsBody tr').forEach(row => {
                    const desc = row.querySelector('.item-desc')?.value;
                    if (desc && desc.trim()) {
                        const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                        const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                        const discountPercent = parseFloat(row.querySelector('.item-discount')?.value) || 0;
                        const taxPercent = parseFloat(row.querySelector('.item-tax')?.value) || 0;
                        
                        const itemSubtotal = qty * price;
                        const itemDiscount = itemSubtotal * (discountPercent / 100);
                        const afterDiscount = itemSubtotal - itemDiscount;
                        const itemTax = afterDiscount * (taxPercent / 100);
                        const total = afterDiscount + itemTax;
                        
                        items.push({
                            description: desc,
                            quantity: qty,
                            unitPrice: price,
                            discount: discountPercent,
                            tax: taxPercent,
                            subtotal: itemSubtotal,
                            discountAmount: itemDiscount,
                            taxAmount: itemTax,
                            total
                        });
                        
                        subtotal += itemSubtotal;
                        totalDiscount += itemDiscount;
                        totalTax += itemTax;
                    }
                });

                if (items.length === 0) {
                    utils.showAlert('documentAlert', 'Please add at least one item', 'danger');
                    return;
                }

                const grandTotal = subtotal - totalDiscount + totalTax;

                const docData = {
                    type: documents.currentType,
                    serialNumber: await utils.generateSerialNumber(documents.currentType, companyId),
                    currency: document.getElementById('docCurrency').value,
                    companyId,
                    companyName: company.name,
                    customerId: clientId,
                    customerName: client.name,
                    customerEmail: client.email || '',
                    customerPhone: client.phone || '',
                    customerAddress: client.address || '',
                    items,
                    subtotal,
                    totalDiscount,
                    totalTax,
                    total: grandTotal,
                    dueDate: document.getElementById('docDueDate').value ? window.firebase.Timestamp.fromDate(new Date(document.getElementById('docDueDate').value)) : null,
                    notes: document.getElementById('documentNotes').value,
                    terms: document.getElementById('documentTerms').value,
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now(),
                    status: 'pending',
                    paidAmount: 0,
                    payments: []
                };

                if (documents.currentType === 'receipt') {
                    docData.receiptReason = document.getElementById('receiptReason').value || 'Payment';
                    docData.receiptDate = window.firebase.Timestamp.fromDate(new Date());
                    docData.paymentMethod = document.getElementById('receiptPaymentMethod').value;
                    docData.referenceInvoice = document.getElementById('receiptInvoice').value;
                }

                const btn = document.getElementById('saveDocBtn');
                btn.disabled = true;
                document.getElementById('docSpinner').classList.remove('hidden');

                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'documents'), docData);
                    utils.showAlert('documentAlert', 'Document saved successfully!', 'success');
                    ui.closeModal('documentModal');
                    await data.loadDocuments(documents.currentType);
                } catch (error) {
                    utils.showAlert('documentAlert', error.message, 'danger');
                } finally {
                    btn.disabled = false;
                    document.getElementById('docSpinner').classList.add('hidden');
                }
            },

            view: (id) => {
                const doc = state.documents.find(d => d.id === id);
                if (!doc) return;
                
                const company = state.companies.find(c => c.id === doc.companyId);
                const preview = document.getElementById('previewContent');
                const symbol = doc.currency === 'KSH' ? 'KSh' : doc.currency === 'USD' ? '$' : doc.currency === 'EUR' ? '€' : '£';
                
                const paidAmount = doc.paidAmount || 0;
                const total = doc.total || 0;
                const balance = total - paidAmount;
                const paidPercent = total > 0 ? (paidAmount / total) * 100 : 0;
                
                preview.innerHTML = `
                    ${doc.revoked ? '<div class="watermark">REVOKED</div>' : ''}
                    
                    <div style="text-align: center; margin-bottom: 30px; color: ${company?.color || '#2563eb'};">
                        <h1>${(doc.type || 'DOCUMENT').toUpperCase()}</h1>
                        <p style="font-size: 1.2rem;">${doc.serialNumber || 'N/A'}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div>
                            <h3 style="color: ${company?.color || '#2563eb'};">From:</h3>
                            <p><strong>${company?.name || 'STARKS GALAXY LIMITED'}</strong></p>
                            <p>${company?.address || ''}</p>
                            <p>${company?.email || ''}</p>
                            <p>${company?.phone || ''}</p>
                            ${company?.taxId ? `<p>Tax ID: ${company.taxId}</p>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <h3 style="color: ${company?.color || '#2563eb'};">To:</h3>
                            <p><strong>${doc.customerName || ''}</strong></p>
                            <p>${doc.customerEmail || ''}</p>
                            <p>${doc.customerPhone || ''}</p>
                            <p>${doc.customerAddress || ''}</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--light); padding: 15px; border-radius: 8px;">
                        <div>
                            <p><strong>Date:</strong> ${utils.formatDate(doc.createdAt)}</p>
                            ${doc.dueDate ? `<p><strong>Due Date:</strong> ${utils.formatDate(doc.dueDate)}</p>` : ''}
                        </div>
                        <div>
                            <p><strong>Currency:</strong> ${doc.currency || 'USD'}</p>
                            ${doc.type === 'receipt' ? `<p><strong>Payment Method:</strong> ${doc.paymentMethod || 'N/A'}</p>` : ''}
                        </div>
                    </div>
                    
                    ${doc.type === 'invoice' ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${paidPercent}%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <span>Paid: ${symbol}${paidAmount.toFixed(2)}</span>
                            <span>Balance: ${symbol}${balance.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: ${company?.color || '#2563eb'}; color: white;">
                                <th style="padding: 12px; text-align: left;">Description</th>
                                <th style="padding: 12px; text-align: right;">Qty</th>
                                <th style="padding: 12px; text-align: right;">Unit Price</th>
                                <th style="padding: 12px; text-align: right;">Discount</th>
                                <th style="padding: 12px; text-align: right;">Tax</th>
                                <th style="padding: 12px; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(doc.items || []).map(item => `
                                <tr>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border);">${item.description || ''}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${item.quantity || 0}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${symbol}${(item.unitPrice || 0).toFixed(2)}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${item.discount || 0}%</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${item.tax || 0}%</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${symbol}${(item.total || 0).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" style="padding: 10px; text-align: right;"><strong>Subtotal:</strong></td>
                                <td style="padding: 10px; text-align: right;">${symbol}${(doc.subtotal || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="5" style="padding: 10px; text-align: right;"><strong>Total Discount:</strong></td>
                                <td style="padding: 10px; text-align: right;">-${symbol}${(doc.totalDiscount || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="5" style="padding: 10px; text-align: right;"><strong>Total Tax:</strong></td>
                                <td style="padding: 10px; text-align: right;">${symbol}${(doc.totalTax || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="5" style="padding: 10px; text-align: right;"><strong>Grand Total:</strong></td>
                                <td style="padding: 10px; text-align: right;"><strong>${symbol}${(doc.total || 0).toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    ${doc.notes ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: ${company?.color || '#2563eb'};">Notes:</h3>
                            <p>${doc.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: ${company?.color || '#2563eb'};">Terms & Conditions:</h3>
                        <p>${doc.terms || 'Payment is due within 30 days.'}</p>
                    </div>
                    
                    ${doc.payments && doc.payments.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: ${company?.color || '#2563eb'};">Payment History:</h3>
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Method</th>
                                        <th>Reference</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${doc.payments.map(p => `
                                        <tr>
                                            <td>${utils.formatDate(p.date)}</td>
                                            <td>${p.method || ''}</td>
                                            <td>${p.reference || '-'}</td>
                                            <td>${symbol}${(p.amount || 0).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 50px; text-align: center;">
                        <p style="color: ${company?.color || '#2563eb'};"><strong>Thank you for your business!</strong></p>
                        <p>For inquiries, please contact ${company?.email || 'support@starksgalaxy.com'}</p>
                    </div>
                `;
                
                ui.openModal('previewModal');
            }
        };

        // ==================== PDF GENERATION ====================
        const pdf = {
            generate: async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    const element = document.getElementById('previewContent');
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const ratio = canvas.width / canvas.height;
                    let imgWidth = pdfWidth - 20;
                    let imgHeight = imgWidth / ratio;
                    
                    if (imgHeight > pdfHeight - 20) {
                        imgHeight = pdfHeight - 20;
                        imgWidth = imgHeight * ratio;
                    }
                    
                    const x = (pdfWidth - imgWidth) / 2;
                    const y = (pdfHeight - imgHeight) / 2;
                    
                    pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
                    pdf.save('document.pdf');
                    
                } catch (error) {
                    console.error('PDF error:', error);
                    alert('PDF generation failed. Please try again.');
                }
            },
            
            print: () => {
                window.print();
            },
            
            fromDocument: (id) => {
                documents.view(id);
                setTimeout(() => pdf.generate(), 500);
            },
            
            fromContract: (id) => {
                contracts.view(id);
                setTimeout(() => pdf.generate(), 500);
            }
        };

        // ==================== ITEMS MANAGEMENT ====================
        const items = {
            add: () => {
                const tbody = document.getElementById('itemsBody');
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                    <td><input type="number" class="form-control item-qty" value="1" min="1" onchange="items.updateTotals()"></td>
                    <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01" onchange="items.updateTotals()"></td>
                    <td><input type="number" class="form-control item-discount" value="0" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                    <td><input type="number" class="form-control item-tax" value="0" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                    <td class="item-total">$0.00</td>
                    <td><button class="btn btn-danger btn-sm" onclick="items.remove(this)">×</button></td>
                `;
                items.updateTotals();
            },
            
            remove: (btn) => {
                btn.closest('tr').remove();
                items.updateTotals();
            },
            
            updateTotals: () => {
                const currency = document.getElementById('docCurrency').value;
                const symbol = currency === 'KSH' ? 'KSh' : currency === 'USD' ? '$' : currency === 'EUR' ? '€' : '£';
                
                let subtotal = 0;
                let totalDiscount = 0;
                let totalTax = 0;
                
                document.querySelectorAll('#itemsBody tr').forEach(row => {
                    const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                    const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                    const discountPercent = parseFloat(row.querySelector('.item-discount')?.value) || 0;
                    const taxPercent = parseFloat(row.querySelector('.item-tax')?.value) || 0;
                    
                    const itemSubtotal = qty * price;
                    const itemDiscount = itemSubtotal * (discountPercent / 100);
                    const afterDiscount = itemSubtotal - itemDiscount;
                    const itemTax = afterDiscount * (taxPercent / 100);
                    const total = afterDiscount + itemTax;
                    
                    subtotal += itemSubtotal;
                    totalDiscount += itemDiscount;
                    totalTax += itemTax;
                    
                    row.querySelector('.item-total').textContent = symbol + total.toFixed(2);
                });
                
                const grandTotal = subtotal - totalDiscount + totalTax;
                
                document.getElementById('subtotal').textContent = symbol + subtotal.toFixed(2);
                document.getElementById('totalDiscount').textContent = '-' + symbol + totalDiscount.toFixed(2);
                document.getElementById('totalTax').textContent = symbol + totalTax.toFixed(2);
                document.getElementById('grandTotal').textContent = symbol + grandTotal.toFixed(2);
            }
        };

        // ==================== REPORTS ====================
        const reports = {
            generate: () => {
                const type = document.getElementById('reportType').value;
                const range = document.getElementById('dateRange').value;
                
                let html = '<h3>Report Results</h3>';
                
                if (type === 'revenue') {
                    const now = new Date();
                    let startDate;
                    
                    if (range === 'month') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    } else if (range === 'quarter') {
                        const quarter = Math.floor(now.getMonth() / 3);
                        startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    } else {
                        startDate = new Date(now.getFullYear(), 0, 1);
                    }
                    
                    const receipts = state.documents.filter(d => 
                        d.type === 'receipt' && 
                        d.createdAt?.toDate?.() >= startDate
                    );
                    
                    const total = receipts.reduce((sum, d) => sum + (d.total || 0), 0);
                    
                    // Update report stats
                    document.getElementById('totalRevenueReport').textContent = utils.formatCurrency(total);
                    document.getElementById('paidReport').textContent = utils.formatCurrency(total);
                    
                    html += `
                        <p>Total Revenue: ${utils.formatCurrency(total)}</p>
                        <p>Number of Receipts: ${receipts.length}</p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Receipt No</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${receipts.map(r => `
                                    <tr>
                                        <td>${utils.formatDate(r.createdAt)}</td>
                                        <td>${r.serialNumber}</td>
                                        <td>${r.customerName}</td>
                                        <td>${utils.formatCurrency(r.total, r.currency)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (type === 'outstanding') {
                    const invoices = state.documents.filter(d => 
                        d.type === 'invoice' && 
                        (d.total || 0) > (d.paidAmount || 0)
                    );
                    
                    const total = invoices.reduce((sum, d) => sum + ((d.total || 0) - (d.paidAmount || 0)), 0);
                    
                    // Update report stats
                    document.getElementById('outstandingReport').textContent = utils.formatCurrency(total);
                    
                    const now = new Date();
                    const overdue = invoices.filter(i => i.dueDate?.toDate?.() < now);
                    const overdueTotal = overdue.reduce((sum, d) => sum + ((d.total || 0) - (d.paidAmount || 0)), 0);
                    document.getElementById('overdueReport').textContent = utils.formatCurrency(overdueTotal);
                    
                    html += `
                        <p>Total Outstanding: ${utils.formatCurrency(total)}</p>
                        <p>Number of Unpaid Invoices: ${invoices.length}</p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Invoice No</th>
                                    <th>Client</th>
                                    <th>Due Date</th>
                                    <th>Total</th>
                                    <th>Paid</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoices.map(i => {
                                    const balance = (i.total || 0) - (i.paidAmount || 0);
                                    return `
                                        <tr>
                                            <td>${i.serialNumber}</td>
                                            <td>${i.customerName}</td>
                                            <td>${utils.formatDate(i.dueDate)}</td>
                                            <td>${utils.formatCurrency(i.total, i.currency)}</td>
                                            <td>${utils.formatCurrency(i.paidAmount, i.currency)}</td>
                                            <td>${utils.formatCurrency(balance, i.currency)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (type === 'client') {
                    // Group by client
                    const clientTotals = {};
                    state.documents.forEach(doc => {
                        if (doc.type === 'invoice') {
                            if (!clientTotals[doc.customerName]) {
                                clientTotals[doc.customerName] = {
                                    totalInvoiced: 0,
                                    totalPaid: 0,
                                    lastInvoice: null
                                };
                            }
                            clientTotals[doc.customerName].totalInvoiced += doc.total || 0;
                            clientTotals[doc.customerName].totalPaid += doc.paidAmount || 0;
                            if (!clientTotals[doc.customerName].lastInvoice || 
                                doc.createdAt?.toDate?.() > clientTotals[doc.customerName].lastInvoice) {
                                clientTotals[doc.customerName].lastInvoice = doc.createdAt?.toDate?.();
                            }
                        }
                    });
                    
                    html += `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Total Invoiced</th>
                                    <th>Total Paid</th>
                                    <th>Outstanding</th>
                                    <th>Last Invoice</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(clientTotals).map(([name, data]) => `
                                    <tr>
                                        <td>${name}</td>
                                        <td>${utils.formatCurrency(data.totalInvoiced)}</td>
                                        <td>${utils.formatCurrency(data.totalPaid)}</td>
                                        <td>${utils.formatCurrency(data.totalInvoiced - data.totalPaid)}</td>
                                        <td>${utils.formatDate(data.lastInvoice)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (type === 'aging') {
                    const now = new Date();
                    const aging = {
                        current: [],
                        '1-30': [],
                        '31-60': [],
                        '61-90': [],
                        '90+': []
                    };
                    
                    state.documents.filter(d => d.type === 'invoice' && (d.total || 0) > (d.paidAmount || 0))
                        .forEach(inv => {
                            const dueDate = inv.dueDate?.toDate?.();
                            if (dueDate) {
                                const daysOverdue = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));
                                const balance = (inv.total || 0) - (inv.paidAmount || 0);
                                
                                if (daysOverdue <= 0) {
                                    aging.current.push(balance);
                                } else if (daysOverdue <= 30) {
                                    aging['1-30'].push(balance);
                                } else if (daysOverdue <= 60) {
                                    aging['31-60'].push(balance);
                                } else if (daysOverdue <= 90) {
                                    aging['61-90'].push(balance);
                                } else {
                                    aging['90+'].push(balance);
                                }
                            }
                        });
                    
                    html += `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Aging Period</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Current (Not Due)</td><td>${utils.formatCurrency(aging.current.reduce((a,b) => a + b, 0))}</td></tr>
                                <tr><td>1-30 Days</td><td>${utils.formatCurrency(aging['1-30'].reduce((a,b) => a + b, 0))}</td></tr>
                                <tr><td>31-60 Days</td><td>${utils.formatCurrency(aging['31-60'].reduce((a,b) => a + b, 0))}</td></tr>
                                <tr><td>61-90 Days</td><td>${utils.formatCurrency(aging['61-90'].reduce((a,b) => a + b, 0))}</td></tr>
                                <tr><td>90+ Days</td><td>${utils.formatCurrency(aging['90+'].reduce((a,b) => a + b, 0))}</td></tr>
                            </tbody>
                        </table>
                    `;
                }
                
                document.getElementById('reportResults').innerHTML = html;
            }
        };

        // ==================== CLIENTS MANAGEMENT ====================
        const clients = {
            currentId: null,
            
            save: async () => {
                const name = document.getElementById('clientName').value.trim();
                if (!name) {
                    utils.showAlert('clientAlert', 'Client name is required', 'danger');
                    return;
                }
                
                const clientData = {
                    name,
                    email: document.getElementById('clientEmail').value,
                    phone: document.getElementById('clientPhone').value,
                    address: document.getElementById('clientAddress').value,
                    taxId: document.getElementById('clientTaxId').value,
                    userId: state.currentUser.uid,
                    updatedAt: window.firebase.Timestamp.now()
                };
                
                try {
                    if (clients.currentId) {
                        await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'clients', clients.currentId), clientData);
                        utils.showAlert('clientAlert', 'Client updated successfully!', 'success');
                    } else {
                        clientData.createdAt = window.firebase.Timestamp.now();
                        await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'clients'), clientData);
                        utils.showAlert('clientAlert', 'Client saved successfully!', 'success');
                    }
                    
                    ui.closeModal('clientModal');
                    await data.loadClients();
                } catch (error) {
                    utils.showAlert('clientAlert', error.message, 'danger');
                }
            },
            
            edit: (id) => {
                const client = state.clients.find(c => c.id === id);
                if (!client) return;
                
                clients.currentId = id;
                document.getElementById('clientName').value = client.name || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientAddress').value = client.address || '';
                document.getElementById('clientTaxId').value = client.taxId || '';
                
                ui.openModal('clientModal');
            }
        };

        // ==================== SETTINGS ====================
        const settings = {
            load: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'settings'),
                        window.firebase.where('userId', '==', state.currentUser.uid)
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    
                    if (!snapshot.empty) {
                        state.settings = snapshot.docs[0].data();
                        settings.populateForm();
                    }
                    
                    // Load payment methods
                    const paymentQ = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'paymentMethods'),
                        window.firebase.where('userId', '==', state.currentUser.uid)
                    );
                    const paymentSnapshot = await window.firebase.getDocs(paymentQ);
                    state.paymentMethods = paymentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load tax rates
                    const taxQ = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'taxRates'),
                        window.firebase.where('userId', '==', state.currentUser.uid)
                    );
                    const taxSnapshot = await window.firebase.getDocs(taxQ);
                    state.taxRates = taxSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    settings.renderPaymentMethods();
                    settings.renderTaxRates();
                } catch (error) {
                    console.error('Load settings error:', error);
                }
            },
            
            populateForm: () => {
                document.getElementById('invoicePrefix').value = state.settings.invoicePrefix || 'INV';
                document.getElementById('quotePrefix').value = state.settings.quotePrefix || 'QUO';
                document.getElementById('receiptPrefix').value = state.settings.receiptPrefix || 'REC';
                document.getElementById('contractPrefix').value = state.settings.contractPrefix || 'CON';
                
                if (state.settings.defaultCompany) {
                    document.getElementById('defaultCompany').value = state.settings.defaultCompany;
                }
            },
            
            renderPaymentMethods: () => {
                const list = document.getElementById('paymentMethodsList');
                if (!list) return;
                
                if (state.paymentMethods.length === 0) {
                    list.innerHTML = '<p class="text-center">No payment methods added yet</p>';
                    return;
                }
                
                list.innerHTML = state.paymentMethods.map(method => `
                    <div class="card">
                        <h4>${method.name}</h4>
                        <p>${method.instructions || ''}</p>
                        <p><small>${method.details || ''}</small></p>
                        <button class="btn btn-sm btn-danger" onclick="settings.deletePaymentMethod('${method.id}')">Delete</button>
                    </div>
                `).join('');
            },
            
            renderTaxRates: () => {
                const list = document.getElementById('taxRatesList');
                if (!list) return;
                
                if (state.taxRates.length === 0) {
                    list.innerHTML = '<p class="text-center">No tax rates added yet</p>';
                    return;
                }
                
                list.innerHTML = state.taxRates.map(tax => `
                    <div class="card">
                        <h4>${tax.name} (${tax.rate}%)</h4>
                        <p>${tax.description || ''}</p>
                        <button class="btn btn-sm btn-danger" onclick="settings.deleteTaxRate('${tax.id}')">Delete</button>
                    </div>
                `).join('');
            },
            
            showTab: (tab, element) => {
                document.querySelectorAll('#settingsSection .sub-tab').forEach(t => t.classList.remove('active'));
                element.classList.add('active');
                
                document.querySelectorAll('#settingsSection > div:not(.sub-tabs)').forEach(d => d.classList.add('hidden'));
                document.getElementById(tab + 'SettingsTab').classList.remove('hidden');
            },
            
            saveGeneral: async () => {
                const settingsData = {
                    invoicePrefix: document.getElementById('invoicePrefix').value,
                    quotePrefix: document.getElementById('quotePrefix').value,
                    receiptPrefix: document.getElementById('receiptPrefix').value,
                    contractPrefix: document.getElementById('contractPrefix').value,
                    defaultCompany: document.getElementById('defaultCompany').value,
                    userId: state.currentUser.uid,
                    updatedAt: window.firebase.Timestamp.now()
                };
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'settings'),
                        window.firebase.where('userId', '==', state.currentUser.uid)
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    
                    if (snapshot.empty) {
                        settingsData.createdAt = window.firebase.Timestamp.now();
                        await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'settings'), settingsData);
                    } else {
                        await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'settings', snapshot.docs[0].id), settingsData);
                    }
                    
                    state.settings = settingsData;
                    alert('Settings saved successfully!');
                } catch (error) {
                    console.error('Save settings error:', error);
                    alert('Error saving settings: ' + error.message);
                }
            },
            
            addPaymentMethod: () => {
                document.getElementById('paymentMethodName').value = '';
                document.getElementById('paymentMethodInstructions').value = '';
                document.getElementById('paymentMethodDetails').value = '';
                ui.openModal('paymentMethodModal');
            },
            
            savePaymentMethod: async () => {
                const name = document.getElementById('paymentMethodName').value.trim();
                if (!name) {
                    utils.showAlert('paymentMethodAlert', 'Method name is required', 'danger');
                    return;
                }
                
                const methodData = {
                    name,
                    instructions: document.getElementById('paymentMethodInstructions').value,
                    details: document.getElementById('paymentMethodDetails').value,
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now()
                };
                
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'paymentMethods'), methodData);
                    utils.showAlert('paymentMethodAlert', 'Payment method added successfully!', 'success');
                    ui.closeModal('paymentMethodModal');
                    await settings.load();
                } catch (error) {
                    utils.showAlert('paymentMethodAlert', error.message, 'danger');
                }
            },
            
            deletePaymentMethod: async (id) => {
                if (!confirm('Are you sure you want to delete this payment method?')) return;
                
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'paymentMethods', id));
                    await settings.load();
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error deleting payment method');
                }
            },
            
            addTaxRate: () => {
                document.getElementById('taxName').value = '';
                document.getElementById('taxRate').value = '16';
                document.getElementById('taxDescription').value = '';
                ui.openModal('taxRateModal');
            },
            
            saveTaxRate: async () => {
                const name = document.getElementById('taxName').value.trim();
                const rate = parseFloat(document.getElementById('taxRate').value);
                
                if (!name || isNaN(rate) || rate < 0 || rate > 100) {
                    utils.showAlert('taxRateAlert', 'Please enter a valid tax name and rate (0-100)', 'danger');
                    return;
                }
                
                const taxData = {
                    name,
                    rate,
                    description: document.getElementById('taxDescription').value,
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now()
                };
                
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'taxRates'), taxData);
                    utils.showAlert('taxRateAlert', 'Tax rate added successfully!', 'success');
                    ui.closeModal('taxRateModal');
                    await settings.load();
                } catch (error) {
                    utils.showAlert('taxRateAlert', error.message, 'danger');
                }
            },
            
            deleteTaxRate: async (id) => {
                if (!confirm('Are you sure you want to delete this tax rate?')) return;
                
                try {
                    await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'taxRates', id));
                    await settings.load();
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error deleting tax rate');
                }
            }
        };

        // ==================== UI MANAGEMENT ====================
        const ui = {
            init: () => {
                // Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        const section = link.dataset.section;
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                        document.getElementById(section + 'Section').classList.add('active');
                    });
                });
                
                // Client search
                document.getElementById('clientSearch')?.addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    document.querySelectorAll('#clientsGrid .card').forEach(card => {
                        const text = card.textContent.toLowerCase();
                        card.style.display = text.includes(search) ? 'block' : 'none';
                    });
                });
            },
            
            switchAuthTab: (tab) => {
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                
                if (tab === 'login') {
                    document.querySelector('.auth-tab:first-child').classList.add('active');
                    document.getElementById('loginForm').classList.remove('hidden');
                } else {
                    document.querySelector('.auth-tab:last-child').classList.add('active');
                    document.getElementById('registerForm').classList.remove('hidden');
                }
            },
            
            showCompanyModal: () => {
                companies.currentId = null;
                document.getElementById('companyModalTitle').textContent = 'Add Company';
                document.getElementById('companyName').value = '';
                document.getElementById('companyRegNo').value = '';
                document.getElementById('companyEmail').value = '';
                document.getElementById('companyPhone').value = '';
                document.getElementById('companyTaxId').value = '';
                document.getElementById('companyWebsite').value = '';
                document.getElementById('companyAddress').value = '';
                document.getElementById('companyLogo').value = '';
                document.getElementById('companyColor').value = '#2563eb';
                document.getElementById('companyBank').value = '';
                document.getElementById('companyAccount').value = '';
                document.getElementById('companySwift').value = '';
                document.getElementById('companyIban').value = '';
                
                document.getElementById('deleteCompanyBtn').style.display = 'none';
                ui.openModal('companyModal');
            },
            
            showDocumentModal: (type) => {
                documents.currentType = type;
                document.getElementById('modalTitle').textContent = `Create ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                document.getElementById('receiptSpecific').classList.toggle('hidden', type !== 'receipt');
                
                // Set default due date (30 days from now)
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                document.getElementById('docDueDate').value = dueDate.toISOString().split('T')[0];
                
                // Clear items except one
                const tbody = document.getElementById('itemsBody');
                tbody.innerHTML = `
                    <tr>
                        <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                        <td><input type="number" class="form-control item-qty" value="1" min="1" onchange="items.updateTotals()"></td>
                        <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01" onchange="items.updateTotals()"></td>
                        <td><input type="number" class="form-control item-discount" value="0" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                        <td><input type="number" class="form-control item-tax" value="0" min="0" max="100" step="0.1" onchange="items.updateTotals()"></td>
                        <td class="item-total">$0.00</td>
                        <td><button class="btn btn-danger btn-sm" onclick="items.remove(this)">×</button></td>
                    </tr>
                `;
                
                items.updateTotals();
                
                // Populate invoice select for receipts
                if (type === 'receipt') {
                    const invoiceSelect = document.getElementById('receiptInvoice');
                    if (invoiceSelect) {
                        invoiceSelect.innerHTML = '<option value="">Select Invoice (Optional)</option>';
                        state.documents
                            .filter(d => d.type === 'invoice' && (d.total || 0) > (d.paidAmount || 0))
                            .forEach(inv => {
                                invoiceSelect.innerHTML += `<option value="${inv.serialNumber}">${inv.serialNumber} - ${inv.customerName}</option>`;
                            });
                    }
                }
                
                ui.openModal('documentModal');
            },
            
            showContractModal: () => {
                document.getElementById('clausesList').innerHTML = '';
                contracts.addClause('Introduction', 'This agreement is entered into on this day...');
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                document.getElementById('contractStart').value = today;
                document.getElementById('contractEnd').value = nextYear.toISOString().split('T')[0];
                
                ui.openModal('contractModal');
            },
            
            showClientModal: () => {
                clients.currentId = null;
                document.getElementById('clientName').value = '';
                document.getElementById('clientEmail').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('clientAddress').value = '';
                document.getElementById('clientTaxId').value = '';
                ui.openModal('clientModal');
            },
            
            openModal: (id) => {
                document.getElementById(id).classList.add('active');
            },
            
            closeModal: (id) => {
                document.getElementById(id).classList.remove('active');
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            ui.init();
            auth.init();
        });

        // Expose to global scope
        window.auth = auth;
        window.ui = ui;
        window.data = data;
        window.companies = companies;
        window.documents = documents;
        window.invoices = invoices;
        window.quotes = quotes;
        window.receipts = receipts;
        window.proforma = proforma;
        window.contracts = contracts;
        window.templates = templates;
        window.payments = payments;
        window.items = items;
        window.clients = clients;
        window.settings = settings;
        window.reports = reports;
        window.pdf = pdf;
    </script>
</body>
</html>
