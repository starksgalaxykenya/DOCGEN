<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARKS GALAXY LIMITED – Document Generator</title>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        
        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDyre2oxURYXHZOLIHUeG2itz56i5ehAYo",
          authDomain: "company-doc-generator.firebaseapp.com",
          projectId: "company-doc-generator",
          storageBucket: "company-doc-generator.firebasestorage.app",
          messagingSenderId: "891677147775",
          appId: "1:891677147775:web:a1ffebf23572f5ca18f54a",
          measurementId: "G-1MMCF9W7HF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = {
            auth, db,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
            collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where
        };
        
        console.log("Firebase initialized successfully");
        
        // Set up auth state listener immediately
        onAuthStateChanged(auth, (user) => {
            console.log("Auth state changed:", user ? `User: ${user.email}` : "No user");
            if (user) {
                window.currentUser = user;
                // Dispatch custom event for the main script
                window.dispatchEvent(new CustomEvent('firebase-auth-ready', { detail: { user } }));
            } else {
                window.currentUser = null;
                window.dispatchEvent(new CustomEvent('firebase-auth-ready', { detail: { user: null } }));
            }
        });
    </script>
    <!-- jsPDF and html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ----- GLOBAL STYLES ----- */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #ff9e00;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f5f7fb; color: var(--dark-color); line-height: 1.6; min-height: 100vh; }
        
        /* Auth screen */
        .auth-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #4361ee, #3a0ca3); padding: 20px; }
        .auth-container { background: white; border-radius: 20px; max-width: 450px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .auth-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 40px 30px; text-align: center; }
        .auth-header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .auth-header p { opacity: 0.9; font-size: 1.1rem; }
        .auth-tabs { display: flex; border-bottom: 2px solid #e0e0e0; }
        .auth-tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: var(--transition); }
        .auth-tab:hover { color: var(--primary-color); }
        .auth-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .auth-form { padding: 40px 30px; }
        .auth-form-group { margin-bottom: 25px; }
        .auth-form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .auth-form-control { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; transition: var(--transition); }
        .auth-form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(67,97,238,0.2); }
        .auth-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: var(--transition); }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(67,97,238,0.3); }
        .auth-footer { text-align: center; padding: 20px; background: #f8f9fa; border-top: 1px solid #e0e0e0; color: #666; }
        
        /* Main app */
        .main-app { display: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 20px; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; box-shadow: var(--box-shadow); }
        .header-left h1 { font-size: 2.2rem; margin-bottom: 5px; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-email { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; }
        .btn-logout { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: var(--transition); }
        .btn-logout:hover { background: rgba(255,255,255,0.3); }
        
        .nav-tabs { display: flex; background: white; border-radius: var(--border-radius); margin-bottom: 30px; box-shadow: var(--box-shadow); flex-wrap: wrap; }
        .nav-tab { flex: 1; min-width: 120px; padding: 18px; text-align: center; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: var(--transition); }
        .nav-tab:hover { background: rgba(67,97,238,0.05); }
        .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: rgba(67,97,238,0.05); }
        
        .tab-content { display: none; background: white; border-radius: var(--border-radius); padding: 30px; box-shadow: var(--box-shadow); animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h2 { color: var(--secondary-color); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 25px; font-size: 1.8rem; }
        h3 { color: var(--primary-color); margin: 25px 0 15px; font-size: 1.4rem; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; color: var(--dark-color); }
        .form-control { padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; transition: var(--transition); }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(67,97,238,0.2); }
        textarea.form-control { resize: vertical; min-height: 80px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: var(--transition); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-secondary { background: var(--gray-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; }
        
        /* Tables */
        .items-table, .history-table, .document-table { width: 100%; border-collapse: collapse; margin: 25px 0; border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 0 0 1px #ddd; }
        .items-table th, .history-table th, .document-table th { background: #f1f5fd; padding: 15px; text-align: left; color: var(--secondary-color); font-weight: 600; }
        .items-table td, .history-table td, .document-table td { padding: 15px; border-top: 1px solid #eee; }
        
        /* Currency selection */
        .currency-selection { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .currency-btn { padding: 10px 20px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: var(--transition); }
        .currency-btn:hover { border-color: var(--primary-color); background: rgba(67,97,238,0.05); }
        .currency-btn.active { border-color: var(--primary-color); background: var(--primary-color); color: white; }
        
        /* Hidden utility */
        .hidden { display: none !important; }
        
        /* Alerts */
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; border-left: 4px solid transparent; }
        .alert-success { background: rgba(76,201,240,0.1); border-left-color: var(--success-color); color: #0a8ea8; }
        .alert-danger { background: rgba(247,37,133,0.1); border-left-color: var(--danger-color); color: #c2185b; }
        .alert-warning { background: rgba(255,158,0,0.1); border-left-color: var(--warning-color); color: #b45f06; }
        
        /* Loading spinner */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s infinite; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Receipt fields */
        .receipt-fields { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; padding: 20px; background: #f9fafc; border-radius: 8px; border-left: 4px solid var(--success-color); }
        
        /* Payment & Terms */
        .multiple-payment-accounts, .terms-section { margin-top: 30px; padding: 20px; background: #f9fafc; border-radius: 8px; border-left: 4px solid var(--primary-color); }
        .payment-methods-checkbox-list, .terms-checkbox-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; max-height: 200px; overflow-y: auto; padding: 10px; background: white; border-radius: 8px; border: 1px solid #eaeaea; }
        .payment-account-item { background: white; padding: 15px; border-radius: 8px; border: 1px solid #eaeaea; margin-bottom: 15px; }
        
        /* Document preview */
        .document-preview { background: white; border-radius: var(--border-radius); padding: 40px; box-shadow: var(--box-shadow); border: 1px solid #eaeaea; position: relative; }
        .document-title { text-align: center; font-size: 2.5rem; margin: 40px 0; font-weight: 700; color: var(--secondary-color); }
        .revoked-stamp { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-45deg); font-size: 80px; color: var(--danger-color); font-weight: bold; opacity: 0.3; border: 8px solid var(--danger-color); padding: 40px; border-radius: 15px; display: none; }
        
        /* PDF MODE */
        .document-preview.pdf-mode {
            width: 210mm !important;
            height: auto !important;
            padding: 12mm 12mm !important;
            margin: 0 auto !important;
            background: white !important;
            font-size: 12px !important;
            line-height: 1.35 !important;
            box-sizing: border-box !important;
            border: none !important;
            box-shadow: none !important;
        }
        .pdf-mode .document-table { width: 100%; table-layout: fixed; font-size: 11px; }
        .pdf-mode th, .pdf-mode td { padding: 6px 4px !important; border: 1px solid #ddd; }
        .pdf-mode .document-title { font-size: 22px !important; margin: 12px 0 !important; }
        .pdf-mode .no-print, .pdf-mode .btn, .pdf-mode .nav-tabs, .pdf-mode .action-buttons { display: none !important; }
        
        /* Client cards */
        .client-list, .company-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .client-card, .company-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--box-shadow); border: 1px solid #eaeaea; transition: var(--transition); cursor: pointer; }
        .client-card:hover, .company-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: var(--border-radius); padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header { flex-direction: column; text-align: center; gap: 15px; }
            .nav-tabs { flex-direction: column; }
            .document-title { font-size: 1.8rem; }
        }
        
        @media print {
            .auth-screen, .nav-tabs, .btn, .tab-content:not(.active) { display: none !important; }
            .tab-content.active { display: block !important; }
            .document-preview { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-header">
                <h1>STARKS GALAXY LIMITED</h1>
                <p>Company Document Generator Engine</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>
            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <div class="alert" id="loginAlert"></div>
                <div class="auth-form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="auth-form-control" placeholder="Enter your email">
                </div>
                <div class="auth-form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="auth-form-control" placeholder="Enter your password">
                </div>
                <button class="auth-btn" onclick="login()" id="loginBtn">
                    <span id="loginText">Login</span>
                    <span id="loginSpinner" class="loading hidden"></span>
                </button>
            </div>
            <!-- Register Form -->
            <div class="auth-form hidden" id="registerForm">
                <div class="alert" id="registerAlert"></div>
                <div class="auth-form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" class="auth-form-control" placeholder="Enter your email">
                </div>
                <div class="auth-form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="auth-form-control" placeholder="Create a password (min. 6 characters)">
                </div>
                <div class="auth-form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" class="auth-form-control" placeholder="Confirm your password">
                </div>
                <button class="auth-btn" onclick="register()" id="registerBtn">
                    <span id="registerText">Create Account</span>
                    <span id="registerSpinner" class="loading hidden"></span>
                </button>
            </div>
            <div class="auth-footer">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="paymentModalTitle">Record Payment</h3>
                <button class="modal-close" onclick="closePaymentModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">×</button>
            </div>
            <div id="paymentFormContainer"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <header>
                <div class="header-left">
                    <h1>STARKS GALAXY LIMITED</h1>
                    <p>Receipts, Invoices, Quotes, and Proforma Invoices Generator</p>
                </div>
                <div class="user-info">
                    <div class="user-email" id="userEmail"></div>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </header>

            <nav class="nav-tabs" id="navTabs">
                <div class="nav-tab active" data-tab="create">Create Document</div>
                <div class="nav-tab" data-tab="history">Document History</div>
                <div class="nav-tab" data-tab="admin">Admin Dashboard</div>
                <div class="nav-tab" data-tab="preview">Live Preview</div>
                <div class="nav-tab" data-tab="clients">Client Database</div>
                <div class="nav-tab" data-tab="terms">Terms Management</div>
            </nav>

            <!-- CREATE TAB -->
            <div class="tab-content active" id="create">
                <h2>Create New Document</h2>
                <div class="alert" id="createAlert"></div>
                
                <div class="currency-selection">
                    <button class="currency-btn active" id="usdCurrency" onclick="selectCurrency('USD')">US Dollars (USD)</button>
                    <button class="currency-btn" id="kshCurrency" onclick="selectCurrency('KSH')">Kenya Shillings (KSH)</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Document Type</label>
                        <select id="documentType" class="form-control" onchange="updateFormLayout(); updateSerialNumber(); loadTermsForDocumentType(this.value);">
                            <option value="invoice">Invoice</option>
                            <option value="quote">Quote</option>
                            <option value="receipt">Receipt</option>
                            <option value="proforma">Proforma Invoice</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <select id="companySelect" class="form-control" onchange="onCompanySelect()">
                            <option value="">Select a company</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Serial Number</label>
                        <input type="text" id="serialNumber" class="form-control" readonly>
                    </div>
                </div>

                <h3>Customer Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Customer Name</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="customerName" class="form-control" placeholder="John Doe" style="flex:1;">
                            <button type="button" class="btn btn-secondary" onclick="showClientList()">Select</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Customer Email</label>
                        <input type="email" id="customerEmail" class="form-control" placeholder="john@example.com">
                    </div>
                    <div class="form-group">
                        <label>Customer Phone</label>
                        <input type="tel" id="customerPhone" class="form-control" placeholder="+1234567890">
                    </div>
                    <div class="form-group">
                        <label>Customer Address</label>
                        <textarea id="customerAddress" class="form-control" rows="2" placeholder="123 Main St, City, Country"></textarea>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-success" onclick="saveCurrentClient()">Save Client Info</button>
                    <button class="btn btn-secondary" onclick="clearClientForm()">Clear Client Info</button>
                </div>

                <!-- Receipt Specific Fields -->
                <div id="receiptFields" class="hidden">
                    <h3>Receipt Details</h3>
                    <div class="receipt-fields">
                        <div class="form-group">
                            <label>Reason for Receipt</label>
                            <input type="text" id="receiptReason" class="form-control" placeholder="Payment for services rendered">
                        </div>
                        <div class="form-group">
                            <label>Date of Receipt</label>
                            <input type="date" id="receiptDate" class="form-control">
                        </div>
                    </div>
                </div>

                <!-- Items Section -->
                <div id="itemsSection">
                    <h3>Items & Services</h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th width="120">Quantity</th>
                                <th width="150">Unit Price (<span id="currencySymbol">$</span>)</th>
                                <th width="150">Total (<span id="currencySymbol2">$</span>)</th>
                                <th width="50">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                                <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                                <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01"></td>
                                <td class="item-total">$0.00</td>
                                <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">✕</button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align:right;"><strong>Subtotal:</strong></td>
                                <td id="subtotal">$0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align:right;">
                                    <strong>Discount (<span id="discountCurrencySymbol">$</span>):</strong>
                                    <input type="number" id="discountAmount" class="form-control" style="width:120px; display:inline-block; margin-left:10px;" value="0" min="0" step="0.01">
                                </td>
                                <td id="discountDisplay">-$0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align:right;">
                                    <strong>Tax Rate (%):</strong>
                                    <input type="number" id="taxRate" class="form-control" style="width:80px; display:inline-block; margin-left:10px;" value="0" min="0" max="100" step="0.1">
                                </td>
                                <td id="taxAmount">$0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align:right;"><strong>Total:</strong></td>
                                <td id="totalAmount">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    <button class="btn btn-secondary" onclick="addItem()">+ Add Item</button>
                </div>

                <!-- Terms and Conditions Section -->
                <div class="terms-section">
                    <h4>Terms & Conditions</h4>
                    <div class="form-group">
                        <label>Select Terms (Multiple selection allowed)</label>
                        <div class="terms-checkbox-list" id="termsCheckboxList">
                            <div class="text-center" style="padding:20px; color:var(--gray-color);">Loading terms...</div>
                        </div>
                    </div>
                    <div class="terms-content" id="termsContent" style="margin-top:15px; padding:15px; background:white; border-radius:8px; border:1px solid #eaeaea;">
                        No terms selected
                    </div>
                </div>

                <!-- Payment Methods Section -->
                <div class="multiple-payment-accounts">
                    <h4>Payment Methods</h4>
                    <div class="payment-methods-checkbox-list" id="paymentMethodsCheckboxList">
                        <div class="payment-method-checkbox-item">
                            <input type="checkbox" class="payment-method-checkbox" value="Bank Transfer"> Bank Transfer
                        </div>
                        <div class="payment-method-checkbox-item">
                            <input type="checkbox" class="payment-method-checkbox" value="Credit Card"> Credit Card
                        </div>
                        <div class="payment-method-checkbox-item">
                            <input type="checkbox" class="payment-method-checkbox" value="M-Pesa"> M-Pesa
                        </div>
                        <div class="payment-method-checkbox-item">
                            <input type="checkbox" class="payment-method-checkbox" value="Cash"> Cash
                        </div>
                    </div>
                    
                    <h4 class="mt-20">Payment Accounts</h4>
                    <div id="paymentAccountsContainer"></div>
                    <div class="mt-20">
                        <button class="btn btn-success" onclick="addPaymentAccount()">+ Add Another Payment Account</button>
                    </div>
                </div>

                <div class="mt-30" style="display:flex; gap:15px; flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="generateDocument()" id="generateBtn">
                        <span id="generateText">Generate Document</span>
                        <span id="generateSpinner" class="loading hidden"></span>
                    </button>
                    <button class="btn btn-success" onclick="previewDocument()">Preview Document</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div class="tab-content" id="history">
                <h2>Document History</h2>
                <div class="alert" id="historyAlert"></div>
                <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
                    <select id="historyFilter" class="form-control" style="width:auto;">
                        <option value="all">All Documents</option>
                        <option value="invoice">Invoices</option>
                        <option value="quote">Quotes</option>
                        <option value="receipt">Receipts</option>
                        <option value="proforma">Proforma Invoices</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadDocumentHistory()">Refresh</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Serial No.</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr><td colspan="7" class="text-center" style="padding:40px;">Loading document history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ADMIN TAB -->
            <div class="tab-content" id="admin">
                <h2>Admin Dashboard</h2>
                <div class="alert" id="adminAlert"></div>
                
                <h3>Manage Companies</h3>
                <div id="companyList" class="company-list">
                    <div class="text-center" style="padding:40px; color:var(--gray-color);">Loading companies...</div>
                </div>
                
                <h3 class="mt-30">Add/Edit Company</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" id="companyName" class="form-control" placeholder="Acme Inc.">
                    </div>
                    <div class="form-group">
                        <label>Parent Company (Optional)</label>
                        <input type="text" id="parentCompany" class="form-control" placeholder="Parent Company Name">
                    </div>
                    <div class="form-group">
                        <label>Company Email</label>
                        <input type="email" id="companyEmail" class="form-control" placeholder="contact@acme.com">
                    </div>
                    <div class="form-group">
                        <label>Company Tax PIN</label>
                        <input type="text" id="companyTaxPin" class="form-control" placeholder="Tax Identification Number">
                    </div>
                    <div class="form-group">
                        <label>Company Phone</label>
                        <input type="tel" id="companyPhone" class="form-control" placeholder="+1234567890">
                    </div>
                    <div class="form-group">
                        <label>Company Website</label>
                        <input type="url" id="companyWebsite" class="form-control" placeholder="https://acme.com">
                    </div>
                    <div class="form-group">
                        <label>Company Address</label>
                        <textarea id="companyAddress" class="form-control" rows="2" placeholder="123 Business Ave, City, Country"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Primary Color</label>
                        <input type="color" id="primaryColor" class="form-control" value="#4361ee">
                    </div>
                    <div class="form-group">
                        <label>Secondary Color</label>
                        <input type="color" id="secondaryColor" class="form-control" value="#3a0ca3">
                    </div>
                </div>
                <div class="mt-30" style="display:flex; gap:15px; flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="saveCompany()" id="saveCompanyBtn">Save Company</button>
                    <button class="btn btn-secondary" onclick="clearCompanyForm()">Clear Form</button>
                    <button class="btn btn-danger" onclick="deleteCompany()" id="deleteCompanyBtn" style="display:none;">Delete Company</button>
                </div>
            </div>

            <!-- PREVIEW TAB -->
            <div class="tab-content" id="preview">
                <h2>Document Preview</h2>
                <div style="margin-bottom:20px;" class="no-print">
                    <button class="btn btn-primary" onclick="generatePDF()">Download as PDF</button>
                    <button class="btn btn-secondary" onclick="refreshPreview()">Refresh Preview</button>
                </div>
                
                <div class="document-preview" id="documentPreview">
                    <div class="revoked-stamp" id="revokedStamp">REVOKED</div>
                    
                    <div class="document-header" style="display:flex; justify-content:space-between; margin-bottom:30px;">
                        <div>
                            <h2 id="previewCompanyName" style="color:var(--secondary-color);">Company Name</h2>
                            <div id="previewParentCompany" class="parent-company" style="color:var(--gray-color);"></div>
                            <div id="previewCompanyTax" class="company-tax" style="color:var(--gray-color);"></div>
                        </div>
                        <div class="company-details" id="previewCompanyContact" style="text-align:right;">
                            Contact information
                        </div>
                    </div>
                    
                    <div class="document-title" id="previewDocumentTitle">INVOICE</div>
                    
                    <!-- Receipt Preview Layout -->
                    <div id="receiptPreview" class="hidden">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px;">
                            <div style="padding:15px; background:#f9fafc; border-radius:8px; border-left:4px solid var(--primary-color);">
                                <h4>Customer Details</h4>
                                <p id="previewCustomerDetails"></p>
                            </div>
                            <div style="padding:15px; background:#f9fafc; border-radius:8px; border-left:4px solid var(--success-color);">
                                <h4>Receipt Details</h4>
                                <p><strong>Serial No:</strong> <span id="previewReceiptSerial"></span></p>
                                <p><strong>Date:</strong> <span id="previewReceiptDate"></span></p>
                                <p><strong>Reason:</strong> <span id="previewReceiptReason"></span></p>
                                <p><strong>Currency:</strong> <span id="previewReceiptCurrency"></span></p>
                            </div>
                        </div>
                        <table class="document-table" id="receiptItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="receiptPreviewItems"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Subtotal:</strong></td>
                                    <td id="receiptPreviewSubtotal">$0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Discount:</strong></td>
                                    <td id="receiptPreviewDiscount">-$0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Tax:</strong></td>
                                    <td id="receiptPreviewTax">$0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Total:</strong></td>
                                    <td id="receiptPreviewTotal">$0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Standard Document Preview Layout -->
                    <div id="standardPreview">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:40px; margin-bottom:40px;">
                            <div>
                                <h3>Bill To:</h3>
                                <p id="previewCustomerDetailsStandard"></p>
                            </div>
                            <div style="text-align:right;">
                                <h3>Document Details:</h3>
                                <p><strong>Serial No:</strong> <span id="previewSerialNumber"></span></p>
                                <p><strong>Date:</strong> <span id="previewDate"></span></p>
                                <p><strong>Document Type:</strong> <span id="previewDocType"></span></p>
                                <p><strong>Currency:</strong> <span id="previewCurrency"></span></p>
                            </div>
                        </div>
                        
                        <table class="document-table" id="standardItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="previewItems"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Subtotal:</strong></td>
                                    <td id="previewSubtotal">$0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Discount:</strong></td>
                                    <td id="previewDiscount">-$0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Tax:</strong></td>
                                    <td id="previewTax">$0.00</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align:right;"><strong>Total:</strong></td>
                                    <td id="previewTotal">$0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="multiple-payment-accounts">
                        <h4>Payment Accounts & Methods</h4>
                        <div id="previewPaymentMethodsList" style="margin-bottom:15px;"></div>
                        <div id="previewPaymentAccounts"></div>
                    </div>
                    
                    <div class="terms-preview" id="previewTerms" style="margin-top:30px; padding:20px; background:#fff9e6; border-radius:8px; border-left:4px solid var(--warning-color);"></div>
                    
                    <div class="document-footer" style="margin-top:40px; padding-top:20px; border-top:2px solid #eee; display:flex; justify-content:space-between;">
                        <div>
                            <h3>Thank You!</h3>
                            <p>We appreciate your business</p>
                        </div>
                        <div style="text-align:right;">
                            <p><strong>Authorized Signature:</strong></p>
                            <div style="width:150px; height:50px; border-bottom:1px solid #000; margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLIENTS TAB -->
            <div class="tab-content" id="clients">
                <h2>Client Database</h2>
                <div class="alert" id="clientsAlert"></div>
                <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="clientSearch" class="form-control" placeholder="Search clients..." style="flex:1; max-width:300px;">
                    <button class="btn btn-primary" onclick="loadClients()">Refresh</button>
                    <button class="btn btn-success" onclick="saveCurrentClient()">Save Current Client</button>
                </div>
                <div id="clientList" class="client-list">
                    <div class="text-center" style="padding:40px; color:var(--gray-color);">Loading clients...</div>
                </div>
            </div>

            <!-- TERMS MANAGEMENT TAB -->
            <div class="tab-content" id="terms">
                <h2>Terms & Conditions Management</h2>
                <div class="alert" id="termsAlert"></div>
                
                <div class="terms-management" style="padding:20px; background:#f9fafc; border-radius:8px; margin-bottom:30px;">
                    <h3>Manage Document Terms</h3>
                    <div class="form-grid" style="margin-top:20px;">
                        <div class="form-group">
                            <label>Term Name</label>
                            <input type="text" id="termName" class="form-control" placeholder="e.g., Standard Invoice Terms">
                        </div>
                        <div class="form-group">
                            <label>Document Type</label>
                            <select id="termDocumentType" class="form-control">
                                <option value="all">All Documents</option>
                                <option value="invoice">Invoice</option>
                                <option value="quote">Quote</option>
                                <option value="receipt">Receipt</option>
                                <option value="proforma">Proforma Invoice</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Term Content</label>
                        <textarea id="termContent" class="form-control" rows="6" placeholder="Enter terms and conditions here..."></textarea>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="saveTerm()">Save Term</button>
                        <button class="btn btn-secondary" onclick="clearTermForm()">Clear Form</button>
                        <button class="btn btn-danger" id="deleteTermBtn" style="display:none;" onclick="deleteTerm()">Delete Term</button>
                    </div>
                </div>
                
                <div class="mt-30">
                    <h3>Available Terms</h3>
                    <div id="termsList" class="terms-list" style="display:grid; gap:15px; margin-top:20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ---------- GLOBAL STATE ----------
        let currentUser = null;
        let db = null;
        let companies = [];
        let documents = [];
        let clients = [];
        let terms = [];
        let currentCompanyId = null;
        let currentTermId = null;
        let currentDocumentForPayment = null;
        let selectedCurrency = 'USD';
        let selectedPaymentMethods = [];
        let paymentAccounts = [];
        let accountCounter = 0;
        let selectedTermIds = [];
        let monthlySequence = {};
        
        // ---------- INITIALIZATION ----------
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, waiting for Firebase auth...");
            
            // Set default receipt date
            const today = new Date().toISOString().split('T')[0];
            const receiptDate = document.getElementById('receiptDate');
            if (receiptDate) receiptDate.value = today;
            
            // Set up tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) targetTab.classList.add('active');
                    if (tabId === 'preview') previewDocument();
                });
            });
            
            // Input listeners for calculations
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-desc') || 
                    e.target.classList.contains('item-qty') || 
                    e.target.classList.contains('item-price') ||
                    e.target.id === 'taxRate' ||
                    e.target.id === 'discountAmount') {
                    updateItemTotals();
                }
                if (e.target.classList.contains('term-checkbox')) {
                    updateSelectedTerms();
                }
                if (e.target.classList.contains('payment-method-checkbox')) {
                    updateSelectedPaymentMethods();
                }
            });
            
            // Listen for Firebase auth ready event
            window.addEventListener('firebase-auth-ready', function(e) {
                console.log("Firebase auth ready event received", e.detail.user);
                currentUser = e.detail.user;
                db = window.firebaseApp?.db;
                
                if (currentUser) {
                    showMainApp();
                    initializeMainApp();
                } else {
                    showAuthScreen();
                }
            });
            
            // If Firebase is already initialized, trigger the event
            if (window.firebaseApp && window.firebaseApp.auth) {
                console.log("Firebase already initialized, checking current user...");
                const user = window.firebaseApp.auth.currentUser;
                if (user) {
                    window.currentUser = user;
                    window.dispatchEvent(new CustomEvent('firebase-auth-ready', { detail: { user } }));
                }
            }
        });
        
        // ---------- MAIN APP INITIALIZATION ----------
        function initializeMainApp() {
            console.log("Initializing main app...");
            db = window.firebaseApp.db;
            
            // Add initial payment account
            addPaymentAccount();
            
            // Load all data
            loadCompanies();
            loadDocumentHistory();
            loadClients();
            loadAllTerms();
            updateSerialNumber();
            updateFormLayout();
            selectCurrency('USD');
        }
        
        // ---------- AUTH FUNCTIONS ----------
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthAlert('loginAlert', 'Please enter both email and password', 'danger');
                return;
            }
            
            const btn = document.getElementById('loginBtn');
            const text = document.getElementById('loginText');
            const spinner = document.getElementById('loginSpinner');
            
            text.textContent = 'Logging in...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                await window.firebaseApp.signInWithEmailAndPassword(window.firebaseApp.auth, email, password);
                // Success - auth state listener will handle the UI
                console.log("Login successful, waiting for auth state change...");
            } catch (error) {
                console.error("Login error:", error);
                let message = 'Login failed. ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        message += 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        message += 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        message += 'Invalid email address.';
                        break;
                    case 'auth/too-many-requests':
                        message += 'Too many failed attempts. Please try again later.';
                        break;
                    default:
                        message += error.message;
                }
                showAuthAlert('loginAlert', message, 'danger');
                
                // Reset button state on error
                text.textContent = 'Login';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }
        
        async function register() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirmPassword').value;
            
            if (!email || !password || !confirm) {
                showAuthAlert('registerAlert', 'Please fill in all fields', 'danger');
                return;
            }
            if (password !== confirm) {
                showAuthAlert('registerAlert', 'Passwords do not match', 'danger');
                return;
            }
            if (password.length < 6) {
                showAuthAlert('registerAlert', 'Password must be at least 6 characters', 'danger');
                return;
            }
            
            const btn = document.getElementById('registerBtn');
            const text = document.getElementById('registerText');
            const spinner = document.getElementById('registerSpinner');
            
            text.textContent = 'Creating account...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                await window.firebaseApp.createUserWithEmailAndPassword(window.firebaseApp.auth, email, password);
                console.log("Registration successful");
            } catch (error) {
                console.error("Registration error:", error);
                let message = 'Registration failed. ';
                if (error.code === 'auth/email-already-in-use') {
                    message += 'Email already in use.';
                } else if (error.code === 'auth/weak-password') {
                    message += 'Password is too weak.';
                } else {
                    message += error.message;
                }
                showAuthAlert('registerAlert', message, 'danger');
                
                text.textContent = 'Create Account';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }
        
        async function logout() {
            try {
                await window.firebaseApp.signOut(window.firebaseApp.auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        }
        
        function showAuthAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.textContent = message;
                alert.className = `alert alert-${type}`;
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }
        
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }
        
        function showMainApp() {
            console.log("Showing main app");
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            if (currentUser) {
                const userEmailEl = document.getElementById('userEmail');
                if (userEmailEl) userEmailEl.textContent = currentUser.email;
            }
            
            // Reset all button states
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                document.getElementById('loginText').textContent = 'Login';
                document.getElementById('loginSpinner').classList.add('hidden');
                loginBtn.disabled = false;
            }
            
            const registerBtn = document.getElementById('registerBtn');
            if (registerBtn) {
                document.getElementById('registerText').textContent = 'Create Account';
                document.getElementById('registerSpinner').classList.add('hidden');
                registerBtn.disabled = false;
            }
        }
        
        function showAuthScreen() {
            console.log("Showing auth screen");
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        // ---------- SERIAL NUMBER ----------
        async function getNextMonthlySequence(docType) {
            if (!db) return 1;
            
            const now = new Date();
            const monthKey = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}`;
            const key = `${docType}_${monthKey}`;
            
            if (!monthlySequence[key]) {
                let max = 0;
                try {
                    const q = window.firebaseApp.query(
                        window.firebaseApp.collection(db, "documents"),
                        window.firebaseApp.where("type", "==", docType),
                        window.firebaseApp.where("createdAt", ">=", window.firebaseApp.Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), 1))),
                        window.firebaseApp.orderBy("createdAt", "desc")
                    );
                    const snap = await window.firebaseApp.getDocs(q);
                    snap.forEach(d => {
                        const s = d.data().serialNumber || '';
                        const m = s.match(/-(\d+)$/);
                        if (m) max = Math.max(max, parseInt(m[1]));
                    });
                } catch(e) {
                    console.warn("Sequence error:", e);
                }
                monthlySequence[key] = max;
            }
            monthlySequence[key]++;
            return monthlySequence[key];
        }
        
        async function updateSerialNumber() {
            const type = document.getElementById('documentType').value;
            const prefix = {invoice:'INV', quote:'QUO', receipt:'REC', proforma:'PRO'}[type] || 'DOC';
            const d = new Date();
            const seq = await getNextMonthlySequence(type);
            const serial = `${prefix}-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}-${String(seq).padStart(3,'0')}`;
            
            const serialInput = document.getElementById('serialNumber');
            if (serialInput) serialInput.value = serial;
        }
        
        // ---------- CURRENCY ----------
        function selectCurrency(curr) {
            selectedCurrency = curr;
            const sym = curr === 'USD' ? '$' : 'KSh';
            
            const usdBtn = document.getElementById('usdCurrency');
            const kshBtn = document.getElementById('kshCurrency');
            
            if (usdBtn) usdBtn.classList.toggle('active', curr === 'USD');
            if (kshBtn) kshBtn.classList.toggle('active', curr === 'KSH');
            
            // Update currency symbols in the UI
            const symbolElements = document.querySelectorAll('#currencySymbol, #currencySymbol2, #discountCurrencySymbol');
            symbolElements.forEach(el => {
                if (el) el.textContent = sym;
            });
            
            updateItemTotals();
        }
        
        // ---------- ITEMS & TOTALS ----------
        function addItem() {
            const tbody = document.getElementById('itemsTableBody');
            if (!tbody) return;
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01"></td>
                <td class="item-total">$0.00</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">✕</button></td>
            `;
        }
        
        function removeItem(btn) {
            const row = btn.closest('tr');
            if (row) row.remove();
            updateItemTotals();
        }
        
        function updateItemTotals() {
            const sym = selectedCurrency === 'USD' ? '$' : 'KSh';
            let subtotal = 0;
            const rows = document.querySelectorAll('#itemsTableBody tr');
            
            rows.forEach(row => {
                const descInput = row.querySelector('.item-desc');
                const qtyInput = row.querySelector('.item-qty');
                const priceInput = row.querySelector('.item-price');
                const totalCell = row.querySelector('.item-total');
                
                if (descInput && qtyInput && priceInput && totalCell) {
                    const desc = descInput.value || '';
                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    const total = qty * price;
                    subtotal += total;
                    totalCell.textContent = sym + total.toFixed(2);
                }
            });
            
            let discount = parseFloat(document.getElementById('discountAmount')?.value) || 0;
            if (discount > subtotal) discount = subtotal;
            
            const discounted = subtotal - discount;
            const taxRate = parseFloat(document.getElementById('taxRate')?.value) || 0;
            const tax = discounted * (taxRate / 100);
            const total = discounted + tax;
            
            const subtotalEl = document.getElementById('subtotal');
            const discountDisplayEl = document.getElementById('discountDisplay');
            const taxAmountEl = document.getElementById('taxAmount');
            const totalAmountEl = document.getElementById('totalAmount');
            
            if (subtotalEl) subtotalEl.innerHTML = sym + subtotal.toFixed(2);
            if (discountDisplayEl) discountDisplayEl.innerHTML = '-' + sym + discount.toFixed(2);
            if (taxAmountEl) taxAmountEl.innerHTML = sym + tax.toFixed(2);
            if (totalAmountEl) totalAmountEl.innerHTML = sym + total.toFixed(2);
            
            // Update preview totals
            updatePreviewTotals(sym, subtotal, discount, tax, total);
        }
        
        function updatePreviewTotals(sym, subtotal, discount, tax, total) {
            const previewSub = document.getElementById('previewSubtotal');
            const previewDisc = document.getElementById('previewDiscount');
            const previewTax = document.getElementById('previewTax');
            const previewTotal = document.getElementById('previewTotal');
            const receiptSub = document.getElementById('receiptPreviewSubtotal');
            const receiptDisc = document.getElementById('receiptPreviewDiscount');
            const receiptTax = document.getElementById('receiptPreviewTax');
            const receiptTotal = document.getElementById('receiptPreviewTotal');
            
            if (previewSub) previewSub.innerHTML = sym + subtotal.toFixed(2);
            if (previewDisc) previewDisc.innerHTML = '-' + sym + discount.toFixed(2);
            if (previewTax) previewTax.innerHTML = sym + tax.toFixed(2);
            if (previewTotal) previewTotal.innerHTML = sym + total.toFixed(2);
            
            if (receiptSub) receiptSub.innerHTML = sym + subtotal.toFixed(2);
            if (receiptDisc) receiptDisc.innerHTML = '-' + sym + discount.toFixed(2);
            if (receiptTax) receiptTax.innerHTML = sym + tax.toFixed(2);
            if (receiptTotal) receiptTotal.innerHTML = sym + total.toFixed(2);
        }
        
        // ---------- PAYMENT ACCOUNTS ----------
        function addPaymentAccount() {
            accountCounter++;
            const id = `paymentAccount${accountCounter}`;
            const container = document.getElementById('paymentAccountsContainer');
            if (!container) return;
            
            const div = document.createElement('div');
            div.className = 'payment-account-item';
            div.id = id;
            div.innerHTML = `
                <div class="payment-account-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h5>Payment Account #${accountCounter}</h5>
                    ${accountCounter > 1 ? `<button class="btn btn-danger btn-sm" onclick="removePaymentAccount('${id}')">Remove</button>` : ''}
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Account Type</label>
                        <select class="form-control account-type" onchange="updateAccountFields(this)">
                            <option value="bank">Bank Account</option>
                            <option value="mobile">Mobile Money</option>
                            <option value="card">Card Payment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account Name</label>
                        <input type="text" class="form-control account-name" placeholder="e.g., Equity Bank USD Account">
                    </div>
                    <div class="form-group bank-fields">
                        <label>Bank Name</label>
                        <input type="text" class="form-control bank-name" placeholder="e.g., Equity Bank">
                    </div>
                    <div class="form-group bank-fields">
                        <label>Account Number</label>
                        <input type="text" class="form-control account-number" placeholder="Account number">
                    </div>
                    <div class="form-group bank-fields">
                        <label>SWIFT/BIC</label>
                        <input type="text" class="form-control swift-code" placeholder="SWIFT/BIC code">
                    </div>
                    <div class="form-group mobile-fields" style="display:none;">
                        <label>Mobile Network</label>
                        <select class="form-control mobile-network">
                            <option value="mpesa">M-Pesa</option>
                            <option value="airtel">Airtel Money</option>
                            <option value="tkash">T-Kash</option>
                        </select>
                    </div>
                    <div class="form-group mobile-fields" style="display:none;">
                        <label>Phone Number</label>
                        <input type="text" class="form-control phone-number" placeholder="Phone number">
                    </div>
                    <div class="form-group mobile-fields" style="display:none;">
                        <label>Paybill/Till Number</label>
                        <input type="text" class="form-control paybill-number" placeholder="Paybill/Till number">
                    </div>
                    <div class="form-group card-fields" style="display:none;">
                        <label>Card Type</label>
                        <select class="form-control card-type">
                            <option value="visa">Visa</option>
                            <option value="mastercard">MasterCard</option>
                            <option value="amex">American Express</option>
                        </select>
                    </div>
                    <div class="form-group card-fields" style="display:none;">
                        <label>Card Last 4 Digits</label>
                        <input type="text" class="form-control card-last4" maxlength="4" placeholder="Last 4 digits">
                    </div>
                    <div class="form-group">
                        <label>Processing Institution</label>
                        <input type="text" class="form-control processing-institution" placeholder="Institution name">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea class="form-control account-notes" rows="1" placeholder="Additional information"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(div);
            
            paymentAccounts.push({
                id: id,
                accountType: 'bank',
                accountName: '',
                bankName: '',
                accountNumber: '',
                swiftCode: ''
            });
        }
        
        function removePaymentAccount(id) {
            if (paymentAccounts.length <= 1) {
                alert('You must keep at least one payment account');
                return;
            }
            const element = document.getElementById(id);
            if (element) element.remove();
            paymentAccounts = paymentAccounts.filter(a => a.id !== id);
        }
        
        function updateAccountFields(select) {
            const item = select.closest('.payment-account-item');
            if (!item) return;
            
            const type = select.value;
            
            item.querySelectorAll('.bank-fields, .mobile-fields, .card-fields').forEach(f => {
                if (f) f.style.display = 'none';
            });
            
            if (type === 'bank') {
                item.querySelectorAll('.bank-fields').forEach(f => {
                    if (f) f.style.display = 'block';
                });
            } else if (type === 'mobile') {
                item.querySelectorAll('.mobile-fields').forEach(f => {
                    if (f) f.style.display = 'block';
                });
            } else if (type === 'card') {
                item.querySelectorAll('.card-fields').forEach(f => {
                    if (f) f.style.display = 'block';
                });
            }
        }
        
        function updateSelectedPaymentMethods() {
            selectedPaymentMethods = [];
            document.querySelectorAll('#paymentMethodsCheckboxList .payment-method-checkbox:checked').forEach(cb => {
                selectedPaymentMethods.push(cb.value);
            });
        }
        
        // ---------- TERMS ----------
        async function loadAllTerms() {
            if (!currentUser || !db) return;
            
            try {
                const q = window.firebaseApp.query(
                    window.firebaseApp.collection(db, "terms"),
                    window.firebaseApp.where("userId", "==", currentUser.uid),
                    window.firebaseApp.orderBy("createdAt", "desc")
                );
                const snap = await window.firebaseApp.getDocs(q);
                terms = [];
                
                const listEl = document.getElementById('termsList');
                const chkEl = document.getElementById('termsCheckboxList');
                
                if (listEl) listEl.innerHTML = '';
                if (chkEl) chkEl.innerHTML = '';
                
                if (snap.empty) {
                    if (chkEl) chkEl.innerHTML = '<div class="text-center" style="padding:20px; color:var(--gray-color);">No terms found. Add your first term!</div>';
                    if (listEl) listEl.innerHTML = '<div class="text-center" style="padding:20px; color:var(--gray-color);">No terms found.</div>';
                    return;
                }
                
                snap.forEach(doc => {
                    const term = { id: doc.id, ...doc.data() };
                    terms.push(term);
                    
                    if (chkEl) {
                        chkEl.insertAdjacentHTML('beforeend', `
                            <div class="term-checkbox-item" style="display:flex; align-items:flex-start; padding:10px; border:1px solid #eee; border-radius:5px; margin-bottom:5px;">
                                <input type="checkbox" class="term-checkbox" value="${doc.id}" style="margin-right:10px; margin-top:3px;">
                                <div class="term-checkbox-content" style="flex:1;">
                                    <div class="term-checkbox-name" style="font-weight:600; color:var(--primary-color);">${term.name || 'Untitled'} (${term.documentType || 'all'})</div>
                                    <div class="term-checkbox-text" style="font-size:0.9rem; color:#666; max-height:60px; overflow-y:auto;">${(term.content || '').substring(0,100)}...</div>
                                </div>
                            </div>
                        `);
                    }
                    
                    if (listEl) {
                        listEl.insertAdjacentHTML('beforeend', `
                            <div class="term-item" style="padding:15px; border:1px solid #eaeaea; border-radius:8px; background:white;">
                                <h5 style="color:var(--primary-color); margin-bottom:10px;">${term.name || 'Untitled'}</h5>
                                <p style="font-size:0.9rem; color:var(--gray-color); margin-bottom:5px;">Document Type: ${term.documentType === 'all' ? 'All Documents' : term.documentType}</p>
                                <div style="font-size:0.9rem; color:#666; max-height:100px; overflow-y:auto; margin-bottom:15px;">${(term.content || '').replace(/\n/g,'<br>')}</div>
                                <div style="display:flex; gap:10px;">
                                    <button class="btn btn-primary btn-sm" onclick="editTerm('${doc.id}')">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTerm('${doc.id}')">Delete</button>
                                </div>
                            </div>
                        `);
                    }
                });
            } catch(e) {
                console.error("Load terms error:", e);
            }
        }
        
        function loadTermsForDocumentType(docType) {
            const chkEl = document.getElementById('termsCheckboxList');
            if (!chkEl || terms.length === 0) return;
            
            chkEl.innerHTML = '';
            let hasAny = false;
            
            terms.forEach(term => {
                if (term.documentType === docType || term.documentType === 'all') {
                    hasAny = true;
                    chkEl.insertAdjacentHTML('beforeend', `
                        <div class="term-checkbox-item" style="display:flex; align-items:flex-start; padding:10px; border:1px solid #eee; border-radius:5px; margin-bottom:5px;">
                            <input type="checkbox" class="term-checkbox" value="${term.id}" style="margin-right:10px; margin-top:3px;">
                            <div class="term-checkbox-content" style="flex:1;">
                                <div class="term-checkbox-name" style="font-weight:600; color:var(--primary-color);">${term.name}</div>
                                <div class="term-checkbox-text" style="font-size:0.9rem; color:#666; max-height:60px; overflow-y:auto;">${(term.content || '').substring(0,100)}...</div>
                            </div>
                        </div>
                    `);
                }
            });
            
            if (!hasAny) {
                chkEl.innerHTML = '<div class="text-center" style="padding:20px; color:var(--gray-color);">No terms available for this document type</div>';
            }
        }
        
        function updateSelectedTerms() {
            selectedTermIds = [];
            document.querySelectorAll('.term-checkbox:checked').forEach(cb => {
                selectedTermIds.push(cb.value);
            });
            
            let termsText = '';
            selectedTermIds.forEach(id => {
                const term = terms.find(t => t.id === id);
                if (term) {
                    if (termsText) termsText += '\n\n';
                    termsText += term.content;
                }
            });
            
            const termsContent = document.getElementById('termsContent');
            if (termsContent) termsContent.textContent = termsText || 'No terms selected';
            
            const previewTerms = document.getElementById('previewTerms');
            if (previewTerms) {
                previewTerms.innerHTML = termsText ? termsText.replace(/\n/g, '<br>') : '<p>No terms selected</p>';
            }
        }
        
        async function saveTerm() {
            const name = document.getElementById('termName').value.trim();
            const content = document.getElementById('termContent').value.trim();
            const docType = document.getElementById('termDocumentType').value;
            
            if (!name || !content) {
                showAlert('termsAlert', 'Term name and content are required', 'danger');
                return;
            }
            
            const data = {
                name,
                content,
                documentType: docType,
                userId: currentUser.uid,
                updatedAt: window.firebaseApp.Timestamp.now()
            };
            
            try {
                if (currentTermId) {
                    await window.firebaseApp.updateDoc(window.firebaseApp.doc(db, "terms", currentTermId), data);
                    showAlert('termsAlert', 'Term updated successfully!', 'success');
                } else {
                    data.createdAt = window.firebaseApp.Timestamp.now();
                    await window.firebaseApp.addDoc(window.firebaseApp.collection(db, "terms"), data);
                    showAlert('termsAlert', 'Term saved successfully!', 'success');
                    document.getElementById('deleteTermBtn').style.display = 'inline-block';
                }
                
                clearTermForm();
                await loadAllTerms();
                loadTermsForDocumentType(document.getElementById('documentType').value);
            } catch(e) {
                console.error("Save term error:", e);
                showAlert('termsAlert', 'Error: ' + e.message, 'danger');
            }
        }
        
        function editTerm(id) {
            const term = terms.find(t => t.id === id);
            if (!term) return;
            
            currentTermId = id;
            document.getElementById('termName').value = term.name || '';
            document.getElementById('termContent').value = term.content || '';
            document.getElementById('termDocumentType').value = term.documentType || 'all';
            document.getElementById('deleteTermBtn').style.display = 'inline-block';
            
            document.querySelector('.nav-tab[data-tab="terms"]').click();
        }
        
        function clearTermForm() {
            currentTermId = null;
            document.getElementById('termName').value = '';
            document.getElementById('termContent').value = '';
            document.getElementById('termDocumentType').value = 'all';
            document.getElementById('deleteTermBtn').style.display = 'none';
        }
        
        async function deleteTerm(id) {
            const targetId = id || currentTermId;
            if (!targetId || !confirm('Are you sure you want to delete this term?')) return;
            
            try {
                await window.firebaseApp.deleteDoc(window.firebaseApp.doc(db, "terms", targetId));
                showAlert('termsAlert', 'Term deleted successfully!', 'success');
                
                if (!id) clearTermForm();
                await loadAllTerms();
                loadTermsForDocumentType(document.getElementById('documentType').value);
            } catch(e) {
                console.error("Delete term error:", e);
                showAlert('termsAlert', 'Error: ' + e.message, 'danger');
            }
        }
        
        // ---------- COMPANIES ----------
        async function loadCompanies() {
            if (!db) return;
            
            try {
                const snap = await window.firebaseApp.getDocs(window.firebaseApp.collection(db, "companies"));
                companies = [];
                
                const sel = document.getElementById('companySelect');
                const list = document.getElementById('companyList');
                
                if (sel) {
                    sel.innerHTML = '<option value="">Select a company</option>';
                }
                if (list) {
                    list.innerHTML = '';
                }
                
                if (snap.empty) {
                    if (list) {
                        list.innerHTML = '<div class="text-center" style="padding:40px; color:var(--gray-color);">No companies found. Add your first company below.</div>';
                    }
                    return;
                }
                
                snap.forEach(doc => {
                    const company = { id: doc.id, ...doc.data() };
                    companies.push(company);
                    
                    if (sel) {
                        sel.insertAdjacentHTML('beforeend', `<option value="${doc.id}">${company.name || 'Unnamed Company'}</option>`);
                    }
                    
                    if (list) {
                        list.insertAdjacentHTML('beforeend', `
                            <div class="company-card" style="padding:20px; border:1px solid #eaeaea; border-radius:8px; background:white;">
                                <div style="display:flex; align-items:center; margin-bottom:15px;">
                                    <div style="flex:1;">
                                        <h4 style="margin-bottom:5px; color:var(--secondary-color);">${company.name || 'Unnamed'}</h4>
                                        <p style="font-size:0.9rem; color:var(--gray-color);">${company.email || 'No email'}</p>
                                        ${company.parentCompany ? `<p style="font-size:0.8rem; color:var(--gray-color);">Parent: ${company.parentCompany}</p>` : ''}
                                    </div>
                                </div>
                                <p style="margin-bottom:10px; font-size:0.9rem;">${company.address || 'No address'}</p>
                                <div style="display:flex; gap:5px; margin-bottom:15px;">
                                    <span style="display:inline-block; width:30px; height:30px; border-radius:5px; background:${company.primaryColor || '#4361ee'}; border:1px solid #ddd;"></span>
                                    <span style="display:inline-block; width:30px; height:30px; border-radius:5px; background:${company.secondaryColor || '#3a0ca3'}; border:1px solid #ddd;"></span>
                                </div>
                                <div style="display:flex; gap:5px;">
                                    <button class="btn btn-primary btn-sm" onclick="editCompany('${doc.id}')">Edit</button>
                                </div>
                            </div>
                        `);
                    }
                });
                
                if (sel && companies.length > 0) {
                    sel.value = companies[0].id;
                    onCompanySelect();
                }
            } catch(e) {
                console.error("Load companies error:", e);
                showAlert('adminAlert', 'Error loading companies: ' + e.message, 'danger');
            }
        }
        
        function onCompanySelect() {
            const id = document.getElementById('companySelect').value;
            if (!id) return;
            
            const company = companies.find(c => c.id === id);
            if (!company) return;
            
            document.getElementById('previewCompanyName').textContent = company.name || 'Company Name';
            
            let contactInfo = '';
            if (company.email) contactInfo += company.email + '<br>';
            if (company.phone) contactInfo += company.phone + '<br>';
            if (company.address) contactInfo += company.address;
            
            document.getElementById('previewCompanyContact').innerHTML = contactInfo || 'No contact information';
            
            const parentEl = document.getElementById('previewParentCompany');
            if (parentEl) {
                if (company.parentCompany) {
                    parentEl.textContent = `A division of ${company.parentCompany}`;
                    parentEl.style.display = 'block';
                } else {
                    parentEl.style.display = 'none';
                }
            }
            
            const taxEl = document.getElementById('previewCompanyTax');
            if (taxEl) {
                if (company.taxPin) {
                    taxEl.textContent = `TAX PIN: ${company.taxPin}`;
                    taxEl.style.display = 'block';
                } else {
                    taxEl.style.display = 'none';
                }
            }
            
            if (company.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', company.primaryColor);
            }
            if (company.secondaryColor) {
                document.documentElement.style.setProperty('--secondary-color', company.secondaryColor);
            }
        }
        
        async function saveCompany() {
            const name = document.getElementById('companyName').value.trim();
            const email = document.getElementById('companyEmail').value.trim();
            
            if (!name || !email) {
                showAlert('adminAlert', 'Company name and email are required', 'danger');
                return;
            }
            
            const data = {
                name,
                parentCompany: document.getElementById('parentCompany').value.trim(),
                taxPin: document.getElementById('companyTaxPin').value.trim(),
                email,
                phone: document.getElementById('companyPhone').value.trim(),
                website: document.getElementById('companyWebsite').value.trim(),
                address: document.getElementById('companyAddress').value.trim(),
                primaryColor: document.getElementById('primaryColor').value,
                secondaryColor: document.getElementById('secondaryColor').value,
                updatedAt: window.firebaseApp.Timestamp.now()
            };
            
            try {
                if (currentCompanyId) {
                    await window.firebaseApp.updateDoc(window.firebaseApp.doc(db, "companies", currentCompanyId), data);
                    showAlert('adminAlert', 'Company updated successfully!', 'success');
                } else {
                    data.createdAt = window.firebaseApp.Timestamp.now();
                    await window.firebaseApp.addDoc(window.firebaseApp.collection(db, "companies"), data);
                    showAlert('adminAlert', 'Company saved successfully!', 'success');
                }
                
                await loadCompanies();
                clearCompanyForm();
            } catch(e) {
                console.error("Save company error:", e);
                showAlert('adminAlert', 'Error: ' + e.message, 'danger');
            }
        }
        
        function editCompany(id) {
            const company = companies.find(c => c.id === id);
            if (!company) return;
            
            currentCompanyId = id;
            
            document.getElementById('companyName').value = company.name || '';
            document.getElementById('parentCompany').value = company.parentCompany || '';
            document.getElementById('companyTaxPin').value = company.taxPin || '';
            document.getElementById('companyEmail').value = company.email || '';
            document.getElementById('companyPhone').value = company.phone || '';
            document.getElementById('companyWebsite').value = company.website || '';
            document.getElementById('companyAddress').value = company.address || '';
            document.getElementById('primaryColor').value = company.primaryColor || '#4361ee';
            document.getElementById('secondaryColor').value = company.secondaryColor || '#3a0ca3';
            
            document.getElementById('deleteCompanyBtn').style.display = 'inline-block';
            document.querySelector('.nav-tab[data-tab="admin"]').click();
        }
        
        function clearCompanyForm() {
            currentCompanyId = null;
            
            document.getElementById('companyName').value = '';
            document.getElementById('parentCompany').value = '';
            document.getElementById('companyTaxPin').value = '';
            document.getElementById('companyEmail').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyWebsite').value = '';
            document.getElementById('companyAddress').value = '';
            document.getElementById('primaryColor').value = '#4361ee';
            document.getElementById('secondaryColor').value = '#3a0ca3';
            
            document.getElementById('deleteCompanyBtn').style.display = 'none';
        }
        
        async function deleteCompany() {
            if (!currentCompanyId || !confirm('Are you sure you want to delete this company? This action cannot be undone.')) {
                return;
            }
            
            try {
                await window.firebaseApp.deleteDoc(window.firebaseApp.doc(db, "companies", currentCompanyId));
                showAlert('adminAlert', 'Company deleted successfully!', 'success');
                await loadCompanies();
                clearCompanyForm();
            } catch(e) {
                console.error("Delete company error:", e);
                showAlert('adminAlert', 'Error: ' + e.message, 'danger');
            }
        }
        
        // ---------- CLIENTS ----------
        async function loadClients() {
            if (!currentUser || !db) return;
            
            try {
                const q = window.firebaseApp.query(
                    window.firebaseApp.collection(db, "clients"),
                    window.firebaseApp.where("userId", "==", currentUser.uid),
                    window.firebaseApp.orderBy("createdAt", "desc")
                );
                const snap = await window.firebaseApp.getDocs(q);
                clients = [];
                
                const list = document.getElementById('clientList');
                if (list) list.innerHTML = '';
                
                if (snap.empty) {
                    if (list) {
                        list.innerHTML = '<div class="text-center" style="padding:40px; color:var(--gray-color);">No clients found. Add your first client!</div>';
                    }
                    return;
                }
                
                snap.forEach(doc => {
                    const client = { id: doc.id, ...doc.data() };
                    clients.push(client);
                    
                    if (list) {
                        const safeName = (client.name || '').replace(/'/g, "\\'");
                        const safeEmail = (client.email || '').replace(/'/g, "\\'");
                        const safePhone = (client.phone || '').replace(/'/g, "\\'");
                        const safeAddress = (client.address || '').replace(/'/g, "\\'");
                        
                        list.insertAdjacentHTML('beforeend', `
                            <div class="client-card" onclick="selectClient({name:'${safeName}', email:'${safeEmail}', phone:'${safePhone}', address:'${safeAddress}'})" style="padding:15px; border:1px solid #eaeaea; border-radius:8px; background:white; cursor:pointer;">
                                <h4 style="color:var(--primary-color); margin-bottom:5px;">${client.name || 'Unnamed'}</h4>
                                ${client.email ? `<p style="font-size:0.9rem; color:var(--gray-color);">📧 ${client.email}</p>` : ''}
                                ${client.phone ? `<p style="font-size:0.9rem; color:var(--gray-color);">📱 ${client.phone}</p>` : ''}
                                ${client.address ? `<p style="font-size:0.9rem; color:var(--gray-color);">📍 ${client.address}</p>` : ''}
                            </div>
                        `);
                    }
                });
            } catch(e) {
                console.error("Load clients error:", e);
                showAlert('clientsAlert', 'Error loading clients: ' + e.message, 'danger');
            }
        }
        
        function filterClients(searchTerm) {
            const cards = document.querySelectorAll('#clientList .client-card');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function showClientList() {
            document.querySelector('.nav-tab[data-tab="clients"]').click();
        }
        
        function selectClient(client) {
            document.getElementById('customerName').value = client.name || '';
            document.getElementById('customerEmail').value = client.email || '';
            document.getElementById('customerPhone').value = client.phone || '';
            document.getElementById('customerAddress').value = client.address || '';
            
            document.querySelector('.nav-tab[data-tab="create"]').click();
            showAlert('createAlert', `Client "${client.name}" selected`, 'success');
        }
        
        function clearClientForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
        }
        
        async function saveCurrentClient() {
            const name = document.getElementById('customerName').value.trim();
            if (!name) {
                showAlert('createAlert', 'Client name is required', 'danger');
                return;
            }
            
            const data = {
                name,
                email: document.getElementById('customerEmail').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                address: document.getElementById('customerAddress').value.trim(),
                userId: currentUser.uid,
                updatedAt: window.firebaseApp.Timestamp.now()
            };
            
            try {
                const existing = clients.find(c => 
                    (c.email && c.email === data.email) || 
                    (c.name && c.name.toLowerCase() === data.name.toLowerCase())
                );
                
                if (existing) {
                    await window.firebaseApp.updateDoc(window.firebaseApp.doc(db, "clients", existing.id), data);
                    showAlert('createAlert', 'Client updated successfully!', 'success');
                } else {
                    data.createdAt = window.firebaseApp.Timestamp.now();
                    await window.firebaseApp.addDoc(window.firebaseApp.collection(db, "clients"), data);
                    showAlert('createAlert', 'Client saved successfully!', 'success');
                }
                
                await loadClients();
            } catch(e) {
                console.error("Save client error:", e);
                showAlert('createAlert', 'Error: ' + e.message, 'danger');
            }
        }
        
        // ---------- DOCUMENT GENERATION ----------
        async function generateDocument() {
            if (selectedTermIds.length === 0) {
                showAlert('createAlert', 'Please select at least one term', 'danger');
                return;
            }
            
            if (selectedPaymentMethods.length === 0) {
                showAlert('createAlert', 'Please select at least one payment method', 'danger');
                return;
            }
            
            const companyId = document.getElementById('companySelect').value;
            if (!companyId) {
                showAlert('createAlert', 'Please select a company', 'danger');
                return;
            }
            
            const customerName = document.getElementById('customerName').value.trim();
            if (!customerName) {
                showAlert('createAlert', 'Customer name is required', 'danger');
                return;
            }
            
            const type = document.getElementById('documentType').value;
            
            // Collect items
            let items = [];
            let subtotal = 0;
            
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const desc = row.querySelector('.item-desc')?.value;
                if (desc && desc.trim()) {
                    const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                    const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                    const total = qty * price;
                    
                    items.push({
                        description: desc,
                        quantity: qty,
                        unitPrice: price,
                        total: total
                    });
                    subtotal += total;
                }
            });
            
            if (items.length === 0) {
                showAlert('createAlert', 'Please add at least one item', 'danger');
                return;
            }
            
            let discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            if (discount > subtotal) discount = subtotal;
            
            const discounted = subtotal - discount;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const tax = discounted * (taxRate / 100);
            const total = discounted + tax;
            
            const company = companies.find(c => c.id === companyId);
            
            // Collect terms text
            let termsText = '';
            selectedTermIds.forEach(id => {
                const term = terms.find(t => t.id === id);
                if (term) {
                    if (termsText) termsText += '\n\n';
                    termsText += term.content;
                }
            });
            
            // Collect payment accounts
            const accounts = [];
            document.querySelectorAll('.payment-account-item').forEach(item => {
                accounts.push({
                    id: item.id,
                    accountType: item.querySelector('.account-type')?.value || 'bank',
                    accountName: item.querySelector('.account-name')?.value || '',
                    bankName: item.querySelector('.bank-name')?.value || '',
                    accountNumber: item.querySelector('.account-number')?.value || '',
                    swiftCode: item.querySelector('.swift-code')?.value || ''
                });
            });
            
            const docData = {
                type,
                serialNumber: document.getElementById('serialNumber').value,
                currency: selectedCurrency,
                companyId,
                companyName: company?.name || '',
                companyEmail: company?.email || '',
                companyPhone: company?.phone || '',
                companyAddress: company?.address || '',
                companyWebsite: company?.website || '',
                parentCompany: company?.parentCompany || '',
                taxPin: company?.taxPin || '',
                customerName,
                customerEmail: document.getElementById('customerEmail').value.trim(),
                customerPhone: document.getElementById('customerPhone').value.trim(),
                customerAddress: document.getElementById('customerAddress').value.trim(),
                items,
                subtotal,
                discount,
                taxRate,
                taxAmount: tax,
                total,
                selectedPaymentMethods,
                paymentAccounts: accounts,
                selectedTermIds,
                terms: termsText,
                userId: currentUser.uid,
                createdAt: window.firebaseApp.Timestamp.now(),
                revoked: false,
                payments: []
            };
            
            if (type === 'receipt') {
                docData.receiptReason = document.getElementById('receiptReason').value.trim() || 'Payment';
                docData.receiptDate = document.getElementById('receiptDate').value;
                docData.totalAmount = total;
            }
            
            const btn = document.getElementById('generateBtn');
            const text = document.getElementById('generateText');
            const spinner = document.getElementById('generateSpinner');
            
            text.textContent = 'Generating...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                await window.firebaseApp.addDoc(window.firebaseApp.collection(db, "documents"), docData);
                showAlert('createAlert', 'Document generated successfully!', 'success');
                clearForm();
                await loadDocumentHistory();
            } catch(e) {
                console.error("Generate document error:", e);
                showAlert('createAlert', 'Error: ' + e.message, 'danger');
            } finally {
                text.textContent = 'Generate Document';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }
        
        // ---------- PREVIEW ----------
        function previewDocument() {
            const customerName = document.getElementById('customerName').value || 'John Doe';
            const customerEmail = document.getElementById('customerEmail').value || 'john@example.com';
            const customerPhone = document.getElementById('customerPhone').value || '+1234567890';
            const customerAddress = document.getElementById('customerAddress').value || '123 Main St, City, Country';
            
            const details = `<strong>${customerName}</strong><br>${customerEmail}<br>${customerPhone}<br>${customerAddress}`;
            
            const previewCustomerDetails = document.getElementById('previewCustomerDetails');
            const previewCustomerDetailsStandard = document.getElementById('previewCustomerDetailsStandard');
            
            if (previewCustomerDetails) previewCustomerDetails.innerHTML = details;
            if (previewCustomerDetailsStandard) previewCustomerDetailsStandard.innerHTML = details;
            
            const type = document.getElementById('documentType').value;
            const title = {invoice:'INVOICE', quote:'QUOTE', receipt:'RECEIPT', proforma:'PROFORMA INVOICE'}[type] || 'DOCUMENT';
            
            const previewTitle = document.getElementById('previewDocumentTitle');
            const previewDocType = document.getElementById('previewDocType');
            
            if (previewTitle) previewTitle.textContent = title;
            if (previewDocType) previewDocType.textContent = title.charAt(0) + title.slice(1).toLowerCase();
            
            const serial = document.getElementById('serialNumber').value;
            const previewSerial = document.getElementById('previewSerialNumber');
            const previewReceiptSerial = document.getElementById('previewReceiptSerial');
            
            if (previewSerial) previewSerial.textContent = serial;
            if (previewReceiptSerial) previewReceiptSerial.textContent = serial;
            
            const today = new Date().toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
            const previewDate = document.getElementById('previewDate');
            const previewReceiptDate = document.getElementById('previewReceiptDate');
            
            if (previewDate) previewDate.textContent = today;
            if (previewReceiptDate) previewReceiptDate.textContent = today;
            
            const previewCurrency = document.getElementById('previewCurrency');
            const previewReceiptCurrency = document.getElementById('previewReceiptCurrency');
            
            if (previewCurrency) previewCurrency.textContent = selectedCurrency;
            if (previewReceiptCurrency) previewReceiptCurrency.textContent = selectedCurrency;
            
            // Show/hide receipt preview
            const receiptPreview = document.getElementById('receiptPreview');
            const standardPreview = document.getElementById('standardPreview');
            
            if (type === 'receipt') {
                if (receiptPreview) receiptPreview.classList.remove('hidden');
                if (standardPreview) standardPreview.classList.add('hidden');
                
                const previewReceiptReason = document.getElementById('previewReceiptReason');
                if (previewReceiptReason) {
                    previewReceiptReason.textContent = document.getElementById('receiptReason').value || 'Payment for services';
                }
            } else {
                if (receiptPreview) receiptPreview.classList.add('hidden');
                if (standardPreview) standardPreview.classList.remove('hidden');
            }
            
            // Populate items preview
            const sym = selectedCurrency === 'USD' ? '$' : 'KSh';
            const previewItems = document.getElementById('previewItems');
            const receiptPreviewItems = document.getElementById('receiptPreviewItems');
            
            if (previewItems) previewItems.innerHTML = '';
            if (receiptPreviewItems) receiptPreviewItems.innerHTML = '';
            
            let hasItems = false;
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const desc = row.querySelector('.item-desc')?.value;
                if (desc && desc.trim()) {
                    hasItems = true;
                    const qty = row.querySelector('.item-qty')?.value || 0;
                    const price = row.querySelector('.item-price')?.value || 0;
                    const total = parseFloat(qty) * parseFloat(price);
                    
                    const rowHtml = `<tr><td>${desc}</td><td>${qty}</td><td>${sym}${parseFloat(price).toFixed(2)}</td><td>${sym}${total.toFixed(2)}</td></tr>`;
                    
                    if (previewItems) previewItems.insertAdjacentHTML('beforeend', rowHtml);
                    if (receiptPreviewItems) receiptPreviewItems.insertAdjacentHTML('beforeend', rowHtml);
                }
            });
            
            if (!hasItems) {
                if (previewItems) previewItems.innerHTML = '<tr><td colspan="4" class="text-center">No items added</td></tr>';
                if (receiptPreviewItems) receiptPreviewItems.innerHTML = '<tr><td colspan="4" class="text-center">No items added</td></tr>';
            }
            
            updateItemTotals();
            updateSelectedTerms();
        }
        
        function refreshPreview() {
            previewDocument();
        }
        
       // ---------- PDF GENERATION (COMPLETELY FIXED) ----------
async function generatePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ 
            orientation: 'portrait', 
            unit: 'mm', 
            format: 'a4'
        });
        
        // First, make sure we're on the preview tab and the preview is fresh
        const previewTab = document.querySelector('.nav-tab[data-tab="preview"]');
        if (!previewTab.classList.contains('active')) {
            previewDocument();
            // Wait for preview to render
            await new Promise(resolve => setTimeout(resolve, 800));
        }
        
        const element = document.getElementById('documentPreview');
        if (!element) {
            throw new Error('Preview element not found');
        }

        // Store original state
        const originalDisplay = element.style.display;
        const originalPosition = element.style.position;
        const originalStyles = {
            width: element.style.width,
            padding: element.style.padding,
            margin: element.style.margin,
            background: element.style.background,
            fontSize: element.style.fontSize,
            boxSizing: element.style.boxSizing,
            position: element.style.position,
            left: element.style.left,
            top: element.style.top
        };

        // Create a clone of the element for PDF generation
        const clone = element.cloneNode(true);
        clone.id = 'documentPreview-clone';
        
        // Style the clone for PDF
        clone.style.width = '210mm';
        clone.style.padding = '15mm';
        clone.style.margin = '0';
        clone.style.background = 'white';
        clone.style.fontSize = '12px';
        clone.style.boxSizing = 'border-box';
        clone.style.position = 'absolute';
        clone.style.left = '-9999px';
        clone.style.top = '0';
        clone.style.visibility = 'visible';
        clone.style.display = 'block';
        clone.style.zIndex = '-1000';
        
        // Add pdf-mode class to clone
        clone.classList.add('pdf-mode');
        
        // Remove any hidden elements from clone
        clone.querySelectorAll('.no-print, .btn, .nav-tabs, .action-buttons, button:not(.document-table button)').forEach(el => {
            if (el) el.style.display = 'none';
        });
        
        // Ensure tables are properly formatted
        clone.querySelectorAll('table').forEach(table => {
            table.style.width = '100%';
            table.style.tableLayout = 'fixed';
            table.style.fontSize = '11px';
            table.style.borderCollapse = 'collapse';
            
            table.querySelectorAll('th, td').forEach(cell => {
                cell.style.padding = '6px 4px';
                cell.style.border = '1px solid #ddd';
            });
            
            // Set column widths
            const headers = table.querySelectorAll('th');
            if (headers.length >= 4) {
                headers[0].style.width = '45%';
                headers[1].style.width = '15%';
                headers[2].style.width = '20%';
                headers[3].style.width = '20%';
            }
        });
        
        // Ensure customer details are populated in the clone
        const cloneCustomerDetails = clone.querySelector('#previewCustomerDetails');
        const cloneCustomerDetailsStd = clone.querySelector('#previewCustomerDetailsStandard');
        const originalCustomerDetails = document.querySelector('#previewCustomerDetails')?.innerHTML;
        const originalCustomerDetailsStd = document.querySelector('#previewCustomerDetailsStandard')?.innerHTML;
        
        if (cloneCustomerDetails && originalCustomerDetails) {
            cloneCustomerDetails.innerHTML = originalCustomerDetails;
        }
        if (cloneCustomerDetailsStd && originalCustomerDetailsStd) {
            cloneCustomerDetailsStd.innerHTML = originalCustomerDetailsStd;
        }
        
        // Append clone to body
        document.body.appendChild(clone);
        
        // Wait for clone to be fully rendered
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Render the clone with html2canvas
        const canvas = await html2canvas(clone, {
            scale: 2,
            useCORS: true,
            allowTaint: false,
            backgroundColor: '#ffffff',
            logging: false,
            windowWidth: 210 * 3.78, // 210mm in pixels at 96 DPI
            windowHeight: clone.scrollHeight
        });

        // Remove the clone
        document.body.removeChild(clone);

        // Validate canvas
        if (!canvas || canvas.width === 0 || canvas.height === 0) {
            throw new Error('Canvas rendering failed - empty canvas');
        }

        // Get image data
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        if (!imgData || imgData.length < 100) {
            throw new Error('Image data is invalid');
        }

        // Calculate dimensions for PDF
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        
        // Margins (5mm each side)
        const margin = 5;
        const maxWidth = pdfWidth - (margin * 2);
        const maxHeight = pdfHeight - (margin * 2);
        
        // Calculate image dimensions to fit within margins
        const ratio = canvas.width / canvas.height;
        let finalWidth = maxWidth;
        let finalHeight = finalWidth / ratio;
        
        if (finalHeight > maxHeight) {
            finalHeight = maxHeight;
            finalWidth = finalHeight * ratio;
        }
        
        // Center the image on the page
        const x = margin + (maxWidth - finalWidth) / 2;
        const y = margin + (maxHeight - finalHeight) / 2;
        
        // Validate coordinates
        if (isNaN(x) || isNaN(y) || isNaN(finalWidth) || isNaN(finalHeight) || 
            finalWidth <= 0 || finalHeight <= 0) {
            throw new Error('Invalid PDF coordinates calculated');
        }
        
        // Add image to PDF
        pdf.addImage(imgData, 'JPEG', x, y, finalWidth, finalHeight, undefined, 'FAST');
        
        // Add footer with document info
        pdf.setFontSize(8);
        pdf.setTextColor(100, 100, 100);
        const serialNumber = document.getElementById('serialNumber')?.value || 'N/A';
        const date = new Date().toLocaleDateString();
        pdf.text(`Document: ${serialNumber} | Generated: ${date} | STARKS GALAXY LIMITED`, pdfWidth / 2, pdfHeight - 3, { align: 'center' });
        
        // Save PDF
        const filename = `${serialNumber}.pdf`;
        pdf.save(filename);
        
        showAlert('historyAlert', 'PDF generated successfully!', 'success');
        
    } catch (err) {
        console.error('PDF generation error:', err);
        
        // ULTIMATE FALLBACK: Generate PDF directly from form data
        try {
            console.log('Attempting direct data PDF generation...');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Get document data
            const docType = document.getElementById('documentType')?.value || 'Document';
            const serialNumber = document.getElementById('serialNumber')?.value || 'N/A';
            const companyName = document.getElementById('companySelect')?.selectedOptions[0]?.text || 'STARKS GALAXY LIMITED';
            const customerName = document.getElementById('customerName')?.value || 'Customer';
            const customerEmail = document.getElementById('customerEmail')?.value || '';
            const customerPhone = document.getElementById('customerPhone')?.value || '';
            const customerAddress = document.getElementById('customerAddress')?.value || '';
            const currency = selectedCurrency === 'USD' ? '$' : 'KSh';
            const date = new Date().toLocaleDateString();
            
            // Company Header
            pdf.setFontSize(20);
            pdf.setTextColor(67, 97, 238);
            pdf.text(companyName, 105, 20, { align: 'center' });
            
            pdf.setFontSize(24);
            pdf.setTextColor(58, 12, 163);
            pdf.text(docType.toUpperCase(), 105, 35, { align: 'center' });
            
            // Document Info
            pdf.setFontSize(11);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`Serial No: ${serialNumber}`, 20, 50);
            pdf.text(`Date: ${date}`, 20, 58);
            pdf.text(`Currency: ${selectedCurrency}`, 20, 66);
            
            // Customer Info
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'bold');
            pdf.text('Bill To:', 20, 85);
            pdf.setFont(undefined, 'normal');
            pdf.setFontSize(11);
            pdf.text(customerName, 20, 95);
            if (customerEmail) pdf.text(customerEmail, 20, 103);
            if (customerPhone) pdf.text(customerPhone, 20, 111);
            if (customerAddress) {
                const addressLines = pdf.splitTextToSize(customerAddress, 80);
                pdf.text(addressLines, 20, 119);
            }
            
            // Items Table Header
            let yPos = 140;
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'bold');
            pdf.text('Description', 20, yPos);
            pdf.text('Qty', 130, yPos, { align: 'right' });
            pdf.text('Price', 150, yPos, { align: 'right' });
            pdf.text('Total', 180, yPos, { align: 'right' });
            
            yPos += 5;
            pdf.line(20, yPos, 190, yPos);
            yPos += 5;
            
            // Items
            pdf.setFont(undefined, 'normal');
            let subtotal = 0;
            const rows = document.querySelectorAll('#itemsTableBody tr');
            
            rows.forEach(row => {
                if (yPos > 250) {
                    pdf.addPage();
                    yPos = 20;
                }
                
                const desc = row.querySelector('.item-desc')?.value;
                const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                const total = qty * price;
                
                if (desc && desc.trim()) {
                    subtotal += total;
                    
                    const descLines = pdf.splitTextToSize(desc, 100);
                    pdf.text(descLines, 20, yPos);
                    pdf.text(qty.toString(), 130, yPos, { align: 'right' });
                    pdf.text(`${currency}${price.toFixed(2)}`, 150, yPos, { align: 'right' });
                    pdf.text(`${currency}${total.toFixed(2)}`, 180, yPos, { align: 'right' });
                    yPos += 7 * descLines.length;
                }
            });
            
            // Totals
            yPos += 5;
            pdf.line(20, yPos, 190, yPos);
            yPos += 7;
            
            const discount = parseFloat(document.getElementById('discountAmount')?.value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate')?.value) || 0;
            const discounted = subtotal - discount;
            const tax = discounted * (taxRate / 100);
            const total = discounted + tax;
            
            pdf.setFont(undefined, 'bold');
            pdf.text('Subtotal:', 150, yPos, { align: 'right' });
            pdf.text(`${currency}${subtotal.toFixed(2)}`, 180, yPos, { align: 'right' });
            yPos += 7;
            
            pdf.text('Discount:', 150, yPos, { align: 'right' });
            pdf.text(`-${currency}${discount.toFixed(2)}`, 180, yPos, { align: 'right' });
            yPos += 7;
            
            pdf.text(`Tax (${taxRate}%):`, 150, yPos, { align: 'right' });
            pdf.text(`${currency}${tax.toFixed(2)}`, 180, yPos, { align: 'right' });
            yPos += 7;
            
            pdf.setFontSize(12);
            pdf.text('Total:', 150, yPos, { align: 'right' });
            pdf.text(`${currency}${total.toFixed(2)}`, 180, yPos, { align: 'right' });
            
            // Footer
            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Thank you for your business!', 105, 280, { align: 'center' });
            pdf.text('Generated by STARKS GALAXY LIMITED Document Generator', 105, 288, { align: 'center' });
            
            // Save
            pdf.save(`${serialNumber}.pdf`);
            
            showAlert('historyAlert', 'PDF generated successfully!', 'success');
            
        } catch (fallbackErr) {
            console.error('Fallback PDF generation failed:', fallbackErr);
            alert('PDF generation failed. Please try again or contact support.');
        }
    }
}
        
        // ---------- DOCUMENT HISTORY ----------
        async function loadDocumentHistory() {
            if (!db) return;
            
            try {
                const filter = document.getElementById('historyFilter').value;
                let q;
                
                if (filter === 'all') {
                    q = window.firebaseApp.query(
                        window.firebaseApp.collection(db, "documents"),
                        window.firebaseApp.orderBy("createdAt", "desc")
                    );
                } else {
                    q = window.firebaseApp.query(
                        window.firebaseApp.collection(db, "documents"),
                        window.firebaseApp.where("type", "==", filter),
                        window.firebaseApp.orderBy("createdAt", "desc")
                    );
                }
                
                const snap = await window.firebaseApp.getDocs(q);
                documents = [];
                
                const tbody = document.getElementById('historyTableBody');
                if (tbody) tbody.innerHTML = '';
                
                if (snap.empty) {
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="padding:40px;">No documents found. Create your first document!</td></tr>';
                    }
                    return;
                }
                
                snap.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    documents.push(data);
                    
                    const date = data.createdAt?.toDate?.() ? data.createdAt.toDate().toLocaleDateString() : 'N/A';
                    const sym = data.currency === 'KSH' ? 'KSh' : '$';
                    const total = data.totalAmount || data.total || 0;
                    
                    if (tbody) {
                        tbody.insertAdjacentHTML('beforeend', `
                            <tr>
                                <td>${data.serialNumber || 'N/A'}</td>
                                <td><span style="text-transform:capitalize;">${data.type || ''}</span></td>
                                <td>${data.customerName || ''}</td>
                                <td>${date}</td>
                                <td>${sym}${total.toFixed(2)}</td>
                                <td>
                                    <span style="display:inline-block; padding:4px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; background:${data.revoked ? 'rgba(247,37,133,0.2)' : 'rgba(76,201,240,0.2)'}; color:${data.revoked ? '#c2185b' : '#0a8ea8'};">
                                        ${data.revoked ? 'Revoked' : 'Active'}
                                    </span>
                                </td>
                                <td>
                                    <div style="display:flex; gap:5px;">
                                        <button class="btn btn-primary btn-sm" onclick="viewDocument('${doc.id}')">View</button>
                                        <button class="btn btn-success btn-sm" onclick="downloadDocumentPDF('${doc.id}')">PDF</button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    }
                });
            } catch(e) {
                console.error("Load history error:", e);
                showAlert('historyAlert', 'Error loading document history: ' + e.message, 'danger');
            }
        }
        
        function viewDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) return;
            
            // Set document type
            const docTypeSelect = document.getElementById('documentType');
            if (docTypeSelect) docTypeSelect.value = doc.type || 'invoice';
            
            // Set currency
            if (doc.currency) {
                selectCurrency(doc.currency);
            }
            
            // Set company
            if (doc.companyId) {
                const companySelect = document.getElementById('companySelect');
                for (let i = 0; i < companySelect.options.length; i++) {
                    if (companySelect.options[i].value === doc.companyId) {
                        companySelect.value = doc.companyId;
                        break;
                    }
                }
                onCompanySelect();
            }
            
            // Set customer details
            document.getElementById('customerName').value = doc.customerName || '';
            document.getElementById('customerEmail').value = doc.customerEmail || '';
            document.getElementById('customerPhone').value = doc.customerPhone || '';
            document.getElementById('customerAddress').value = doc.customerAddress || '';
            
            // Set receipt fields
            if (doc.type === 'receipt') {
                document.getElementById('receiptReason').value = doc.receiptReason || '';
                document.getElementById('receiptDate').value = doc.receiptDate || '';
            }
            
            // Load items
            const tbody = document.getElementById('itemsTableBody');
            if (tbody) tbody.innerHTML = '';
            
            if (doc.items && doc.items.length > 0) {
                doc.items.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><input type="text" class="form-control item-desc" value="${item.description || ''}"></td>
                        <td><input type="number" class="form-control item-qty" value="${item.quantity || 1}" min="1"></td>
                        <td><input type="number" class="form-control item-price" value="${item.unitPrice || 0}" min="0" step="0.01"></td>
                        <td class="item-total">$0.00</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">✕</button></td>
                    `;
                });
            } else {
                addItem();
            }
            
            // Set discount and tax
            document.getElementById('discountAmount').value = doc.discount || 0;
            document.getElementById('taxRate').value = doc.taxRate || 0;
            
            updateItemTotals();
            updateFormLayout();
            updateSerialNumber();
            
            // Switch to create tab and preview
            document.querySelector('.nav-tab[data-tab="create"]').click();
            setTimeout(() => previewDocument(), 100);
        }
        
        async function downloadDocumentPDF(id) {
            viewDocument(id);
            setTimeout(() => generatePDF(), 500);
        }
        
        // ---------- FORM UTILITIES ----------
        function updateFormLayout() {
            const isReceipt = document.getElementById('documentType').value === 'receipt';
            const receiptFields = document.getElementById('receiptFields');
            if (receiptFields) {
                receiptFields.classList.toggle('hidden', !isReceipt);
            }
        }
        
        function clearForm() {
            // Clear customer fields
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            
            // Clear items
            const tbody = document.getElementById('itemsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                        <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                        <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01"></td>
                        <td class="item-total">$0.00</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">✕</button></td>
                    </tr>
                `;
            }
            
            // Clear discount and tax
            document.getElementById('discountAmount').value = '0';
            document.getElementById('taxRate').value = '0';
            
            // Clear receipt fields
            document.getElementById('receiptReason').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('receiptDate').value = today;
            
            // Clear selections
            selectedTermIds = [];
            selectedPaymentMethods = [];
            
            // Uncheck all checkboxes
            document.querySelectorAll('.term-checkbox, #paymentMethodsCheckboxList .payment-method-checkbox').forEach(cb => {
                if (cb) cb.checked = false;
            });
            
            // Clear payment accounts (keep only one)
            const accountsContainer = document.getElementById('paymentAccountsContainer');
            if (accountsContainer) {
                accountsContainer.innerHTML = '';
                accountCounter = 0;
                addPaymentAccount();
            }
            
            updateItemTotals();
            updateSerialNumber();
            updateSelectedTerms();
        }
        
        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.textContent = message;
                alert.className = `alert alert-${type}`;
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 4000);
            }
        }
        
        // Payment modal functions (stub)
        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) modal.style.display = 'none';
        }
        
        // Client search function
        window.filterClients = function(searchTerm) {
            const cards = document.querySelectorAll('#clientList .client-card');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        };
        
        // Add client search listener
        document.addEventListener('DOMContentLoaded', function() {
            const clientSearch = document.getElementById('clientSearch');
            if (clientSearch) {
                clientSearch.addEventListener('input', function(e) {
                    filterClients(e.target.value);
                });
            }
        });
        
        // Expose functions globally
        window.switchAuthTab = switchAuthTab;
        window.login = login;
        window.register = register;
        window.logout = logout;
        window.selectCurrency = selectCurrency;
        window.addItem = addItem;
        window.removeItem = removeItem;
        window.addPaymentAccount = addPaymentAccount;
        window.removePaymentAccount = removePaymentAccount;
        window.updateAccountFields = updateAccountFields;
        window.updateSelectedPaymentMethods = updateSelectedPaymentMethods;
        window.saveCompany = saveCompany;
        window.deleteCompany = deleteCompany;
        window.editCompany = editCompany;
        window.clearCompanyForm = clearCompanyForm;
        window.onCompanySelect = onCompanySelect;
        window.saveCurrentClient = saveCurrentClient;
        window.clearClientForm = clearClientForm;
        window.selectClient = selectClient;
        window.showClientList = showClientList;
        window.loadClients = loadClients;
        window.saveTerm = saveTerm;
        window.editTerm = editTerm;
        window.deleteTerm = deleteTerm;
        window.clearTermForm = clearTermForm;
        window.loadAllTerms = loadAllTerms;
        window.loadTermsForDocumentType = loadTermsForDocumentType;
        window.generateDocument = generateDocument;
        window.previewDocument = previewDocument;
        window.refreshPreview = refreshPreview;
        window.generatePDF = generatePDF;
        window.viewDocument = viewDocument;
        window.downloadDocumentPDF = downloadDocumentPDF;
        window.loadDocumentHistory = loadDocumentHistory;
        window.updateFormLayout = updateFormLayout;
        window.updateSerialNumber = updateSerialNumber;
        window.updateItemTotals = updateItemTotals;
        window.updateSelectedTerms = updateSelectedTerms;
        window.clearForm = clearForm;
        window.showAlert = showAlert;
        window.closePaymentModal = closePaymentModal;
    </script>
</body>
</html>
