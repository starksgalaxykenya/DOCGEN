<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARKS GALAXY LIMITED - Professional Document Suite</title>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDyre2oxURYXHZOLIHUeG2itz56i5ehAYo",
            authDomain: "company-doc-generator.firebaseapp.com",
            projectId: "company-doc-generator",
            storageBucket: "company-doc-generator.firebasestorage.app",
            messagingSenderId: "891677147775",
            appId: "1:891677147775:web:a1ffebf23572f5ca18f54a",
            measurementId: "G-1MMCF9W7HF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Export all Firebase functions to window
        window.firebase = {
            auth,
            db,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            getDocs,
            updateDoc,
            doc,
            query,
            orderBy,
            Timestamp,
            deleteDoc,
            where
        };
        
        console.log("Firebase initialized successfully");
    </script>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --gray: #64748b;
            --light: #f8fafc;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body { background: #f1f5f9; color: var(--dark); min-height: 100vh; }

        /* Auth Styles */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .auth-card { background: white; border-radius: 20px; width: 100%; max-width: 450px; box-shadow: var(--shadow-lg); overflow: hidden; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .auth-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 40px 30px; text-align: center; }
        .auth-header h1 { font-size: 2rem; margin-bottom: 10px; }
        .auth-tabs { display: flex; border-bottom: 2px solid var(--border); }
        .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; color: var(--gray); transition: all 0.3s; }
        .auth-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .auth-form { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; transition: all 0.3s; }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 8px 15px; font-size: 0.9rem; }

        /* Main App */
        .main-app { display: none; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Top Navigation */
        .top-nav { background: white; border-radius: 15px; padding: 15px 25px; margin-bottom: 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .nav-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-link { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--gray); transition: all 0.3s; }
        .nav-link:hover { background: var(--light); color: var(--primary); }
        .nav-link.active { background: var(--primary); color: white; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-email { background: var(--light); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; color: var(--dark); }

        /* Content Area */
        .content-area { background: white; border-radius: 15px; padding: 30px; box-shadow: var(--shadow); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--light); padding: 25px; border-radius: 12px; border-left: 4px solid var(--primary); }
        .stat-card h3 { font-size: 2rem; color: var(--primary); margin-bottom: 5px; }
        .stat-card p { color: var(--gray); font-size: 0.9rem; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .data-table th { background: var(--light); padding: 15px; text-align: left; font-weight: 600; color: var(--dark); }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--border); }
        .data-table tbody tr:hover { background: var(--light); }

        /* Cards Grid */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: all 0.3s; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: var(--primary); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px; }

        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }

        /* Items Table */
        .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .items-table th { background: var(--light); padding: 12px; text-align: left; }
        .items-table td { padding: 10px; border-bottom: 1px solid var(--border); }
        .items-table input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }

        /* Utility Classes */
        .hidden { display: none !important; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .text-right { text-align: right; }
        .flex { display: flex; gap: 10px; flex-wrap: wrap; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid var(--success); }
        .alert-danger { background: #fee2e2; color: #991b1b; border-left: 4px solid var(--danger); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }

        /* Document Preview */
        .document-preview { padding: 40px; background: white; border-radius: 12px; border: 1px solid var(--border); }
        .document-preview.pdf-mode { width: 210mm; padding: 15mm; margin: 0 auto; font-size: 12px; }
        .contract-clauses { margin: 20px 0; }
        .clause-item { background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--primary); }

        @media (max-width: 768px) {
            .top-nav { flex-direction: column; }
            .nav-links { justify-content: center; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>STARKS GALAXY</h1>
                <p>Professional Document Suite</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="ui.switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="ui.switchAuthTab('register')">Register</div>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <div id="loginAlert" class="alert"></div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" onclick="auth.login()" style="width: 100%;" id="loginBtn">
                    <span id="loginText">Login</span>
                    <span id="loginSpinner" class="loading hidden"></span>
                </button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <div id="registerAlert" class="alert"></div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Create a password (min. 6 characters)">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="registerConfirm" class="form-control" placeholder="Confirm your password">
                </div>
                <button class="btn btn-primary" onclick="auth.register()" style="width: 100%;" id="registerBtn">
                    <span id="registerText">Create Account</span>
                    <span id="registerSpinner" class="loading hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <!-- Top Navigation -->
            <div class="top-nav">
                <div class="nav-links">
                    <div class="nav-link active" data-section="dashboard">Dashboard</div>
                    <div class="nav-link" data-section="invoices">Invoices</div>
                    <div class="nav-link" data-section="quotes">Quotes</div>
                    <div class="nav-link" data-section="receipts">Receipts</div>
                    <div class="nav-link" data-section="proforma">Proforma</div>
                    <div class="nav-link" data-section="contracts">Contracts</div>
                    <div class="nav-link" data-section="clients">Clients</div>
                    <div class="nav-link" data-section="settings">Settings</div>
                </div>
                <div class="user-menu">
                    <span class="user-email" id="userEmail"></span>
                    <button class="btn btn-sm btn-danger" onclick="auth.logout()">Logout</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="content-section active">
                    <h2>Dashboard</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="totalInvoices">0</h3>
                            <p>Total Invoices</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalQuotes">0</h3>
                            <p>Total Quotes</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalReceipts">0</h3>
                            <p>Total Receipts</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalContracts">0</h3>
                            <p>Active Contracts</p>
                        </div>
                    </div>
                    
                    <h3 class="mb-20">Recent Documents</h3>
                    <table class="data-table" id="recentDocumentsTable">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Serial No</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentDocumentsBody">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Invoices Section -->
                <div id="invoicesSection" class="content-section">
                    <h2>Invoice Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('invoice')">Create New Invoice</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('invoice')">Refresh</button>
                    </div>
                    <table class="data-table" id="invoicesTable">
                        <thead>
                            <tr>
                                <th>Serial No</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesBody">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Quotes Section -->
                <div id="quotesSection" class="content-section">
                    <h2>Quote Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('quote')">Create New Quote</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('quote')">Refresh</button>
                    </div>
                    <table class="data-table" id="quotesTable">
                        <thead>
                            <tr>
                                <th>Serial No</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="quotesBody">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Receipts Section -->
                <div id="receiptsSection" class="content-section">
                    <h2>Receipt Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('receipt')">Create New Receipt</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('receipt')">Refresh</button>
                    </div>
                    <table class="data-table" id="receiptsTable">
                        <thead>
                            <tr>
                                <th>Serial No</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="receiptsBody">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Proforma Section -->
                <div id="proformaSection" class="content-section">
                    <h2>Proforma Invoice Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showDocumentModal('proforma')">Create New Proforma</button>
                        <button class="btn btn-success" onclick="data.loadDocuments('proforma')">Refresh</button>
                    </div>
                    <table class="data-table" id="proformaTable">
                        <thead>
                            <tr>
                                <th>Serial No</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Valid Until</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="proformaBody">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Contracts Section (NEW) -->
                <div id="contractsSection" class="content-section">
                    <h2>Contract Management</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showContractModal()">Create New Contract</button>
                        <button class="btn btn-success" onclick="data.loadContracts()">Refresh</button>
                    </div>
                    
                    <!-- Contract Templates -->
                    <div class="mb-20">
                        <h3>Quick Templates</h3>
                        <div class="cards-grid" id="contractTemplates">
                            <div class="card" onclick="ui.loadTemplate('nda')">
                                <h4>NDA Agreement</h4>
                                <p>Non-Disclosure Agreement template</p>
                            </div>
                            <div class="card" onclick="ui.loadTemplate('service')">
                                <h4>Service Agreement</h4>
                                <p>Standard service contract</p>
                            </div>
                            <div class="card" onclick="ui.loadTemplate('employment')">
                                <h4>Employment Contract</h4>
                                <p>Employee agreement template</p>
                            </div>
                            <div class="card" onclick="ui.loadTemplate('consultancy')">
                                <h4>Consultancy Agreement</h4>
                                <p>Consultant/contractor template</p>
                            </div>
                        </div>
                    </div>
                    
                    <table class="data-table" id="contractsTable">
                        <thead>
                            <tr>
                                <th>Contract No</th>
                                <th>Title</th>
                                <th>Party A</th>
                                <th>Party B</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contractsBody">
                            <tr><td colspan="8">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Clients Section -->
                <div id="clientsSection" class="content-section">
                    <h2>Client Database</h2>
                    <div class="flex mb-20">
                        <button class="btn btn-primary" onclick="ui.showClientModal()">Add New Client</button>
                        <input type="text" id="clientSearch" class="form-control" placeholder="Search clients..." style="max-width: 300px;">
                    </div>
                    <div class="cards-grid" id="clientsGrid"></div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="content-section">
                    <h2>Company Settings</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" id="companyName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Company Email</label>
                            <input type="email" id="companyEmail" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Company Phone</label>
                            <input type="tel" id="companyPhone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Tax ID/VAT Number</label>
                            <input type="text" id="companyTaxId" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="companyAddress" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="flex">
                        <button class="btn btn-primary" onclick="settings.saveCompany()">Save Settings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="documentModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Create Document</h2>
            <div id="documentAlert" class="alert"></div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Client</label>
                    <select id="docClient" class="form-control">
                        <option value="">Select Client</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select id="docCurrency" class="form-control" onchange="items.updateTotals()">
                        <option value="USD">USD ($)</option>
                        <option value="KSH">KSH (KSh)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="GBP">GBP (¬£)</option>
                    </select>
                </div>
            </div>

            <div id="receiptSpecific" class="hidden">
                <div class="form-group">
                    <label>Receipt Reason</label>
                    <input type="text" id="receiptReason" class="form-control" placeholder="Payment for services">
                </div>
            </div>

            <h3>Items</h3>
            <table class="items-table" id="itemsTable">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <tr>
                        <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                        <td><input type="number" class="form-control item-qty" value="1" min="1" onchange="items.updateTotals()"></td>
                        <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01" onchange="items.updateTotals()"></td>
                        <td class="item-total">$0.00</td>
                        <td><button class="btn btn-danger btn-sm" onclick="items.remove(this)">√ó</button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-right"><strong>Subtotal:</strong></td>
                        <td id="subtotal">$0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="text-right">
                            <strong>Discount:</strong>
                            <input type="number" id="discount" class="form-control" style="width:100px; display:inline-block;" value="0" min="0" step="0.01" onchange="items.updateTotals()">
                        </td>
                        <td id="discountDisplay">-$0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="text-right">
                            <strong>Tax (%):</strong>
                            <input type="number" id="taxRate" class="form-control" style="width:80px; display:inline-block;" value="0" min="0" max="100" step="0.1" onchange="items.updateTotals()">
                        </td>
                        <td id="taxAmount">$0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="3" class="text-right"><strong>Total:</strong></td>
                        <td id="totalAmount">$0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <button class="btn btn-success btn-sm" onclick="items.add()">+ Add Item</button>

            <div class="flex mt-20">
                <button class="btn btn-primary" onclick="documents.save()" id="saveDocBtn">
                    <span>Save Document</span>
                    <span id="docSpinner" class="loading hidden"></span>
                </button>
                <button class="btn btn-secondary" onclick="ui.closeModal('documentModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Contract Modal (NEW) -->
    <div id="contractModal" class="modal">
        <div class="modal-content">
            <h2>Create Contract</h2>
            <div id="contractAlert" class="alert"></div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Contract Title</label>
                    <input type="text" id="contractTitle" class="form-control" placeholder="e.g., Service Agreement">
                </div>
                <div class="form-group">
                    <label>Contract Type</label>
                    <select id="contractType" class="form-control">
                        <option value="nda">NDA</option>
                        <option value="service">Service Agreement</option>
                        <option value="employment">Employment</option>
                        <option value="consultancy">Consultancy</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Party A (First Party)</label>
                    <input type="text" id="partyA" class="form-control" value="STARKS GALAXY LIMITED">
                </div>
                <div class="form-group">
                    <label>Party B (Second Party)</label>
                    <select id="partyB" class="form-control">
                        <option value="">Select Client</option>
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="contractStart" class="form-control">
                </div>
                <div class="form-group">
                    <label>End Date (if applicable)</label>
                    <input type="date" id="contractEnd" class="form-control">
                </div>
            </div>

            <div class="form-group">
                <label>Contract Value (if applicable)</label>
                <input type="number" id="contractValue" class="form-control" min="0" step="0.01">
            </div>

            <h3>Clauses</h3>
            <div id="clausesList" class="contract-clauses"></div>
            <div class="flex mb-20">
                <button class="btn btn-success btn-sm" onclick="contracts.addClause()">+ Add Clause</button>
                <button class="btn btn-warning btn-sm" onclick="contracts.loadStandardClauses()">Load Standard Clauses</button>
            </div>

            <div class="form-group">
                <label>Special Conditions</label>
                <textarea id="specialConditions" class="form-control" rows="3" placeholder="Additional conditions..."></textarea>
            </div>

            <div class="form-group">
                <label>Governing Law</label>
                <input type="text" id="governingLaw" class="form-control" value="Laws of Kenya">
            </div>

            <div class="flex">
                <button class="btn btn-primary" onclick="contracts.save()">Save Contract</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('contractModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2>Add/Edit Client</h2>
            <div id="clientAlert" class="alert"></div>
            
            <div class="form-group">
                <label>Client Name</label>
                <input type="text" id="clientName" class="form-control">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="clientEmail" class="form-control">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="clientPhone" class="form-control">
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="clientAddress" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Tax ID/VAT Number</label>
                <input type="text" id="clientTaxId" class="form-control">
            </div>

            <div class="flex">
                <button class="btn btn-primary" onclick="clients.save()">Save Client</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('clientModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>Document Preview</h2>
            <div class="flex mb-20">
                <button class="btn btn-primary" onclick="pdf.generate()">Download PDF</button>
                <button class="btn btn-secondary" onclick="ui.closeModal('previewModal')">Close</button>
            </div>
            <div id="previewContent" class="document-preview"></div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const state = {
            currentUser: null,
            clients: [],
            documents: [],
            contracts: [],
            settings: {},
            monthlySequence: {}
        };

        // ==================== UTILITIES ====================
        const utils = {
            showAlert: (elementId, message, type) => {
                const alert = document.getElementById(elementId);
                if (alert) {
                    alert.textContent = message;
                    alert.className = `alert alert-${type}`;
                    alert.style.display = 'block';
                    setTimeout(() => alert.style.display = 'none', 4000);
                }
            },
            
            formatCurrency: (amount, currency = 'USD') => {
                const symbols = { USD: '$', KSH: 'KSh', EUR: '‚Ç¨', GBP: '¬£' };
                return symbols[currency] + (amount || 0).toFixed(2);
            },
            
            generateSerialNumber: async (type) => {
                const now = new Date();
                const prefix = { invoice: 'INV', quote: 'QUO', receipt: 'REC', proforma: 'PRO', contract: 'CON' }[type] || 'DOC';
                const monthKey = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}`;
                const key = `${type}_${monthKey}`;
                
                if (!state.monthlySequence[key]) {
                    state.monthlySequence[key] = 1;
                } else {
                    state.monthlySequence[key]++;
                }
                
                return `${prefix}-${monthKey}-${String(state.monthlySequence[key]).padStart(3, '0')}`;
            }
        };

        // ==================== AUTHENTICATION ====================
        const auth = {
            init: () => {
                if (!window.firebase) {
                    console.error("Firebase not initialized");
                    return;
                }
                
                window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                    state.currentUser = user;
                    
                    if (user) {
                        document.getElementById('authScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('userEmail').textContent = user.email;
                        data.loadAll();
                    } else {
                        document.getElementById('authScreen').style.display = 'flex';
                        document.getElementById('mainApp').style.display = 'none';
                    }
                });
            },

            login: async () => {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    utils.showAlert('loginAlert', 'Please enter email and password', 'danger');
                    return;
                }

                const btn = document.getElementById('loginBtn');
                btn.disabled = true;
                document.getElementById('loginText').classList.add('hidden');
                document.getElementById('loginSpinner').classList.remove('hidden');

                try {
                    await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                } catch (error) {
                    utils.showAlert('loginAlert', error.message, 'danger');
                    btn.disabled = false;
                    document.getElementById('loginText').classList.remove('hidden');
                    document.getElementById('loginSpinner').classList.add('hidden');
                }
            },

            register: async () => {
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirm = document.getElementById('registerConfirm').value;
                
                if (!email || !password || !confirm) {
                    utils.showAlert('registerAlert', 'Please fill all fields', 'danger');
                    return;
                }
                if (password !== confirm) {
                    utils.showAlert('registerAlert', 'Passwords do not match', 'danger');
                    return;
                }
                if (password.length < 6) {
                    utils.showAlert('registerAlert', 'Password must be at least 6 characters', 'danger');
                    return;
                }

                const btn = document.getElementById('registerBtn');
                btn.disabled = true;
                document.getElementById('registerText').classList.add('hidden');
                document.getElementById('registerSpinner').classList.remove('hidden');

                try {
                    await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                } catch (error) {
                    utils.showAlert('registerAlert', error.message, 'danger');
                    btn.disabled = false;
                    document.getElementById('registerText').classList.remove('hidden');
                    document.getElementById('registerSpinner').classList.add('hidden');
                }
            },

            logout: () => {
                window.firebase.signOut(window.firebase.auth);
            }
        };

        // ==================== DATA MANAGEMENT ====================
        const data = {
            loadAll: async () => {
                await data.loadClients();
                await data.loadDocuments();
                await data.loadContracts();
                await settings.load();
            },

            loadClients: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'clients'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Update client selects
                    const selects = ['docClient', 'partyB'];
                    selects.forEach(id => {
                        const select = document.getElementById(id);
                        if (select) {
                            select.innerHTML = '<option value="">Select Client</option>';
                            state.clients.forEach(client => {
                                select.innerHTML += `<option value="${client.id}">${client.name}</option>`;
                            });
                        }
                    });
                    
                    data.renderClients();
                } catch (error) {
                    console.error('Load clients error:', error);
                }
            },

            loadDocuments: async (type = null) => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    let q;
                    if (type) {
                        q = window.firebase.query(
                            window.firebase.collection(window.firebase.db, 'documents'),
                            window.firebase.where('userId', '==', state.currentUser.uid),
                            window.firebase.where('type', '==', type),
                            window.firebase.orderBy('createdAt', 'desc')
                        );
                    } else {
                        q = window.firebase.query(
                            window.firebase.collection(window.firebase.db, 'documents'),
                            window.firebase.where('userId', '==', state.currentUser.uid),
                            window.firebase.orderBy('createdAt', 'desc')
                        );
                    }
                    
                    const snapshot = await window.firebase.getDocs(q);
                    state.documents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    data.renderDocuments(type);
                    data.updateDashboard();
                } catch (error) {
                    console.error('Load documents error:', error);
                }
            },

            loadContracts: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'contracts'),
                        window.firebase.where('userId', '==', state.currentUser.uid),
                        window.firebase.orderBy('createdAt', 'desc')
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    state.contracts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.renderContracts();
                } catch (error) {
                    console.error('Load contracts error:', error);
                }
            },

            renderClients: () => {
                const grid = document.getElementById('clientsGrid');
                if (!grid) return;
                
                if (state.clients.length === 0) {
                    grid.innerHTML = '<p class="text-center">No clients yet. Add your first client!</p>';
                    return;
                }
                
                grid.innerHTML = '';
                state.clients.forEach(client => {
                    grid.innerHTML += `
                        <div class="card" onclick="clients.edit('${client.id}')">
                            <h4>${client.name}</h4>
                            <p>üìß ${client.email || 'No email'}</p>
                            <p>üì± ${client.phone || 'No phone'}</p>
                            <p>üìç ${client.address || 'No address'}</p>
                        </div>
                    `;
                });
            },

            renderDocuments: (type = null) => {
                if (type) {
                    const tbody = document.getElementById(`${type}sBody`);
                    if (!tbody) return;
                    
                    const filtered = state.documents.filter(d => d.type === type);
                    
                    if (filtered.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No documents found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = filtered.map(doc => {
                        const date = doc.createdAt?.toDate?.() ? doc.createdAt.toDate().toLocaleDateString() : 'N/A';
                        const amount = utils.formatCurrency(doc.total || 0, doc.currency || 'USD');
                        return `
                            <tr>
                                <td>${doc.serialNumber || 'N/A'}</td>
                                <td>${doc.customerName || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${amount}</td>
                                <td><span class="badge ${doc.revoked ? 'badge-danger' : 'badge-success'}">${doc.revoked ? 'Revoked' : 'Active'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="documents.view('${doc.id}')">View</button>
                                    <button class="btn btn-sm btn-success" onclick="pdf.fromDocument('${doc.id}')">PDF</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                // Update recent documents
                const recentBody = document.getElementById('recentDocumentsBody');
                if (recentBody) {
                    if (state.documents.length === 0) {
                        recentBody.innerHTML = '<tr><td colspan="7" class="text-center">No documents yet</td></tr>';
                        return;
                    }
                    
                    recentBody.innerHTML = state.documents.slice(0, 5).map(doc => {
                        const date = doc.createdAt?.toDate?.() ? doc.createdAt.toDate().toLocaleDateString() : 'N/A';
                        const amount = utils.formatCurrency(doc.total || 0, doc.currency || 'USD');
                        return `
                            <tr>
                                <td><span class="badge badge-success">${doc.type}</span></td>
                                <td>${doc.serialNumber || 'N/A'}</td>
                                <td>${doc.customerName || 'N/A'}</td>
                                <td>${date}</td>
                                <td>${amount}</td>
                                <td><span class="badge ${doc.revoked ? 'badge-danger' : 'badge-success'}">${doc.revoked ? 'Revoked' : 'Active'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="documents.view('${doc.id}')">View</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            },

            renderContracts: () => {
                const tbody = document.getElementById('contractsBody');
                if (!tbody) return;
                
                if (state.contracts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No contracts found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = state.contracts.map(contract => {
                    const start = contract.startDate?.toDate?.() ? contract.startDate.toDate().toLocaleDateString() : 'N/A';
                    const end = contract.endDate?.toDate?.() ? contract.endDate.toDate().toLocaleDateString() : 'N/A';
                    return `
                        <tr>
                            <td>${contract.contractNumber || 'N/A'}</td>
                            <td>${contract.title}</td>
                            <td>${contract.partyA}</td>
                            <td>${contract.partyBName || 'N/A'}</td>
                            <td>${start}</td>
                            <td>${end}</td>
                            <td><span class="badge ${contract.status === 'active' ? 'badge-success' : 'badge-warning'}">${contract.status || 'Draft'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="contracts.view('${contract.id}')">View</button>
                                <button class="btn btn-sm btn-success" onclick="pdf.fromContract('${contract.id}')">PDF</button>
                                <button class="btn btn-sm btn-danger" onclick="contracts.sign('${contract.id}')">Sign</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Update dashboard count
                document.getElementById('totalContracts').textContent = state.contracts.length;
            },

            updateDashboard: () => {
                document.getElementById('totalInvoices').textContent = state.documents.filter(d => d.type === 'invoice').length;
                document.getElementById('totalQuotes').textContent = state.documents.filter(d => d.type === 'quote').length;
                document.getElementById('totalReceipts').textContent = state.documents.filter(d => d.type === 'receipt').length;
            }
        };

        // ==================== DOCUMENTS ====================
        const documents = {
            currentType: null,
            
            save: async () => {
                const clientId = document.getElementById('docClient').value;
                const client = state.clients.find(c => c.id === clientId);
                
                if (!client) {
                    utils.showAlert('documentAlert', 'Please select a client', 'danger');
                    return;
                }

                const items = [];
                let subtotal = 0;
                
                document.querySelectorAll('#itemsBody tr').forEach(row => {
                    const desc = row.querySelector('.item-desc')?.value;
                    if (desc && desc.trim()) {
                        const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                        const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                        const total = qty * price;
                        items.push({ description: desc, quantity: qty, unitPrice: price, total });
                        subtotal += total;
                    }
                });

                if (items.length === 0) {
                    utils.showAlert('documentAlert', 'Please add at least one item', 'danger');
                    return;
                }

                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const discounted = subtotal - discount;
                const tax = discounted * (taxRate / 100);
                const total = discounted + tax;

                const docData = {
                    type: documents.currentType,
                    serialNumber: await utils.generateSerialNumber(documents.currentType),
                    currency: document.getElementById('docCurrency').value,
                    customerId: clientId,
                    customerName: client.name,
                    customerEmail: client.email || '',
                    customerPhone: client.phone || '',
                    customerAddress: client.address || '',
                    items,
                    subtotal,
                    discount,
                    taxRate,
                    taxAmount: tax,
                    total,
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now(),
                    revoked: false,
                    payments: []
                };

                if (documents.currentType === 'receipt') {
                    docData.receiptReason = document.getElementById('receiptReason').value || 'Payment';
                    docData.receiptDate = new Date().toISOString().split('T')[0];
                }

                const btn = document.getElementById('saveDocBtn');
                btn.disabled = true;
                document.getElementById('docSpinner').classList.remove('hidden');

                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'documents'), docData);
                    utils.showAlert('documentAlert', 'Document saved successfully!', 'success');
                    ui.closeModal('documentModal');
                    await data.loadDocuments(documents.currentType);
                } catch (error) {
                    utils.showAlert('documentAlert', error.message, 'danger');
                } finally {
                    btn.disabled = false;
                    document.getElementById('docSpinner').classList.add('hidden');
                }
            },

            view: (id) => {
                const doc = state.documents.find(d => d.id === id);
                if (!doc) return;
                
                const preview = document.getElementById('previewContent');
                const symbol = doc.currency === 'KSH' ? 'KSh' : doc.currency === 'USD' ? '$' : doc.currency === 'EUR' ? '‚Ç¨' : '¬£';
                
                preview.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: var(--primary);">${doc.type.toUpperCase()}</h1>
                        <p style="color: var(--gray);">${doc.serialNumber}</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        <div>
                            <h3 style="color: var(--primary); margin-bottom: 10px;">From:</h3>
                            <p><strong>STARKS GALAXY LIMITED</strong></p>
                        </div>
                        <div style="text-align: right;">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">To:</h3>
                            <p><strong>${doc.customerName}</strong><br>
                            ${doc.customerEmail}<br>
                            ${doc.customerPhone}<br>
                            ${doc.customerAddress}</p>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: var(--light);">
                                <th style="padding: 12px; text-align: left;">Description</th>
                                <th style="padding: 12px; text-align: right;">Qty</th>
                                <th style="padding: 12px; text-align: right;">Unit Price</th>
                                <th style="padding: 12px; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${doc.items.map(item => `
                                <tr>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border);">${item.description}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${item.quantity}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${symbol}${item.unitPrice.toFixed(2)}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: right;">${symbol}${item.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="padding: 10px; text-align: right;"><strong>Subtotal:</strong></td>
                                <td style="padding: 10px; text-align: right;">${symbol}${doc.subtotal.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding: 10px; text-align: right;"><strong>Discount:</strong></td>
                                <td style="padding: 10px; text-align: right;">-${symbol}${doc.discount.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding: 10px; text-align: right;"><strong>Tax (${doc.taxRate}%):</strong></td>
                                <td style="padding: 10px; text-align: right;">${symbol}${doc.taxAmount.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding: 10px; text-align: right;"><strong>Total:</strong></td>
                                <td style="padding: 10px; text-align: right;"><strong>${symbol}${doc.total.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 40px; text-align: center;">
                        <p style="color: var(--primary);"><strong>Thank you for your business!</strong></p>
                    </div>
                `;
                
                ui.openModal('previewModal');
            }
        };

        // ==================== CONTRACTS ====================
        const contracts = {
            addClause: (title = '', content = '') => {
                const list = document.getElementById('clausesList');
                const clauseId = 'clause_' + Date.now() + Math.random();
                
                const div = document.createElement('div');
                div.className = 'clause-item';
                div.id = clauseId;
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="Clause Title" value="${title}" style="width: 70%;">
                        <button class="btn btn-danger btn-sm" onclick="this.closest('.clause-item').remove()">Remove</button>
                    </div>
                    <textarea class="form-control" rows="3" placeholder="Clause content...">${content}</textarea>
                `;
                
                list.appendChild(div);
            },
            
            loadStandardClauses: () => {
                const standardClauses = [
                    { title: 'Termination', content: 'This agreement may be terminated by either party with 30 days written notice.' },
                    { title: 'Confidentiality', content: 'Both parties agree to keep all confidential information private and secure.' },
                    { title: 'Liability', content: 'Neither party shall be liable for indirect or consequential damages.' },
                    { title: 'Governing Law', content: 'This agreement shall be governed by the laws of the Republic of Kenya.' }
                ];
                
                standardClauses.forEach(clause => contracts.addClause(clause.title, clause.content));
            },
            
            save: async () => {
                const title = document.getElementById('contractTitle').value.trim();
                const partyBId = document.getElementById('partyB').value;
                const partyB = state.clients.find(c => c.id === partyBId);
                
                if (!title || !partyBId) {
                    utils.showAlert('contractAlert', 'Please fill all required fields', 'danger');
                    return;
                }
                
                // Collect clauses
                const clauses = [];
                document.querySelectorAll('#clausesList .clause-item').forEach(item => {
                    const titleInput = item.querySelector('input');
                    const contentInput = item.querySelector('textarea');
                    if (titleInput.value && contentInput.value) {
                        clauses.push({
                            title: titleInput.value,
                            content: contentInput.value
                        });
                    }
                });

                const contractData = {
                    contractNumber: await utils.generateSerialNumber('contract'),
                    title,
                    type: document.getElementById('contractType').value,
                    partyA: document.getElementById('partyA').value,
                    partyB: partyBId,
                    partyBName: partyB.name,
                    partyBEmail: partyB.email || '',
                    partyBPhone: partyB.phone || '',
                    partyBAddress: partyB.address || '',
                    startDate: document.getElementById('contractStart').value ? window.firebase.Timestamp.fromDate(new Date(document.getElementById('contractStart').value)) : null,
                    endDate: document.getElementById('contractEnd').value ? window.firebase.Timestamp.fromDate(new Date(document.getElementById('contractEnd').value)) : null,
                    value: parseFloat(document.getElementById('contractValue').value) || 0,
                    clauses,
                    specialConditions: document.getElementById('specialConditions').value,
                    governingLaw: document.getElementById('governingLaw').value,
                    status: 'draft',
                    userId: state.currentUser.uid,
                    createdAt: window.firebase.Timestamp.now()
                };

                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'contracts'), contractData);
                    utils.showAlert('contractAlert', 'Contract saved successfully!', 'success');
                    ui.closeModal('contractModal');
                    await data.loadContracts();
                } catch (error) {
                    utils.showAlert('contractAlert', error.message, 'danger');
                }
            },
            
            view: (id) => {
                const contract = state.contracts.find(c => c.id === id);
                if (!contract) return;
                
                const preview = document.getElementById('previewContent');
                
                preview.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: var(--primary);">${contract.title}</h1>
                        <p style="color: var(--gray);">Contract No: ${contract.contractNumber}</p>
                        <p>Date: ${contract.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">PARTIES</h3>
                        <p><strong>Party A:</strong> ${contract.partyA}</p>
                        <p><strong>Party B:</strong> ${contract.partyBName}</p>
                        ${contract.partyBEmail ? `<p>Email: ${contract.partyBEmail}</p>` : ''}
                        ${contract.partyBPhone ? `<p>Phone: ${contract.partyBPhone}</p>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">TERM</h3>
                        <p><strong>Start Date:</strong> ${contract.startDate?.toDate?.().toLocaleDateString() || 'N/A'}</p>
                        <p><strong>End Date:</strong> ${contract.endDate?.toDate?.().toLocaleDateString() || 'Indefinite'}</p>
                        ${contract.value ? `<p><strong>Contract Value:</strong> $${contract.value.toFixed(2)}</p>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">CLAUSES</h3>
                        ${contract.clauses.map(clause => `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--primary-dark);">${clause.title}</h4>
                                <p>${clause.content}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${contract.specialConditions ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">SPECIAL CONDITIONS</h3>
                            <p>${contract.specialConditions}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 10px;">GOVERNING LAW</h3>
                        <p>${contract.governingLaw}</p>
                    </div>
                    
                    <div style="margin-top: 50px; display: flex; justify-content: space-between;">
                        <div>
                            <p><strong>Signed for and on behalf of ${contract.partyA}</strong></p>
                            <div style="margin-top: 30px;">
                                <p>_________________________</p>
                                <p style="color: var(--gray);">Signature & Date</p>
                            </div>
                        </div>
                        <div>
                            <p><strong>Signed for and on behalf of ${contract.partyBName}</strong></p>
                            <div style="margin-top: 30px;">
                                <p>_________________________</p>
                                <p style="color: var(--gray);">Signature & Date</p>
                            </div>
                        </div>
                    </div>
                `;
                
                ui.openModal('previewModal');
            },
            
            sign: async (id) => {
                if (!confirm('Sign this contract? This action cannot be undone.')) return;
                
                try {
                    const contractRef = window.firebase.doc(window.firebase.db, 'contracts', id);
                    await window.firebase.updateDoc(contractRef, {
                        status: 'active',
                        signedAt: window.firebase.Timestamp.now()
                    });
                    await data.loadContracts();
                    alert('Contract signed successfully!');
                } catch (error) {
                    console.error('Sign error:', error);
                    alert('Error signing contract: ' + error.message);
                }
            }
        };

        // ==================== PDF GENERATION ====================
        const pdf = {
            generate: async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    const element = document.getElementById('previewContent');
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const ratio = canvas.width / canvas.height;
                    let imgWidth = pdfWidth - 20;
                    let imgHeight = imgWidth / ratio;
                    
                    if (imgHeight > pdfHeight - 20) {
                        imgHeight = pdfHeight - 20;
                        imgWidth = imgHeight * ratio;
                    }
                    
                    const x = (pdfWidth - imgWidth) / 2;
                    const y = (pdfHeight - imgHeight) / 2;
                    
                    pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
                    pdf.save('document.pdf');
                    
                } catch (error) {
                    console.error('PDF error:', error);
                    alert('PDF generation failed. Please try again.');
                }
            },
            
            fromDocument: (id) => {
                documents.view(id);
                setTimeout(() => pdf.generate(), 500);
            },
            
            fromContract: (id) => {
                contracts.view(id);
                setTimeout(() => pdf.generate(), 500);
            }
        };

        // ==================== ITEMS MANAGEMENT ====================
        const items = {
            add: () => {
                const tbody = document.getElementById('itemsBody');
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                    <td><input type="number" class="form-control item-qty" value="1" min="1" onchange="items.updateTotals()"></td>
                    <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01" onchange="items.updateTotals()"></td>
                    <td class="item-total">$0.00</td>
                    <td><button class="btn btn-danger btn-sm" onclick="items.remove(this)">√ó</button></td>
                `;
                items.updateTotals();
            },
            
            remove: (btn) => {
                btn.closest('tr').remove();
                items.updateTotals();
            },
            
            updateTotals: () => {
                const currency = document.getElementById('docCurrency').value;
                const symbol = currency === 'KSH' ? 'KSh' : currency === 'USD' ? '$' : currency === 'EUR' ? '‚Ç¨' : '¬£';
                
                let subtotal = 0;
                document.querySelectorAll('#itemsBody tr').forEach(row => {
                    const qty = parseFloat(row.querySelector('.item-qty')?.value) || 0;
                    const price = parseFloat(row.querySelector('.item-price')?.value) || 0;
                    const total = qty * price;
                    subtotal += total;
                    row.querySelector('.item-total').textContent = symbol + total.toFixed(2);
                });
                
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const discounted = subtotal - discount;
                const tax = discounted * (taxRate / 100);
                const total = discounted + tax;
                
                document.getElementById('subtotal').textContent = symbol + subtotal.toFixed(2);
                document.getElementById('discountDisplay').textContent = '-' + symbol + discount.toFixed(2);
                document.getElementById('taxAmount').textContent = symbol + tax.toFixed(2);
                document.getElementById('totalAmount').textContent = symbol + total.toFixed(2);
            }
        };

        // ==================== SETTINGS ====================
        const settings = {
            load: async () => {
                if (!state.currentUser || !window.firebase) return;
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'settings'),
                        window.firebase.where('userId', '==', state.currentUser.uid)
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    
                    if (!snapshot.empty) {
                        state.settings = snapshot.docs[0].data();
                        settings.populateForm();
                    }
                } catch (error) {
                    console.error('Load settings error:', error);
                }
            },
            
            populateForm: () => {
                document.getElementById('companyName').value = state.settings.companyName || '';
                document.getElementById('companyEmail').value = state.settings.companyEmail || '';
                document.getElementById('companyPhone').value = state.settings.companyPhone || '';
                document.getElementById('companyTaxId').value = state.settings.taxId || '';
                document.getElementById('companyAddress').value = state.settings.address || '';
            },
            
            saveCompany: async () => {
                const settingsData = {
                    companyName: document.getElementById('companyName').value,
                    companyEmail: document.getElementById('companyEmail').value,
                    companyPhone: document.getElementById('companyPhone').value,
                    taxId: document.getElementById('companyTaxId').value,
                    address: document.getElementById('companyAddress').value,
                    userId: state.currentUser.uid,
                    updatedAt: window.firebase.Timestamp.now()
                };
                
                try {
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'settings'),
                        window.firebase.where('userId', '==', state.currentUser.uid)
                    );
                    const snapshot = await window.firebase.getDocs(q);
                    
                    if (snapshot.empty) {
                        settingsData.createdAt = window.firebase.Timestamp.now();
                        await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'settings'), settingsData);
                    } else {
                        await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'settings', snapshot.docs[0].id), settingsData);
                    }
                    
                    alert('Settings saved successfully!');
                } catch (error) {
                    console.error('Save settings error:', error);
                    alert('Error saving settings: ' + error.message);
                }
            }
        };

        // ==================== CLIENTS MANAGEMENT ====================
        const clients = {
            currentId: null,
            
            save: async () => {
                const name = document.getElementById('clientName').value.trim();
                if (!name) {
                    utils.showAlert('clientAlert', 'Client name is required', 'danger');
                    return;
                }
                
                const clientData = {
                    name,
                    email: document.getElementById('clientEmail').value,
                    phone: document.getElementById('clientPhone').value,
                    address: document.getElementById('clientAddress').value,
                    taxId: document.getElementById('clientTaxId').value,
                    userId: state.currentUser.uid,
                    updatedAt: window.firebase.Timestamp.now()
                };
                
                try {
                    if (clients.currentId) {
                        await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'clients', clients.currentId), clientData);
                    } else {
                        clientData.createdAt = window.firebase.Timestamp.now();
                        await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'clients'), clientData);
                    }
                    
                    utils.showAlert('clientAlert', 'Client saved successfully!', 'success');
                    ui.closeModal('clientModal');
                    await data.loadClients();
                } catch (error) {
                    utils.showAlert('clientAlert', error.message, 'danger');
                }
            },
            
            edit: (id) => {
                const client = state.clients.find(c => c.id === id);
                if (!client) return;
                
                clients.currentId = id;
                document.getElementById('clientName').value = client.name || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientAddress').value = client.address || '';
                document.getElementById('clientTaxId').value = client.taxId || '';
                
                ui.openModal('clientModal');
            }
        };

        // ==================== UI MANAGEMENT ====================
        const ui = {
            init: () => {
                // Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        const section = link.dataset.section;
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                        document.getElementById(section + 'Section').classList.add('active');
                    });
                });
                
                // Client search
                document.getElementById('clientSearch')?.addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    document.querySelectorAll('#clientsGrid .card').forEach(card => {
                        const text = card.textContent.toLowerCase();
                        card.style.display = text.includes(search) ? 'block' : 'none';
                    });
                });
            },
            
            switchAuthTab: (tab) => {
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                
                if (tab === 'login') {
                    document.querySelector('.auth-tab:first-child').classList.add('active');
                    document.getElementById('loginForm').classList.remove('hidden');
                } else {
                    document.querySelector('.auth-tab:last-child').classList.add('active');
                    document.getElementById('registerForm').classList.remove('hidden');
                }
            },
            
            showDocumentModal: (type) => {
                documents.currentType = type;
                document.getElementById('modalTitle').textContent = `Create ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                document.getElementById('receiptSpecific').classList.toggle('hidden', type !== 'receipt');
                ui.openModal('documentModal');
            },
            
            showContractModal: () => {
                document.getElementById('clausesList').innerHTML = '';
                contracts.addClause('Introduction', 'This agreement is entered into on this day...');
                ui.openModal('contractModal');
            },
            
            showClientModal: () => {
                clients.currentId = null;
                document.getElementById('clientName').value = '';
                document.getElementById('clientEmail').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('clientAddress').value = '';
                document.getElementById('clientTaxId').value = '';
                ui.openModal('clientModal');
            },
            
            loadTemplate: (type) => {
                const templates = {
                    nda: {
                        title: 'Non-Disclosure Agreement',
                        clauses: [
                            { title: 'Definition of Confidential Information', content: 'Confidential information includes all information disclosed by one party to the other, whether orally or in writing, that is designated as confidential.' },
                            { title: 'Obligations of Receiving Party', content: 'The receiving party shall hold the confidential information in strict confidence and shall not disclose it to any third party.' },
                            { title: 'Term', content: 'This agreement shall commence on the effective date and continue for a period of 2 years.' }
                        ]
                    },
                    service: {
                        title: 'Service Agreement',
                        clauses: [
                            { title: 'Scope of Services', content: 'The service provider shall perform the services as described in Schedule A attached hereto.' },
                            { title: 'Compensation', content: 'The client shall pay the service provider the fees as set out in Schedule B.' },
                            { title: 'Term and Termination', content: 'This agreement shall commence on the start date and continue until terminated by either party with 30 days written notice.' }
                        ]
                    },
                    employment: {
                        title: 'Employment Contract',
                        clauses: [
                            { title: 'Position and Duties', content: 'The employee shall serve in the position of [Position] and perform all duties associated with this role.' },
                            { title: 'Compensation', content: 'The employee shall receive a monthly salary of [Amount] payable on the last day of each month.' },
                            { title: 'Termination', content: 'Either party may terminate this agreement with 30 days written notice.' }
                        ]
                    },
                    consultancy: {
                        title: 'Consultancy Agreement',
                        clauses: [
                            { title: 'Services', content: 'The consultant shall provide expert advice and guidance in the field of [Specialization].' },
                            { title: 'Fees', content: 'The consultant shall be paid [Rate] per hour/day for services rendered.' },
                            { title: 'Independent Contractor', content: 'The consultant is an independent contractor and not an employee.' }
                        ]
                    }
                };
                
                const template = templates[type];
                if (template) {
                    document.getElementById('contractTitle').value = template.title;
                    document.getElementById('clausesList').innerHTML = '';
                    template.clauses.forEach(clause => contracts.addClause(clause.title, clause.content));
                }
            },
            
            openModal: (id) => {
                document.getElementById(id).classList.add('active');
            },
            
            closeModal: (id) => {
                document.getElementById(id).classList.remove('active');
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            ui.init();
            auth.init();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('contractStart')) {
                document.getElementById('contractStart').value = today;
            }
        });

        // Expose to global scope
        window.auth = auth;
        window.ui = ui;
        window.data = data;
        window.documents = documents;
        window.contracts = contracts;
        window.items = items;
        window.clients = clients;
        window.settings = settings;
        window.pdf = pdf;
    </script>
</body>
</html>
