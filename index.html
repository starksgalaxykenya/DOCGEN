<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARKS GALAXY LIMITED</title>
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        
        // Your Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDyre2oxURYXHZOLIHUeG2itz56i5ehAYo",
  authDomain: "company-doc-generator.firebaseapp.com",
  projectId: "company-doc-generator",
  storageBucket: "company-doc-generator.firebasestorage.app",
  messagingSenderId: "891677147775",
  appId: "1:891677147775:web:a1ffebf23572f5ca18f54a",
  measurementId: "G-1MMCF9W7HF"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = {
            auth, db,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
            collection, addDoc, getDocs, updateDoc, doc, query, orderBy, Timestamp, deleteDoc, where
        };
        
        console.log("Firebase initialized successfully");
    </script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Global Styles */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #ff9e00;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Auth Screen Styles */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }

        .auth-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .auth-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .auth-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .auth-tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .auth-tab:hover {
            color: var(--primary-color);
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .auth-form {
            padding: 40px 30px;
        }

        .auth-form-group {
            margin-bottom: 25px;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .auth-form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .auth-form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }

        .auth-footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9rem;
            color: #666;
        }

        /* Main App Styles - Hidden by default */
        .main-app {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-left h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .nav-tab {
            flex: 1;
            padding: 18px 25px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: var(--secondary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            font-size: 1.8rem;
        }

        h3 {
            color: var(--primary-color);
            margin: 25px 0 15px 0;
            font-size: 1.4rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .required::after {
            content: '*';
            color: var(--danger-color);
        }

        .form-control {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: var(--gray-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px #ddd;
        }

        .items-table th {
            background-color: #f1f5fd;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .items-table td {
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .items-table tfoot td {
            font-weight: 600;
            background-color: #f9fafc;
        }

        .input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-row .form-control {
            flex: 1;
        }

        /* Discount Section */
        .discount-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9fafc;
            border-radius: 8px;
            border-left: 4px solid var(--success-color);
        }

        .discount-section h4 {
            color: var(--success-color);
            margin-bottom: 15px;
        }

        .discount-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        /* Terms and Conditions */
        .terms-section {
            margin: 25px 0;
            padding: 20px;
            background: #fff9e6;
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
        }

        .terms-section h4 {
            color: var(--warning-color);
            margin-bottom: 10px;
        }

        .terms-content {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #666;
        }

        /* Payment Methods */
        .payment-methods-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .payment-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .payment-method-tag {
            background-color: #f1f5fd;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .payment-method-tag:hover {
            background-color: #e1e9ff;
        }

        .payment-method-tag.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .payment-details-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eaeaea;
            display: none;
        }

        .payment-details-fields.active {
            display: grid;
            animation: fadeIn 0.3s ease;
        }

        /* Document Preview */
        .document-preview {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 1px solid #eaeaea;
            position: relative;
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .company-logo {
            max-width: 180px;
            max-height: 100px;
            object-fit: contain;
        }

        .company-details {
            text-align: right;
        }

        .company-tax {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: 5px;
        }

        .parent-company {
            font-size: 0.9rem;
            color: var(--gray-color);
            font-style: italic;
            margin-top: 3px;
        }

        .document-title {
            text-align: center;
            font-size: 2.5rem;
            margin: 40px 0;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .document-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .document-info-column h3 {
            color: var(--secondary-color);
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
            margin: 40px 0;
        }

        .document-table th {
            background-color: #f1f5fd;
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .document-table td {
            padding: 15px;
            border: 1px solid #ddd;
        }

        .document-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .terms-preview {
            margin-top: 30px;
            padding: 20px;
            background: #fff9e6;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #666;
        }

        /* History Table */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 0 0 1px #ddd;
        }

        .history-table th {
            background-color: #f1f5fd;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .history-table td {
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background-color: rgba(76, 201, 240, 0.2);
            color: #0a8ea8;
        }

        .status-revoked {
            background-color: rgba(247, 37, 133, 0.2);
            color: #c2185b;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Company Cards */
        .company-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .company-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid #eaeaea;
            transition: var(--transition);
        }

        .company-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .company-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .company-card-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-right: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            padding: 5px;
        }

        /* Color Preview */
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            display: inline-block;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        /* Logo Selector */
        .logo-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo-preview {
            width: 120px;
            height: 120px;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .logo-options {
            flex: 1;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid transparent;
        }

        .alert-success {
            background-color: rgba(76, 201, 240, 0.1);
            border-left-color: var(--success-color);
            color: #0a8ea8;
        }

        .alert-danger {
            background-color: rgba(247, 37, 133, 0.1);
            border-left-color: var(--danger-color);
            color: #c2185b;
        }

        .alert-info {
            background-color: rgba(67, 97, 238, 0.1);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mt-30 {
            margin-top: 30px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .document-info {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .company-details {
                text-align: left;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .discount-inputs {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                padding: 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .document-preview {
                padding: 20px;
            }
            
            .document-title {
                font-size: 2rem;
            }
            
            .company-list {
                grid-template-columns: 1fr;
            }
            
            .logo-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Revoked Stamp */
        .revoked-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 80px;
            color: var(--danger-color);
            font-weight: bold;
            opacity: 0.3;
            pointer-events: none;
            border: 8px solid var(--danger-color);
            padding: 40px;
            border-radius: 15px;
            text-transform: uppercase;
            letter-spacing: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-header">
                <h1>Document Generator</h1>
                <p>Create professional documents with ease</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>
            
            <!-- Login Form -->
            <div class="auth-form" id="loginForm">
                <div class="alert" id="loginAlert"></div>
                <div class="auth-form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="auth-form-control" placeholder="Enter your email">
                </div>
                <div class="auth-form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="auth-form-control" placeholder="Enter your password">
                </div>
                <button class="auth-btn" onclick="login()" id="loginBtn">
                    <span id="loginText">Login</span>
                    <span id="loginSpinner" class="loading hidden"></span>
                </button>
            </div>
            
            <!-- Register Form -->
            <div class="auth-form hidden" id="registerForm">
                <div class="alert" id="registerAlert"></div>
                <div class="auth-form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" class="auth-form-control" placeholder="Enter your email">
                </div>
                <div class="auth-form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="auth-form-control" placeholder="Create a password (min. 6 characters)">
                </div>
                <div class="auth-form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" class="auth-form-control" placeholder="Confirm your password">
                </div>
                <button class="auth-btn" onclick="register()" id="registerBtn">
                    <span id="registerText">Create Account</span>
                    <span id="registerSpinner" class="loading hidden"></span>
                </button>
            </div>
            
            <div class="auth-footer">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <header>
                <div class="header-left">
                    <h1>STARKS GALAXY LIMITED</h1>
                    <p>Create professional receipts, invoices, quotes, and proforma invoices</p>
                </div>
                <div class="user-info">
                    <div class="user-email" id="userEmail"></div>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </header>

            <nav class="nav-tabs" id="navTabs">
                <div class="nav-tab active" data-tab="create">Create Document</div>
                <div class="nav-tab" data-tab="history">Document History</div>
                <div class="nav-tab" data-tab="admin">Admin Dashboard</div>
                <div class="nav-tab" data-tab="preview">Live Preview</div>
            </nav>

            <!-- Create Document Tab -->
            <div class="tab-content active" id="create">
                <h2>Create New Document</h2>
                <div class="alert" id="createAlert"></div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="documentType" class="required">Document Type</label>
                        <select id="documentType" class="form-control">
                            <option value="invoice">Invoice</option>
                            <option value="quote">Quote</option>
                            <option value="receipt">Receipt</option>
                            <option value="proforma">Proforma Invoice</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="companySelect" class="required">Company</label>
                        <select id="companySelect" class="form-control">
                            <option value="">Select a company</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="serialNumber">Serial Number</label>
                        <input type="text" id="serialNumber" class="form-control" placeholder="Auto-generated" readonly>
                    </div>
                </div>

                <h3>Customer Details</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customerName" class="required">Customer Name</label>
                        <input type="text" id="customerName" class="form-control" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Customer Email</label>
                        <input type="email" id="customerEmail" class="form-control" placeholder="john@example.com">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Customer Phone</label>
                        <input type="tel" id="customerPhone" class="form-control" placeholder="+1234567890">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Customer Address</label>
                        <textarea id="customerAddress" class="form-control" rows="2" placeholder="123 Main St, City, Country"></textarea>
                    </div>
                </div>

                <h3>Items & Services</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th width="120">Quantity</th>
                            <th width="150">Unit Price ($)</th>
                            <th width="150">Total ($)</th>
                            <th width="50">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                            <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                            <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01"></td>
                            <td class="item-total">$0.00</td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">âœ•</button></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right;"><strong>Subtotal:</strong></td>
                            <td id="subtotal">$0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3" style="text-align: right;">
                                <strong>Discount ($):</strong>
                                <input type="number" id="discountAmount" class="form-control" style="width: 120px; display: inline-block; margin-left: 10px;" value="0" min="0" step="0.01">
                            </td>
                            <td id="discountDisplay">$0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3" style="text-align: right;">
                                <strong>Tax Rate (%):</strong>
                                <input type="number" id="taxRate" class="form-control" style="width: 80px; display: inline-block; margin-left: 10px;" value="10" min="0" max="50">
                            </td>
                            <td id="taxAmount">$0.00</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                            <td id="totalAmount">$0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                <button class="btn btn-secondary mt-20" onclick="addItem()">+ Add Item</button>

                <!-- Terms and Conditions Section -->
                <div class="terms-section">
                    <h4>Terms & Conditions</h4>
                    <div class="terms-content" id="termsContent">
                        Terms will appear based on document type
                    </div>
                </div>

                <div class="payment-methods-section mt-30">
                    <h4>Payment Method</h4>
                    <div class="payment-methods" id="paymentMethodsSelection">
                        <!-- Payment methods will be populated here -->
                    </div>
                    <div class="payment-details-fields" id="paymentDetailsContainer">
                        <div class="form-group">
                            <label for="accountNumber">Account Number</label>
                            <input type="text" id="accountNumber" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="accountName">Account Name</label>
                            <input type="text" id="accountName" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="processingInstitution">Processing Institution</label>
                            <input type="text" id="processingInstitution" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="paybillNumber">Paybill Number</label>
                            <input type="text" id="paybillNumber" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="tillNumber">Till Number</label>
                            <input type="text" id="tillNumber" class="form-control" placeholder="Optional">
                        </div>
                    </div>
                </div>

                <div class="mt-30" style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateDocument()" id="generateBtn">
                        <span id="generateText">Generate Document</span>
                        <span id="generateSpinner" class="loading hidden"></span>
                    </button>
                    <button class="btn btn-success" onclick="previewDocument()">Preview Document</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                </div>
            </div>

            <!-- Document History Tab -->
            <div class="tab-content" id="history">
                <h2>Document History</h2>
                <div class="alert" id="historyAlert"></div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="historyFilter" class="form-control" style="width: auto;">
                        <option value="all">All Documents</option>
                        <option value="invoice">Invoices</option>
                        <option value="quote">Quotes</option>
                        <option value="receipt">Receipts</option>
                        <option value="proforma">Proforma Invoices</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadDocumentHistory()">Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Serial No.</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="7" class="text-center" style="padding: 40px;">
                                    Loading document history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Dashboard Tab -->
            <div class="tab-content" id="admin">
                <h2>Admin Dashboard</h2>
                <div class="alert" id="adminAlert"></div>
                
                <h3>Manage Companies</h3>
                <div class="company-list" id="companyList">
                    <div class="text-center" style="padding: 40px; color: var(--gray-color);">
                        Loading companies...
                    </div>
                </div>
                
                <h3 class="mt-30">Add/Edit Company</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="companyName" class="required">Company Name</label>
                        <input type="text" id="companyName" class="form-control" placeholder="Acme Inc.">
                    </div>
                    <div class="form-group">
                        <label for="parentCompany">Parent Company (Optional)</label>
                        <input type="text" id="parentCompany" class="form-control" placeholder="Parent Company Name">
                    </div>
                    <div class="form-group">
                        <label for="companyEmail" class="required">Company Email</label>
                        <input type="email" id="companyEmail" class="form-control" placeholder="contact@acme.com">
                    </div>
                    <div class="form-group">
                        <label for="companyTaxPin">Company TAX PIN (Optional)</label>
                        <input type="text" id="companyTaxPin" class="form-control" placeholder="Tax Identification Number">
                    </div>
                    <div class="form-group">
                        <label for="companyPhone">Company Phone</label>
                        <input type="tel" id="companyPhone" class="form-control" placeholder="+1234567890">
                    </div>
                    <div class="form-group">
                        <label for="companyWebsite">Company Website</label>
                        <input type="url" id="companyWebsite" class="form-control" placeholder="https://acme.com">
                    </div>
                    <div class="form-group">
                        <label for="companyAddress">Company Address</label>
                        <textarea id="companyAddress" class="form-control" rows="2" placeholder="123 Business Ave, City, Country"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="primaryColor">Primary Color</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="color-preview" id="colorPreview" style="background-color: #4361ee;"></div>
                            <input type="color" id="primaryColor" class="form-control" value="#4361ee" style="padding: 0; width: 60px;">
                            <input type="text" id="primaryColorText" class="form-control" value="#4361ee" style="flex: 1;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="secondaryColor">Secondary Color</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="color-preview" id="secondaryColorPreview" style="background-color: #3a0ca3;"></div>
                            <input type="color" id="secondaryColor" class="form-control" value="#3a0ca3" style="padding: 0; width: 60px;">
                            <input type="text" id="secondaryColorText" class="form-control" value="#3a0ca3" style="flex: 1;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-20">
                    <label>Company Logo Selection</label>
                    <div class="logo-selector">
                        <div class="logo-preview" id="logoPreviewContainer">
                            <span style="color: var(--gray-color);">No logo</span>
                        </div>
                        <div class="logo-options">
                            <select id="logoSelect" class="form-control" onchange="updateLogoPreview()">
                                <option value="">Select a logo</option>
                            </select>
                            <p style="margin-top: 5px; font-size: 0.9rem; color: var(--gray-color);">
                                Upload logo files (xxxxx.png) to your hosting root folder
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-20">
                    <label>Payment Methods</label>
                    <div class="payment-methods" id="paymentMethodsContainer">
                        <!-- Payment methods will be populated here -->
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="newPaymentMethod" class="form-control" placeholder="Add custom payment method" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="addPaymentMethod()">Add</button>
                    </div>
                </div>
                
                <div class="mt-30" style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveCompany()" id="saveCompanyBtn">
                        <span id="saveCompanyText">Save Company</span>
                        <span id="saveCompanySpinner" class="loading hidden"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearCompanyForm()">Clear Form</button>
                    <button class="btn btn-danger" onclick="deleteCompany()" id="deleteCompanyBtn" style="display: none;">Delete Company</button>
                </div>
            </div>

            <!-- Preview Tab -->
            <div class="tab-content" id="preview">
                <h2>Document Preview</h2>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generatePDF()">Download as PDF</button>
                    <button class="btn btn-secondary" onclick="refreshPreview()">Refresh Preview</button>
                </div>
                <div class="document-preview" id="documentPreview">
                    <div class="revoked-stamp" id="revokedStamp">REVOKED</div>
                    
                    <div class="document-header">
                        <div>
                            <img id="previewLogo" class="company-logo" src="" alt="Company Logo" style="display: none;">
                            <h2 id="previewCompanyName">Company Name</h2>
                            <div id="previewParentCompany" class="parent-company"></div>
                            <div id="previewCompanyTax" class="company-tax"></div>
                        </div>
                        <div class="company-details">
                            <p id="previewCompanyContact">Contact information</p>
                            <p id="previewCompanyWebsite">Website</p>
                        </div>
                    </div>
                    
                    <div class="document-title" id="previewDocumentTitle">INVOICE</div>
                    
                    <div class="document-info">
                        <div class="document-info-column">
                            <h3>Bill To:</h3>
                            <p id="previewCustomerDetails">Customer details will appear here</p>
                        </div>
                        <div class="document-info-column" style="text-align: right;">
                            <h3>Document Details:</h3>
                            <p><strong>Serial No:</strong> <span id="previewSerialNumber">INV-2023-001</span></p>
                            <p><strong>Date:</strong> <span id="previewDate">January 1, 2023</span></p>
                            <p><strong>Document Type:</strong> <span id="previewDocType">Invoice</span></p>
                        </div>
                    </div>
                    
                    <table class="document-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="previewItems">
                            <tr>
                                <td colspan="4" class="text-center">No items added</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Subtotal:</strong></td>
                                <td id="previewSubtotal">$0.00</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Discount:</strong></td>
                                <td id="previewDiscount">$0.00</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Tax:</strong></td>
                                <td id="previewTax">$0.00</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right;"><strong>Total:</strong></td>
                                <td id="previewTotal">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="payment-methods-section">
                        <h4>Payment Method</h4>
                        <div class="payment-methods" id="previewPaymentMethods">
                            <span class="payment-method-tag">Select a payment method</span>
                        </div>
                        <div id="previewPaymentDetails"></div>
                    </div>
                    
                    <div class="terms-preview" id="previewTerms">
                        <!-- Terms will be populated here -->
                    </div>
                    
                    <div class="document-footer">
                        <div>
                            <h3>Thank You!</h3>
                            <p>We appreciate your business</p>
                        </div>
                        <div style="text-align: right;">
                            <p><strong>Authorized Signature:</strong></p>
                            <p>_________________________</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let db = null;
        let companies = [];
        let documents = [];
        let currentCompanyId = null;
        let selectedPaymentMethod = '';
        let paymentMethodDetails = {};
        let availableLogos = [];
        let discountAmount = 0;

        // Terms and conditions for each document type
        const documentTerms = {
            receipt: "All payments are final. No refunds allowed after receipt.",
            quote: "Customer will be billed after indicating acceptance of this quote.\nThis is not an Invoice nor a receipt.\nPrices are due to change depending on market forces or other circumstances.",
            invoice: "All payments are due within 14 days.\nPlease include Invoice number in the cheque.",
            proforma: "This is not an actual invoice.\nPrices are indicative.\nAn actual invoice will be shared upon acceptance of this proforma invoice."
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing...");
            
            // Wait for Firebase to be initialized
            if (!window.firebaseApp) {
                console.error("Firebase not initialized");
                showAuthAlert('loginAlert', 'Firebase initialization failed. Please refresh the page.', 'danger');
                return;
            }

            // Initialize Firebase components
            db = window.firebaseApp.db;
            
            // Set up auth state listener
            window.firebaseApp.onAuthStateChanged(window.firebaseApp.auth, (user) => {
                if (user) {
                    console.log("User signed in:", user.email);
                    currentUser = user;
                    showMainApp();
                    initializeMainApp();
                } else {
                    console.log("No user signed in");
                    showAuthScreen();
                }
            });

            // Set up event listeners for auth screen
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('registerConfirmPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') register();
            });
        });

        // Auth functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        function showAuthAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthAlert('loginAlert', 'Please enter both email and password', 'danger');
                return;
            }
            
            const btn = document.getElementById('loginBtn');
            const text = document.getElementById('loginText');
            const spinner = document.getElementById('loginSpinner');
            
            text.textContent = 'Logging in...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                await window.firebaseApp.signInWithEmailAndPassword(window.firebaseApp.auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                let message = 'Login failed. ';
                switch(error.code) {
                    case 'auth/user-not-found':
                        message += 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        message += 'Incorrect password.';
                        break;
                    case 'auth/invalid-email':
                        message += 'Invalid email address.';
                        break;
                    default:
                        message += error.message;
                }
                showAuthAlert('loginAlert', message, 'danger');
                
                text.textContent = 'Login';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        async function register() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showAuthAlert('registerAlert', 'Please fill in all fields', 'danger');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthAlert('registerAlert', 'Passwords do not match', 'danger');
                return;
            }
            
            if (password.length < 6) {
                showAuthAlert('registerAlert', 'Password must be at least 6 characters', 'danger');
                return;
            }
            
            const btn = document.getElementById('registerBtn');
            const text = document.getElementById('registerText');
            const spinner = document.getElementById('registerSpinner');
            
            text.textContent = 'Creating account...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                await window.firebaseApp.createUserWithEmailAndPassword(window.firebaseApp.auth, email, password);
            } catch (error) {
                console.error("Registration error:", error);
                let message = 'Registration failed. ';
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        message += 'Email already in use.';
                        break;
                    case 'auth/invalid-email':
                        message += 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        message += 'Password is too weak.';
                        break;
                    default:
                        message += error.message;
                }
                showAuthAlert('registerAlert', message, 'danger');
                
                text.textContent = 'Create Account';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        async function logout() {
            try {
                await window.firebaseApp.signOut(window.firebaseApp.auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Clear forms
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirmPassword').value = '';
        }

        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        // Main App Functions
        function initializeMainApp() {
            console.log("Initializing main app...");
            
            // Set up color pickers
            document.getElementById('primaryColor')?.addEventListener('input', function() {
                document.getElementById('primaryColorText').value = this.value;
                document.getElementById('colorPreview').style.backgroundColor = this.value;
            });
            
            document.getElementById('primaryColorText')?.addEventListener('input', function() {
                const color = this.value;
                if (isValidColor(color)) {
                    document.getElementById('primaryColor').value = color;
                    document.getElementById('colorPreview').style.backgroundColor = color;
                }
            });
            
            document.getElementById('secondaryColor')?.addEventListener('input', function() {
                document.getElementById('secondaryColorText').value = this.value;
                document.getElementById('secondaryColorPreview').style.backgroundColor = this.value;
            });
            
            document.getElementById('secondaryColorText')?.addEventListener('input', function() {
                const color = this.value;
                if (isValidColor(color)) {
                    document.getElementById('secondaryColor').value = color;
                    document.getElementById('secondaryColorPreview').style.backgroundColor = color;
                }
            });
            
            // Set up tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Set up form event listeners
            document.getElementById('documentType')?.addEventListener('change', function() {
                updateSerialNumber();
                updateTermsAndConditions();
            });
            
            document.getElementById('companySelect')?.addEventListener('change', onCompanySelect);
            
            // Set up item calculations
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('item-desc') || 
                    e.target.classList.contains('item-qty') || 
                    e.target.classList.contains('item-price') ||
                    e.target.id === 'taxRate' ||
                    e.target.id === 'discountAmount') {
                    updateItemTotals();
                }
                
                // Update payment details
                if (e.target.id === 'accountNumber' || e.target.id === 'accountName' || 
                    e.target.id === 'processingInstitution' || e.target.id === 'paybillNumber' || 
                    e.target.id === 'tillNumber') {
                    updatePaymentMethodDetails();
                }
            });
            
            // Initialize
            updateSerialNumber();
            updateTermsAndConditions();
            loadDefaultPaymentMethods();
            scanForLogos();
            loadCompanies();
            loadDocumentHistory();
            
            // Set current date
            const now = new Date();
            document.getElementById('previewDate').textContent = now.toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            
            console.log("Main app initialized successfully");
        }

        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function switchTab(tabId) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) {
                    content.classList.add('active');
                }
            });
            
            // Special actions
            if (tabId === 'preview') {
                previewDocument();
            }
        }

        function isValidColor(color) {
            const s = new Option().style;
            s.color = color;
            return s.color !== '';
        }

        // Update terms and conditions based on document type
        function updateTermsAndConditions() {
            const docType = document.getElementById('documentType').value;
            const terms = documentTerms[docType] || '';
            document.getElementById('termsContent').textContent = terms;
            
            // Update preview
            const previewTerms = document.getElementById('previewTerms');
            const formattedTerms = terms.split('\n').map(line => `<p>${line}</p>`).join('');
            previewTerms.innerHTML = formattedTerms;
        }

        // Logo scanning and management
        async function scanForLogos() {
            try {
                // This is a mock function - in production, you would scan your server for logo files
                // For demonstration, we'll create a list of potential logo files
                availableLogos = [
                    'company1.png',
                    'company2.png',
                    'company3.png',
                    'acme.png',
                    'logo.png',
                    'business.png'
                ];
                
                const select = document.getElementById('logoSelect');
                select.innerHTML = '<option value="">Select a logo</option>';
                
                availableLogos.forEach(logo => {
                    const option = document.createElement('option');
                    option.value = logo;
                    option.textContent = logo;
                    select.appendChild(option);
                });
                
                console.log(`Found ${availableLogos.length} logo files`);
            } catch (error) {
                console.error("Error scanning for logos:", error);
            }
        }

        function updateLogoPreview() {
            const select = document.getElementById('logoSelect');
            const logoFile = select.value;
            const previewContainer = document.getElementById('logoPreviewContainer');
            
            if (logoFile) {
                // Assuming logos are in root folder
                const logoUrl = `/${logoFile}`;
                previewContainer.innerHTML = `<img src="${logoUrl}" alt="Logo Preview" onerror="this.onerror=null; this.parentElement.innerHTML='<span style=\\'color: var(--gray-color);\\'>Logo not found</span>'">`;
            } else {
                previewContainer.innerHTML = '<span style="color: var(--gray-color);">No logo</span>';
            }
        }

        // Serial Number Generation
        function updateSerialNumber() {
            const docType = document.getElementById('documentType').value;
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            let prefix = 'DOC';
            switch(docType) {
                case 'invoice': prefix = 'INV'; break;
                case 'quote': prefix = 'QUO'; break;
                case 'receipt': prefix = 'REC'; break;
                case 'proforma': prefix = 'PRO'; break;
            }
            
            const randomNum = Math.floor(Math.random() * 999) + 1;
            const serialNumber = `${prefix}-${year}${month}${day}-${String(randomNum).padStart(3, '0')}`;
            
            document.getElementById('serialNumber').value = serialNumber;
            document.getElementById('previewSerialNumber').textContent = serialNumber;
        }

        // Item Management with Discount
        function addItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="form-control item-desc" placeholder="Item description"></td>
                <td><input type="number" class="form-control item-qty" value="1" min="1"></td>
                <td><input type="number" class="form-control item-price" value="0" min="0" step="0.01"></td>
                <td class="item-total">$0.00</td>
                <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">âœ•</button></td>
            `;
            tableBody.appendChild(newRow);
            updateItemTotals();
        }

        function removeItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateItemTotals();
        }

        function updateItemTotals() {
            let subtotal = 0;
            const rows = document.querySelectorAll('#itemsTableBody tr');
            const previewItems = document.getElementById('previewItems');
            
            previewItems.innerHTML = '';
            
            rows.forEach(row => {
                const desc = row.querySelector('.item-desc').value || '';
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = qty * price;
                subtotal += total;
                
                row.querySelector('.item-total').textContent = '$' + total.toFixed(2);
                
                if (desc.trim()) {
                    const previewRow = document.createElement('tr');
                    previewRow.innerHTML = `
                        <td>${desc}</td>
                        <td>${qty}</td>
                        <td>$${price.toFixed(2)}</td>
                        <td>$${total.toFixed(2)}</td>
                    `;
                    previewItems.appendChild(previewRow);
                }
            });
            
            if (previewItems.children.length === 0) {
                previewItems.innerHTML = '<tr><td colspan="4" class="text-center">No items added</td></tr>';
            }
            
            // Calculate discount
            discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
                document.getElementById('discountAmount').value = discountAmount.toFixed(2);
            }
            
            const discountedSubtotal = subtotal - discountAmount;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            const taxAmount = discountedSubtotal * (taxRate / 100);
            const totalAmount = discountedSubtotal + taxAmount;
            
            // Update display
            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('discountDisplay').textContent = '-$' + discountAmount.toFixed(2);
            document.getElementById('taxAmount').textContent = '$' + taxAmount.toFixed(2);
            document.getElementById('totalAmount').textContent = '$' + totalAmount.toFixed(2);
            
            // Update preview
            document.getElementById('previewSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('previewDiscount').textContent = '-$' + discountAmount.toFixed(2);
            document.getElementById('previewTax').textContent = '$' + taxAmount.toFixed(2);
            document.getElementById('previewTotal').textContent = '$' + totalAmount.toFixed(2);
        }

        // Payment Methods
        function loadDefaultPaymentMethods() {
            const defaultMethods = ['Credit Card', 'PayPal', 'Bank Transfer', 'Cash', 'M-Pesa', 'Check'];
            const container = document.getElementById('paymentMethodsContainer');
            
            container.innerHTML = '';
            defaultMethods.forEach(method => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.marginRight = '15px';
                label.style.marginBottom = '10px';
                label.innerHTML = `
                    <input type="checkbox" class="payment-method-checkbox" value="${method}" ${method === 'Credit Card' || method === 'PayPal' ? 'checked' : ''}>
                    <span style="margin-left: 5px;">${method}</span>
                `;
                container.appendChild(label);
            });
        }

        function addPaymentMethod() {
            const input = document.getElementById('newPaymentMethod');
            const method = input.value.trim();
            
            if (!method) {
                showAlert('adminAlert', 'Please enter a payment method name', 'danger');
                return;
            }
            
            const container = document.getElementById('paymentMethodsContainer');
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.marginRight = '15px';
            label.style.marginBottom = '10px';
            label.innerHTML = `
                <input type="checkbox" class="payment-method-checkbox" value="${method}" checked>
                <span style="margin-left: 5px;">${method}</span>
            `;
            container.appendChild(label);
            
            input.value = '';
        }

        function updatePaymentMethodsSelection(company) {
            const container = document.getElementById('paymentMethodsSelection');
            container.innerHTML = '';
            
            if (company && company.paymentMethods && Array.isArray(company.paymentMethods)) {
                company.paymentMethods.forEach(method => {
                    const span = document.createElement('span');
                    span.className = 'payment-method-tag';
                    span.textContent = method;
                    span.dataset.method = method;
                    
                    if (method === selectedPaymentMethod) {
                        span.classList.add('active');
                    }
                    
                    span.addEventListener('click', function() {
                        document.querySelectorAll('#paymentMethodsSelection .payment-method-tag').forEach(el => {
                            el.classList.remove('active');
                        });
                        
                        this.classList.add('active');
                        selectedPaymentMethod = this.dataset.method;
                        
                        // Show payment details
                        document.getElementById('paymentDetailsContainer').classList.add('active');
                    });
                    
                    container.appendChild(span);
                });
            }
        }

        function updatePaymentMethodDetails() {
            paymentMethodDetails = {
                accountNumber: document.getElementById('accountNumber').value || '',
                accountName: document.getElementById('accountName').value || '',
                processingInstitution: document.getElementById('processingInstitution').value || '',
                paybillNumber: document.getElementById('paybillNumber').value || '',
                tillNumber: document.getElementById('tillNumber').value || ''
            };
            
            updatePaymentDetailsPreview();
        }

        function updatePaymentDetailsPreview() {
            const container = document.getElementById('previewPaymentDetails');
            let html = '';
            
            if (Object.values(paymentMethodDetails).some(value => value.trim())) {
                html = '<div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">';
                html += '<h5 style="margin-bottom: 10px; color: var(--secondary-color);">Payment Details:</h5>';
                
                if (paymentMethodDetails.accountNumber) {
                    html += `<p><strong>Account Number:</strong> ${paymentMethodDetails.accountNumber}</p>`;
                }
                if (paymentMethodDetails.accountName) {
                    html += `<p><strong>Account Name:</strong> ${paymentMethodDetails.accountName}</p>`;
                }
                if (paymentMethodDetails.processingInstitution) {
                    html += `<p><strong>Institution:</strong> ${paymentMethodDetails.processingInstitution}</p>`;
                }
                if (paymentMethodDetails.paybillNumber) {
                    html += `<p><strong>Paybill:</strong> ${paymentMethodDetails.paybillNumber}</p>`;
                }
                if (paymentMethodDetails.tillNumber) {
                    html += `<p><strong>Till Number:</strong> ${paymentMethodDetails.tillNumber}</p>`;
                }
                
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // Company Management
        async function loadCompanies() {
            try {
                console.log("Loading companies...");
                const querySnapshot = await window.firebaseApp.getDocs(window.firebaseApp.collection(db, "companies"));
                companies = [];
                const companySelect = document.getElementById('companySelect');
                const companyList = document.getElementById('companyList');
                
                // Clear existing options except the first one
                while (companySelect.options.length > 1) {
                    companySelect.remove(1);
                }
                
                companyList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    companyList.innerHTML = '<div class="text-center" style="padding: 40px; color: var(--gray-color);">No companies found. Add your first company below.</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const company = { id: doc.id, ...doc.data() };
                    companies.push(company);
                    
                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = company.name;
                    companySelect.appendChild(option);
                    
                    // Add to company list
                    const card = document.createElement('div');
                    card.className = 'company-card';
                    card.innerHTML = `
                        <div class="company-card-header">
                            ${company.logoFile ? `<img src="/${company.logoFile}" class="company-card-logo" alt="${company.name}" onerror="this.style.display='none'">` : ''}
                            <div>
                                <h4 style="margin-bottom: 5px;">${company.name}</h4>
                                <p style="font-size: 0.9rem; color: var(--gray-color);">${company.email}</p>
                                ${company.parentCompany ? `<p style="font-size: 0.8rem; color: var(--gray-color);">Parent: ${company.parentCompany}</p>` : ''}
                            </div>
                        </div>
                        <p style="margin-bottom: 10px; font-size: 0.9rem;">${company.address || 'No address'}</p>
                        <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                            <span class="color-preview" style="background-color: ${company.primaryColor || '#4361ee'}"></span>
                            <span class="color-preview" style="background-color: ${company.secondaryColor || '#3a0ca3'}"></span>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="editCompany('${doc.id}')">Edit</button>
                    `;
                    companyList.appendChild(card);
                });
                
                // Select first company
                if (companies.length > 0) {
                    companySelect.value = companies[0].id;
                    onCompanySelect();
                }
                
                console.log(`Loaded ${companies.length} companies`);
            } catch (error) {
                console.error("Error loading companies:", error);
                showAlert('adminAlert', 'Error loading companies: ' + error.message, 'danger');
            }
        }

        function onCompanySelect() {
            const companyId = document.getElementById('companySelect').value;
            if (!companyId) return;
            
            const company = companies.find(c => c.id === companyId);
            if (company) {
                updatePreviewWithCompany(company);
                updatePaymentMethodsSelection(company);
            }
        }

        function updatePreviewWithCompany(company) {
            document.getElementById('previewCompanyName').textContent = company.name;
            
            let contactInfo = '';
            if (company.email) contactInfo += company.email + '<br>';
            if (company.phone) contactInfo += company.phone + '<br>';
            if (company.address) contactInfo += company.address;
            
            document.getElementById('previewCompanyContact').innerHTML = contactInfo || 'No contact information';
            document.getElementById('previewCompanyWebsite').textContent = company.website || '';
            
            // Update parent company
            const parentCompany = document.getElementById('previewParentCompany');
            if (company.parentCompany) {
                parentCompany.textContent = `A division of ${company.parentCompany}`;
                parentCompany.style.display = 'block';
            } else {
                parentCompany.style.display = 'none';
            }
            
            // Update tax pin
            const companyTax = document.getElementById('previewCompanyTax');
            if (company.taxPin) {
                companyTax.textContent = `TAX PIN: ${company.taxPin}`;
                companyTax.style.display = 'block';
            } else {
                companyTax.style.display = 'none';
            }
            
            // Update logo
            const logoImg = document.getElementById('previewLogo');
            if (company.logoFile) {
                logoImg.src = `/${company.logoFile}`;
                logoImg.style.display = 'block';
                logoImg.onerror = function() {
                    this.style.display = 'none';
                };
            } else {
                logoImg.style.display = 'none';
            }
            
            // Update colors
            if (company.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', company.primaryColor);
            }
            if (company.secondaryColor) {
                document.documentElement.style.setProperty('--secondary-color', company.secondaryColor);
            }
        }

        async function saveCompany() {
            const name = document.getElementById('companyName').value.trim();
            const email = document.getElementById('companyEmail').value.trim();
            
            if (!name || !email) {
                showAlert('adminAlert', 'Company name and email are required', 'danger');
                return;
            }
            
            const btn = document.getElementById('saveCompanyBtn');
            const text = document.getElementById('saveCompanyText');
            const spinner = document.getElementById('saveCompanySpinner');
            
            text.textContent = 'Saving...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                // Get payment methods
                const paymentMethods = [];
                document.querySelectorAll('.payment-method-checkbox:checked').forEach(cb => {
                    paymentMethods.push(cb.value);
                });
                
                // Get selected logo
                const logoSelect = document.getElementById('logoSelect');
                const logoFile = logoSelect.value || '';
                
                // Prepare company data
                const companyData = {
                    name: name,
                    parentCompany: document.getElementById('parentCompany').value.trim(),
                    taxPin: document.getElementById('companyTaxPin').value.trim(),
                    email: email,
                    phone: document.getElementById('companyPhone').value.trim(),
                    website: document.getElementById('companyWebsite').value.trim(),
                    address: document.getElementById('companyAddress').value.trim(),
                    primaryColor: document.getElementById('primaryColor').value,
                    secondaryColor: document.getElementById('secondaryColor').value,
                    paymentMethods: paymentMethods,
                    logoFile: logoFile,
                    updatedAt: window.firebaseApp.Timestamp.now()
                };
                
                if (currentCompanyId) {
                    // Update existing company
                    const companyRef = window.firebaseApp.doc(db, "companies", currentCompanyId);
                    await window.firebaseApp.updateDoc(companyRef, companyData);
                    showAlert('adminAlert', 'Company updated successfully!', 'success');
                } else {
                    // Add new company
                    companyData.createdAt = window.firebaseApp.Timestamp.now();
                    const docRef = await window.firebaseApp.addDoc(
                        window.firebaseApp.collection(db, "companies"), 
                        companyData
                    );
                    currentCompanyId = docRef.id;
                    showAlert('adminAlert', 'Company saved successfully!', 'success');
                    document.getElementById('deleteCompanyBtn').style.display = 'inline-block';
                }
                
                // Reload companies
                await loadCompanies();
                
                if (!currentCompanyId) {
                    clearCompanyForm();
                }
                
            } catch (error) {
                console.error("Error saving company:", error);
                showAlert('adminAlert', 'Error saving company: ' + error.message, 'danger');
            } finally {
                text.textContent = 'Save Company';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function editCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;
            
            currentCompanyId = companyId;
            
            // Populate form
            document.getElementById('companyName').value = company.name || '';
            document.getElementById('parentCompany').value = company.parentCompany || '';
            document.getElementById('companyTaxPin').value = company.taxPin || '';
            document.getElementById('companyEmail').value = company.email || '';
            document.getElementById('companyPhone').value = company.phone || '';
            document.getElementById('companyWebsite').value = company.website || '';
            document.getElementById('companyAddress').value = company.address || '';
            document.getElementById('primaryColor').value = company.primaryColor || '#4361ee';
            document.getElementById('primaryColorText').value = company.primaryColor || '#4361ee';
            document.getElementById('secondaryColor').value = company.secondaryColor || '#3a0ca3';
            document.getElementById('secondaryColorText').value = company.secondaryColor || '#3a0ca3';
            
            // Update color previews
            document.getElementById('colorPreview').style.backgroundColor = company.primaryColor || '#4361ee';
            document.getElementById('secondaryColorPreview').style.backgroundColor = company.secondaryColor || '#3a0ca3';
            
            // Update logo selection
            const logoSelect = document.getElementById('logoSelect');
            logoSelect.value = company.logoFile || '';
            updateLogoPreview();
            
            // Update payment methods
            document.querySelectorAll('.payment-method-checkbox').forEach(cb => {
                cb.checked = company.paymentMethods && company.paymentMethods.includes(cb.value);
            });
            
            document.getElementById('deleteCompanyBtn').style.display = 'inline-block';
            
            // Switch to admin tab
            switchTab('admin');
        }

        function clearCompanyForm() {
            currentCompanyId = null;
            
            document.getElementById('companyName').value = '';
            document.getElementById('parentCompany').value = '';
            document.getElementById('companyTaxPin').value = '';
            document.getElementById('companyEmail').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyWebsite').value = '';
            document.getElementById('companyAddress').value = '';
            document.getElementById('primaryColor').value = '#4361ee';
            document.getElementById('primaryColorText').value = '#4361ee';
            document.getElementById('secondaryColor').value = '#3a0ca3';
            document.getElementById('secondaryColorText').value = '#3a0ca3';
            
            document.getElementById('colorPreview').style.backgroundColor = '#4361ee';
            document.getElementById('secondaryColorPreview').style.backgroundColor = '#3a0ca3';
            
            document.querySelectorAll('.payment-method-checkbox').forEach(cb => {
                cb.checked = cb.value === 'Credit Card' || cb.value === 'PayPal';
            });
            
            document.getElementById('logoSelect').value = '';
            updateLogoPreview();
            
            document.getElementById('deleteCompanyBtn').style.display = 'none';
            document.getElementById('adminAlert').style.display = 'none';
        }

        async function deleteCompany() {
            if (!currentCompanyId || !confirm('Are you sure you want to delete this company? This action cannot be undone.')) {
                return;
            }
            
            try {
                const companyRef = window.firebaseApp.doc(db, "companies", currentCompanyId);
                await window.firebaseApp.deleteDoc(companyRef);
                
                showAlert('adminAlert', 'Company deleted successfully!', 'success');
                clearCompanyForm();
                await loadCompanies();
            } catch (error) {
                console.error("Error deleting company:", error);
                showAlert('adminAlert', 'Error deleting company: ' + error.message, 'danger');
            }
        }

        // Document Generation with Discount
        async function generateDocument() {
            const companyId = document.getElementById('companySelect').value;
            const customerName = document.getElementById('customerName').value.trim();
            
            if (!companyId) {
                showAlert('createAlert', 'Please select a company', 'danger');
                return;
            }
            
            if (!customerName) {
                showAlert('createAlert', 'Please enter customer name', 'danger');
                return;
            }
            
            // Check items
            const rows = document.querySelectorAll('#itemsTableBody tr');
            let hasItems = false;
            rows.forEach(row => {
                const desc = row.querySelector('.item-desc').value;
                if (desc && desc.trim()) hasItems = true;
            });
            
            if (!hasItems) {
                showAlert('createAlert', 'Please add at least one item', 'danger');
                return;
            }
            
            const btn = document.getElementById('generateBtn');
            const text = document.getElementById('generateText');
            const spinner = document.getElementById('generateSpinner');
            
            text.textContent = 'Generating...';
            spinner.classList.remove('hidden');
            btn.disabled = true;
            
            try {
                const company = companies.find(c => c.id === companyId);
                if (!company) throw new Error('Company not found');
                
                // Calculate totals
                let subtotal = 0;
                const items = [];
                
                rows.forEach(row => {
                    const desc = row.querySelector('.item-desc').value;
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    const total = qty * price;
                    
                    if (desc && desc.trim()) {
                        items.push({
                            description: desc,
                            quantity: qty,
                            unitPrice: price,
                            total: total
                        });
                        subtotal += total;
                    }
                });
                
                discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
                if (discountAmount > subtotal) discountAmount = subtotal;
                
                const discountedSubtotal = subtotal - discountAmount;
                const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
                const taxAmount = discountedSubtotal * (taxRate / 100);
                const totalAmount = discountedSubtotal + taxAmount;
                
                // Get document type
                const docType = document.getElementById('documentType').value;
                const terms = documentTerms[docType] || '';
                
                // Prepare document data
                const documentData = {
                    type: docType,
                    serialNumber: document.getElementById('serialNumber').value,
                    companyId: companyId,
                    companyName: company.name,
                    companyEmail: company.email,
                    companyPhone: company.phone,
                    companyAddress: company.address,
                    companyWebsite: company.website,
                    companyLogoFile: company.logoFile || '',
                    parentCompany: company.parentCompany || '',
                    taxPin: company.taxPin || '',
                    customerName: customerName,
                    customerEmail: document.getElementById('customerEmail').value.trim(),
                    customerPhone: document.getElementById('customerPhone').value.trim(),
                    customerAddress: document.getElementById('customerAddress').value.trim(),
                    items: items,
                    subtotal: subtotal,
                    discount: discountAmount,
                    taxRate: taxRate,
                    taxAmount: taxAmount,
                    total: totalAmount,
                    paymentMethods: company.paymentMethods || [],
                    selectedPaymentMethod: selectedPaymentMethod,
                    paymentMethodDetails: paymentMethodDetails,
                    terms: terms,
                    userId: currentUser.uid,
                    createdAt: window.firebaseApp.Timestamp.now(),
                    revoked: false
                };
                
                // Save to Firebase
                const docRef = await window.firebaseApp.addDoc(
                    window.firebaseApp.collection(db, "documents"), 
                    documentData
                );
                
                console.log("Document saved with ID:", docRef.id);
                showAlert('createAlert', 'Document generated successfully!', 'success');
                
                clearForm();
                await loadDocumentHistory();
                
            } catch (error) {
                console.error("Error generating document:", error);
                showAlert('createAlert', 'Error generating document: ' + error.message, 'danger');
            } finally {
                text.textContent = 'Generate Document';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function clearForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            
            // Clear items except first
            const tableBody = document.getElementById('itemsTableBody');
            while (tableBody.rows.length > 1) {
                tableBody.deleteRow(1);
            }
            
            // Reset first row
            const firstRow = tableBody.rows[0];
            firstRow.querySelector('.item-desc').value = '';
            firstRow.querySelector('.item-qty').value = '1';
            firstRow.querySelector('.item-price').value = '0';
            
            document.getElementById('discountAmount').value = '0';
            document.getElementById('taxRate').value = '10';
            updateItemTotals();
            
            // Clear payment details
            selectedPaymentMethod = '';
            paymentMethodDetails = {};
            document.getElementById('accountNumber').value = '';
            document.getElementById('accountName').value = '';
            document.getElementById('processingInstitution').value = '';
            document.getElementById('paybillNumber').value = '';
            document.getElementById('tillNumber').value = '';
            document.getElementById('paymentDetailsContainer').classList.remove('active');
            document.querySelectorAll('#paymentMethodsSelection .payment-method-tag').forEach(el => {
                el.classList.remove('active');
            });
            
            updateSerialNumber();
            updateTermsAndConditions();
            document.getElementById('createAlert').style.display = 'none';
        }

        function previewDocument() {
            // Update customer details
            const customerName = document.getElementById('customerName').value || 'John Doe';
            const customerEmail = document.getElementById('customerEmail').value || 'john@example.com';
            const customerPhone = document.getElementById('customerPhone').value || '+1234567890';
            const customerAddress = document.getElementById('customerAddress').value || '123 Main St, City, Country';
            
            document.getElementById('previewCustomerDetails').innerHTML = `
                <strong>${customerName}</strong><br>
                ${customerEmail}<br>
                ${customerPhone}<br>
                ${customerAddress}
            `;
            
            // Update document type
            const docType = document.getElementById('documentType').value;
            let docTitle = 'DOCUMENT';
            switch(docType) {
                case 'invoice': docTitle = 'INVOICE'; break;
                case 'quote': docTitle = 'QUOTE'; break;
                case 'receipt': docTitle = 'RECEIPT'; break;
                case 'proforma': docTitle = 'PROFORMA INVOICE'; break;
            }
            
            document.getElementById('previewDocumentTitle').textContent = docTitle;
            document.getElementById('previewDocType').textContent = docTitle.charAt(0) + docTitle.slice(1).toLowerCase();
            
            // Update serial number and date
            document.getElementById('previewSerialNumber').textContent = document.getElementById('serialNumber').value;
            document.getElementById('previewDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            
            // Update payment methods in preview
            const previewMethods = document.getElementById('previewPaymentMethods');
            previewMethods.innerHTML = '';
            
            if (selectedPaymentMethod) {
                const span = document.createElement('span');
                span.className = 'payment-method-tag active';
                span.textContent = selectedPaymentMethod;
                previewMethods.appendChild(span);
            } else {
                previewMethods.innerHTML = '<span class="payment-method-tag">Select a payment method</span>';
            }
            
            updatePaymentDetailsPreview();
            
            // Update terms in preview
            updateTermsAndConditions();
            
            // Switch to preview tab
            switchTab('preview');
        }

        function refreshPreview() {
            previewDocument();
        }

        // Document History
        async function loadDocumentHistory() {
            try {
                const filter = document.getElementById('historyFilter').value;
                const q = filter === 'all' 
                    ? window.firebaseApp.query(window.firebaseApp.collection(db, "documents"), window.firebaseApp.orderBy("createdAt", "desc"))
                    : window.firebaseApp.query(window.firebaseApp.collection(db, "documents"), window.firebaseApp.where("type", "==", filter), window.firebaseApp.orderBy("createdAt", "desc"));
                
                const querySnapshot = await window.firebaseApp.getDocs(q);
                documents = [];
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center" style="padding: 40px;">No documents found. Create your first document!</td>
                        </tr>
                    `;
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    documents.push(data);
                    
                    const date = data.createdAt?.toDate() || new Date();
                    const dateStr = date.toLocaleDateString('en-US');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${data.serialNumber || 'N/A'}</td>
                        <td><span style="text-transform: capitalize;">${data.type || 'Unknown'}</span></td>
                        <td>${data.customerName || 'Unknown'}</td>
                        <td>${dateStr}</td>
                        <td>$${data.total?.toFixed(2) || '0.00'}</td>
                        <td>
                            <span class="status-badge ${data.revoked ? 'status-revoked' : 'status-active'}">
                                ${data.revoked ? 'Revoked' : 'Active'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="viewDocument('${doc.id}')">View</button>
                                <button class="btn btn-success btn-sm" onclick="downloadDocumentPDF('${doc.id}')">PDF</button>
                                ${!data.revoked ? `<button class="btn btn-danger btn-sm" onclick="revokeDocument('${doc.id}')">Revoke</button>` : ''}
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("Error loading history:", error);
                showAlert('historyAlert', 'Error loading document history: ' + error.message, 'danger');
            }
        }

        function viewDocument(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) return;
            
            // Populate form
            document.getElementById('documentType').value = doc.type;
            document.getElementById('serialNumber').value = doc.serialNumber;
            
            if (doc.companyId) {
                document.getElementById('companySelect').value = doc.companyId;
                const company = companies.find(c => c.id === doc.companyId);
                if (company) {
                    updatePreviewWithCompany(company);
                    updatePaymentMethodsSelection(company);
                }
            }
            
            document.getElementById('customerName').value = doc.customerName || '';
            document.getElementById('customerEmail').value = doc.customerEmail || '';
            document.getElementById('customerPhone').value = doc.customerPhone || '';
            document.getElementById('customerAddress').value = doc.customerAddress || '';
            
            // Clear items
            const tableBody = document.getElementById('itemsTableBody');
            tableBody.innerHTML = '';
            
            // Add items
            if (doc.items && Array.isArray(doc.items)) {
                doc.items.forEach((item, index) => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="form-control item-desc" value="${item.description || ''}"></td>
                        <td><input type="number" class="form-control item-qty" value="${item.quantity || 1}" min="1"></td>
                        <td><input type="number" class="form-control item-price" value="${item.unitPrice || 0}" min="0" step="0.01"></td>
                        <td class="item-total">$${(item.total || 0).toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeItem(this)">âœ•</button></td>
                    `;
                    tableBody.appendChild(newRow);
                });
            }
            
            // Add one empty row if needed
            if (tableBody.rows.length === 0) {
                addItem();
            }
            
            document.getElementById('discountAmount').value = doc.discount || 0;
            document.getElementById('taxRate').value = doc.taxRate || 10;
            updateItemTotals();
            
            // Set payment method
            if (doc.selectedPaymentMethod) {
                selectedPaymentMethod = doc.selectedPaymentMethod;
                document.querySelectorAll('#paymentMethodsSelection .payment-method-tag').forEach(el => {
                    if (el.dataset.method === selectedPaymentMethod) {
                        el.classList.add('active');
                    }
                });
                
                if (doc.paymentMethodDetails) {
                    paymentMethodDetails = doc.paymentMethodDetails;
                    document.getElementById('accountNumber').value = paymentMethodDetails.accountNumber || '';
                    document.getElementById('accountName').value = paymentMethodDetails.accountName || '';
                    document.getElementById('processingInstitution').value = paymentMethodDetails.processingInstitution || '';
                    document.getElementById('paybillNumber').value = paymentMethodDetails.paybillNumber || '';
                    document.getElementById('tillNumber').value = paymentMethodDetails.tillNumber || '';
                    document.getElementById('paymentDetailsContainer').classList.add('active');
                    updatePaymentDetailsPreview();
                }
            }
            
            // Show revoked stamp if needed
            document.getElementById('revokedStamp').style.display = doc.revoked ? 'block' : 'none';
            
            // Update terms
            updateTermsAndConditions();
            
            // Switch to create tab
            switchTab('create');
            previewDocument();
        }

        async function revokeDocument(documentId) {
            if (!confirm('Are you sure you want to revoke this document?')) {
                return;
            }
            
            try {
                const docRef = window.firebaseApp.doc(db, "documents", documentId);
                await window.firebaseApp.updateDoc(docRef, { revoked: true });
                
                showAlert('historyAlert', 'Document revoked successfully!', 'success');
                await loadDocumentHistory();
                
                // Update preview if viewing this document
                const doc = documents.find(d => d.id === documentId);
                if (doc && doc.serialNumber === document.getElementById('serialNumber').value) {
                    document.getElementById('revokedStamp').style.display = 'block';
                }
            } catch (error) {
                console.error("Error revoking document:", error);
                showAlert('historyAlert', 'Error revoking document: ' + error.message, 'danger');
            }
        }

        async function downloadDocumentPDF(documentId) {
            const doc = documents.find(d => d.id === documentId);
            if (!doc) {
                // If not in history, load it first
                viewDocument(documentId);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            generatePDF();
        }

        async function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('portrait', 'pt', 'a4');
                
                const element = document.getElementById('documentPreview');
                
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 595.28;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                const docType = document.getElementById('documentType').value;
                const serialNumber = document.getElementById('serialNumber').value;
                doc.save(`${serialNumber}-${docType}.pdf`);
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert('Error generating PDF: ' + error.message);
            }
        }
    </script>
</body>
</html>
